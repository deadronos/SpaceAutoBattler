{
  "version": 3,
  "sources": ["../src/config/assets/assetsConfig.ts", "../src/config/displayConfig.ts", "../src/config/rendererConfig.ts", "../src/math/polygon.ts", "../src/assets/svgToPolylines.ts", "../src/assets/svgLoader.ts", "../src/assets/svgRenderer.ts", "../src/dev/shipPipelineOverlay.ts", "../src/config/entitiesConfig.ts", "../src/config/runtimeConfigResolver.ts", "../src/config/simConfig.ts", "../src/rng.ts", "../src/config/teamsConfig.ts", "../src/pools/pool.ts", "../src/entities.ts", "../src/config/behaviorConfig.ts", "../src/behavior.ts", "../src/simulate.ts", "../src/config/progressionConfig.ts", "../src/spatialGrid.ts", "../src/createSimWorker.ts", "../src/pools/PoolManager.ts", "../src/pools/assetPool.ts", "../src/config/gamemanagerConfig.ts", "../src/gamemanager.ts", "../src/canvasrenderer.ts", "../src/pools/tintedHullPool.ts", "../src/webglrenderer.ts", "../src/main.ts"],
  "sourcesContent": ["/**\r\n * Returns the engine trail config for a given ship type.\r\n * If not present, returns the default engineTrail animation config.\r\n */\r\nexport function getEngineTrailConfig(type: string): any {\r\n  const vconf = getVisualConfig(type);\r\n  const trailName = (vconf.visuals && vconf.visuals.engineTrail) || 'engineTrail';\r\n  return (AssetsConfig.animations && AssetsConfig.animations[trailName]) || (AssetsConfig.animations && AssetsConfig.animations.engineTrail);\r\n}\r\n/**\r\n * Asset-agnostic sprite provider: returns a sprite object for a given type.\r\n * Supports fallback to vector shapes, 3D models, or SVG files.\r\n * Usage: getSpriteAsset('fighter'), getSpriteAsset('carrier'), etc.\r\n */\r\nexport function getSpriteAsset(type: string): { shape?: Shape2D; model3d?: Model3D; svg?: string } {\r\n  // Prefer an inlined SVG string from AssetsConfig.svgAssets (standalone build)\r\n  // if present and looks like SVG markup. This allows the build-time inlined\r\n  // SVGs to be used directly by the renderer. If not inlined, fall back to\r\n  // any `svg` field on the shapes2d entry (legacy) or model3d/shape data.\r\n  const inlineSvg = (AssetsConfig as any).svgAssets && (AssetsConfig as any).svgAssets[type];\r\n  if (typeof inlineSvg === 'string' && inlineSvg.trim().startsWith('<svg')) {\r\n    return { svg: inlineSvg };\r\n  }\r\n  // For backward compatibility, check shapes2d entry for an embedded svg string\r\n  const shapeEntry = AssetsConfig.shapes2d[type] || AssetsConfig.shapes2d.fighter;\r\n  if ((shapeEntry as any).svg) {\r\n    return { svg: (shapeEntry as any).svg };\r\n  }\r\n  // If model3d is present, use it\r\n  if (shapeEntry.model3d && shapeEntry.model3d.url) {\r\n    return { model3d: shapeEntry.model3d };\r\n  }\r\n  // Fallback to vector shape\r\n  return { shape: shapeEntry };\r\n}\r\n// Basic asset templates for 2D top-down rendering with future 3D model placeholders.\r\n// Orientation: shapes face +X (to the right). Scale is in logical units; renderer\r\n// should scale to entity radius and rotate by entity heading if present.\r\n\r\nexport type PolygonShape = {\r\n  type: 'polygon';\r\n  points: number[][]; // [[x,y], ...]\r\n  strokeWidth?: number;\r\n  model3d?: Model3D | undefined;\r\n};\r\n\r\nexport type CircleShape = {\r\n  type: 'circle';\r\n  r: number;\r\n  strokeWidth?: number;\r\n  model3d?: Model3D | undefined;\r\n};\r\n\r\nexport type CompoundPart = PolygonShape | CircleShape;\r\n\r\nexport type CompoundShape = {\r\n  type: 'compound';\r\n  parts: CompoundPart[];\r\n  strokeWidth?: number;\r\n  model3d?: Model3D | undefined;\r\n};\r\n\r\nexport type Shape2D = PolygonShape | CircleShape | CompoundShape;\r\nexport type TurretVisualConfig = {\r\n  kind: string;\r\n  position: [number, number]; // relative to ship center, in radius units\r\n};\r\n\r\nexport type TurretDefaultConfig = {\r\n  turnRate?: number; // radians per second default\r\n  sprite?: string; // optional sprite key to use for turret visuals\r\n};\r\n\r\nexport type Model3D = {\r\n  url?: string | undefined;\r\n  scale?: number | undefined;\r\n  type?: string | undefined;\r\n  mesh?: string | undefined;\r\n};\r\n\r\nexport type AssetsConfigType = {\r\n  meta: { orientation: string; coordinateSystem: string };\r\n  palette: Record<string, string>;\r\n  shapes2d: Record<string, Shape2D & { turrets?: TurretVisualConfig[] }>;\r\n  // Optional mapping of ship type -> svg filename (for future svg-based rendering)\r\n  svgAssets?: Record<string, string>;\r\n  // Optional explicit mountpoints extracted from SVGs or authored here.\r\n  // Positions are in ship-local radius units (same space as shapes2d.turrets)\r\n  svgMounts?: Record<string, [number, number][]>;\r\n  // Defaults for turret kinds (turn rate, sprite override, etc.)\r\n  turretDefaults?: Record<string, TurretDefaultConfig>;\r\n  animations?: Record<string, any>;\r\n  damageStates?: Record<string, { opacity?: number; accentColor?: string }>;\r\n  visualStateDefaults?: Record<string, { engine?: string; shield?: string; damageParticles?: string }>;\r\n};\r\n\r\nexport const AssetsConfig: AssetsConfigType = {\r\n  meta: {\r\n    orientation: '+X',\r\n    coordinateSystem: 'topdown-2d',\r\n  },\r\n  palette: {\r\n    shipHull: '#b0b7c3',\r\n    shipAccent: '#6c7380',\r\n    bullet: '#ffd166',\r\n    turret: '#94a3b8',\r\n    // Scene background color used by renderers\r\n    background: '#0b1220',\r\n  },\r\n  // 2D vector shapes defined as polygons and circles. Points are unit-sized\r\n  // profiles (roughly radius 1). Renderer should multiply by entity radius or\r\n  // provided scale before drawing.\r\n  shapes2d: {\r\n    fighter: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'polygon', points: [[1.2, 0], [-0.8, 0.6], [-0.5, 0], [-0.8, -0.6]] },\r\n        { type: 'polygon', points: [[0.0, 0.35], [-0.6, 0.65], [-0.35, 0.0]] },\r\n        { type: 'polygon', points: [[0.0, -0.35], [-0.35, 0.0], [-0.6, -0.65]] },\r\n        { type: 'circle', r: 0.5 }\r\n      ],\r\n      strokeWidth: 0.08,\r\n      model3d: { url: undefined, scale: 1, type: 'gltf', mesh: undefined }\r\n    },\r\n    corvette: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'polygon', points: [[1.2, 0], [0.4, 0.7], [-1.0, 0.6], [-1.2, 0], [-1.0, -0.6], [0.4, -0.7]] },\r\n        { type: 'polygon', points: [[1.4, 0.22], [1.2, 0.12], [1.2, -0.12], [1.4, -0.22]] },\r\n        { type: 'circle', r: 0.6 }\r\n      ],\r\n      strokeWidth: 0.08,\r\n      model3d: { url: undefined, scale: 1.4, type: 'gltf', mesh: undefined }\r\n    },\r\n    frigate: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'polygon', points: [[1.3, 0], [0.7, 0.65], [-0.3, 1.0], [-1.3, 0.55], [-1.3, -0.55], [-0.3, -1.0], [0.7, -0.65]] },\r\n        { type: 'circle', r: 0.7 }\r\n      ],\r\n      strokeWidth: 0.1,\r\n      model3d: { url: undefined, scale: 1.8, type: 'gltf', mesh: undefined }\r\n    },\r\n    destroyer: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'polygon', points: [[1.8, 0], [1.0, 0.7], [0.2, 1.0], [-0.8, 0.9], [-1.8, 0.6], [-1.8, -0.6], [-0.8, -0.9], [0.2, -1.0], [1.0, -0.7]] },\r\n        { type: 'circle', r: 1.0 },\r\n        { type: 'polygon', points: [[2.0, 0.3], [1.8, 0.2], [1.8, -0.2], [2.0, -0.3]] }\r\n      ],\r\n      strokeWidth: 0.12,\r\n      model3d: { url: undefined, scale: 2.2, type: 'gltf', mesh: undefined },\r\n      turrets: [\r\n        { kind: 'basic', position: [1.2, 0.8] },\r\n        { kind: 'basic', position: [-1.2, 0.8] },\r\n        { kind: 'basic', position: [1.2, -0.8] },\r\n        { kind: 'basic', position: [-1.2, -0.8] },\r\n        { kind: 'basic', position: [0, 1.5] },\r\n        { kind: 'basic', position: [0, -1.5] }\r\n      ]\r\n    },\r\n    carrier: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'polygon', points: [[2.2, 0], [1.2, 1.2], [-1.0, 1.6], [-2.8, 1.2], [-3.2, 0], [-2.8, -1.2], [-1.0, -1.6], [1.2, -1.2]] },\r\n        { type: 'circle', r: 1.2 },\r\n        { type: 'polygon', points: [[2.6, 0.5], [2.2, 0.3], [2.2, -0.3], [2.6, -0.5]] }\r\n      ],\r\n      strokeWidth: 0.12,\r\n      model3d: { url: undefined, scale: 3.0, type: 'gltf', mesh: undefined },\r\n      turrets: [\r\n        { kind: 'basic', position: [2.0, 1.2] },\r\n        { kind: 'basic', position: [-2.0, 1.2] },\r\n        { kind: 'basic', position: [2.0, -1.2] },\r\n        { kind: 'basic', position: [-2.0, -1.2] }\r\n      ]\r\n    },\r\n    bulletSmall: { type: 'circle', r: 0.18 },\r\n    bulletMedium: { type: 'circle', r: 0.25 },\r\n    bulletLarge: { type: 'circle', r: 0.36 },\r\n    turretBasic: {\r\n      type: 'compound',\r\n      parts: [\r\n        { type: 'circle', r: 0.5 },\r\n        { type: 'polygon', points: [[-0.2, 0.2], [0.7, 0.2], [0.7, -0.2], [-0.2, -0.2]] }\r\n      ],\r\n      strokeWidth: 0.08\r\n    },\r\n    // Small effect/particle shapes for renderer-driven effects\r\n    particleSmall: { type: 'circle', r: 0.12 },\r\n    particleMedium: { type: 'circle', r: 0.22 },\r\n    explosionParticle: { type: 'circle', r: 0.32 },\r\n    shieldRing: { type: 'circle', r: 1.2 }\r\n  }\r\n};\r\n\r\n// Optional mapping to ship SVGs (relative to this file path). These are\r\n// provided as a convenience for renderers that can load and parse the\r\n// inline SVGs to extract mountpoints or render higher-fidelity imagery.\r\n\r\n// For standalone builds, SVGs are inlined as strings. Use globalThis.__INLINE_SVG_ASSETS if present.\r\nif (typeof globalThis !== 'undefined' && (globalThis as any).__INLINE_SVG_ASSETS) {\r\n  (AssetsConfig as any).svgAssets = (globalThis as any).__INLINE_SVG_ASSETS;\r\n} else {\r\n  (AssetsConfig as any).svgAssets = {\r\n    destroyer: './svg/destroyer.svg',\r\n    carrier: './svg/carrier.svg',\r\n    frigate: './svg/frigate.svg',\r\n    corvette: './svg/corvette.svg'\r\n  };\r\n}\r\n\r\n// For environments where SVG mountpoint extraction isn't available yet we\r\n// provide an explicit mapping that mirrors the turrets defined in shapes2d.\r\n(AssetsConfig as any).svgMounts = {\r\n  destroyer: AssetsConfig.shapes2d.destroyer.turrets ? AssetsConfig.shapes2d.destroyer.turrets.map((t: any) => t.position) : [],\r\n  carrier: AssetsConfig.shapes2d.carrier.turrets ? AssetsConfig.shapes2d.carrier.turrets.map((t: any) => t.position) : []\r\n};\r\n\r\n// Turret defaults (radians per second) and optional sprite selection.\r\n(AssetsConfig as any).turretDefaults = {\r\n  basic: { turnRate: Math.PI * 1.5, sprite: 'turretBasic' }\r\n};\r\n\r\n// Animations and visual defaults (align with JS AssetsConfig)\r\n(AssetsConfig as any).animations = {\r\n  engineFlare: {\r\n    type: 'polygon',\r\n    points: [ [0, 0], [-0.3, 0.15], [-0.5, 0], [-0.3, -0.15] ],\r\n    pulseRate: 8,\r\n    // configurable alpha multiplier for engine overlay\r\n    alpha: 0.4,\r\n    // local-space X offset (negative = behind ship)\r\n    offset: -0.9\r\n  },\r\n  shieldEffect: {\r\n    type: 'circle',\r\n    r: 1.2,\r\n    strokeWidth: 0.1,\r\n    color: '#88ccff',\r\n    pulseRate: 2,\r\n    // map shieldPct -> alpha = base + scale * shieldPct\r\n    alphaBase: 0.25,\r\n    alphaScale: 0.75\r\n  },\r\n  damageParticles: {\r\n    type: 'particles',\r\n    color: '#ff6b6b',\r\n    count: 6,\r\n    lifetime: 0.8,\r\n    spread: 0.6\r\n  }\r\n  ,\r\n  engineTrail: {\r\n    type: 'trail',\r\n    color: '#fff0a0', // brighter, warm highlight for good contrast\r\n    maxLength: 120,   // longer trail (was 40)\r\n    width: 0.9,       // thicker trail line (was 0.35)\r\n    fade: 0.6         // older points remain more visible (was 0.35)\r\n  }\r\n};\r\n\r\n(AssetsConfig as any).damageStates = {\r\n  light: { opacity: 0.9, accentColor: '#b0b7c3' },\r\n  moderate: { opacity: 0.75, accentColor: '#d4a06a' },\r\n  heavy: { opacity: 0.5, accentColor: '#ff6b6b' }\r\n};\r\n\r\n(AssetsConfig as any).visualStateDefaults = {\r\n  fighter:   { engine: 'engineFlare', shield: 'shieldEffect', damageParticles: 'damageParticles', engineTrail: 'engineTrail', arcWidth: Math.PI / 12 },\r\n  corvette:  { engine: 'engineFlare', shield: 'shieldEffect', damageParticles: 'damageParticles', engineTrail: 'engineTrail', arcWidth: Math.PI / 12 },\r\n  frigate:   { engine: 'engineFlare', shield: 'shieldEffect', damageParticles: 'damageParticles', engineTrail: 'engineTrail', arcWidth: Math.PI / 12 },\r\n  destroyer: { engine: 'engineFlare', shield: 'shieldEffect', damageParticles: 'damageParticles', engineTrail: 'engineTrail', arcWidth: Math.PI / 12 },\r\n  carrier:   { engine: 'engineFlare', shield: 'shieldEffect', damageParticles: 'damageParticles', engineTrail: 'engineTrail', arcWidth: Math.PI / 12 }\r\n};\r\n\r\n// thresholds for mapping hpPct -> damage state key\r\n(AssetsConfig as any).damageThresholds = { moderate: 0.66, heavy: 0.33 };\r\n(AssetsConfig as any).shieldArcWidth = Math.PI / 12;\r\n\r\nexport function getVisualConfig(type: string) {\r\n  const shape = getShipAsset(type);\r\n  const visuals = (AssetsConfig as any).visualStateDefaults[type] || (AssetsConfig as any).visualStateDefaults.fighter;\r\n  return { shape, visuals, palette: AssetsConfig.palette, animations: (AssetsConfig as any).animations, damageStates: (AssetsConfig as any).damageStates } as any;\r\n}\r\n\r\nexport function getShipAsset(type: string): Shape2D {\r\n  return AssetsConfig.shapes2d[type] || AssetsConfig.shapes2d.fighter;\r\n}\r\n\r\nexport function getBulletAsset(kind: 'small' | 'medium' | 'large' = 'small'): Shape2D {\r\n  if (kind === 'large') return AssetsConfig.shapes2d.bulletLarge;\r\n  if (kind === 'medium') return AssetsConfig.shapes2d.bulletMedium;\r\n  return AssetsConfig.shapes2d.bulletSmall;\r\n}\r\n\r\nexport function getTurretAsset(_kind: 'basic' = 'basic'): Shape2D {\r\n  return AssetsConfig.shapes2d.turretBasic;\r\n}\r\n\r\nexport default AssetsConfig;\r\n", "export const DISPLAY_DEFAULTS = {\r\n  renderScale: 1.0,\r\n  displayScale: 1.0,\r\n  hpBar: { bg: \"#222\", fill: \"#4caf50\", w: 20, h: 4, dx: -10, dy: -12 },\r\n};\r\n\r\nexport default {};\r\n", "import { DISPLAY_DEFAULTS } from \"./displayConfig\";\r\n\r\nexport const RendererConfig = {\r\n  preferred: \"canvas\" as \"canvas\" | \"webgl\",\r\n  allowUrlOverride: true,\r\n  allowWebGL: true,\r\n  renderScale: DISPLAY_DEFAULTS.renderScale,\r\n  displayScale: DISPLAY_DEFAULTS.displayScale,\r\n  dynamicScaleEnabled: false,\r\n  lastFrameTime: 0,\r\n  frameScore: \"green\", // green, yellow, red\r\n  // UI overlays configuration\r\n  hpBar: DISPLAY_DEFAULTS.hpBar,\r\n  // starfield rendering tweaks\r\n  starfield: {\r\n    parallaxFactor: 0.01, // how much the starfield moves relative to camera (0 = static)\r\n    density: 0.00035, // base star density multiplier (stars = size*size*density)\r\n    bloomIntensity: 0.9, // applied alpha when compositing bloom on canvas\r\n  },\r\n};\r\n\r\nexport function getPreferredRenderer(): \"canvas\" | \"webgl\" {\r\n  try {\r\n    if (\r\n      RendererConfig.allowUrlOverride &&\r\n      typeof window !== \"undefined\" &&\r\n      window.location &&\r\n      window.location.search\r\n    ) {\r\n      const p = new URLSearchParams(window.location.search);\r\n      const r = p.get(\"renderer\");\r\n      if (r === \"canvas\" || r === \"webgl\") return r;\r\n    }\r\n  } catch (e) {}\r\n  return RendererConfig.preferred;\r\n}\r\n\r\nexport default RendererConfig;\r\n", "// polygon.ts\r\n// Polygon math utilities for hull/collision logic\r\n// See svg-hull-implementation-plan.md for requirements\r\n\r\nexport function pointInPolygon(point: [number, number], polygon: [number, number][]): boolean {\r\n  // Raycast algorithm (even-odd rule)\r\n  let inside = false;\r\n  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {\r\n    const [xi, yi] = polygon[i];\r\n    const [xj, yj] = polygon[j];\r\n    if (((yi > point[1]) !== (yj > point[1])) &&\r\n        (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi + 1e-12) + xi)) {\r\n      inside = !inside;\r\n    }\r\n  }\r\n  return inside;\r\n}\r\n\r\nexport function distancePointToSegment(point: [number, number], segA: [number, number], segB: [number, number]): number {\r\n  // Compute distance from point to segment AB\r\n  const [px, py] = point;\r\n  const [ax, ay] = segA;\r\n  const [bx, by] = segB;\r\n  const dx = bx - ax, dy = by - ay;\r\n  if (dx === 0 && dy === 0) return Math.hypot(px - ax, py - ay);\r\n  const t = Math.max(0, Math.min(1, ((px - ax) * dx + (py - ay) * dy) / (dx * dx + dy * dy)));\r\n  const projX = ax + t * dx, projY = ay + t * dy;\r\n  return Math.hypot(px - projX, py - projY);\r\n}\r\n\r\nexport function circleIntersectsPolygon(center: [number, number], radius: number, polygon: [number, number][]): boolean {\r\n  // Check if circle intersects polygon edges or is inside polygon\r\n  if (pointInPolygon(center, polygon)) return true;\r\n  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {\r\n    if (distancePointToSegment(center, polygon[j], polygon[i]) <= radius) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n// Ramer\u2013Douglas\u2013Peucker simplification\r\nexport function polygonSimplify(points: [number, number][], tolerance: number): [number, number][] {\r\n  if (points.length < 3) return points;\r\n  const sqTolerance = tolerance * tolerance;\r\n  function getSqDist(p1: [number, number], p2: [number, number]) {\r\n    const dx = p1[0] - p2[0], dy = p1[1] - p2[1];\r\n    return dx * dx + dy * dy;\r\n  }\r\n  function getSqSegDist(p: [number, number], a: [number, number], b: [number, number]) {\r\n    const x = a[0], y = a[1];\r\n    const dx = b[0] - x;\r\n    const dy = b[1] - y;\r\n    if (dx === 0 && dy === 0) return getSqDist(p, a);\r\n    const t = ((p[0] - x) * dx + (p[1] - y) * dy) / (dx * dx + dy * dy);\r\n    if (t <= 0) return getSqDist(p, a);\r\n    if (t >= 1) return getSqDist(p, b);\r\n    const projX = x + t * dx;\r\n    const projY = y + t * dy;\r\n    const ddx = p[0] - projX;\r\n    const ddy = p[1] - projY;\r\n    return ddx * ddx + ddy * ddy;\r\n  }\r\n\r\n  function simplifyDP(start: number, end: number, out: number[]) {\r\n    let maxDist = 0, index = -1;\r\n    for (let i = start + 1; i < end; i++) {\r\n      const dist = getSqSegDist(points[i], points[start], points[end]);\r\n      if (dist > maxDist) { maxDist = dist; index = i; }\r\n    }\r\n    if (maxDist > sqTolerance && index !== -1) {\r\n      simplifyDP(start, index, out);\r\n      simplifyDP(index, end, out);\r\n    } else {\r\n      out.push(start);\r\n    }\r\n  }\r\n\r\n  const out: number[] = [];\r\n  simplifyDP(0, points.length - 1, out);\r\n  out.push(points.length - 1);\r\n  // map indices to points\r\n  return out.map(i => points[i]);\r\n}\r\n\r\n// Optional: triangulate via earcut (not implemented)\r\n// export function triangulate(polygon: [number, number][]): number[][] {\r\n//   // TODO: Use earcut or similar\r\n//   return [];\r\n// }\r\n", "// svgToPolylines.ts\r\n// Utility to parse SVG and extract polygonal hull outlines for shield/collision use\r\n// Lightweight implementation: depends on global DOMParser (available in jsdom/test envs)\r\n// Supports <polygon>, <polyline>, <rect>, <circle>, <ellipse>, and basic <path> commands (M/L/H/V/Z).\r\n// Coordinates are normalized to viewBox-centered unit space: x' = (x - vb.w/2)/(vb.w/2)\r\n// so that multiplying by ship.radius produces pixel offsets used by the renderer.\r\n\r\nimport { polygonSimplify } from \"../math/polygon\";\r\n\r\n// Simple in-memory cache for svg->polylines results keyed by a hash of the svg string + tolerance.\r\n// Keeps insertion order (Map) so we can evict oldest entries when over capacity.\r\nconst SVG_POLY_CACHE = new Map<string, { ts: number; value: SvgPolylinesResult }>();\r\nconst CACHE_MAX_ENTRIES = 200; // evict oldest when exceeded\r\nconst CACHE_MAX_AGE_MS = 1000 * 60 * 60; // 1 hour\r\nlet CACHE_HITS = 0;\r\nlet CACHE_MISSES = 0;\r\n\r\nexport function getSvgPolylinesCacheStats() {\r\n  return { hits: CACHE_HITS, misses: CACHE_MISSES, entries: SVG_POLY_CACHE.size };\r\n}\r\n\r\nexport function resetSvgPolylinesCacheStats() {\r\n  CACHE_HITS = 0;\r\n  CACHE_MISSES = 0;\r\n}\r\n\r\nexport function clearSvgPolylinesCache() {\r\n  SVG_POLY_CACHE.clear();\r\n}\r\n\r\nfunction hashStringToKey(s: string) {\r\n  // FNV-1a 32-bit\r\n  let h = 2166136261 >>> 0;\r\n  for (let i = 0; i < s.length; i++) {\r\n    h ^= s.charCodeAt(i);\r\n    h = Math.imul(h, 16777619) >>> 0;\r\n  }\r\n  return h.toString(36);\r\n}\r\n\r\n\r\nexport interface SvgPolylinesResult {\r\n  contours: number[][][]; // Array of polylines (each: array of [x, y] pairs)\r\n  bbox: { minX: number; minY: number; maxX: number; maxY: number };\r\n  convexHull?: number[][];\r\n}\r\n\r\nexport interface SvgToPolylinesOptions {\r\n  tolerance?: number; // Curve flattening / simplify tolerance (default: 0.5)\r\n  assetId?: string; // optional asset identifier to key cache\r\n}\r\n\r\nfunction parseViewBox(svgEl: SVGSVGElement | Element | null) {\r\n  const vbAttr = svgEl && (svgEl.getAttribute && svgEl.getAttribute(\"viewBox\"));\r\n  if (vbAttr) {\r\n    const parts = vbAttr.trim().split(/[,\\s]+/).map((s) => parseFloat(s));\r\n    if (parts.length >= 4 && parts.every((n) => !Number.isNaN(n))) {\r\n      return { x: parts[0], y: parts[1], w: parts[2], h: parts[3] };\r\n    }\r\n  }\r\n  // fallback to width/height attributes or default 128x128\r\n  if (svgEl && svgEl.getAttribute) {\r\n    const wAttr = svgEl.getAttribute(\"width\");\r\n    const hAttr = svgEl.getAttribute(\"height\");\r\n    const w = wAttr ? parseFloat(wAttr) || 128 : 128;\r\n    const h = hAttr ? parseFloat(hAttr) || 128 : 128;\r\n    return { x: 0, y: 0, w, h };\r\n  }\r\n  return { x: 0, y: 0, w: 128, h: 128 };\r\n}\r\n\r\n// Matrix helpers: SVG matrix [a b c d e f] maps (x,y) -> (a*x + c*y + e, b*x + d*y + f)\r\ntype Matrix = [number, number, number, number, number, number];\r\nconst IDENTITY_MATRIX: Matrix = [1, 0, 0, 1, 0, 0];\r\nfunction multiplyMatrix(a: Matrix, b: Matrix): Matrix {\r\n  // a * b\r\n  const [a1, a2, a3, a4, a5, a6] = a;\r\n  const [b1, b2, b3, b4, b5, b6] = b;\r\n  return [\r\n    a1 * b1 + a3 * b2,\r\n    a2 * b1 + a4 * b2,\r\n    a1 * b3 + a3 * b4,\r\n    a2 * b3 + a4 * b4,\r\n    a1 * b5 + a3 * b6 + a5,\r\n    a2 * b5 + a4 * b6 + a6,\r\n  ];\r\n}\r\nfunction applyMatrixToPoint(m: Matrix, x: number, y: number): [number, number] {\r\n  const [a, b, c, d, e, f] = m;\r\n  return [a * x + c * y + e, b * x + d * y + f];\r\n}\r\nfunction applyMatrixToPoints(m: Matrix, pts: number[][]) {\r\n  for (let i = 0; i < pts.length; i++) {\r\n    const [x, y] = pts[i];\r\n    const p = applyMatrixToPoint(m, x, y);\r\n    pts[i][0] = p[0]; pts[i][1] = p[1];\r\n  }\r\n}\r\n\r\nfunction isIdentityMatrix(m: Matrix) {\r\n  return m[0] === 1 && m[1] === 0 && m[2] === 0 && m[3] === 1 && m[4] === 0 && m[5] === 0;\r\n}\r\n\r\nfunction parseTransform(transformStr: string | null): Matrix {\r\n  if (!transformStr) return IDENTITY_MATRIX;\r\n  let m: Matrix = IDENTITY_MATRIX;\r\n  // e.g. translate(10,20) rotate(30) scale(2) matrix(a b c d e f)\r\n  const re = /([a-zA-Z]+)\\s*\\(([^)]+)\\)/g;\r\n  let mm: RegExpExecArray | null;\r\n  while ((mm = re.exec(transformStr))) {\r\n    const cmd = mm[1].trim();\r\n    const raw = mm[2].trim();\r\n    const nums = raw.split(/[\\s,]+/).filter(Boolean).map((s) => parseFloat(s));\r\n    let t: Matrix = IDENTITY_MATRIX;\r\n    try {\r\n      if (cmd === 'matrix' && nums.length >= 6) {\r\n        t = [nums[0], nums[1], nums[2], nums[3], nums[4], nums[5]] as Matrix;\r\n      } else if (cmd === 'translate') {\r\n        const tx = nums[0] || 0; const ty = nums[1] || 0; t = [1,0,0,1,tx,ty] as Matrix;\r\n      } else if (cmd === 'scale') {\r\n        const sx = nums[0] || 1; const sy = typeof nums[1] === 'number' ? nums[1] : sx; t = [sx,0,0,sy,0,0] as Matrix;\r\n      } else if (cmd === 'rotate') {\r\n        const a = (nums[0] || 0) * Math.PI / 180;\r\n        const cosA = Math.cos(a), sinA = Math.sin(a);\r\n        if (nums.length >= 3) {\r\n          const cx = nums[1], cy = nums[2];\r\n          // translate(cx,cy) * rotate * translate(-cx,-cy)\r\n          const to = [1,0,0,1,cx,cy] as Matrix;\r\n          const rot = [cosA, sinA, -sinA, cosA, 0, 0] as Matrix;\r\n          const back = [1,0,0,1,-cx,-cy] as Matrix;\r\n          t = multiplyMatrix(to, multiplyMatrix(rot, back));\r\n        } else {\r\n          t = [cosA, sinA, -sinA, cosA, 0, 0] as Matrix;\r\n        }\r\n      } else if (cmd === 'skewX') {\r\n        const a = (nums[0] || 0) * Math.PI / 180; t = [1,0,Math.tan(a),1,0,0] as Matrix;\r\n      } else if (cmd === 'skewY') {\r\n        const a = (nums[0] || 0) * Math.PI / 180; t = [1,Math.tan(a),0,1,0,0] as Matrix;\r\n      }\r\n    } catch (e) { t = IDENTITY_MATRIX; }\r\n    // concatenation: new total = m * t (apply t after existing)\r\n    m = multiplyMatrix(m, t);\r\n  }\r\n  return m;\r\n}\r\n\r\nfunction computeCumulativeTransform(el: Element | null, svgEl: Element | null): Matrix {\r\n  let m: Matrix = IDENTITY_MATRIX;\r\n  const chain: Element[] = [];\r\n  let cur: Element | null = el as Element | null;\r\n  while (cur && cur !== svgEl && cur.nodeType === 1) {\r\n    chain.push(cur);\r\n    cur = cur.parentElement;\r\n  }\r\n  // include svgEl transform if present\r\n  if (svgEl && svgEl !== el) chain.push(svgEl as Element);\r\n  // accumulate from root down to element\r\n  for (let i = chain.length - 1; i >= 0; i--) {\r\n    const e = chain[i];\r\n    try {\r\n      const t = parseTransform(e.getAttribute && e.getAttribute('transform'));\r\n      m = multiplyMatrix(m, t);\r\n    } catch (e) {}\r\n  }\r\n  return m;\r\n}\r\n\r\nfunction parsePointsAttr(val: string) {\r\n  const parts = val.trim().split(/[,\\s]+/).map((s) => s.trim()).filter(Boolean);\r\n  const pts: number[][] = [];\r\n  for (let i = 0; i + 1 < parts.length; i += 2) {\r\n    const x = parseFloat(parts[i]);\r\n    const y = parseFloat(parts[i + 1]);\r\n    if (!Number.isNaN(x) && !Number.isNaN(y)) pts.push([x, y]);\r\n  }\r\n  return pts;\r\n}\r\n\r\nfunction applyViewBoxNormalization(points: number[][], vb: { x: number; y: number; w: number; h: number }) {\r\n  // Normalize coordinates into renderer-local unit space centered at viewBox center.\r\n  // Correctly account for viewBox minX/minY (vb.x, vb.y). Previous logic incorrectly\r\n  // subtracted half-width/height instead of viewBox origin + half-size which broke\r\n  // assets with non-zero viewBox origins.\r\n  const hw = (vb.w || 1) / 2;\r\n  const hh = (vb.h || 1) / 2;\r\n  const cx = (vb.x || 0) + hw;\r\n  const cy = (vb.y || 0) + hh;\r\n  return points.map(([x, y]) => [((x - cx) / hw) as number, ((y - cy) / hh) as number]);\r\n}\r\n\r\nfunction sampleCircle(cx: number, cy: number, r: number, segments = 48) {\r\n  const pts: number[][] = [];\r\n  for (let i = 0; i < segments; i++) {\r\n    const a = (i / segments) * Math.PI * 2;\r\n    pts.push([cx + Math.cos(a) * r, cy + Math.sin(a) * r]);\r\n  }\r\n  return pts;\r\n}\r\n\r\n// Path parser: supports M/m, L/l, H/h, V/v, Z/z, C/c, S/s, Q/q, T/t, A/a with curve flattening.\r\nfunction parsePathCommands(d: string, tolerance: number) {\r\n  // Enhanced path parser supporting M/m, L/l, H/h, V/v, Z/z, C/c, S/s, Q/q, T/t, A/a\r\n  const tokens = d.replace(/,/g, ' ').replace(/\\s+/g, ' ').trim();\r\n  const cmdRe = /([MmLlHhVvZzCcSsQqTtAa])([^MmLlHhVvZzCcSsQqTtAa]*)/g;\r\n  const pts: number[][] = [];\r\n  let curX = 0,\r\n    curY = 0;\r\n  let lastCpx: number | null = null,\r\n    lastCpy: number | null = null; // for S/T shorthand\r\n  let m: RegExpExecArray | null;\r\n  while ((m = cmdRe.exec(tokens))) {\r\n    const cmd = m[1];\r\n    const rawArgs = m[2].trim();\r\n    const args = rawArgs ? rawArgs.split(/[\\s,]+/).filter(Boolean).map((s) => parseFloat(s)) : [];\r\n    let ai = 0;\r\n    if (cmd === 'Z' || cmd === 'z') {\r\n      // close path -> no-op for now\r\n      continue;\r\n    }\r\n    if (cmd === 'H' || cmd === 'h') {\r\n      while (ai < args.length) {\r\n        const x = args[ai++];\r\n        curX = cmd === 'h' ? curX + x : x;\r\n        pts.push([curX, curY]);\r\n      }\r\n      lastCpx = lastCpy = null;\r\n      continue;\r\n    }\r\n    if (cmd === 'V' || cmd === 'v') {\r\n      while (ai < args.length) {\r\n        const y = args[ai++];\r\n        curY = cmd === 'v' ? curY + y : y;\r\n        pts.push([curX, curY]);\r\n      }\r\n      lastCpx = lastCpy = null;\r\n      continue;\r\n    }\r\n    // M/m and L/l\r\n    if (cmd === 'M' || cmd === 'm' || cmd === 'L' || cmd === 'l') {\r\n      while (ai + 1 < args.length) {\r\n        const ax = args[ai++], ay = args[ai++];\r\n        if (cmd === 'm' || cmd === 'l') {\r\n          curX += ax; curY += ay;\r\n        } else {\r\n          curX = ax; curY = ay;\r\n        }\r\n        pts.push([curX, curY]);\r\n      }\r\n      lastCpx = lastCpy = null;\r\n      continue;\r\n    }\r\n    // Cubic commands C/c: (x1 y1 x2 y2 x y)+\r\n    if (cmd === 'C' || cmd === 'c') {\r\n      while (ai + 5 < args.length) {\r\n        const x1 = args[ai++], y1 = args[ai++], x2 = args[ai++], y2 = args[ai++], x = args[ai++], y = args[ai++];\r\n        const cp1x = cmd === 'c' ? curX + x1 : x1;\r\n        const cp1y = cmd === 'c' ? curY + y1 : y1;\r\n        const cp2x = cmd === 'c' ? curX + x2 : x2;\r\n        const cp2y = cmd === 'c' ? curY + y2 : y2;\r\n        const ex = cmd === 'c' ? curX + x : x;\r\n        const ey = cmd === 'c' ? curY + y : y;\r\n  // flatten cubic from (curX,curY) -> (ex,ey)\r\n  const cubicPts = flattenCubicBezier([curX, curY], [cp1x, cp1y], [cp2x, cp2y], [ex, ey], tolerance);\r\n  // append (skip initial duplicate if present)\r\n  for (let i = 1; i < cubicPts.length; i++) pts.push(cubicPts[i]);\r\n        curX = ex; curY = ey;\r\n        lastCpx = cp2x; lastCpy = cp2y;\r\n      }\r\n      continue;\r\n    }\r\n    // Smooth cubic S/s: (x2 y2 x y)+ (reflect previous control)\r\n    if (cmd === 'S' || cmd === 's') {\r\n      while (ai + 3 < args.length) {\r\n        const x2 = args[ai++], y2 = args[ai++], x = args[ai++], y = args[ai++];\r\n        let cp1x = curX, cp1y = curY;\r\n        if (lastCpx != null && lastCpy != null) {\r\n          cp1x = curX + (curX - lastCpx);\r\n          cp1y = curY + (curY - lastCpy);\r\n        }\r\n        const cp2x = cmd === 's' ? curX + x2 : x2;\r\n        const cp2y = cmd === 's' ? curY + y2 : y2;\r\n        const ex = cmd === 's' ? curX + x : x;\r\n        const ey = cmd === 's' ? curY + y : y;\r\n  const cubicPts2 = flattenCubicBezier([curX, curY], [cp1x, cp1y], [cp2x, cp2y], [ex, ey], tolerance);\r\n  for (let i = 1; i < cubicPts2.length; i++) pts.push(cubicPts2[i]);\r\n        lastCpx = cp2x; lastCpy = cp2y;\r\n        curX = ex; curY = ey;\r\n      }\r\n      continue;\r\n    }\r\n    // Quadratic Q/q: (x1 y1 x y)+\r\n    if (cmd === 'Q' || cmd === 'q') {\r\n      while (ai + 3 < args.length) {\r\n        const x1 = args[ai++], y1 = args[ai++], x = args[ai++], y = args[ai++];\r\n        const qx1 = cmd === 'q' ? curX + x1 : x1;\r\n        const qy1 = cmd === 'q' ? curY + y1 : y1;\r\n        const ex = cmd === 'q' ? curX + x : x;\r\n        const ey = cmd === 'q' ? curY + y : y;\r\n  const qpts = flattenQuadraticBezier([curX, curY], [qx1, qy1], [ex, ey], tolerance);\r\n  for (let i = 1; i < qpts.length; i++) pts.push(qpts[i]);\r\n        lastCpx = qx1; lastCpy = qy1;\r\n        curX = ex; curY = ey;\r\n      }\r\n      continue;\r\n    }\r\n    // Smooth quadratic T/t: (x y)+, reflect previous control point\r\n    if (cmd === 'T' || cmd === 't') {\r\n      while (ai + 1 < args.length) {\r\n        const x = args[ai++], y = args[ai++];\r\n        let qx1 = curX, qy1 = curY;\r\n        if (lastCpx != null && lastCpy != null) {\r\n          qx1 = curX + (curX - lastCpx);\r\n          qy1 = curY + (curY - lastCpy);\r\n        }\r\n        const ex = cmd === 't' ? curX + x : x;\r\n        const ey = cmd === 't' ? curY + y : y;\r\n  const qpts2 = flattenQuadraticBezier([curX, curY], [qx1, qy1], [ex, ey], tolerance);\r\n  for (let i = 1; i < qpts2.length; i++) pts.push(qpts2[i]);\r\n        lastCpx = qx1; lastCpy = qy1;\r\n        curX = ex; curY = ey;\r\n      }\r\n      continue;\r\n    }\r\n    // Arc A/a: (rx ry xAxisRotation large-arc-flag sweep-flag x y)+\r\n    if (cmd === 'A' || cmd === 'a') {\r\n      while (ai + 6 < args.length) {\r\n        const rx = args[ai++], ry = args[ai++], xrot = args[ai++], laf = args[ai++], sf = args[ai++], x = args[ai++], y = args[ai++];\r\n        const ex = cmd === 'a' ? curX + x : x;\r\n        const ey = cmd === 'a' ? curY + y : y;\r\n  const arcPts = arcToPoints(curX, curY, ex, ey, rx, ry, xrot, laf ? 1 : 0, sf ? 1 : 0, Math.max(0.1, tolerance));\r\n        // arcPts includes start..end; skip first since it's cur point\r\n        for (let i = 1; i < arcPts.length; i++) pts.push(arcPts[i]);\r\n        curX = ex; curY = ey;\r\n        lastCpx = lastCpy = null;\r\n      }\r\n      continue;\r\n    }\r\n    // Unknown command -> ignore\r\n  }\r\n  return pts;\r\n}\r\n\r\n// Helpers: flatten cubic/quadratic Beziers and approximate arcs\r\nfunction distToSegmentSq(px: number, py: number, x1: number, y1: number, x2: number, y2: number) {\r\n  const dx = x2 - x1, dy = y2 - y1;\r\n  if (dx === 0 && dy === 0) return (px - x1) * (px - x1) + (py - y1) * (py - y1);\r\n  const t = ((px - x1) * dx + (py - y1) * dy) / (dx * dx + dy * dy);\r\n  if (t <= 0) return (px - x1) * (px - x1) + (py - y1) * (py - y1);\r\n  if (t >= 1) return (px - x2) * (px - x2) + (py - y2) * (py - y2);\r\n  const projx = x1 + t * dx, projy = y1 + t * dy;\r\n  return (px - projx) * (px - projx) + (py - projy) * (py - projy);\r\n}\r\n\r\nfunction flattenCubicBezier(p0: number[], p1: number[], p2: number[], p3: number[], tolerance: number): number[][] {\r\n  // recursive subdivision producing a sequence of points from p0..p3\r\n  const tolSq = tolerance * tolerance;\r\n  const out: number[][] = [];\r\n  function recurse(a: number[], b: number[], c: number[], d: number[]) {\r\n    const d1 = distToSegmentSq(b[0], b[1], a[0], a[1], d[0], d[1]);\r\n    const d2 = distToSegmentSq(c[0], c[1], a[0], a[1], d[0], d[1]);\r\n    if (Math.max(d1, d2) <= tolSq) {\r\n      out.push([d[0], d[1]]);\r\n      return;\r\n    }\r\n    // subdivide via de Casteljau\r\n    const ab = [(a[0] + b[0]) / 2, (a[1] + b[1]) / 2];\r\n    const bc = [(b[0] + c[0]) / 2, (b[1] + c[1]) / 2];\r\n    const cd = [(c[0] + d[0]) / 2, (c[1] + d[1]) / 2];\r\n    const abc = [(ab[0] + bc[0]) / 2, (ab[1] + bc[1]) / 2];\r\n    const bcd = [(bc[0] + cd[0]) / 2, (bc[1] + cd[1]) / 2];\r\n    const abcd = [(abc[0] + bcd[0]) / 2, (abc[1] + bcd[1]) / 2];\r\n    recurse(a, ab, abc, abcd);\r\n    recurse(abcd, bcd, cd, d);\r\n  }\r\n  // Start with the initial point\r\n  out.push([p0[0], p0[1]]);\r\n  recurse(p0, p1, p2, p3);\r\n  return out;\r\n}\r\n\r\nfunction flattenQuadraticBezier(p0: number[], p1: number[], p2: number[], tolerance: number): number[][] {\r\n  // convert to cubic and reuse cubic flattener\r\n  const cp1 = [p0[0] + (2 / 3) * (p1[0] - p0[0]), p0[1] + (2 / 3) * (p1[1] - p0[1])];\r\n  const cp2 = [p2[0] + (2 / 3) * (p1[0] - p2[0]), p2[1] + (2 / 3) * (p1[1] - p2[1])];\r\n  const pts = flattenCubicBezier(p0, cp1, cp2, p2, tolerance);\r\n  if (pts.length >= 4) return pts;\r\n  // fallback: uniform sampling of quadratic if subdivision produced too few points\r\n  const samples = 4;\r\n  const out: number[][] = [];\r\n  for (let i = 0; i <= samples; i++) {\r\n    const t = i / samples;\r\n    const mt = 1 - t;\r\n    const x = mt * mt * p0[0] + 2 * mt * t * p1[0] + t * t * p2[0];\r\n    const y = mt * mt * p0[1] + 2 * mt * t * p1[1] + t * t * p2[1];\r\n    out.push([x, y]);\r\n  }\r\n  return out;\r\n}\r\n\r\nfunction arcToPoints(x1: number, y1: number, x2: number, y2: number, rx: number, ry: number, angle: number, largeArcFlag: number, sweepFlag: number, tolerance: number) {\r\n  // Implementation based on SVG spec (convert endpoint to center parameterization)\r\n  // angle in degrees\r\n  const rad = (angle * Math.PI) / 180;\r\n  const cosA = Math.cos(rad), sinA = Math.sin(rad);\r\n  // Step 1: handle degenerate\r\n  if (rx === 0 || ry === 0) return [[x1, y1], [x2, y2]];\r\n  // Step 2: compute (x1', y1')\r\n  const dx = (x1 - x2) / 2, dy = (y1 - y2) / 2;\r\n  const x1p = cosA * dx + sinA * dy;\r\n  const y1p = -sinA * dx + cosA * dy;\r\n  // ensure radii large enough\r\n  let rxAbs = Math.abs(rx), ryAbs = Math.abs(ry);\r\n  const lambda = (x1p * x1p) / (rxAbs * rxAbs) + (y1p * y1p) / (ryAbs * ryAbs);\r\n  if (lambda > 1) {\r\n    const s = Math.sqrt(lambda);\r\n    rxAbs *= s; ryAbs *= s;\r\n  }\r\n  const rx2 = rxAbs * rxAbs, ry2 = ryAbs * ryAbs;\r\n  const sign = largeArcFlag === sweepFlag ? -1 : 1;\r\n  const num = rx2 * ry2 - rx2 * y1p * y1p - ry2 * x1p * x1p;\r\n  const denom = rx2 * y1p * y1p + ry2 * x1p * x1p;\r\n  let cc = 0;\r\n  if (denom !== 0) cc = Math.max(0, num / denom);\r\n  const coef = sign * Math.sqrt(cc || 0);\r\n  const cxp = (coef * (rxAbs * y1p)) / ryAbs;\r\n  const cyp = (coef * -(ryAbs * x1p)) / rxAbs;\r\n  // center in original coords\r\n  const cx = cosA * cxp - sinA * cyp + (x1 + x2) / 2;\r\n  const cy = sinA * cxp + cosA * cyp + (y1 + y2) / 2;\r\n  // angles\r\n  function angleBetween(ux: number, uy: number, vx: number, vy: number) {\r\n    const dot = ux * vx + uy * vy;\r\n    const l = Math.hypot(ux, uy) * Math.hypot(vx, vy);\r\n    let a = Math.acos(Math.max(-1, Math.min(1, dot / (l || 1))));\r\n    if (ux * vy - uy * vx < 0) a = -a;\r\n    return a;\r\n  }\r\n  const ux = (x1p - cxp) / rxAbs, uy = (y1p - cyp) / ryAbs;\r\n  const vx = (-x1p - cxp) / rxAbs, vy = (-y1p - cyp) / ryAbs;\r\n  let startAng = angleBetween(1, 0, ux, uy);\r\n  let deltaAng = angleBetween(ux, uy, vx, vy);\r\n  if (!sweepFlag && deltaAng > 0) deltaAng -= 2 * Math.PI;\r\n  else if (sweepFlag && deltaAng < 0) deltaAng += 2 * Math.PI;\r\n  // choose number of segments based on arc length and tolerance\r\n  const r = Math.max(rxAbs, ryAbs);\r\n  const estLen = Math.abs(deltaAng) * r;\r\n  const segCount = Math.max(4, Math.ceil(estLen / Math.max(1, tolerance * 4)));\r\n  const pts: number[][] = [];\r\n  for (let i = 0; i <= segCount; i++) {\r\n    const t = i / segCount;\r\n    const ang = startAng + t * deltaAng;\r\n    const cosAng = Math.cos(ang), sinAng = Math.sin(ang);\r\n    const xp = rxAbs * cosAng;\r\n    const yp = ryAbs * sinAng;\r\n    const x = cosA * xp - sinA * yp + cx;\r\n    const y = sinA * xp + cosA * yp + cy;\r\n    pts.push([x, y]);\r\n  }\r\n  return pts;\r\n}\r\n\r\nexport function svgToPolylines(svgString: string, options: SvgToPolylinesOptions = {}): SvgPolylinesResult {\r\n  const tolerance = typeof options.tolerance === 'number' ? options.tolerance : 0.1;\r\n  // Attempt cache lookup\r\n  try {\r\n    const key = options && options.assetId ? `${options.assetId}::${tolerance}` : hashStringToKey(svgString + '::' + tolerance);\r\n    const entry = SVG_POLY_CACHE.get(key);\r\n    if (entry) {\r\n      // check age\r\n      if (Date.now() - entry.ts < CACHE_MAX_AGE_MS) {\r\n        // move to back (most recent)\r\n        SVG_POLY_CACHE.delete(key);\r\n        SVG_POLY_CACHE.set(key, entry);\r\n        CACHE_HITS++;\r\n        return entry.value;\r\n      }\r\n      // expired\r\n      SVG_POLY_CACHE.delete(key);\r\n      CACHE_MISSES++;\r\n    } else {\r\n      CACHE_MISSES++;\r\n    }\r\n  } catch (e) {}\r\n  // Use global DOMParser when available\r\n  const DP = (globalThis as any).DOMParser;\r\n  if (!DP) {\r\n    // In very restricted envs, attempt to fallback with a minimal regex-based extraction\r\n    // but prefer envs with DOMParser (jsdom in tests)\r\n    throw new Error('DOMParser not available in this environment');\r\n  }\r\n  const parser = new DP();\r\n  const doc = parser.parseFromString(svgString, 'image/svg+xml');\r\n  const svgEl = doc.querySelector('svg') || doc.documentElement;\r\n  const vb = parseViewBox(svgEl as any);\r\n\r\n  const contours: number[][][] = [];\r\n\r\n  // Helper to push normalized contour (and simplify)\r\n  function pushContour(raw: number[][]) {\r\n    if (!raw || raw.length === 0) return;\r\n    // close if not closed\r\n    const first = raw[0];\r\n    const last = raw[raw.length - 1];\r\n    if (first[0] !== last[0] || first[1] !== last[1]) {\r\n      // do not force duplicate closing point; many consumers expect open polygons\r\n    }\r\n    const norm = applyViewBoxNormalization(raw, vb);\r\n    // simplify\r\n    const simp = polygonSimplify(norm as any, tolerance as number) as number[][];\r\n    if (simp && simp.length >= 2) contours.push(simp);\r\n  }\r\n\r\n  // polygon / polyline\r\n  const polys = Array.from(doc.querySelectorAll('polygon, polyline')) as Element[];\r\n  for (const el of polys) {\r\n    const ptsAttr = (el as Element).getAttribute('points') || '';\r\n    const pts = parsePointsAttr(ptsAttr);\r\n    try {\r\n      const mtx = computeCumulativeTransform(el, svgEl as Element);\r\n      if (!isIdentityMatrix(mtx) && pts.length) applyMatrixToPoints(mtx, pts);\r\n    } catch (e) {}\r\n    pushContour(pts);\r\n  }\r\n\r\n  // rect\r\n  const rects = Array.from(doc.querySelectorAll('rect')) as Element[];\r\n  for (const r of rects) {\r\n    const x = parseFloat((r as Element).getAttribute('x') || '0');\r\n    const y = parseFloat((r as Element).getAttribute('y') || '0');\r\n    const w = parseFloat((r as Element).getAttribute('width') || '0');\r\n    const h = parseFloat((r as Element).getAttribute('height') || '0');\r\n    const pts = [[x, y], [x + w, y], [x + w, y + h], [x, y + h]];\r\n    try {\r\n      const mtx = computeCumulativeTransform(r, svgEl as Element);\r\n      if (!isIdentityMatrix(mtx)) applyMatrixToPoints(mtx, pts);\r\n    } catch (e) {}\r\n    pushContour(pts);\r\n  }\r\n\r\n  // circle\r\n  const circles = Array.from(doc.querySelectorAll('circle')) as Element[];\r\n  for (const c of circles) {\r\n    const cx = parseFloat((c as Element).getAttribute('cx') || '0');\r\n    const cy = parseFloat((c as Element).getAttribute('cy') || '0');\r\n    const r = parseFloat((c as Element).getAttribute('r') || '0');\r\n    if (r > 0) {\r\n      const pts = sampleCircle(cx, cy, r, 24);\r\n      try {\r\n        const mtx = computeCumulativeTransform(c, svgEl as Element);\r\n        if (!isIdentityMatrix(mtx)) applyMatrixToPoints(mtx, pts);\r\n      } catch (ex) {}\r\n      pushContour(pts);\r\n    }\r\n  }\r\n\r\n  // ellipse\r\n  const ellipses = Array.from(doc.querySelectorAll('ellipse')) as Element[];\r\n  for (const e of ellipses) {\r\n    const cx = parseFloat((e as Element).getAttribute('cx') || '0');\r\n    const cy = parseFloat((e as Element).getAttribute('cy') || '0');\r\n    const rx = parseFloat((e as Element).getAttribute('rx') || '0');\r\n    const ry = parseFloat((e as Element).getAttribute('ry') || '0');\r\n    if (rx > 0 && ry > 0) {\r\n      const pts: number[][] = [];\r\n      const segs = 48;\r\n      for (let i = 0; i < segs; i++) {\r\n        const a = (i / segs) * Math.PI * 2;\r\n        pts.push([cx + Math.cos(a) * rx, cy + Math.sin(a) * ry]);\r\n      }\r\n      try {\r\n        const mtx = computeCumulativeTransform(e, svgEl as Element);\r\n        if (!isIdentityMatrix(mtx)) applyMatrixToPoints(mtx, pts);\r\n      } catch (ex) {}\r\n      pushContour(pts);\r\n    }\r\n  }\r\n\r\n  // simple path parser (no curves)\r\n  const paths = Array.from(doc.querySelectorAll('path')) as Element[];\r\n  for (const p of paths) {\r\n    const d = (p as Element).getAttribute('d') || '';\r\n    if (!d.trim()) continue;\r\n    try {\r\n      const pts = parsePathCommands(d, tolerance);\r\n      try {\r\n        const mtx = computeCumulativeTransform(p, svgEl as Element);\r\n        if (!isIdentityMatrix(mtx) && pts.length) applyMatrixToPoints(mtx, pts);\r\n      } catch (ex) {}\r\n      pushContour(pts);\r\n    } catch (e) {\r\n      // ignore complex paths\r\n    }\r\n  }\r\n\r\n  // Compute bbox in normalized units\r\n  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n  for (const c of contours) {\r\n    for (const [x, y] of c) {\r\n      if (x < minX) minX = x;\r\n      if (y < minY) minY = y;\r\n      if (x > maxX) maxX = x;\r\n      if (y > maxY) maxY = y;\r\n    }\r\n  }\r\n  if (minX === Infinity) {\r\n    minX = 0; minY = 0; maxX = 0; maxY = 0;\r\n  }\r\n\r\n  const result = { contours, bbox: { minX, minY, maxX, maxY } } as SvgPolylinesResult;\r\n  // store in cache\r\n  try {\r\n    const key = options && options.assetId ? `${options.assetId}::${tolerance}` : hashStringToKey(svgString + '::' + tolerance);\r\n    SVG_POLY_CACHE.set(key, { ts: Date.now(), value: result });\r\n    // evict if over capacity (simple FIFO)\r\n    while (SVG_POLY_CACHE.size > CACHE_MAX_ENTRIES) {\r\n      const firstKey = SVG_POLY_CACHE.keys().next().value;\r\n      if (!firstKey) break;\r\n      SVG_POLY_CACHE.delete(firstKey);\r\n    }\r\n  } catch (e) {}\r\n\r\n  return result;\r\n}\r\n\r\n// Note: this is intentionally a small, dependency-free implementation that\r\n// covers the common SVG constructs we use in assets. For full support (cubic\r\n// Beziers, arcs), replace the path parser/flattening with a robust library.\r\n", "import { svgToPolylines, SvgPolylinesResult } from \"./svgToPolylines\";\r\n\r\nlet _svgHashes: Record<string, string> | null = null;\r\nfunction loadSvgHashes() {\r\n  if (_svgHashes !== null) return _svgHashes;\r\n  // In a browser environment, direct file system access is not possible.\r\n  // If svg hashes are needed, they should be pre-loaded or fetched.\r\n  // For now, return an empty object to prevent build errors.\r\n  _svgHashes = {};\r\n  return _svgHashes;\r\n}\r\n\r\n// Utility: extract hull outline polylines from SVG for shield/collision\r\n// Accepts optional `assetFilename` parameter so callers can supply the source filename\r\n// (used to form an `assetId` that keys the svgToPolylines cache). Backwards compatible\r\n// call: `getHullOutlineFromSvg(svgText, tolerance)` still works.\r\nexport function getHullOutlineFromSvg(\r\n  svgText: string,\r\n  tolerance: number = 1.5,\r\n  assetFilename?: string,\r\n): SvgPolylinesResult {\r\n  // Optionally strip non-hull elements for cleaner outline\r\n  const hullSvg = stripHullOnly(svgText);\r\n  try {\r\n    let assetId: string | undefined = undefined;\r\n    if (assetFilename) {\r\n      try {\r\n        assetId = assetFilename; // Simplified for browser environment\r\n      } catch (e) {\r\n        assetId = assetFilename;\r\n      }\r\n    }\r\n    return svgToPolylines(\r\n      hullSvg,\r\n      assetId ? { tolerance, assetId } : { tolerance },\r\n    );\r\n  } catch (e) {\r\n    // fallback to best-effort parsing\r\n    return svgToPolylines(hullSvg, { tolerance });\r\n  }\r\n}\r\n/* eslint-disable */\r\n// Clean authoritative svgLoader implementation (single export)\r\n\r\nexport function parseSvgForMounts(svgText: string) {\r\n  try {\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(svgText, \"image/svg+xml\");\r\n    const svg = doc.querySelector(\"svg\");\r\n    if (!svg)\r\n      return { mounts: [], engineMounts: [], viewBox: null, colorRegions: [] };\r\n    const vbAttr = svg.getAttribute(\"viewBox\");\r\n    let viewBox: { w: number; h: number } | null = null;\r\n    if (vbAttr) {\r\n      // viewBox syntax: minX minY width height\r\n      const parts = vbAttr\r\n        .trim()\r\n        .split(/[\\s,]+/)\r\n        .map((s) => parseFloat(s));\r\n      if (parts.length >= 4 && !isNaN(parts[2]) && !isNaN(parts[3])) {\r\n        viewBox = { w: parts[2], h: parts[3] };\r\n      }\r\n    }\r\n    const toNumber = (v: string | null) => {\r\n      const n = v == null ? NaN : parseFloat(v);\r\n      return isNaN(n) ? null : n;\r\n    };\r\n\r\n    // Mounts: data-mount or class 'turret'\r\n    const mountEls = Array.from(\r\n      svg.querySelectorAll(\"[data-mount], .turret\"),\r\n    ) as Element[];\r\n    const mounts = mountEls.map((el) => {\r\n      const slot =\r\n        el.getAttribute(\"data-mount\") ||\r\n        (el.classList && (el.classList.contains(\"turret\") ? \"turret\" : null));\r\n      // center calculation for rects: x + width/2, y + height/2. For circles/ellipses use cx/cy.\r\n      const xAttr = el.getAttribute(\"cx\") || el.getAttribute(\"x\");\r\n      const yAttr = el.getAttribute(\"cy\") || el.getAttribute(\"y\");\r\n      let x = toNumber(xAttr);\r\n      let y = toNumber(yAttr);\r\n      if (\r\n        (x == null || y == null) &&\r\n        el.getAttribute(\"width\") &&\r\n        el.getAttribute(\"height\")\r\n      ) {\r\n        const rx = toNumber(el.getAttribute(\"x\"));\r\n        const ry = toNumber(el.getAttribute(\"y\"));\r\n        const rw = toNumber(el.getAttribute(\"width\"));\r\n        const rh = toNumber(el.getAttribute(\"height\"));\r\n        if (rx != null && rw != null) x = rx + rw / 2;\r\n        if (ry != null && rh != null) y = ry + rh / 2;\r\n      }\r\n      return { x, y, slot };\r\n    });\r\n\r\n    // Engine mounts: data-engine-mount or class 'engine'\r\n    const engineEls = Array.from(\r\n      svg.querySelectorAll(\"[data-engine-mount], .engine\"),\r\n    ) as Element[];\r\n    const engineMounts = engineEls.map((el) => {\r\n      const slot =\r\n        el.getAttribute(\"data-engine-mount\") ||\r\n        (el.classList && (el.classList.contains(\"engine\") ? \"engine\" : null));\r\n      const xAttr = el.getAttribute(\"cx\") || el.getAttribute(\"x\");\r\n      const yAttr = el.getAttribute(\"cy\") || el.getAttribute(\"y\");\r\n      let x = toNumber(xAttr);\r\n      let y = toNumber(yAttr);\r\n      if (\r\n        (x == null || y == null) &&\r\n        el.getAttribute(\"width\") &&\r\n        el.getAttribute(\"height\")\r\n      ) {\r\n        const rx = toNumber(el.getAttribute(\"x\"));\r\n        const ry = toNumber(el.getAttribute(\"y\"));\r\n        const rw = toNumber(el.getAttribute(\"width\"));\r\n        const rh = toNumber(el.getAttribute(\"height\"));\r\n        if (rx != null && rw != null) x = rx + rw / 2;\r\n        if (ry != null && rh != null) y = ry + rh / 2;\r\n      }\r\n      return { x, y, slot };\r\n    });\r\n    const colorRegions = Array.from(\r\n      svg.querySelectorAll(\r\n        '[data-team],[data-team-slot],[class*=\"team-fill-\"]',\r\n      ),\r\n    ).map((el) => ({\r\n      tag: el.tagName,\r\n      id: (el as Element).id || null,\r\n      role:\r\n        el.getAttribute(\"data-team\") ||\r\n        el.getAttribute(\"data-team-slot\") ||\r\n        null,\r\n    }));\r\n    return { mounts, engineMounts, viewBox, colorRegions };\r\n  } catch (e) {\r\n    return { mounts: [], engineMounts: [], viewBox: null, colorRegions: [] };\r\n  }\r\n}\r\n\r\nexport function applyTeamColorsToSvg(\r\n  svgText: string,\r\n  mapping: Record<string, string>,\r\n  options?: { applyTo?: \"fill\" | \"stroke\" | \"both\" },\r\n): string {\r\n  try {\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(svgText, \"image/svg+xml\");\r\n    const svg = doc.querySelector(\"svg\");\r\n    if (!svg) return svgText;\r\n    const applyDefault = options && options.applyTo ? options.applyTo : \"both\";\r\n    const els = Array.from(\r\n      svg.querySelectorAll(\r\n        '[data-team],[data-team-slot],[data-team-slot-fill],[data-team-slot-stroke],[class*=\"team-fill-\"]',\r\n      ),\r\n    ) as Element[];\r\n    for (const el of els) {\r\n      try {\r\n        const role = (\r\n          el.getAttribute(\"data-team\") ||\r\n          el.getAttribute(\"data-team-slot\") ||\r\n          \"\"\r\n        ).trim();\r\n        const fillRoleAttr = (\r\n          el.getAttribute(\"data-team-slot-fill\") || \"\"\r\n        ).trim();\r\n        const strokeRoleAttr = (\r\n          el.getAttribute(\"data-team-slot-stroke\") || \"\"\r\n        ).trim();\r\n        const cls = el.getAttribute(\"class\") || \"\";\r\n        let classRole: string | undefined;\r\n        try {\r\n          const m = cls.match(/team-fill-([a-z0-9_-]+)/i);\r\n          if (m) classRole = m[1];\r\n        } catch (e) {\r\n          classRole = undefined;\r\n        }\r\n        const resolvedFillRole = fillRoleAttr || role || classRole || \"primary\";\r\n        const resolvedStrokeRole =\r\n          strokeRoleAttr || role || classRole || \"trim\";\r\n        const fillColor = mapping[resolvedFillRole];\r\n        const strokeColor = mapping[resolvedStrokeRole] || fillColor;\r\n        if (!fillColor && !strokeColor) continue;\r\n        const applyAttr = (el.getAttribute(\"data-team-apply\") || \"\")\r\n          .trim()\r\n          .toLowerCase();\r\n        const apply =\r\n          applyAttr === \"fill\" || applyAttr === \"stroke\"\r\n            ? (applyAttr as \"fill\" | \"stroke\")\r\n            : applyDefault;\r\n        const setStyleProp = (prop: \"fill\" | \"stroke\", value: string) => {\r\n          try {\r\n            el.setAttribute(prop, value);\r\n            const cur = el.getAttribute(\"style\") || \"\";\r\n            const re = new RegExp(\"(^|;)\\\\s*\" + prop + \"\\\\s*:\\\\s*[^;]+\", \"i\");\r\n            if (re.test(cur)) {\r\n              const replaced = cur.replace(re, `$1 ${prop}: ${value}`);\r\n              el.setAttribute(\"style\", replaced);\r\n            } else {\r\n              const next = cur\r\n                ? cur + `; ${prop}: ${value}`\r\n                : `${prop}: ${value}`;\r\n              el.setAttribute(\"style\", next);\r\n            }\r\n          } catch (e) {}\r\n        };\r\n        if ((apply === \"fill\" || apply === \"both\") && fillColor)\r\n          setStyleProp(\"fill\", fillColor);\r\n        if ((apply === \"stroke\" || apply === \"both\") && strokeColor)\r\n          setStyleProp(\"stroke\", strokeColor);\r\n      } catch (e) {\r\n        continue;\r\n      }\r\n    }\r\n    return new XMLSerializer().serializeToString(svg);\r\n  } catch (e) {\r\n    return svgText;\r\n  }\r\n}\r\n\r\nfunction encodeSvgDataUrl(svgText: string) {\r\n  try {\r\n    return \"data:image/svg+xml;utf8,\" + encodeURIComponent(svgText);\r\n  } catch (e) {\r\n    return \"data:image/svg+xml;utf8,\" + svgText;\r\n  }\r\n}\r\n\r\nasync function tryLoadUrlToCanvas(\r\n  url: string,\r\n  outW: number,\r\n  outH: number,\r\n): Promise<HTMLCanvasElement | undefined> {\r\n  return new Promise((resolve) => {\r\n    let settled = false;\r\n    const to = setTimeout(() => {\r\n      if (!settled) {\r\n        settled = true;\r\n        resolve(undefined);\r\n      }\r\n    }, 500);\r\n    const safeResolve = (v?: HTMLCanvasElement | undefined) => {\r\n      if (!settled) {\r\n        settled = true;\r\n        try {\r\n          clearTimeout(to);\r\n        } catch (e) {}\r\n        resolve(v);\r\n      }\r\n    };\r\n    try {\r\n      const img = new Image();\r\n      img.onload = () => {\r\n        try {\r\n          const c = document.createElement(\"canvas\");\r\n          c.width = outW;\r\n          c.height = outH;\r\n          const ctx = c.getContext(\"2d\");\r\n          if (!ctx) return safeResolve(undefined);\r\n          ctx.clearRect(0, 0, outW, outH);\r\n          ctx.drawImage(img, 0, 0, outW, outH);\r\n          safeResolve(c);\r\n        } catch (e) {\r\n          safeResolve(undefined);\r\n        }\r\n      };\r\n      img.onerror = () => safeResolve(undefined);\r\n      img.src = url;\r\n    } catch (e) {\r\n      safeResolve(undefined);\r\n    }\r\n  });\r\n}\r\n\r\nfunction canvasHasOpaquePixels(\r\n  c: HTMLCanvasElement,\r\n  thresholdAlpha = 8,\r\n): boolean {\r\n  try {\r\n    const ctx = c.getContext(\"2d\");\r\n    if (!ctx) return false;\r\n    const w = Math.max(1, Math.min(16, c.width));\r\n    const h = Math.max(1, Math.min(16, c.height));\r\n    const data = ctx.getImageData(0, 0, w, h).data;\r\n    for (let i = 3; i < data.length; i += 4)\r\n      if (data[i] > thresholdAlpha) return true;\r\n  } catch (e) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport async function rasterizeSvgToCanvasAsync(\r\n  svgText: string,\r\n  outW: number,\r\n  outH: number,\r\n): Promise<HTMLCanvasElement> {\r\n  const dataUrl = encodeSvgDataUrl(svgText);\r\n  let canvas = await tryLoadUrlToCanvas(dataUrl, outW, outH);\r\n  if (canvas && canvasHasOpaquePixels(canvas)) return canvas;\r\n  try {\r\n    const blob = new Blob([svgText], { type: \"image/svg+xml\" });\r\n    const url = URL.createObjectURL(blob);\r\n    try {\r\n      const c2 = await tryLoadUrlToCanvas(url, outW, outH);\r\n      if (c2 && canvasHasOpaquePixels(c2)) return c2;\r\n      if (c2) return c2;\r\n    } finally {\r\n      URL.revokeObjectURL(url);\r\n    }\r\n  } catch (e) {}\r\n  if (canvas) return canvas;\r\n  throw new Error(\"Failed to rasterize SVG to canvas\");\r\n}\r\n\r\nexport function rasterizeSvgToCanvas(\r\n  svgText: string,\r\n  outW: number,\r\n  outH: number,\r\n): HTMLCanvasElement | undefined {\r\n  try {\r\n    const dataUrl = encodeSvgDataUrl(svgText);\r\n    const img = new Image();\r\n    img.src = dataUrl;\r\n    if (!img.complete) return undefined;\r\n    const c = document.createElement(\"canvas\");\r\n    c.width = outW;\r\n    c.height = outH;\r\n    const ctx = c.getContext(\"2d\");\r\n    if (!ctx) return undefined;\r\n    ctx.drawImage(img, 0, 0, outW, outH);\r\n    return c;\r\n  } catch (e) {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction stripHullOnly(svgText: string) {\r\n  try {\r\n    const parser = new DOMParser();\r\n    const doc = parser.parseFromString(svgText, \"image/svg+xml\");\r\n    const svg = doc.querySelector(\"svg\");\r\n    if (!svg) return svgText;\r\n    const rects = Array.from(svg.querySelectorAll(\"rect\")) as Element[];\r\n    for (const r of rects) {\r\n      try {\r\n        const cls = (r.getAttribute(\"class\") || \"\").toLowerCase();\r\n        if (cls.includes(\"backdrop\") || cls.includes(\"bg\")) r.remove();\r\n        const w = parseFloat(r.getAttribute(\"width\") || \"0\");\r\n        const h = parseFloat(r.getAttribute(\"height\") || \"0\");\r\n        if (!isNaN(w) && !isNaN(h) && (w > 1000 || h > 1000)) r.remove();\r\n      } catch (e) {}\r\n    }\r\n    // Remove turret (and weapon) artwork which is rendered separately by the\r\n    // renderer (turrets are handled as independent sprites). Be conservative\r\n    // and remove elements explicitly marked as turret/weapon by attribute or\r\n    // class. Mount extraction runs before stripHullOnly during preload so\r\n    // removing these elements here won't prevent mount detection earlier.\r\n    const turretSelectors = '[data-turret], .turret, [data-weapon], .weapon, [data-turret-slot], [data-weapon-slot]';\r\n    const turrets = Array.from(svg.querySelectorAll(turretSelectors)) as Element[];\r\n    for (const t of turrets) {\r\n      try {\r\n        t.remove();\r\n      } catch (e) {}\r\n    }\r\n    return new XMLSerializer().serializeToString(svg);\r\n  } catch (e) {\r\n    return svgText;\r\n  }\r\n}\r\n\r\nexport async function rasterizeHullOnlySvgToCanvasAsync(\r\n  svgText: string,\r\n  outW: number,\r\n  outH: number,\r\n) {\r\n  const hull = stripHullOnly(svgText);\r\n  return await rasterizeSvgToCanvasAsync(hull, outW, outH);\r\n}\r\n\r\n// Backwards-compatible sync wrapper: best-effort synchronous rasterization for callers that expect it.\r\nexport function rasterizeHullOnlySvgToCanvas(\r\n  svgText: string,\r\n  outW: number,\r\n  outH: number,\r\n): HTMLCanvasElement {\r\n  try {\r\n    // Try to use renderer cached canvas first\r\n    const c = getCachedHullCanvasSync(svgText, outW, outH);\r\n    if (c) return c;\r\n    // Try synchronous rasterize path\r\n    const hull = stripHullOnly(svgText);\r\n    const rc = rasterizeSvgToCanvas(hull, outW, outH);\r\n    if (rc) return rc;\r\n  } catch (e) {}\r\n  // Fallback: return an empty transparent canvas to preserve caller expectations\r\n  const empty = document.createElement(\"canvas\");\r\n  empty.width = outW;\r\n  empty.height = outH;\r\n  return empty;\r\n}\r\n\r\nexport function getCachedHullCanvasSync(\r\n  svgText: string,\r\n  outW: number,\r\n  outH: number,\r\n  assetKey?: string,\r\n): HTMLCanvasElement | undefined {\r\n  try {\r\n    // Prefer require (synchronous) so this function stays sync and Vitest mocks are visible\r\n    // Try multiple candidate module specifiers to match how tests may mock the module\r\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n    let svgRenderer: any = undefined;\r\n    const candidates = [\r\n      \"./svgRenderer\",\r\n      \"../assets/svgRenderer\",\r\n      \"../../src/assets/svgRenderer\",\r\n      \"src/assets/svgRenderer\",\r\n    ];\r\n    for (const cpath of candidates) {\r\n      try {\r\n        svgRenderer = (\r\n          typeof require === \"function\"\r\n            ? (function () {\r\n                try {\r\n                  return require(cpath);\r\n                } catch (e) {\r\n                  return undefined;\r\n                }\r\n              })()\r\n            : undefined\r\n        ) as any;\r\n        if (svgRenderer) break;\r\n      } catch (e) {\r\n        svgRenderer = svgRenderer || undefined;\r\n      }\r\n    }\r\n    const getCanvasFn =\r\n      (svgRenderer && svgRenderer.getCanvas) ||\r\n      (svgRenderer && svgRenderer.default && svgRenderer.default.getCanvas);\r\n    // If require-based resolution failed to find a shared svgRenderer instance,\r\n    // try the global shared helper exposed by src/assets/svgRenderer.ts so that\r\n    // different module instances (bundled vs. runtime) can share the same cache.\r\n    try {\r\n      if (!getCanvasFn && typeof globalThis !== 'undefined') {\r\n        const g = (globalThis as any).__SpaceAutoBattler_svgRenderer;\r\n        if (g && typeof g.getCanvas === 'function') {\r\n          try {\r\n            const c = g.getCanvas(assetKey || '', {}, outW, outH);\r\n            try {\r\n              if (c && typeof (globalThis as any).window !== 'undefined' && (globalThis as any).window.__SAB_DEBUG_SVG) {\r\n                // eslint-disable-next-line no-console\r\n                console.debug('[svgLoader] global bridge provided canvas', { assetKey, outW, outH });\r\n              }\r\n            } catch (e) {}\r\n            if (c) return c as HTMLCanvasElement;\r\n          } catch (e) {}\r\n        }\r\n      }\r\n    } catch (e) {}\r\n    if (getCanvasFn && typeof getCanvasFn === \"function\") {\r\n      try {\r\n        const c = getCanvasFn(assetKey || \"\", {}, outW, outH);\r\n        if (c) return c as HTMLCanvasElement;\r\n      } catch (e) {}\r\n    }\r\n  } catch (e) {}\r\n  try {\r\n    const hull = stripHullOnly(svgText);\r\n    try {\r\n      const rc = rasterizeSvgToCanvas(hull, outW, outH) as\r\n        | HTMLCanvasElement\r\n        | undefined;\r\n      if (rc) return rc;\r\n    } catch (e) {}\r\n    // Synchronous rasterization may not be available in headless test envs.\r\n    // Return an empty placeholder canvas sized to the requested output so callers\r\n    // that expect a synchronous canvas receive a usable element.\r\n    const ph = document.createElement(\"canvas\");\r\n    ph.width = outW;\r\n    ph.height = outH;\r\n    return ph;\r\n  } catch (e) {\r\n    return undefined;\r\n  }\r\n  return undefined; // Ensure a return value in all cases\r\n}\r\n\r\nexport async function ensureRasterizedAndCached(\r\n  svgText: string,\r\n  mapping: Record<string, string>,\r\n  outW: number,\r\n  outH: number,\r\n  options?: { applyTo?: \"fill\" | \"stroke\" | \"both\"; assetKey?: string },\r\n): Promise<HTMLCanvasElement> {\r\n  const assetKey = options?.assetKey;\r\n  try {\r\n    // Check cache first\r\n    const cached = getCachedHullCanvasSync(svgText, outW, outH, assetKey);\r\n    if (cached) return cached;\r\n  } catch (e) {}\r\n  try {\r\n    // Ensure rasterization\r\n    const blob = new Blob([svgText], { type: \"image/svg+xml\" });\r\n    const url = URL.createObjectURL(blob);\r\n    try {\r\n      const c2 = await tryLoadUrlToCanvas(url, outW, outH);\r\n      if (c2) return c2;\r\n    } finally {\r\n      URL.revokeObjectURL(url);\r\n    }\r\n  } catch (e) {}\r\n  throw new Error(\"Failed to ensure rasterized canvas\");\r\n}\r\n", "import { applyTeamColorsToSvg, rasterizeSvgToCanvasAsync } from './svgLoader';\r\n\r\n// Simple stable stringify for objects (sort keys) to generate deterministic mapping key\r\nfunction stableStringify(obj: any): string {\r\n  if (obj === null || typeof obj !== 'object') return JSON.stringify(obj);\r\n  if (Array.isArray(obj)) return '[' + obj.map(stableStringify).join(',') + ']';\r\n  const keys = Object.keys(obj).sort();\r\n  return '{' + keys.map(k => JSON.stringify(k) + ':' + stableStringify(obj[k])).join(',') + '}';\r\n}\r\n\r\n// Simple djb2 hash to produce a compact hex string from input\r\nfunction djb2Hash(str: string): string {\r\n  let h = 5381;\r\n  for (let i = 0; i < str.length; i++) { h = ((h << 5) + h) + str.charCodeAt(i); h = h & 0xffffffff; }\r\n  // convert to unsigned and hex\r\n  return (h >>> 0).toString(16);\r\n}\r\n\r\n// Cache of in-flight and completed rasterizations. Keyed by computed cacheKey.\r\n// Each entry stores metadata so we can expose a synchronous getter and TTL info.\r\ntype CacheEntry = {\r\n  promise: Promise<HTMLCanvasElement> | null;\r\n  canvas?: HTMLCanvasElement;\r\n  createdAt: number;\r\n  lastAccess: number;\r\n};\r\nconst rasterCache: Map<string, CacheEntry> = new Map();\r\nlet rasterCacheMaxEntries = 256;\r\nlet rasterCacheMaxAgeMS = 0; // 0 means disabled\r\n\r\nfunction ensureCacheLimit() {\r\n  try {\r\n    const now = Date.now();\r\n    // Evict by TTL first\r\n    if (rasterCacheMaxAgeMS > 0) {\r\n      for (const [k, v] of Array.from(rasterCache.entries())) {\r\n        if (now - v.lastAccess > rasterCacheMaxAgeMS || now - v.createdAt > rasterCacheMaxAgeMS) {\r\n          rasterCache.delete(k);\r\n        }\r\n      }\r\n    }\r\n    // Then evict oldest entries until under limit\r\n    while (rasterCache.size > rasterCacheMaxEntries) {\r\n      const it = rasterCache.keys().next();\r\n      if (it.done) break;\r\n      rasterCache.delete(it.value);\r\n    }\r\n  } catch (e) {}\r\n}\r\n\r\n/**\r\n * Rasterize an SVG with team colors applied.\r\n * svgText: original svg source\r\n * mapping: { role: color }\r\n * outW,outH: output canvas size\r\n * options: { applyTo?: 'fill'|'stroke'|'both', assetKey?: string }\r\n * If options.assetKey is provided, it is used as the stable asset identifier in the cache key.\r\n */\r\nexport async function rasterizeSvgWithTeamColors(svgText: string, mapping: Record<string, string>, outW: number, outH: number, options?: { applyTo?: 'fill' | 'stroke' | 'both', assetKey?: string }): Promise<HTMLCanvasElement> {\r\n  // Fast-path for headless/test environments: if a 2D canvas context is\r\n  // not available, return a blank canvas immediately. This avoids waiting\r\n  // on image onload handlers that may never fire in environments like\r\n  // happy-dom or partial DOM shims used in tests.\r\n  // Detect headless/partial DOM where 2D context is unavailable. Don't return early;\r\n  // instead handle via cacheKey below so repeated calls with same key return the same placeholder.\r\n  let headlessNoCtx = false;\r\n  try {\r\n    if (typeof document !== 'undefined' && typeof document.createElement === 'function') {\r\n      const probe = document.createElement('canvas');\r\n      const ctx = (probe.getContext && probe.getContext('2d')) as CanvasRenderingContext2D | null;\r\n      if (!ctx) headlessNoCtx = true;\r\n    }\r\n  } catch (e) { headlessNoCtx = true; }\r\n  // compute mapping hash and asset identifier\r\n  const mappingStable = stableStringify(mapping || {});\r\n  const mappingHash = djb2Hash(mappingStable);\r\n  const assetId = options && options.assetKey ? options.assetKey : djb2Hash(stableStringify(svgText || ''));\r\n  const cacheKey = `${assetId}:${mappingHash}:${outW}x${outH}`;\r\n\r\n  if (rasterCache.has(cacheKey)) {\r\n    const entry = rasterCache.get(cacheKey)!;\r\n    // update lastAccess and promote to MRU\r\n    try {\r\n      entry.lastAccess = Date.now();\r\n      rasterCache.delete(cacheKey);\r\n      rasterCache.set(cacheKey, entry);\r\n    } catch (e) {}\r\n    // If a resolved canvas is present, return it quickly\r\n    if (entry.canvas) return Promise.resolve(entry.canvas);\r\n    // otherwise return the in-flight promise\r\n    if (entry.promise) return entry.promise;\r\n  }\r\n\r\n  const entry: CacheEntry = {\r\n    promise: null,\r\n    canvas: undefined,\r\n    createdAt: Date.now(),\r\n    lastAccess: Date.now(),\r\n  };\r\n\r\n  const p = (async () => {\r\n    try {\r\n      // If caller passed a path/URL instead of inline SVG markup, try to fetch it\r\n      let sourceSvg = svgText || '';\r\n      try {\r\n        if (!/<svg[\\s>]/i.test(sourceSvg) && typeof fetch === 'function') {\r\n          try {\r\n            const resp = await fetch(sourceSvg);\r\n            if (resp && resp.ok) {\r\n              const txt = await resp.text();\r\n              if (txt && /<svg[\\s>]/i.test(txt)) sourceSvg = txt;\r\n            } else {\r\n              try {\r\n                const isProd = (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'production');\r\n                const isTest = (typeof process !== 'undefined' && process.env && (process.env.VITEST || process.env.VITEST_WORKER_ID)) || (typeof (globalThis as any).vitest !== 'undefined');\r\n                if (!isProd && !isTest) {\r\n                  // eslint-disable-next-line no-console\r\n                  console.warn(`[svgRenderer] fetch failed for SVG url '${sourceSvg}'. Status: ${resp && (resp as any).status}`);\r\n                }\r\n              } catch (e) {}\r\n            }\r\n          } catch (e) {\r\n            try {\r\n              const isProd = (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'production');\r\n              const isTest = (typeof process !== 'undefined' && process.env && (process.env.VITEST || process.env.VITEST_WORKER_ID)) || (typeof (globalThis as any).vitest !== 'undefined');\r\n              if (!isProd && !isTest) {\r\n                // eslint-disable-next-line no-console\r\n                console.warn(`[svgRenderer] fetch threw for '${sourceSvg}', continuing with original string`, e);\r\n              }\r\n            } catch (ee) {}\r\n            // ignore fetch errors and continue with original string\r\n          }\r\n        }\r\n      } catch (e) {}\r\n\r\n      const recolored = applyTeamColorsToSvg(sourceSvg, mapping, options && { applyTo: options?.applyTo });\r\n      if (headlessNoCtx) {\r\n        // create a placeholder canvas and cache it so subsequent calls return same instance\r\n        const ph = ((): HTMLCanvasElement => {\r\n          try {\r\n            const c = document.createElement('canvas');\r\n            c.width = outW || 1; c.height = outH || 1; return c;\r\n          } catch (e) {\r\n            // as a last resort, create a minimal object that looks like a canvas\r\n            const obj: any = { width: outW || 1, height: outH || 1 }; return obj as unknown as HTMLCanvasElement;\r\n          }\r\n        })();\r\n        entry.canvas = ph;\r\n        entry.promise = Promise.resolve(ph);\r\n        entry.lastAccess = Date.now();\r\n        rasterCache.set(cacheKey, entry);\r\n        ensureCacheLimit();\r\n        return ph;\r\n      }\r\n      const canvas = await rasterizeSvgToCanvasAsync(recolored, outW, outH);\r\n      // store resolved canvas for synchronous reads\r\n      entry.canvas = canvas;\r\n      entry.promise = Promise.resolve(canvas);\r\n      entry.lastAccess = Date.now();\r\n      return canvas;\r\n    } catch (e) {\r\n      const canvas = await rasterizeSvgToCanvasAsync(svgText, outW, outH);\r\n      entry.canvas = canvas;\r\n      entry.promise = Promise.resolve(canvas);\r\n      entry.lastAccess = Date.now();\r\n      return canvas;\r\n    }\r\n  })();\r\n\r\n  entry.promise = p;\r\n  rasterCache.set(cacheKey, entry);\r\n  ensureCacheLimit();\r\n  try {\r\n    const res = await p;\r\n    return res;\r\n  } catch (e) {\r\n    // on error, remove from cache so future attempts can retry\r\n    rasterCache.delete(cacheKey);\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport function _clearRasterCache() {\r\n  rasterCache.clear();\r\n}\r\n\r\n/**\r\n * Store an already-rendered canvas into the raster cache for the given asset/mapping/size.\r\n * Useful for synchronous renderer code that produces canvases and wants them cached for later reuse.\r\n */\r\nexport function cacheCanvasForAsset(assetKey: string, mapping: Record<string, string>, outW: number, outH: number, canvas: HTMLCanvasElement) {\r\n  const mappingStable = stableStringify(mapping || {});\r\n  const mappingHash = djb2Hash(mappingStable);\r\n  const assetId = assetKey || djb2Hash(stableStringify(''));\r\n  const cacheKey = `${assetId}:${mappingHash}:${outW}x${outH}`;\r\n  // Insert and promote to MRU, storing metadata for sync reads\r\n  try {\r\n    if (rasterCache.has(cacheKey)) rasterCache.delete(cacheKey);\r\n  } catch (e) {}\r\n  const entry: CacheEntry = {\r\n    promise: Promise.resolve(canvas),\r\n    canvas,\r\n    createdAt: Date.now(),\r\n    lastAccess: Date.now(),\r\n  };\r\n  rasterCache.set(cacheKey, entry);\r\n  ensureCacheLimit();\r\n  try {\r\n    if (typeof (globalThis as any).window !== 'undefined' && (globalThis as any).window.__SAB_DEBUG_SVG) {\r\n      // eslint-disable-next-line no-console\r\n      console.debug('[svgRenderer] cacheCanvasForAsset set', { assetKey, mappingHash, outW, outH });\r\n    }\r\n  } catch (e) {}\r\n}\r\n\r\n// Test helper: return current cache keys in insertion order (oldest -> newest)\r\nexport function _getRasterCacheKeysForTest(): string[] {\r\n  return Array.from(rasterCache.keys());\r\n}\r\n\r\nexport function setRasterCacheMaxEntries(n: number) {\r\n  // Allow small sizes for tests; enforce at least 1 entry\r\n  rasterCacheMaxEntries = Math.max(1, Math.floor(n) || 256);\r\n  ensureCacheLimit();\r\n}\r\n\r\n/**\r\n * Set maximum age for cache entries in milliseconds. 0 disables TTL.\r\n */\r\nexport function setRasterCacheMaxAge(ms: number) {\r\n  rasterCacheMaxAgeMS = Math.max(0, Math.floor(ms) || 0);\r\n  ensureCacheLimit();\r\n}\r\n\r\n/**\r\n * Synchronous getter: return an already-resolved canvas for the given key if present.\r\n * This allows renderers to prefer cached canvases without awaiting a Promise.\r\n */\r\nexport function getCanvasFromCache(assetKey: string, mapping: Record<string, string>, outW: number, outH: number): HTMLCanvasElement | undefined {\r\n  const mappingStable = stableStringify(mapping || {});\r\n  const mappingHash = djb2Hash(mappingStable);\r\n  const assetId = assetKey || djb2Hash(stableStringify(''));\r\n  const cacheKey = `${assetId}:${mappingHash}:${outW}x${outH}`;\r\n  const entry = rasterCache.get(cacheKey);\r\n  try {\r\n    if (typeof (globalThis as any).window !== 'undefined' && (globalThis as any).window.__SAB_DEBUG_SVG) {\r\n      // eslint-disable-next-line no-console\r\n      console.debug('[svgRenderer] getCanvasFromCache lookup', { assetKey, mappingHash, outW, outH, present: !!entry });\r\n    }\r\n  } catch (e) {}\r\n  if (!entry) return undefined;\r\n  // Evict if expired\r\n  if (rasterCacheMaxAgeMS > 0) {\r\n    const now = Date.now();\r\n    if (now - entry.lastAccess > rasterCacheMaxAgeMS || now - entry.createdAt > rasterCacheMaxAgeMS) {\r\n      rasterCache.delete(cacheKey);\r\n      return undefined;\r\n    }\r\n  }\r\n  entry.lastAccess = Date.now();\r\n  // Promote to MRU\r\n  try {\r\n    rasterCache.delete(cacheKey);\r\n    rasterCache.set(cacheKey, entry);\r\n  } catch (e) {}\r\n  return entry.canvas;\r\n}\r\n\r\n// Named convenience export for clearer imports\r\nexport function getCanvas(assetKey: string, mapping: Record<string, string>, outW: number, outH: number) {\r\n  return getCanvasFromCache(assetKey, mapping, outW, outH);\r\n}\r\n\r\n// (previous default export removed to avoid duplicate exports)\r\n\r\n// Create a stable API object so bundlers can't easily tree-shake the bridge.\r\n// Export it as default and also attach it to globalThis under a known name\r\n// so different module instances can share the same raster cache at runtime.\r\nconst svgRendererAPI = {\r\n  rasterizeSvgWithTeamColors,\r\n  _clearRasterCache,\r\n  cacheCanvasForAsset,\r\n  setRasterCacheMaxEntries,\r\n  setRasterCacheMaxAge,\r\n  getCanvasFromCache,\r\n  getCanvas(assetKey: string, mapping: Record<string, string>, outW: number, outH: number) {\r\n    return getCanvasFromCache(assetKey, mapping, outW, outH);\r\n  },\r\n  /**\r\n   * Pre-warm a small set of assets into the raster cache. assetKeys are keys\r\n   * from AssetsConfig.svgAssets (or direct SVG/URL strings). teamColors is an\r\n   * array of color hex strings to generate tinted variants for. This helper\r\n   * kicks off async rasterization and awaits completion so subsequent\r\n   * synchronous getCanvas calls can find entries.\r\n   */\r\n  async prewarmAssets(assetKeys: string[], teamColors: string[] = [], outW = 128, outH = 128) {\r\n    try {\r\n      // Attempt to resolve AssetsConfig from globalThis if available\r\n      const assetsConfig = (typeof globalThis !== 'undefined' && (globalThis as any).AssetsConfig) ? (globalThis as any).AssetsConfig : undefined;\r\n      for (const key of assetKeys) {\r\n        try {\r\n          const rel = assetsConfig && assetsConfig.svgAssets && assetsConfig.svgAssets[key] ? assetsConfig.svgAssets[key] : key;\r\n          // Insert a placeholder canvas synchronously so getCanvasFromCache can\r\n          // return a usable element immediately. Then kick off async\r\n          // rasterization to replace the placeholder when ready.\r\n          try {\r\n            const ph = ((): HTMLCanvasElement => {\r\n              try {\r\n                const c = document.createElement('canvas');\r\n                c.width = outW || 1; c.height = outH || 1; return c;\r\n              } catch (e) {\r\n                const obj: any = { width: outW || 1, height: outH || 1 }; return obj as unknown as HTMLCanvasElement;\r\n              }\r\n            })();\r\n            try { cacheCanvasForAsset(key, {}, outW, outH, ph); } catch (e) {}\r\n          } catch (e) {}\r\n          // Kick off async rasterization to populate/replace the cache\r\n          (async () => {\r\n            try {\r\n              const canvas = await rasterizeSvgWithTeamColors(rel, {}, outW, outH, { applyTo: 'both', assetKey: key });\r\n              try { cacheCanvasForAsset(key, {}, outW, outH, canvas); } catch (e) {}\r\n            } catch (e) {}\r\n          })();\r\n          // Rasterize tinted variants for provided team colors (placeholder then async)\r\n          for (const col of teamColors || []) {\r\n            try {\r\n              const mapping = { primary: col, hull: col } as Record<string, string>;\r\n              try {\r\n                const ph2 = ((): HTMLCanvasElement => {\r\n                  try {\r\n                    const c = document.createElement('canvas');\r\n                    c.width = outW || 1; c.height = outH || 1; return c;\r\n                  } catch (e) {\r\n                    const obj: any = { width: outW || 1, height: outH || 1 }; return obj as unknown as HTMLCanvasElement;\r\n                  }\r\n                })();\r\n                try { cacheCanvasForAsset(key, mapping, outW, outH, ph2); } catch (e) {}\r\n              } catch (e) {}\r\n              (async () => {\r\n                try {\r\n                  const canvas = await rasterizeSvgWithTeamColors(rel, mapping, outW, outH, { applyTo: 'both', assetKey: key });\r\n                  try { cacheCanvasForAsset(key, mapping, outW, outH, canvas); } catch (e) {}\r\n                } catch (e) {}\r\n              })();\r\n            } catch (e) {}\r\n          }\r\n        } catch (e) {}\r\n      }\r\n    } catch (e) {}\r\n  }\r\n};\r\n\r\n// Attach to globalThis explicitly. Keep this small and obvious so it survives\r\n// bundling and executes at module eval time in the browser runtime.\r\ntry {\r\n  if (typeof globalThis !== 'undefined') {\r\n    (globalThis as any).__SpaceAutoBattler_svgRenderer = (globalThis as any).__SpaceAutoBattler_svgRenderer || {};\r\n    Object.assign((globalThis as any).__SpaceAutoBattler_svgRenderer, svgRendererAPI);\r\n  }\r\n} catch (e) {\r\n  // ignore failures (older environments)\r\n}\r\n\r\nexport default svgRendererAPI;\r\n", "import { AssetsConfig, getSpriteAsset } from \"../config/assets/assetsConfig\";\r\n\r\nfunction detectPipeline(type: string) {\r\n  const sprite = getSpriteAsset(type);\r\n  if (sprite.svg) return { pipeline: \"svg\", source: sprite.svg };\r\n  if (sprite.model3d && sprite.model3d.url)\r\n    return { pipeline: \"mesh3d\", source: sprite.model3d.url };\r\n  if (sprite.shape) return { pipeline: \"shape2d\", source: \"shapes2d\" };\r\n  return { pipeline: \"unknown\", source: \"-\" };\r\n}\r\n\r\nfunction createOverlay() {\r\n  if (typeof document === \"undefined\") return null;\r\n  const host = (location && location.hostname) || \"\";\r\n  const urlParams =\r\n    typeof URLSearchParams !== \"undefined\"\r\n      ? new URLSearchParams(location.search)\r\n      : null;\r\n  const enabled =\r\n    urlParams?.get(\"devShipTable\") === \"1\" ||\r\n    host === \"127.0.0.1\" ||\r\n    host === \"localhost\";\r\n  if (!enabled) return null;\r\n\r\n  const container = document.createElement(\"div\");\r\n  container.id = \"ship-pipeline-overlay\";\r\n  container.style.position = \"fixed\";\r\n  container.style.top = \"8px\";\r\n  container.style.right = \"8px\";\r\n  container.style.zIndex = \"99999\";\r\n  container.style.fontFamily = \"sans-serif\";\r\n  container.style.fontSize = \"12px\";\r\n  container.style.color = \"#fff\";\r\n\r\n  const badge = document.createElement(\"div\");\r\n  badge.id = \"ship-pipeline-badge\";\r\n  badge.style.background = \"rgba(20,20,30,0.9)\";\r\n  badge.style.padding = \"6px 10px\";\r\n  badge.style.borderRadius = \"6px\";\r\n  badge.style.cursor = \"pointer\";\r\n  badge.style.userSelect = \"none\";\r\n  badge.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.6)\";\r\n  badge.textContent = \"Pipelines\";\r\n  badge.setAttribute(\"role\", \"button\");\r\n  badge.tabIndex = 0;\r\n\r\n  const panel = document.createElement(\"div\");\r\n  panel.id = \"ship-pipeline-panel\";\r\n  panel.style.marginTop = \"8px\";\r\n  panel.style.background = \"rgba(8,10,16,0.95)\";\r\n  panel.style.border = \"1px solid rgba(255,255,255,0.06)\";\r\n  panel.style.padding = \"8px\";\r\n  panel.style.borderRadius = \"6px\";\r\n  panel.style.maxHeight = \"320px\";\r\n  panel.style.overflowY = \"auto\";\r\n  panel.style.minWidth = \"220px\";\r\n  panel.style.display = \"none\";\r\n\r\n  const table = document.createElement(\"table\");\r\n  table.style.width = \"100%\";\r\n  table.style.borderCollapse = \"collapse\";\r\n\r\n  const thead = document.createElement(\"thead\");\r\n  const headerRow = document.createElement(\"tr\");\r\n  [\"Ship\", \"Pipeline\", \"Source\"].forEach((h) => {\r\n    const th = document.createElement(\"th\");\r\n    th.textContent = h;\r\n    th.style.textAlign = \"left\";\r\n    th.style.padding = \"4px 6px\";\r\n    th.style.fontSize = \"11px\";\r\n    th.style.opacity = \"0.9\";\r\n    headerRow.appendChild(th);\r\n  });\r\n  thead.appendChild(headerRow);\r\n  table.appendChild(thead);\r\n\r\n  const tbody = document.createElement(\"tbody\");\r\n\r\n  const types = new Set<string>([\r\n    ...Object.keys(AssetsConfig.shapes2d || {}),\r\n    ...Object.keys((AssetsConfig as any).svgAssets || {}),\r\n  ]);\r\n  for (const t of Array.from(types).sort()) {\r\n    const res = detectPipeline(t as string);\r\n    const tr = document.createElement(\"tr\");\r\n    const nameTd = document.createElement(\"td\");\r\n    nameTd.textContent = t;\r\n    nameTd.style.padding = \"4px 6px\";\r\n    const pTd = document.createElement(\"td\");\r\n    pTd.textContent = res.pipeline;\r\n    pTd.style.padding = \"4px 6px\";\r\n    pTd.style.opacity = \"0.95\";\r\n    const sTd = document.createElement(\"td\");\r\n    sTd.textContent = String(res.source).replace(/^\\s+|\\s+$/g, \"\");\r\n    sTd.style.padding = \"4px 6px\";\r\n    sTd.style.opacity = \"0.8\";\r\n    tr.appendChild(nameTd);\r\n    tr.appendChild(pTd);\r\n    tr.appendChild(sTd);\r\n    tbody.appendChild(tr);\r\n  }\r\n\r\n  table.appendChild(tbody);\r\n  panel.appendChild(table);\r\n\r\n  let open = false;\r\n  function setOpen(v: boolean) {\r\n    open = !!v;\r\n    panel.style.display = open ? \"block\" : \"none\";\r\n    badge.style.background = open\r\n      ? \"rgba(60,60,70,0.95)\"\r\n      : \"rgba(20,20,30,0.9)\";\r\n    try {\r\n      localStorage.setItem(\"shipPipelineOpen\", open ? \"1\" : \"0\");\r\n    } catch (e) {}\r\n  }\r\n\r\n  badge.addEventListener(\"click\", () => setOpen(!open));\r\n  badge.addEventListener(\"keydown\", (ev) => {\r\n    if (\r\n      (ev as KeyboardEvent).key === \"Enter\" ||\r\n      (ev as KeyboardEvent).key === \" \"\r\n    ) {\r\n      ev.preventDefault();\r\n      setOpen(!open);\r\n    }\r\n  });\r\n\r\n  // restore state\r\n  try {\r\n    if (localStorage.getItem(\"shipPipelineOpen\") === \"1\") setOpen(true);\r\n  } catch (e) {}\r\n\r\n  container.appendChild(badge);\r\n  container.appendChild(panel);\r\n  document.body.appendChild(container);\r\n  return { container, badge, panel };\r\n}\r\n\r\nexport default function initShipPipelineOverlay() {\r\n  try {\r\n    createOverlay();\r\n  } catch (e) {\r\n    console.warn(\"shipPipelineOverlay init failed\", e);\r\n  }\r\n}\r\n", "// entitiesConfig.ts - ship-type defaults and visuals helpers (typed)\r\n//\r\n// Tuning rationale (2025-08-24):\r\n// - Playfield size: 1920x1080\r\n// - Ship speeds (maxSpeed, accel): Higher speed enables kiting and rapid repositioning; slower ships are easier to flank.\r\n// - Turn rates (turnRate): Higher turn rate allows ships to evade, flank, and respond to threats quickly; low turn rate makes ships vulnerable to flanking.\r\n// - Weapon ranges (muzzleSpeed * bulletTTL): Longer range supports kiting and edge play; shorter range requires close engagement and rewards flanking.\r\n// - Weapon rate (rate): Higher fire rate enables sustained pressure and kiting; lower rate rewards timing and positioning.\r\n// - Ship radius: Larger ships are easier to hit and harder to flank; smaller ships excel at flanking and evasion.\r\n// - Boundary options (see simConfig.ts): Enable edge play (wrap, bounce, remove) for tactical escapes and repositioning.\r\n// - See patch history for details\r\nimport {\r\n  getShipAsset,\r\n  getBulletAsset,\r\n  getTurretAsset,\r\n} from \"./assets/assetsConfig\";\r\n\r\n// CannonCfg parameters and tactical impact:\r\n// - damage: Higher damage increases threat, rewards flanking and burst attacks.\r\n// - rate: Higher rate supports kiting and pressure; lower rate rewards timing.\r\n// - spread: More spread makes weapons less accurate, favors close-range flanking.\r\n// - muzzleSpeed: Higher speed increases range and kiting potential.\r\n// - bulletRadius: Larger radius makes shots easier to land, favors area denial.\r\n// - bulletTTL: Longer TTL increases range, supports edge play and kiting.\r\nexport type CannonCfg = {\r\n  damage: number;\r\n  rate: number;\r\n  spread?: number;\r\n  muzzleSpeed?: number;\r\n  bulletRadius?: number;\r\n  bulletTTL?: number;\r\n  // optional per-weapon effective range (units). If omitted, engine uses muzzleSpeed*bulletTTL or BULLET_DEFAULTS.range\r\n  range?: number;\r\n};\r\n\r\n// ShipTypeCfg parameters and tactical impact:\r\n// - maxHp, armor, maxShield: Higher values increase survivability, allow for riskier flanking and edge play.\r\n// - shieldRegen: Faster regen supports hit-and-run and kiting.\r\n// - damage/dmg: Higher damage rewards successful flanking and burst attacks.\r\n// - radius: Smaller radius makes ships harder to hit and better at flanking; larger radius increases vulnerability.\r\n// - cannons: Weapon loadout affects tactical options (see CannonCfg).\r\n// - accel: Higher acceleration enables rapid repositioning and kiting.\r\n// - turnRate: Higher turn rate allows for quick flanking, evasion, and edge play.\r\n// - maxSpeed: Higher speed supports kiting and edge escapes; lower speed makes ships easier to pursue and flank.\r\n// - turrets: Multiple turrets increase area control, make flanking harder.\r\n// - friction: Lower friction (closer to 1) enables sustained velocity for kiting and edge play; higher friction increases tactical vulnerability to pursuit and flanking.\r\n// All entities and events are pruned immediately upon destruction or expiration, ensuring tactical scenarios remain robust and consistent.\r\nexport type ShipTypeCfg = {\r\n  maxHp: number;\r\n  armor?: number;\r\n  maxShield?: number;\r\n  shieldRegen?: number;\r\n  // size classification for tuning: 'small' | 'medium' | 'large'\r\n  size?: \"small\" | \"medium\" | \"large\";\r\n  dmg?: number;\r\n  damage?: number;\r\n  radius?: number;\r\n  cannons?: CannonCfg[];\r\n  accel?: number;\r\n  turnRate?: number;\r\n  maxSpeed?: number;\r\n  carrier?: {\r\n    fighterCooldown: number;\r\n    maxFighters: number;\r\n    spawnPerCooldown: number;\r\n  };\r\n  turrets?: Array<{\r\n    // runtime: spread and barrel length can be provided per-turret\r\n    // runtime: spread and barrel length can be provided per-turret\r\n    position: [number, number]; // relative to ship center, in radius units\r\n    kind: string; // turret asset kind\r\n    targeting?: \"nearest\" | \"random\" | \"focus\" | \"custom\"; // targeting logic\r\n    cooldown?: number; // seconds between shots\r\n    lastFired?: number; // timestamp of last shot\r\n    // optional turret firing range (units)\r\n    range?: number;\r\n    // optional per-turret defaults\r\n    spread?: number;\r\n    barrel?: number; // barrel length in radius units\r\n  }>;\r\n};\r\n\r\nexport type ShipConfigMap = Record<string, ShipTypeCfg>;\r\n\r\nexport const ShipConfig: ShipConfigMap = {\r\n  fighter: {\r\n    maxHp: 15,\r\n    // size classification used for armor/shield tuning\r\n    size: \"small\",\r\n    armor: 0,\r\n    maxShield: 8,\r\n    shieldRegen: 1.0,\r\n    dmg: 3,\r\n    damage: 3,\r\n    radius: 12,\r\n    cannons: [\r\n      {\r\n        damage: 3,\r\n        rate: 3,\r\n        spread: 0.1,\r\n        muzzleSpeed: 260, // reduced back (/10)\r\n        bulletRadius: 1.5,\r\n        bulletTTL: 1.1, // was 1.2\r\n        // effective range (muzzleSpeed * bulletTTL) scaled to engine units\r\n        range: Math.round(260 * 1.1),\r\n      },\r\n    ],\r\n\r\n    // Refined tuning: slightly higher accel and a moderate maxSpeed for clearer motion\r\n    accel: 100, // ~10x accel\r\n    turnRate: 6,\r\n    maxSpeed: 2200, // ~10x maxSpeed\r\n  },\r\n  corvette: {\r\n    maxHp: 50,\r\n    size: \"medium\",\r\n    armor: 0,\r\n    maxShield: Math.round(50 * 0.6),\r\n    shieldRegen: 0.5,\r\n    dmg: 5,\r\n    damage: 5,\r\n    radius: 20,\r\n    accel: 80,\r\n    turnRate: 3.5, // was 3\r\n    maxSpeed: 1800, // ~10x increased\r\n    cannons: [\r\n      {\r\n        damage: 6,\r\n        rate: 1.2,\r\n        spread: 0.05,\r\n        muzzleSpeed: 180, // reduced back (/10)\r\n        bulletRadius: 2,\r\n        bulletTTL: 1.8, // was 2.0\r\n        range: Math.round(180 * 1.8),\r\n      },\r\n    ],\r\n  },\r\n  frigate: {\r\n    maxHp: 80,\r\n    size: \"medium\",\r\n    armor: 1,\r\n    maxShield: Math.round(80 * 0.6),\r\n    shieldRegen: 0.4,\r\n    dmg: 8,\r\n    damage: 8,\r\n    radius: 24,\r\n    cannons: [\r\n      {\r\n        damage: 8,\r\n        rate: 1.0,\r\n        spread: 0.06,\r\n        muzzleSpeed: 180, // reduced back (/10)\r\n        bulletRadius: 2.5,\r\n        bulletTTL: 2.0, // was 2.2\r\n        range: Math.round(180 * 2.0),\r\n      },\r\n    ],\r\n    accel: 70,\r\n    turnRate: 2.5, // was 2.2\r\n    maxSpeed: 1500, // ~10x increased\r\n  },\r\n  destroyer: {\r\n    maxHp: 120,\r\n    size: \"large\",\r\n    armor: 2,\r\n    maxShield: Math.round(120 * 0.6),\r\n    shieldRegen: 0.3,\r\n    dmg: 12,\r\n    damage: 12,\r\n    radius: 40,\r\n    cannons: new Array(6).fill(0).map(() => ({\r\n      damage: 6,\r\n      rate: 0.8,\r\n      spread: 0.08,\r\n      muzzleSpeed: 160, // reduced back (/10)\r\n      bulletRadius: 2.5,\r\n      bulletTTL: 1.8, // was 2.4\r\n      range: Math.round(160 * 1.8),\r\n    })),\r\n    accel: 60,\r\n    turnRate: 2.0, // was 1.6\r\n    maxSpeed: 1300, // ~10x increased\r\n    turrets: [\r\n      {\r\n        position: [1.2, 0.8],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n        // turret effective range (units)\r\n        range: 300,\r\n      },\r\n      {\r\n        position: [-1.2, 0.8],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n      },\r\n      {\r\n        position: [1.2, -0.8],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n      },\r\n      {\r\n        position: [-1.2, -0.8],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n      },\r\n      {\r\n        position: [0, 1.5],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n      },\r\n      {\r\n        position: [0, -1.5],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 0.8,\r\n      },\r\n    ],\r\n  },\r\n  carrier: {\r\n    maxHp: 200,\r\n    size: \"large\",\r\n    armor: 3,\r\n    maxShield: Math.round(200 * 0.6),\r\n    shieldRegen: 0.2,\r\n    dmg: 2,\r\n    damage: 2,\r\n    radius: 40,\r\n    cannons: new Array(4).fill(0).map(() => ({\r\n      damage: 4,\r\n      rate: 0.6,\r\n      spread: 0.12,\r\n      muzzleSpeed: 140, // reduced back (/10)\r\n      bulletRadius: 3,\r\n      bulletTTL: 2.2, // was 2.8\r\n      range: Math.round(140 * 2.2),\r\n    })),\r\n    accel: 55,\r\n    turnRate: 1.2, // was 0.8\r\n    maxSpeed: 1100, // ~10x increased\r\n    carrier: { fighterCooldown: 1.5, maxFighters: 6, spawnPerCooldown: 2 },\r\n    turrets: [\r\n      {\r\n        position: [2.0, 1.2],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 1.0,\r\n        range: 300,\r\n      },\r\n      {\r\n        position: [-2.0, 1.2],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 1.0,\r\n      },\r\n      {\r\n        position: [2.0, -1.2],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 1.0,\r\n      },\r\n      {\r\n        position: [-2.0, -1.2],\r\n        kind: \"basic\",\r\n        targeting: \"nearest\",\r\n        cooldown: 1.0,\r\n      },\r\n    ],\r\n  },\r\n};\r\n\r\n// Per-size defaults to provide consistent tuning shortcuts. These values are\r\n// applied when a ShipTypeCfg omits explicit armor/shield tuning. They make it\r\n// easy to adjust broad balance by class (small/medium/large) in one place.\r\nexport const SIZE_DEFAULTS: Record<\r\n  \"small\" | \"medium\" | \"large\",\r\n  Partial<ShipTypeCfg>\r\n> = {\r\n  small: {\r\n    armor: 0,\r\n    maxShield: 8,\r\n    shieldRegen: 1.0,\r\n    radius: 12,\r\n    turnRate: 6,\r\n    accel: 100,\r\n    maxSpeed: 2200,\r\n  },\r\n  medium: {\r\n    armor: 1,\r\n    maxShield: 40,\r\n    shieldRegen: 0.5,\r\n    radius: 24,\r\n    turnRate: 3.5,\r\n    accel: 80,\r\n    maxSpeed: 1800,\r\n  },\r\n  large: {\r\n    armor: 2,\r\n    maxShield: 120,\r\n    shieldRegen: 0.25,\r\n    radius: 40,\r\n    turnRate: 2.0,\r\n    accel: 60,\r\n    maxSpeed: 1300,\r\n  },\r\n};\r\n\r\nexport function getSizeDefaults(size: \"small\" | \"medium\" | \"large\") {\r\n  return SIZE_DEFAULTS[size] || SIZE_DEFAULTS.small;\r\n}\r\n\r\n// Runtime configuration helpers: update per-size defaults in-place.\r\nexport function setSizeDefaults(\r\n  size: \"small\" | \"medium\" | \"large\",\r\n  patch: Partial<ShipTypeCfg>,\r\n) {\r\n  SIZE_DEFAULTS[size] = Object.assign({}, SIZE_DEFAULTS[size], patch);\r\n}\r\n\r\nexport function setAllSizeDefaults(patch: Partial<ShipTypeCfg>) {\r\n  SIZE_DEFAULTS.small = Object.assign({}, SIZE_DEFAULTS.small, patch);\r\n  SIZE_DEFAULTS.medium = Object.assign({}, SIZE_DEFAULTS.medium, patch);\r\n  SIZE_DEFAULTS.large = Object.assign({}, SIZE_DEFAULTS.large, patch);\r\n}\r\n// NOTE: The factory that creates Ship objects (`createShip` in src/entities.ts)\r\n// enforces a positive fallback for `maxSpeed` when the config is missing or\r\n// set to 0. This guards against malformed saved state or partial config\r\n// payloads which would otherwise clamp ship velocity to 0 and prevent\r\n// translation while still allowing rotation/firing (a common source of\r\n// confusing \"ships rotate and shoot but don't move\" bugs).\r\nexport function getShipConfig() {\r\n  // Normalize weapon ranges at runtime so configs may omit 'range'.\r\n  // For cannons: range = Math.round(muzzleSpeed * bulletTTL) or BULLET_DEFAULTS.range\r\n  // For turrets: if missing, inherit first cannon range or BULLET_DEFAULTS.range\r\n  Object.keys(ShipConfig).forEach((key) => {\r\n    const cfg = ShipConfig[key];\r\n    if (cfg.cannons) {\r\n      cfg.cannons.forEach((c) => {\r\n        if (c.range == null) {\r\n          const ms = c.muzzleSpeed ?? BULLET_DEFAULTS.muzzleSpeed;\r\n          const ttl = c.bulletTTL ?? BULLET_DEFAULTS.ttl;\r\n          const computed =\r\n            Number.isFinite(ms) && Number.isFinite(ttl)\r\n              ? Math.round(ms * ttl)\r\n              : BULLET_DEFAULTS.range;\r\n          c.range = computed || BULLET_DEFAULTS.range;\r\n        }\r\n      });\r\n    }\r\n    // Turret range fallback: prefer existing turret.range, else try first cannon, else BULLET_DEFAULTS.range\r\n    if (cfg.turrets) {\r\n      const firstCannonRange =\r\n        cfg.cannons && cfg.cannons.length\r\n          ? cfg.cannons[0].range || BULLET_DEFAULTS.range\r\n          : BULLET_DEFAULTS.range;\r\n      cfg.turrets.forEach((t) => {\r\n        if (t.range == null) {\r\n          t.range = firstCannonRange;\r\n        }\r\n      });\r\n    }\r\n  });\r\n  return ShipConfig;\r\n}\r\n\r\n// Bullet global defaults (used if not per-ship)\r\nexport const BULLET_DEFAULTS = {\r\n  damage: 1,\r\n  ttl: 2.0,\r\n  radius: 1.5,\r\n  muzzleSpeed: 24,\r\n  // default effective range (units)\r\n  range: 300,\r\n};\r\n\r\n// Particle defaults (used for generic effects)\r\nexport const PARTICLE_DEFAULTS = {\r\n  ttl: 1,\r\n  color: \"#fff\",\r\n  size: 2,\r\n};\r\n\r\n// Team fallback default\r\n\r\nexport function bulletKindForRadius(r: number): string {\r\n  if (r < 2) return \"small\";\r\n  if (r < 2.5) return \"medium\";\r\n  if (r < 3.5) return \"large\";\r\n  return \"heavy\";\r\n}\r\n\r\nexport function getDefaultShipType(): string {\r\n  return Object.keys(ShipConfig)[0] || \"fighter\";\r\n}\r\n\r\nexport default ShipConfig;\r\n\r\n// CommonJS shim for tests that use require() to import the TS module path directly.\r\n// This keeps runtime behavior identical while allowing `require(\"../../src/config/entitiesConfig\")`\r\n// to access named exports in a CJS environment (Vitest/node require).\r\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n// @ts-ignore\r\ndeclare const module: any;\r\nif (typeof module !== \"undefined\" && module.exports) {\r\n  // assign named exports to module.exports for CommonJS consumers\r\n  try {\r\n    const existing = module.exports || {};\r\n    Object.defineProperty(existing, \"ShipConfig\", {\r\n      value: ShipConfig,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"getShipConfig\", {\r\n      value: getShipConfig,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"SIZE_DEFAULTS\", {\r\n      value: SIZE_DEFAULTS,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"getSizeDefaults\", {\r\n      value: getSizeDefaults,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"setSizeDefaults\", {\r\n      value: setSizeDefaults,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"setAllSizeDefaults\", {\r\n      value: setAllSizeDefaults,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"BULLET_DEFAULTS\", {\r\n      value: BULLET_DEFAULTS,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"PARTICLE_DEFAULTS\", {\r\n      value: PARTICLE_DEFAULTS,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"bulletKindForRadius\", {\r\n      value: bulletKindForRadius,\r\n      enumerable: true,\r\n    });\r\n    Object.defineProperty(existing, \"getDefaultShipType\", {\r\n      value: getDefaultShipType,\r\n      enumerable: true,\r\n    });\r\n    // ensure default also exists without reassigning module.exports entirely\r\n    try {\r\n      Object.defineProperty(existing, \"default\", {\r\n        value: ShipConfig,\r\n        enumerable: true,\r\n      });\r\n    } catch (e) {}\r\n    // merge back to module.exports if possible\r\n    try {\r\n      module.exports = existing;\r\n    } catch (e) {}\r\n  } catch (e) {}\r\n}\r\n", "// Centralized runtime config resolver for ESM/CJS interop safety\r\n// Provides safe accessors used by hot paths to avoid partial module init and drift\r\n\r\n// Prefer a direct ESM import when available so bundlers include the config\r\n// and the resolver works in browsers without Node's require.\r\nimport * as EntitiesConfigESM from \"./entitiesConfig\";\r\n\r\n// ESM-safe require using Node's createRequire\r\nlet __nodeRequire: any;\r\ntry {\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  const { createRequire } = require(\"module\");\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  __nodeRequire = createRequire(typeof import.meta !== \"undefined\" ? (import.meta as any).url : __filename);\r\n} catch (e) {\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n    const { createRequire } = require(\"module\");\r\n    __nodeRequire = createRequire(__filename);\r\n  } catch (e2) {}\r\n}\r\n\r\nexport function getRuntimeEntitiesModule(): any {\r\n  // Memoize the successfully resolved module to avoid repeated require calls\r\n  // across hot paths.\r\n  // Use closure-scoped cache to preserve behavior within the same process.\r\n  // Only cache on success so that if resolution fails once during early init,\r\n  // subsequent calls can retry.\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore - attach a hidden cache symbol on the function object\r\n  const cacheKey = \"__cachedModule\";\r\n  try {\r\n    // Use eager ESM import if present\r\n    try {\r\n      const esmMod: any = (EntitiesConfigESM as any) || {};\r\n      if (esmMod && Object.keys(esmMod).length) {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        (getRuntimeEntitiesModule as any)[cacheKey] = esmMod;\r\n        return esmMod;\r\n      }\r\n    } catch {}\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    if ((getRuntimeEntitiesModule as any)[cacheKey])\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      return (getRuntimeEntitiesModule as any)[cacheKey];\r\n  } catch {}\r\n  try {\r\n    if (__nodeRequire) {\r\n      try {\r\n        const mod = __nodeRequire(\"./entitiesConfig\");\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        (getRuntimeEntitiesModule as any)[cacheKey] = mod;\r\n        return mod;\r\n      } catch {}\r\n    }\r\n  } catch {}\r\n  try {\r\n    const mod = __nodeRequire ? __nodeRequire(\"./entitiesConfig.ts\") : undefined;\r\n    if (mod) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeEntitiesModule as any)[cacheKey] = mod;\r\n      return mod;\r\n    }\r\n  } catch {}\r\n  try {\r\n    const mod = __nodeRequire ? __nodeRequire(\"./entitiesConfig.js\") : undefined;\r\n    if (mod) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeEntitiesModule as any)[cacheKey] = mod;\r\n      return mod;\r\n    }\r\n  } catch {}\r\n  return undefined;\r\n}\r\n\r\nexport function getRuntimeShipConfigSafe(): any {\r\n  // Return memoized config if available\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  const cfgKey = \"__cachedShipConfig\";\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    if ((getRuntimeShipConfigSafe as any)[cfgKey])\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      return (getRuntimeShipConfigSafe as any)[cfgKey];\r\n  } catch {}\r\n  // Try named getter first to ensure ranges are normalized\r\n  try {\r\n    const mod: any = getRuntimeEntitiesModule() || {};\r\n    if (typeof mod.getShipConfig === \"function\") {\r\n      const cfg = mod.getShipConfig();\r\n      if (cfg && Object.keys(cfg).length) {\r\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n        // @ts-ignore\r\n        (getRuntimeShipConfigSafe as any)[cfgKey] = cfg;\r\n        return cfg;\r\n      }\r\n    }\r\n    if (mod.ShipConfig && Object.keys(mod.ShipConfig).length) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeShipConfigSafe as any)[cfgKey] = mod.ShipConfig;\r\n      return mod.ShipConfig;\r\n    }\r\n    if (mod.default && Object.keys(mod.default).length) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeShipConfigSafe as any)[cfgKey] = mod.default;\r\n      return mod.default;\r\n    }\r\n    if (mod && Object.keys(mod).length) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeShipConfigSafe as any)[cfgKey] = mod;\r\n      return mod;\r\n    }\r\n  } catch {}\r\n  // Last-resort minimal set (fighter + carrier so carrier features work)\r\n  // IMPORTANT: Do not cache fallback. If early resolution fails during init,\r\n  // we want later calls to retry and obtain the full config when available.\r\n  const fallback = {\r\n    fighter: {\r\n      size: \"small\",\r\n      maxHp: 10,\r\n      maxShield: 8,\r\n      shieldRegen: 1,\r\n      accel: 100,\r\n      turnRate: 6,\r\n      radius: 12,\r\n      maxSpeed: 2200,\r\n      cannons: [{ damage: 3, rate: 3, muzzleSpeed: 260, bulletTTL: 1.1 }],\r\n    },\r\n    carrier: {\r\n      size: \"large\",\r\n      maxHp: 50,\r\n      armor: 2,\r\n      maxShield: 30,\r\n      shieldRegen: 0.3,\r\n      radius: 40,\r\n      accel: 60,\r\n      turnRate: 1.5,\r\n      maxSpeed: 1200,\r\n      cannons: [{ damage: 2, rate: 0.8, muzzleSpeed: 140, bulletTTL: 2.0 }],\r\n      carrier: { fighterCooldown: 1.5, maxFighters: 6, spawnPerCooldown: 2 },\r\n      turrets: [{ position: [2.0, 1.2], kind: \"basic\" }],\r\n    },\r\n  } as const;\r\n  return fallback;\r\n}\r\n\r\nexport function getRuntimeSizeDefaultsSafe(size: \"small\" | \"medium\" | \"large\") {\r\n  // Memoize per-size lookups to avoid repeated module calls\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  const sizeCacheKey = \"__cachedSizeDefaults\";\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    const cache: Map<string, any> = (getRuntimeSizeDefaultsSafe as any)[sizeCacheKey] || new Map();\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    (getRuntimeSizeDefaultsSafe as any)[sizeCacheKey] = cache;\r\n    if (cache.has(size)) return cache.get(size);\r\n  } catch {}\r\n  try {\r\n    const mod: any = getRuntimeEntitiesModule() || {};\r\n    let val: any = {};\r\n    if (typeof mod.getSizeDefaults === \"function\") val = mod.getSizeDefaults(size);\r\n    else if (mod.default && typeof mod.default.getSizeDefaults === \"function\") val = mod.default.getSizeDefaults(size);\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    const cache: Map<string, any> = (getRuntimeSizeDefaultsSafe as any)[sizeCacheKey] || new Map();\r\n    cache.set(size, val || {});\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    (getRuntimeSizeDefaultsSafe as any)[sizeCacheKey] = cache;\r\n    return val || {};\r\n  } catch {}\r\n  return {};\r\n}\r\n\r\nexport function getRuntimeBulletDefaultsSafe() {\r\n  // Memoize bullet defaults\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  const bulletKey = \"__cachedBulletDefaults\";\r\n  try {\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    if ((getRuntimeBulletDefaultsSafe as any)[bulletKey])\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      return (getRuntimeBulletDefaultsSafe as any)[bulletKey];\r\n  } catch {}\r\n  try {\r\n    const mod: any = getRuntimeEntitiesModule() || {};\r\n    if (mod && mod.BULLET_DEFAULTS) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeBulletDefaultsSafe as any)[bulletKey] = mod.BULLET_DEFAULTS;\r\n      return mod.BULLET_DEFAULTS;\r\n    }\r\n    if (mod && mod.default && mod.default.BULLET_DEFAULTS) {\r\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n      // @ts-ignore\r\n      (getRuntimeBulletDefaultsSafe as any)[bulletKey] = mod.default.BULLET_DEFAULTS;\r\n      return mod.default.BULLET_DEFAULTS;\r\n    }\r\n  } catch {}\r\n  const fallback = { damage: 1, ttl: 2.0, radius: 1.5, muzzleSpeed: 24, range: 300 };\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore\r\n  (getRuntimeBulletDefaultsSafe as any)[bulletKey] = fallback;\r\n  return fallback;\r\n}\r\n\r\n// Shared helper: choose a default ship type safely across module systems.\r\n// Returns the first key of the runtime ship config map, or 'fighter' as a fallback.\r\nexport function getDefaultShipTypeSafe(): string {\r\n  try {\r\n    const cfg: any = getRuntimeShipConfigSafe();\r\n    const keys = Object.keys(cfg || {});\r\n    return keys.length ? keys[0] : \"fighter\";\r\n  } catch (e) {\r\n    return \"fighter\";\r\n  }\r\n}\r\n", "import type { BoundaryBehavior } from \"./types\";\r\n\r\nexport interface SimConfig {\r\n  DT_MS: number;\r\n  MAX_ACC_MS: number;\r\n  bounds: { W: number; H: number };\r\n  friction: number; // Velocity damping factor for ships\r\n  gridCellSize?: number; // spatial grid cell size (px)\r\n}\r\n\r\nexport const SIM: SimConfig = {\r\n  DT_MS: 16,\r\n  MAX_ACC_MS: 250,\r\n  bounds: { W: 1920, H: 1080 }, // Use LOGICAL_MAP for default bounds\r\n  friction: 0.99,\r\n  gridCellSize: 64,\r\n};\r\n// boundaryBehavior: Tactical impact and pruning rationale\r\n// - 'remove': Ships/bullets are eliminated at map edge; punishes edge play, rewards central control. Pruning is immediate for out-of-bounds entities.\r\n// - 'wrap': Ships/bullets reappear on opposite edge; enables edge escapes, flanking via wrap, and kiting around boundaries. Pruning only occurs for expired entities.\r\n// - 'bounce': Ships/bullets reflect off edge; supports tactical repositioning, edge denial, and hit-and-run. Pruning is immediate for expired entities.\r\n// All entities, particles, and events are pruned immediately upon destruction, expiration, or leaving bounds, ensuring robust cleanup and tactical consistency.\r\nexport const boundaryBehavior: {\r\n  ships: BoundaryBehavior;\r\n  bullets: BoundaryBehavior;\r\n} = {\r\n  ships: \"wrap\",\r\n  bullets: \"remove\",\r\n};\r\n\r\nexport const progression = {\r\n  xpPerDamage: 1,\r\n  xpPerKill: 50,\r\n  xpToLevel: (level: number) => 100 + level * 50,\r\n};\r\n\r\nexport const LOGICAL_MAP = { W: 1920, H: 1080 };\r\n\r\nexport function getDefaultBounds() {\r\n  // Fixed logical map size for simulation and rendering\r\n  return { W: LOGICAL_MAP.W, H: LOGICAL_MAP.H };\r\n}\r\n\r\nexport default {\r\n  SIM,\r\n  progression,\r\n  boundaryBehavior,\r\n  LOGICAL_MAP,\r\n  getDefaultBounds,\r\n};\r\n", "// src/rng.ts - Seeded RNG utilities (ported from rng.js)\r\nlet _seed = 1;\r\n\r\nexport function srand(seed: number = 1) {\r\n  // store as 32-bit unsigned\r\n  _seed = seed >>> 0;\r\n}\r\n\r\n// mulberry32 PRNG\r\nfunction mulberry32(a: number) {\r\n  return function() {\r\n    let t = (a += 0x6D2B79F5) >>> 0;\r\n    t = Math.imul(t ^ (t >>> 15), t | 1);\r\n    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);\r\n    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;\r\n  };\r\n}\r\n\r\nexport function srandom(): number {\r\n  const f = mulberry32(_seed);\r\n  // advance seed deterministically\r\n  _seed = (_seed + 0x9E3779B1) >>> 0;\r\n  return f();\r\n}\r\n\r\nexport function srange(min: number, max: number): number {\r\n  return min + (max - min) * srandom();\r\n}\r\n\r\nexport function srangeInt(min: number, max: number): number {\r\n  // exclusive upper bound to match expectations\r\n  return Math.floor(srange(min, max));\r\n}\r\n\r\nexport default { srand, srandom, srange, srangeInt };\r\n", "// teamsConfig.ts - Teams and fleet helpers (typed)\r\nimport { getDefaultShipType, getShipConfig } from \"./entitiesConfig\"; // should be './config/entitiesConfig'\r\nimport { getDefaultBounds } from \"./simConfig\";\r\nexport type Team = { id: string; color: string; label?: string };\r\nexport const TeamsConfig = {\r\n  teams: {\r\n    red: { id: \"red\", color: \"#ff4d4d\", label: \"Red\" },\r\n    blue: { id: \"blue\", color: \"#4da6ff\", label: \"Blue\" },\r\n  },\r\n  defaultFleet: {\r\n    counts: (() => {\r\n      // Build a default counts map from available ShipConfig types so new\r\n      // ship types are automatically included without needing manual edits.\r\n      // Defensive: some module resolution paths may expose a non-function\r\n      // binding for getShipConfig (e.g. default object). Accept both a\r\n      // function or an object shape to avoid TypeError during tests.\r\n      const shipCfg =\r\n        (typeof getShipConfig === \"function\" && getShipConfig()) ||\r\n        // if imported as default-only: try default export object/function\r\n        (typeof (getShipConfig as any)?.default === \"function\" &&\r\n          (getShipConfig as any).default()) ||\r\n        (typeof (getShipConfig as any)?.default === \"object\" &&\r\n          (getShipConfig as any).default) ||\r\n        // some bundlers may bind getShipConfig to the config object itself\r\n        (typeof (getShipConfig as any) === \"object\" &&\r\n          (getShipConfig as any)) ||\r\n        {};\r\n      let types = Object.keys(shipCfg || {});\r\n      // Robust fallback: if we couldn't discover any types (interop edge-case),\r\n      // seed with the canonical baseline so feature tests remain stable.\r\n      if (types.length === 0) {\r\n        types = [\"fighter\", \"corvette\", \"frigate\", \"destroyer\", \"carrier\"];\r\n      }\r\n      // sane defaults: make fighters most common, others rarer\r\n      const defaultCounts: Record<string, number> = {};\r\n      for (const t of types) {\r\n        if (t === \"fighter\") defaultCounts[t] = 8;\r\n        else if (t === \"corvette\") defaultCounts[t] = 3;\r\n        else if (t === \"frigate\") defaultCounts[t] = 2;\r\n        else if (t === \"destroyer\") defaultCounts[t] = 1;\r\n        else if (t === \"carrier\") defaultCounts[t] = 1;\r\n        else defaultCounts[t] = 1;\r\n      }\r\n      return defaultCounts;\r\n    })(),\r\n    spacing: 28,\r\n    jitter: { x: 80, y: 120 },\r\n  },\r\n  // continuousReinforcement controls: enable/disable, scoreMargin is the\r\n  // imbalance fraction (e.g. 0.12 means reinforce when weakest ratio < 0.38),\r\n  // perTick is the maximum ships considered per reinforcement tick, and\r\n  // shipTypes is an optional array of types to choose from randomly. If\r\n  // omitted, keys from defaultFleet.counts are used.\r\n  continuousReinforcement: {\r\n    enabled: false,\r\n    scoreMargin: 0.12,\r\n    perTick: 1,\r\n    interval: 5.0,\r\n    shipTypes: undefined as string[] | undefined,\r\n  },\r\n};\r\n\r\n// Local seeded PRNG (does not affect global rng)\r\nfunction mulberry32(seed: number) {\r\n  let t = seed >>> 0;\r\n  return function () {\r\n    t += 0x6d2b79f5;\r\n    let r = Math.imul(t ^ (t >>> 15), 1 | t);\r\n    r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);\r\n    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;\r\n  };\r\n}\r\n\r\nfunction hashStringToInt(s: string) {\r\n  let h = 2166136261 >>> 0;\r\n  for (let i = 0; i < s.length; i++) {\r\n    h ^= s.charCodeAt(i);\r\n    h = Math.imul(h, 16777619) >>> 0;\r\n  }\r\n  return h >>> 0;\r\n}\r\n\r\nexport function generateFleetForTeam(\r\n  seed = 0,\r\n  teamId: \"red\" | \"blue\" = \"red\",\r\n  bounds?: { W: number; H: number },\r\n  shipFactory?: (type: string, x: number, y: number, team: string) => any,\r\n  options: any = {},\r\n) {\r\n  const b = bounds || getDefaultBounds();\r\n  const cfg = Object.assign({}, TeamsConfig.defaultFleet, options.fleet || {});\r\n  const spacing = options.spacing ?? cfg.spacing;\r\n  const jitter = Object.assign({}, cfg.jitter, options.jitter || {});\r\n  const centerY = b.H / 2;\r\n  const baseX = teamId === \"red\" ? b.W * 0.22 : b.W * 0.78;\r\n  const rng = mulberry32((seed >>> 0) + hashStringToInt(teamId));\r\n  const out: any[] = [];\r\n  for (const [type, count] of Object.entries(cfg.counts)) {\r\n    for (let i = 0; i < (count as number); i++) {\r\n      const r = spacing * Math.sqrt(rng());\r\n      const angle = rng() * Math.PI * 2;\r\n      const dx = Math.cos(angle) * r + (rng() - 0.5) * (jitter.x ?? 0);\r\n      const dy = Math.sin(angle) * r + (rng() - 0.5) * (jitter.y ?? 0);\r\n      const x = Math.max(0, Math.min(b.W - 1e-6, baseX + dx));\r\n      const y = Math.max(0, Math.min(b.H - 1e-6, centerY + dy));\r\n      if (typeof shipFactory === \"function\")\r\n        out.push(shipFactory(type, x, y, teamId));\r\n      else out.push({ type, x, y, team: teamId });\r\n    }\r\n  }\r\n  return out;\r\n}\r\n\r\nexport function makeInitialFleets(\r\n  seed = 0,\r\n  bounds?: { W: number; H: number },\r\n  shipFactory?: (type: string, x: number, y: number, team: string) => any,\r\n  options: any = {},\r\n) {\r\n  const b = bounds || getDefaultBounds();\r\n  const red = generateFleetForTeam(seed, \"red\", b, shipFactory, options);\r\n  const blue = generateFleetForTeam(seed + 1, \"blue\", b, shipFactory, options);\r\n  return red.concat(blue);\r\n}\r\n\r\nexport function chooseReinforcements(\r\n  seed = 0,\r\n  state: any = {},\r\n  options: any = {},\r\n) {\r\n  const cfg = Object.assign({}, TeamsConfig.continuousReinforcement, options);\r\n  // (no-op) merge options onto default continuous reinforcement config\r\n  if (!cfg.enabled) return [] as any[];\r\n  const teamStrength: Record<string, number> = {};\r\n  if (Array.isArray(state.ships)) {\r\n    for (const s of state.ships) {\r\n      if (!s || !s.team) continue;\r\n      const hp = typeof s.hp === \"number\" ? s.hp : 1;\r\n      teamStrength[s.team] = (teamStrength[s.team] || 0) + hp;\r\n    }\r\n  }\r\n  const teams = Object.keys(TeamsConfig.teams);\r\n  if (teams.length === 0) return [];\r\n  for (const t of teams) {\r\n    if (!teamStrength[t]) {\r\n      const cnt = (state.ships || []).filter(\r\n        (s: any) => s && s.team === t,\r\n      ).length;\r\n      teamStrength[t] = cnt > 0 ? cnt : 0;\r\n    }\r\n  }\r\n  let weakest = teams[0];\r\n  let strongest = teams[0];\r\n  for (const t of teams) {\r\n    if (teamStrength[t] < teamStrength[weakest]) weakest = t;\r\n    if (teamStrength[t] > teamStrength[strongest]) strongest = t;\r\n  }\r\n  const total = teams.reduce((s, t) => s + (teamStrength[t] || 0), 0) || 1;\r\n  const weakestRatio = (teamStrength[weakest] || 0) / total;\r\n  if (weakestRatio < 0.5 - cfg.scoreMargin) {\r\n    const orders: any[] = [];\r\n    const rng = mulberry32((seed >>> 0) + hashStringToInt(weakest));\r\n    // determine candidate ship types: either explicit list or keys from defaultFleet\r\n    const candidateTypes =\r\n      Array.isArray(cfg.shipTypes) && cfg.shipTypes.length\r\n        ? cfg.shipTypes\r\n        : Object.keys(TeamsConfig.defaultFleet.counts || { fighter: 1 });\r\n    // Build weights for candidate types using defaultFleet counts when available\r\n    const countsMap =\r\n      TeamsConfig && TeamsConfig.defaultFleet && TeamsConfig.defaultFleet.counts\r\n        ? TeamsConfig.defaultFleet.counts\r\n        : {};\r\n    const weights = candidateTypes.map((t: string) =>\r\n      Math.max(0, Number((countsMap as any)[t]) || 1),\r\n    );\r\n    const totalWeight =\r\n      weights.reduce((s: number, w: number) => s + w, 0) ||\r\n      candidateTypes.length ||\r\n      1;\r\n    // Helper: weighted random pick for ship types\r\n    const weightedPick = () => {\r\n      const r = rng() * totalWeight;\r\n      let acc = 0;\r\n      for (let i = 0; i < candidateTypes.length; i++) {\r\n        acc += weights[i];\r\n        if (r < acc) return candidateTypes[i];\r\n      }\r\n      return candidateTypes[candidateTypes.length - 1];\r\n    };\r\n    // Randomize number to spawn between 1 and cfg.perTick (inclusive)\r\n    const maxPerTick = Math.max(1, Math.floor(Number(cfg.perTick) || 1));\r\n    const spawnCount = Math.max(1, Math.floor(rng() * maxPerTick) + 1);\r\n    // spawnCount computed deterministically from the provided seed\r\n    const b = options.bounds || getDefaultBounds();\r\n    const centerY = b.H / 2;\r\n    const baseX = weakest === \"red\" ? b.W * 0.18 : b.W * 0.82;\r\n    for (let i = 0; i < spawnCount; i++) {\r\n      const x = Math.max(0, Math.min(b.W - 1e-6, baseX + (rng() - 0.5) * 120));\r\n      const y = Math.max(\r\n        0,\r\n        Math.min(b.H - 1e-6, centerY + (rng() - 0.5) * 160),\r\n      );\r\n      const type =\r\n        Array.isArray(cfg.shipTypes) && cfg.shipTypes.length\r\n          ? candidateTypes[Math.floor(rng() * candidateTypes.length)] ||\r\n            getDefaultShipType()\r\n          : weightedPick();\r\n      orders.push({ type, team: weakest, x, y });\r\n    }\r\n    // return deterministic orders\r\n    return orders;\r\n  }\r\n  return [] as any[];\r\n}\r\n\r\n// Team fallback default\r\nexport const TEAM_DEFAULT = \"red\";\r\n\r\nexport default TeamsConfig;\r\n\r\n// Helper: call chooseReinforcements using a manager-derived seed (from global RNG)\r\n// This is convenient for callers (like gamemanager) that want to keep\r\n// reinforcements deterministic relative to the global `srand`/`srandom` state.\r\nimport { srandom } from \"../rng\";\r\nexport function chooseReinforcementsWithManagerSeed(\r\n  state: any = {},\r\n  options: any = {},\r\n) {\r\n  const seed = Math.floor(srandom() * 0xffffffff) >>> 0;\r\n  return chooseReinforcements(seed, state, options);\r\n}\r\n", "// Generic object pool\r\nexport type ResetFn<T> = (obj: T) => void;\r\nexport default class Pool<T> {\r\n  private stack: T[] = [];\r\n  private factory: () => T;\r\n  private reset?: ResetFn<T>;\r\n  public created = 0;\r\n\r\n  constructor(factory: () => T, reset?: ResetFn<T>, initialSize = 0) {\r\n    this.factory = factory;\r\n    this.reset = reset;\r\n    for (let i = 0; i < initialSize; i++) this.stack.push(this.factory());\r\n    this.created = this.stack.length;\r\n  }\r\n\r\n  acquire(): T {\r\n    const obj = this.stack.pop();\r\n    if (typeof obj !== \"undefined\") return obj;\r\n    const newObj = this.factory();\r\n    this.created++;\r\n    return newObj;\r\n  }\r\n\r\n  release(obj: T): void {\r\n    if (this.reset) this.reset(obj);\r\n    // Avoid pushing the same object twice which can lead to duplicate\r\n    // references in the pool and subtle reuse bugs.\r\n    if (!this.stack.includes(obj)) this.stack.push(obj);\r\n  }\r\n\r\n  size(): number {\r\n    return this.stack.length;\r\n  }\r\n\r\n  clear(): void {\r\n    this.stack.length = 0;\r\n  }\r\n}\r\n", "import type { GameState } from \"./types\";\r\nimport {\r\n  getRuntimeShipConfigSafe,\r\n  getRuntimeSizeDefaultsSafe,\r\n  getDefaultShipTypeSafe,\r\n} from \"./config/runtimeConfigResolver\";\r\n// Lazily resolve entitiesConfig to avoid partial module initialization during test interop.\r\n// Support ESM environments by creating a CommonJS-like require.\r\nlet __nodeRequire: any;\r\ntry {\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore - Node ESM global\r\n  const { createRequire } = require(\"module\");\r\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n  // @ts-ignore - import.meta in TS transpiled output\r\n  __nodeRequire = createRequire(\r\n    typeof import.meta !== \"undefined\" ? (import.meta as any).url : __filename,\r\n  );\r\n} catch (e) {\r\n  try {\r\n    // Fallback if native require exists (CJS paths)\r\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n    const { createRequire } = require(\"module\");\r\n    __nodeRequire = createRequire(__filename);\r\n  } catch (e2) {}\r\n}\r\nfunction __resolveEntitiesConfigModule(): any {\r\n  try {\r\n    // Prefer explicit .js when available (CJS consumers / runtime that resolve to compiled files)\r\n    if (__nodeRequire) {\r\n      try {\r\n        return __nodeRequire(\"./config/entitiesConfig.js\");\r\n      } catch {}\r\n      try {\r\n        return __nodeRequire(\"./config/entitiesConfig\");\r\n      } catch {}\r\n    }\r\n  } catch {}\r\n  try {\r\n    const mod = __nodeRequire\r\n      ? __nodeRequire(\"./config/entitiesConfig.ts\")\r\n      : undefined;\r\n    if (mod) return mod;\r\n  } catch {}\r\n  try {\r\n    // As a last resort, attempt ESM namespace import already transpiled\r\n    // Note: In many bundlers, this path will be rewritten; keep as safety.\r\n    return __nodeRequire\r\n      ? __nodeRequire(\"./config/entitiesConfig.js\")\r\n      : undefined;\r\n  } catch {}\r\n  return undefined;\r\n}\r\n\r\n// Delegate to centralized runtime resolver (memoized) to avoid repeated module work\r\nconst getShipConfigSafe = () => getRuntimeShipConfigSafe();\r\nconst getSizeDefaultsSafe = (size: \"small\" | \"medium\" | \"large\") =>\r\n  getRuntimeSizeDefaultsSafe(size as any);\r\n// (Removed duplicate getShipConfigSafe)\r\n// pooling helpers moved to src/pools; importers should use that module now\r\nimport { TEAM_DEFAULT } from \"./config/teamsConfig\";\r\nimport type { ShipConfigMap, ShipSpec } from \"./types\";\r\nimport Pool from \"./pools/pool\";\r\n\r\n// Pooling helpers were moved to `src/pools` \u2014 import from there directly.\r\n\r\nlet nextId = 1;\r\nexport function genId(): number {\r\n  return nextId++;\r\n}\r\n\r\nexport type Cannon = {\r\n  damage: number;\r\n  rate: number;\r\n  // runtime cooldown (internal) - optional\r\n  __cd?: number;\r\n  // optional range used by behavior logic\r\n  range?: number;\r\n  spread?: number;\r\n  muzzleSpeed?: number;\r\n  bulletRadius?: number;\r\n  bulletTTL?: number;\r\n};\r\n\r\nexport type Ship = {\r\n  id: number;\r\n  type: string;\r\n  x: number;\r\n  y: number;\r\n  vx: number;\r\n  vy: number;\r\n  hp: number;\r\n  maxHp: number;\r\n  shield?: number;\r\n  maxShield?: number;\r\n  angle: number;\r\n  team?: string;\r\n  xp?: number;\r\n  level?: number;\r\n  cannons?: Cannon[];\r\n  accel?: number;\r\n  currentAccel?: number;\r\n  throttle?: number;\r\n  steering?: number;\r\n  turnRate?: number;\r\n  radius?: number;\r\n  maxSpeed?: number;\r\n  trail?: { x: number; y: number }[];\r\n  shieldRegen?: number;\r\n  shieldPercent?: number;\r\n  hpPercent?: number;\r\n  armor?: number;\r\n  size?: \"small\" | \"medium\" | \"large\";\r\n  // parentId is set on ships spawned by other entities (e.g. fighters launched by a carrier)\r\n  parentId?: number;\r\n  // Internal carrier timer accumulator (seconds). Not serialized.\r\n  _carrierTimer?: number;\r\n  // Turrets attached to the ship. Normalized via normalizeTurrets -> each turret\r\n  // is an object { position: [x,y], angle, targetAngle, spread, barrel, cooldown }\r\n  // Accept either normalized turret objects or shorthand [x,y] arrays for\r\n  // backwards compatibility with saved snapshots and concise configs.\r\n  turrets?: Array<\r\n    | [number, number]\r\n    | {\r\n        position: [number, number];\r\n        angle?: number;\r\n        targetAngle?: number;\r\n        spread?: number;\r\n        barrel?: number;\r\n        cooldown?: number;\r\n        kind?: string;\r\n      }\r\n  >;\r\n};\r\n\r\nexport function createShip(\r\n  type: string | undefined = undefined,\r\n  x = 0,\r\n  y = 0,\r\n  team = TEAM_DEFAULT,\r\n): Ship {\r\n  const shipCfg = getShipConfigSafe() as ShipConfigMap;\r\n  const availableTypes = Object.keys(shipCfg || {});\r\n  const resolvedType =\r\n    type && shipCfg[type]\r\n      ? type\r\n      : availableTypes.length\r\n        ? availableTypes[0]\r\n        : getDefaultShipTypeSafe();\r\n  const rawCfg = (shipCfg[resolvedType] ||\r\n    shipCfg[getDefaultShipTypeSafe()]) as Partial<ShipSpec>;\r\n  // Merge in per-size defaults for any fields not explicitly provided by the\r\n  // ship type config. This keeps configs concise while ensuring sensible\r\n  // defaults for armor/shields per size class.\r\n  const sizeVal =\r\n    (rawCfg as any).size ||\r\n    (rawCfg.radius && rawCfg.radius >= 36\r\n      ? \"large\"\r\n      : rawCfg.radius && rawCfg.radius >= 20\r\n        ? \"medium\"\r\n        : \"small\");\r\n  const sizeDefaults = getSizeDefaultsSafe(\r\n    sizeVal as \"small\" | \"medium\" | \"large\",\r\n  );\r\n  const cfg = Object.assign({}, sizeDefaults, rawCfg) as Partial<ShipSpec>;\r\n  const ship = {\r\n    id: genId(),\r\n    type: resolvedType,\r\n    x,\r\n    y,\r\n    vx: 0,\r\n    vy: 0,\r\n    hp: cfg.maxHp ?? 0,\r\n    maxHp: cfg.maxHp ?? 0,\r\n    shield: cfg.maxShield ?? 0,\r\n    maxShield: cfg.maxShield ?? 0,\r\n    shieldRegen: cfg.shieldRegen ?? 0,\r\n    armor: cfg.armor ?? 0,\r\n    size: (cfg as any).size || sizeVal,\r\n    team,\r\n    xp: 0,\r\n    level: 1,\r\n    // Shallow-clone cannons to avoid mutating config and avoid expensive JSON roundtrip\r\n    cannons: Array.isArray(cfg.cannons)\r\n      ? (cfg.cannons as any[]).map((c) => (c && typeof c === \"object\" ? { ...c } : c))\r\n      : [],\r\n    // Keep raw turret defs here for now; we'll normalize below via helper so\r\n    // normalization logic is centralized and reusable by snapshot handlers.\r\n    turrets: cfg.turrets || [],\r\n    accel: cfg.accel || 0,\r\n    currentAccel: 0,\r\n    throttle: 0,\r\n    steering: 0,\r\n    turnRate: cfg.turnRate || 0,\r\n    radius: cfg.radius || 6,\r\n    // Ensure maxSpeed is always a sensible positive number. Some saved state\r\n    // or malformed configs may have maxSpeed omitted or set to 0 which causes\r\n    // ships to never translate (they can still rotate/fire). Prefer the\r\n    // configured value but fall back to a safe default > 0.\r\n    maxSpeed:\r\n      typeof cfg.maxSpeed === \"number\" && cfg.maxSpeed > 0 ? cfg.maxSpeed : 120,\r\n    angle: 0,\r\n    trail: undefined,\r\n    shieldPercent: 1,\r\n    hpPercent: 1,\r\n  } as Ship;\r\n  // Ensure turrets are normalized to the object shape (idempotent)\r\n  try {\r\n    normalizeTurrets(ship as any);\r\n  } catch (e) {}\r\n  return ship as Ship;\r\n}\r\n\r\n// normalizeTurrets\r\n// Converts turret shorthand arrays ([x,y]) into normalized turret objects\r\n// with default runtime fields. This function is idempotent and safe to call\r\n// on ships coming from snapshots or network/worker messages.\r\nexport function normalizeTurrets(ship: any): void {\r\n  try {\r\n    if (!ship) return;\r\n    const tarr = ship.turrets;\r\n    if (!Array.isArray(tarr)) return;\r\n    ship.turrets = tarr.map((t: any) => {\r\n      if (Array.isArray(t) && t.length === 2) {\r\n        return {\r\n          position: t,\r\n          angle: 0,\r\n          targetAngle: 0,\r\n          kind: \"basic\",\r\n          spread: 0,\r\n          barrel: 0,\r\n          cooldown: 1.0,\r\n        };\r\n      }\r\n      // If it's already an object turret, shallow-copy and ensure runtime defaults\r\n      if (t && typeof t === \"object\") {\r\n        const copy = Object.assign({}, t);\r\n        if (typeof copy.angle !== \"number\") copy.angle = 0;\r\n        if (typeof copy.targetAngle !== \"number\") copy.targetAngle = 0;\r\n        if (typeof copy.spread !== \"number\") copy.spread = 0;\r\n        if (typeof copy.barrel !== \"number\") copy.barrel = 0;\r\n        if (typeof copy.cooldown !== \"number\")\r\n          copy.cooldown = copy.cooldown || 1.0;\r\n        return copy;\r\n      }\r\n      return t;\r\n    });\r\n  } catch (e) {}\r\n}\r\n\r\n// normalizeStateShips\r\n// Normalizes turrets for every ship in the provided state, rebuilds a\r\n// shipMap for quick lookups and recomputes teamCounts (keeps red/blue keys).\r\nexport function normalizeStateShips(state: any): void {\r\n  if (!state || typeof state !== \"object\") return;\r\n  try {\r\n    const ships = Array.isArray(state.ships) ? state.ships : [];\r\n    // Normalize each ship's turret defs\r\n    for (const s of ships) {\r\n      try {\r\n        normalizeTurrets(s);\r\n      } catch (e) {}\r\n    }\r\n    // Rebuild shipMap\r\n    try {\r\n      (state as any).shipMap = new Map<number, any>();\r\n      for (const s of ships)\r\n        if (s && typeof s.id !== \"undefined\")\r\n          (state as any).shipMap.set(s.id, s);\r\n    } catch (e) {}\r\n    // Recompute teamCounts, preserve red/blue keys default\r\n    try {\r\n      const counts: Record<string, number> = { red: 0, blue: 0 };\r\n      for (const s of ships) {\r\n        try {\r\n          const t = String((s && (s as any).team) || \"\");\r\n          if (t) counts[t] = (counts[t] || 0) + 1;\r\n        } catch (e) {}\r\n      }\r\n      state.teamCounts = counts;\r\n    } catch (e) {}\r\n  } catch (e) {}\r\n}\r\n\r\nexport type Bullet = {\r\n  id: number;\r\n  x: number;\r\n  y: number;\r\n  vx: number;\r\n  vy: number;\r\n  team: string;\r\n  ownerId?: number | null;\r\n  damage: number;\r\n  ttl: number;\r\n  radius?: number;\r\n  bulletRadius?: number;\r\n  bulletTTL?: number;\r\n  kind?: string;\r\n  alive?: boolean;\r\n  prevX?: number;\r\n  prevY?: number;\r\n  _prevX?: number;\r\n  _prevY?: number;\r\n};\r\n\r\nconst bulletPool = new Pool<Bullet>(\r\n  () => ({\r\n    id: 0,\r\n    x: 0,\r\n    y: 0,\r\n    vx: 0,\r\n    vy: 0,\r\n    team: TEAM_DEFAULT,\r\n    ownerId: null,\r\n    damage: 0,\r\n    ttl: 0,\r\n    prevX: 0,\r\n    prevY: 0,\r\n    _prevX: 0,\r\n    _prevY: 0,\r\n  }),\r\n  (b) => {\r\n    /* reset */ b.id = 0;\r\n    b.x = 0;\r\n    b.y = 0;\r\n    b.vx = 0;\r\n    b.vy = 0;\r\n    b.team = TEAM_DEFAULT;\r\n    b.ownerId = null;\r\n    b.damage = 0;\r\n    b.ttl = 0;\r\n    b.prevX = 0;\r\n    b.prevY = 0;\r\n    b._prevX = 0;\r\n    b._prevY = 0;\r\n  },\r\n);\r\n\r\nexport function createBullet(\r\n  x: number,\r\n  y: number,\r\n  vx: number,\r\n  vy: number,\r\n  team = TEAM_DEFAULT,\r\n  ownerId: number | null = null,\r\n  damage = 1,\r\n  ttl = 2.0,\r\n): Bullet {\r\n  const b = bulletPool.acquire();\r\n  b.id = genId();\r\n  b.x = x;\r\n  b.y = y;\r\n  b.vx = vx;\r\n  b.vy = vy;\r\n  b.team = team;\r\n  b.ownerId = ownerId;\r\n  b.damage = damage;\r\n  b.ttl = ttl;\r\n  b.prevX = x;\r\n  b.prevY = y;\r\n  b._prevX = x;\r\n  b._prevY = y;\r\n  b.alive = true;\r\n  return b;\r\n}\r\n\r\nexport function releaseBullet(b: Bullet) {\r\n  try {\r\n    b.alive = false;\r\n  } catch {}\r\n  bulletPool.release(b);\r\n}\r\n\r\nexport interface ExplosionEffect {\r\n  x: number;\r\n  y: number;\r\n  r?: number;\r\n  alive?: boolean;\r\n  _pooled?: boolean;\r\n  [key: string]: unknown;\r\n}\r\nexport interface ShieldHitEffect {\r\n  x: number;\r\n  y: number;\r\n  magnitude?: number;\r\n  alive?: boolean;\r\n  _pooled?: boolean;\r\n  [key: string]: unknown;\r\n}\r\nexport interface HealthHitEffect {\r\n  x: number;\r\n  y: number;\r\n  amount?: number;\r\n  alive?: boolean;\r\n  _pooled?: boolean;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport function createExplosionEffect(\r\n  init?: Partial<ExplosionEffect>,\r\n): ExplosionEffect {\r\n  return {\r\n    x: init?.x ?? 0,\r\n    y: init?.y ?? 0,\r\n    r: init?.r,\r\n    alive: true,\r\n    _pooled: false,\r\n    ...init,\r\n  };\r\n}\r\nexport function resetExplosionEffect(\r\n  obj: ExplosionEffect,\r\n  init?: Partial<ExplosionEffect>,\r\n) {\r\n  obj.x = init?.x ?? 0;\r\n  obj.y = init?.y ?? 0;\r\n  obj.r = init?.r;\r\n  obj.alive = true;\r\n  obj._pooled = false;\r\n  Object.assign(obj, init);\r\n}\r\nexport function createShieldHitEffect(\r\n  init?: Partial<ShieldHitEffect>,\r\n): ShieldHitEffect {\r\n  return {\r\n    x: init?.x ?? 0,\r\n    y: init?.y ?? 0,\r\n    magnitude: init?.magnitude,\r\n    alive: true,\r\n    _pooled: false,\r\n    ...init,\r\n  };\r\n}\r\nexport function resetShieldHitEffect(\r\n  obj: ShieldHitEffect,\r\n  init?: Partial<ShieldHitEffect>,\r\n) {\r\n  obj.x = init?.x ?? 0;\r\n  obj.y = init?.y ?? 0;\r\n  obj.magnitude = init?.magnitude;\r\n  obj.alive = true;\r\n  obj._pooled = false;\r\n  Object.assign(obj, init);\r\n}\r\nexport function createHealthHitEffect(\r\n  init?: Partial<HealthHitEffect>,\r\n): HealthHitEffect {\r\n  return {\r\n    x: init?.x ?? 0,\r\n    y: init?.y ?? 0,\r\n    amount: init?.amount,\r\n    alive: true,\r\n    _pooled: false,\r\n    ...init,\r\n  };\r\n}\r\nexport function resetHealthHitEffect(\r\n  obj: HealthHitEffect,\r\n  init?: Partial<HealthHitEffect>,\r\n) {\r\n  obj.x = init?.x ?? 0;\r\n  obj.y = init?.y ?? 0;\r\n  obj.amount = init?.amount;\r\n  obj.alive = true;\r\n  obj._pooled = false;\r\n  Object.assign(obj, init);\r\n}\r\n\r\nimport type { PoolEntry, TexturePoolEntry } from \"./types/pool\";\r\n// Provide a default initial GameState for simulation and tests\r\nexport function makeInitialState(): GameState {\r\n  return {\r\n    t: 0,\r\n    ships: [],\r\n    // fast lookup map kept in sync with ships[] where possible\r\n    shipMap: new Map<number, Ship>(),\r\n    // Cached counts per team to avoid per-frame filter allocations\r\n    teamCounts: { red: 0, blue: 0 },\r\n    bullets: [],\r\n    explosions: [],\r\n    shieldHits: [],\r\n    healthHits: [],\r\n    // optional event arrays used by GameState contract\r\n    particles: [],\r\n    flashes: [],\r\n    shieldFlashes: [],\r\n    healthFlashes: [],\r\n    engineTrailsEnabled: true,\r\n    assetPool: {\r\n      textures: new Map<string, PoolEntry<WebGLTexture>>(),\r\n      sprites: new Map<string, PoolEntry<any>>(),\r\n      effects: new Map<string, PoolEntry<any>>(),\r\n      counts: {\r\n        textures: new Map<string, number>(),\r\n        sprites: new Map<string, number>(),\r\n        effects: new Map<string, number>(),\r\n      },\r\n      config: {\r\n        texturePoolSize: 128,\r\n        spritePoolSize: 256,\r\n        effectPoolSize: 128,\r\n        textureOverflowStrategy: \"discard-oldest\",\r\n        spriteOverflowStrategy: \"discard-oldest\",\r\n        effectOverflowStrategy: \"discard-oldest\",\r\n      },\r\n    },\r\n  };\r\n}\r\n\r\n// Update team counts safely. oldTeam/newTeam may be undefined when adding or removing.\r\nexport function updateTeamCount(\r\n  state: GameState,\r\n  oldTeam?: string,\r\n  newTeam?: string,\r\n) {\r\n  try {\r\n    if (oldTeam) {\r\n      state.teamCounts[oldTeam] = Math.max(\r\n        0,\r\n        (state.teamCounts[oldTeam] || 0) - 1,\r\n      );\r\n    }\r\n    if (newTeam) {\r\n      state.teamCounts[newTeam] = (state.teamCounts[newTeam] || 0) + 1;\r\n    }\r\n  } catch (e) {}\r\n}\r\n", "export const EVASIVE_DURATION = 0.8; // seconds\r\nexport const TURN_RATES = { default: 4.0 } as const; // radians per second typical turn rate\r\nexport const EVASIVE_THRUST_MULT = 1.5; // multiplier for thrust during evasive maneuvers\r\nexport const SEPARATION_MULT = 0.6; // separation force multiplier between ships\r\n\r\n// AI logic thresholds and decision timer\r\nexport const AI_THRESHOLDS = {\r\n  decisionTimerMin: 0.5,\r\n  decisionTimerMax: 2.0,\r\n  hpEvadeThreshold: 0.35,\r\n  randomLow: 0.15,\r\n  randomHigh: 0.85,\r\n};\r\n\r\n// Ship movement global defaults (used if not per-ship)\r\nexport const SHIP_MOVEMENT_DEFAULTS = {\r\n  maxSpeed: 160,\r\n  maxAccel: 5,\r\n};\r\n\r\nexport default {\r\n  EVASIVE_DURATION,\r\n  TURN_RATES,\r\n  EVASIVE_THRUST_MULT,\r\n  SEPARATION_MULT,\r\n  AI_THRESHOLDS,\r\n  SHIP_MOVEMENT_DEFAULTS,\r\n};\r\n", "// behavior.ts - deterministic, simple AI for steering and firing\r\n// Uses seeded RNG for any randomness so results are reproducible.\r\nimport { srandom, srange } from \"./rng\";\r\nimport { createBullet } from \"./entities\";\r\nimport { acquireBullet } from \"./gamemanager\";\r\nimport { AI_THRESHOLDS, SHIP_MOVEMENT_DEFAULTS } from \"./config/behaviorConfig\";\r\nimport { BULLET_DEFAULTS } from \"./config/entitiesConfig\";\r\nimport { TEAM_DEFAULT } from \"./config/teamsConfig\";\r\n\r\ntype ShipLike = {\r\n  id?: number;\r\n  x?: number;\r\n  y?: number;\r\n  vx?: number;\r\n  vy?: number;\r\n  team?: string;\r\n  hp?: number;\r\n  maxHp?: number;\r\n  cannons?: any[];\r\n  accel?: number; // max acceleration from config\r\n  currentAccel?: number; // dynamic, set by AI/gamemanager, 0..accel\r\n  radius?: number;\r\n  turnRate?: number;\r\n  damage?: number;\r\n  dmg?: number;\r\n  maxSpeed?: number; // NEW: max speed per ship\r\n  steering?: number; // NEW: steering intent (-1..1)\r\n  throttle?: number; // NEW: throttle intent (0..1)\r\n  __ai?: any;\r\n  turrets?: any[];\r\n  angle?: number;\r\n  type?: string; // Added for config sync\r\n};\r\n\r\nimport type { GameState } from \"./types\";\r\nimport { getDefaultBounds } from \"./config/simConfig\";\r\ntype State = GameState;\r\n\r\nfunction len2(vx: number, vy: number) {\r\n  return vx * vx + vy * vy;\r\n}\r\nconst DEFAULT_BULLET_RANGE =\r\n  // Guard against undefined export in certain CJS/ESM interop paths\r\n  typeof (BULLET_DEFAULTS as any)?.range === \"number\"\r\n    ? (BULLET_DEFAULTS as any).range\r\n    : 300;\r\n\r\n// Local safe accessor for bullet defaults to avoid hard crashes when the\r\n// named export is unavailable due to module interop differences in tests.\r\nfunction getBulletDefaultsSafe() {\r\n  const fallback = { damage: 1, ttl: 2.0, radius: 1.5, muzzleSpeed: 24, range: 300 } as const;\r\n  // If BULLET_DEFAULTS is an object, use it; otherwise use fallback.\r\n  const src: any = BULLET_DEFAULTS as any;\r\n  return (src && typeof src === \"object\") ? src : (fallback as any);\r\n}\r\nfunction withinRange(\r\n  sx: number,\r\n  sy: number,\r\n  tx: number,\r\n  ty: number,\r\n  range: number,\r\n) {\r\n  const dx = tx - sx;\r\n  const dy = ty - sy;\r\n  return dx * dx + dy * dy <= range * range;\r\n}\r\nfunction clampSpeed(s: ShipLike, max: number) {\r\n  const v2 = len2(s.vx || 0, s.vy || 0);\r\n\r\n  const max2 = max * max;\r\n  if (v2 > max2 && v2 > 0) {\r\n    const inv = max / Math.sqrt(v2);\r\n    s.vx = (s.vx || 0) * inv;\r\n    s.vy = (s.vy || 0) * inv;\r\n  }\r\n}\r\n\r\nexport { clampSpeed };\r\n\r\nfunction aimWithSpread(from: ShipLike, to: ShipLike, spread = 0) {\r\n  let dx = (to.x || 0) - (from.x || 0);\r\n  let dy = (to.y || 0) - (from.y || 0);\r\n  const d = Math.hypot(dx, dy) || 1;\r\n  dx /= d;\r\n  dy /= d;\r\n  if (spread > 0) {\r\n    const ang = Math.atan2(dy, dx);\r\n    const jitter = srange(-spread, spread);\r\n    const na = ang + jitter;\r\n    return { x: Math.cos(na), y: Math.sin(na) };\r\n  }\r\n  return { x: dx, y: dy };\r\n}\r\n\r\nfunction tryFire(state: State, ship: ShipLike, target: ShipLike, dt: number) {\r\n  // Legacy cannons (single target, all fire at once)\r\n  if (Array.isArray(ship.cannons) && ship.cannons.length > 0) {\r\n    for (const c of ship.cannons) {\r\n      if (typeof c.__cd !== \"number\") c.__cd = 0;\r\n      c.__cd -= dt;\r\n      if (c.__cd > 0) continue;\r\n      const range =\r\n        typeof c.range === \"number\" ? c.range : DEFAULT_BULLET_RANGE;\r\n      if (\r\n        !withinRange(\r\n          ship.x || 0,\r\n          ship.y || 0,\r\n          target.x || 0,\r\n          target.y || 0,\r\n          range,\r\n        )\r\n      )\r\n        continue;\r\n      const spread = typeof c.spread === \"number\" ? c.spread : 0;\r\n      const dir = aimWithSpread(ship, target, spread);\r\n      const speed =\r\n        typeof c.muzzleSpeed === \"number\"\r\n          ? c.muzzleSpeed\r\n          : getBulletDefaultsSafe().muzzleSpeed;\r\n      const dmg =\r\n        typeof c.damage === \"number\"\r\n          ? c.damage\r\n          : typeof ship.damage === \"number\"\r\n            ? ship.damage\r\n            : typeof ship.dmg === \"number\"\r\n              ? ship.dmg\r\n              : getBulletDefaultsSafe().damage;\r\n      const ttl =\r\n        typeof c.bulletTTL === \"number\" ? c.bulletTTL : getBulletDefaultsSafe().ttl;\r\n      const radius =\r\n        typeof c.bulletRadius === \"number\"\r\n          ? c.bulletRadius\r\n          : getBulletDefaultsSafe().radius;\r\n      const vx = dir.x * speed;\r\n      const vy = dir.y * speed;\r\n      const b = Object.assign(\r\n        acquireBullet(state, {\r\n          x: ship.x || 0,\r\n          y: ship.y || 0,\r\n          vx,\r\n          vy,\r\n          team: ship.team || TEAM_DEFAULT,\r\n          ownerId: ship.id || null,\r\n          damage: dmg,\r\n          ttl,\r\n        }),\r\n        { radius },\r\n      );\r\n      const rate = typeof c.rate === \"number\" && c.rate > 0 ? c.rate : 1;\r\n      c.__cd = 1 / rate;\r\n    }\r\n  }\r\n  // Multi-turret support: each turret fires independently\r\n  if (Array.isArray(ship.turrets) && ship.turrets.length > 0) {\r\n    for (const [i, turret] of ship.turrets.entries()) {\r\n      if (!turret) continue;\r\n      if (typeof turret.__cd !== \"number\") turret.__cd = 0;\r\n      turret.__cd -= dt;\r\n      if (turret.__cd > 0) continue;\r\n      // Target selection per turret\r\n      let turretTarget: ShipLike | null = null;\r\n      if (turret.targeting === \"nearest\") {\r\n        const enemies = (state.ships || []).filter(\r\n          (sh) => sh && sh.team !== ship.team,\r\n        );\r\n        let minDist = Infinity;\r\n        for (const enemy of enemies) {\r\n          const dx = (enemy.x || 0) - (ship.x || 0);\r\n          const dy = (enemy.y || 0) - (ship.y || 0);\r\n          const d2 = dx * dx + dy * dy;\r\n          if (d2 < minDist) {\r\n            minDist = d2;\r\n            turretTarget = enemy;\r\n          }\r\n        }\r\n      } else if (turret.targeting === \"random\") {\r\n        const enemies = (state.ships || []).filter(\r\n          (sh) => sh && sh.team !== ship.team,\r\n        );\r\n        if (enemies.length)\r\n          turretTarget = enemies[Math.floor(srandom() * enemies.length)];\r\n      } else if (turret.targeting === \"focus\") {\r\n        // Use ship's main target if available (O(1) via shipMap)\r\n        if (ship.__ai && ship.__ai.targetId != null) {\r\n          const tId = ship.__ai.targetId as number | string | null;\r\n          turretTarget =\r\n            (state as any).shipMap && typeof tId !== \"undefined\" && tId !== null\r\n              ? (state as any).shipMap.get(Number(tId)) || null\r\n              : (state.ships || []).find((sh) => sh && sh.id === tId) || null;\r\n        }\r\n      } else {\r\n        // Default: nearest\r\n        const enemies = (state.ships || []).filter(\r\n          (sh) => sh && sh.team !== ship.team,\r\n        );\r\n        let minDist = Infinity;\r\n        for (const enemy of enemies) {\r\n          const dx = (enemy.x || 0) - (ship.x || 0);\r\n          const dy = (enemy.y || 0) - (ship.y || 0);\r\n          const d2 = dx * dx + dy * dy;\r\n          if (d2 < minDist) {\r\n            minDist = d2;\r\n            turretTarget = enemy;\r\n          }\r\n        }\r\n      }\r\n      if (!turretTarget) continue;\r\n      // Fire from turret position (relative to ship center, using config radius)\r\n      const spread =\r\n        typeof turret.spread === \"number\"\r\n          ? turret.spread\r\n          : 0.05; // default turret spread when not provided\r\n      // Compute turret mount world position and aim from that mount\r\n      const mountPos =\r\n        Array.isArray(turret) && turret.length === 2\r\n          ? turret\r\n          : turret && Array.isArray((turret as any).position)\r\n            ? (turret as any).position\r\n            : [0, 0];\r\n      const [mTx, mTy] = mountPos;\r\n      const shipAngle = ship.angle || 0;\r\n      const configRadiusLocal =\r\n        typeof ship.radius === \"number\" && ship.radius > 0 ? ship.radius : 12;\r\n      const mountX =\r\n        (ship.x || 0) +\r\n        Math.cos(shipAngle) * mTx * configRadiusLocal -\r\n        Math.sin(shipAngle) * mTy * configRadiusLocal;\r\n      const mountY =\r\n        (ship.y || 0) +\r\n        Math.sin(shipAngle) * mTx * configRadiusLocal +\r\n        Math.cos(shipAngle) * mTy * configRadiusLocal;\r\n      const dir = aimWithSpread({ x: mountX, y: mountY }, turretTarget, spread);\r\n      const speed =\r\n        typeof turret.muzzleSpeed === \"number\"\r\n          ? turret.muzzleSpeed\r\n          : getBulletDefaultsSafe().muzzleSpeed;\r\n      const dmg =\r\n        typeof turret.damage === \"number\"\r\n          ? turret.damage\r\n          : typeof ship.damage === \"number\"\r\n            ? ship.damage\r\n            : getBulletDefaultsSafe().damage;\r\n      const ttl =\r\n        typeof turret.bulletTTL === \"number\"\r\n          ? turret.bulletTTL\r\n          : getBulletDefaultsSafe().ttl;\r\n      const radius =\r\n        typeof turret.bulletRadius === \"number\"\r\n          ? turret.bulletRadius\r\n          : getBulletDefaultsSafe().radius;\r\n\r\n      const range =\r\n        typeof turret.range === \"number\" ? turret.range : DEFAULT_BULLET_RANGE;\r\n      const dxT = (turretTarget.x || 0) - mountX;\r\n      const dyT = (turretTarget.y || 0) - mountY;\r\n      if (dxT * dxT + dyT * dyT > range * range) continue;\r\n      const vx = dir.x * speed;\r\n      const vy = dir.y * speed;\r\n      // If turret defines a barrel offset (in local turret coords), spawn from the tip\r\n      let spawnX = mountX;\r\n      let spawnY = mountY;\r\n      const barrelLen =\r\n        turret && typeof (turret as any).barrel === \"number\"\r\n          ? (turret as any).barrel\r\n          : turret && (turret as any).barrel && (turret as any).barrel.length\r\n            ? (turret as any).barrel[0]\r\n            : 0;\r\n      if (barrelLen && barrelLen > 0) {\r\n        // turret world angle: shipAngle + (turret.angle || 0)\r\n        const turretLocalAngle =\r\n          turret && typeof (turret as any).angle === \"number\"\r\n            ? (turret as any).angle\r\n            : 0;\r\n        const turretWorldAngle = shipAngle + turretLocalAngle;\r\n        spawnX = mountX + Math.cos(turretWorldAngle) * barrelLen;\r\n        spawnY = mountY + Math.sin(turretWorldAngle) * barrelLen;\r\n      }\r\n      const b = Object.assign(\r\n        acquireBullet(state, {\r\n          x: spawnX,\r\n          y: spawnY,\r\n          vx,\r\n          vy,\r\n          team: ship.team || TEAM_DEFAULT,\r\n          ownerId: ship.id || null,\r\n          damage: dmg,\r\n          ttl,\r\n        }),\r\n        { radius },\r\n      );\r\n      turret.__cd =\r\n        typeof turret.cooldown === \"number\" && turret.cooldown > 0\r\n          ? turret.cooldown\r\n          : 1.0;\r\n    }\r\n  }\r\n}\r\n\r\nfunction ensureShipAiState(s: ShipLike) {\r\n  if (!s.__ai) {\r\n    s.__ai = { state: \"idle\", decisionTimer: 0, targetId: null };\r\n  }\r\n  return s.__ai;\r\n}\r\n\r\nfunction chooseNewTarget(state: State, ship: ShipLike) {\r\n  const enemies = (state.ships || []).filter(\r\n    (sh) => sh && sh.team !== ship.team,\r\n  );\r\n  if (!enemies.length) return null;\r\n  const idx = Math.floor(srandom() * enemies.length);\r\n  return enemies[idx];\r\n}\r\n\r\nfunction steerAway(\r\n  s: ShipLike,\r\n  tx: number,\r\n  ty: number,\r\n  accel: number,\r\n  dt: number,\r\n) {\r\n  const dx = (s.x || 0) - tx;\r\n  const dy = (s.y || 0) - ty;\r\n  const d = Math.hypot(dx, dy) || 1;\r\n  const nx = dx / d;\r\n  const ny = dy / d;\r\n  s.vx = (s.vx || 0) + nx * accel * dt;\r\n  s.vy = (s.vy || 0) + ny * accel * dt;\r\n}\r\n\r\nexport function applySimpleAI(\r\n  state: State,\r\n  dt: number,\r\n  bounds = getDefaultBounds(),\r\n) {\r\n  if (!state || !Array.isArray(state.ships)) return;\r\n  for (const s of state.ships) {\r\n    const ai = ensureShipAiState(s);\r\n    ai.decisionTimer = Math.max(0, (ai.decisionTimer || 0) - dt);\r\n\r\n    let target: ShipLike | null = null;\r\n    if (ai.targetId != null)\r\n      target =\r\n        (state as any).shipMap &&\r\n        typeof ai.targetId !== \"undefined\" &&\r\n        ai.targetId !== null\r\n          ? (state as any).shipMap.get(Number(ai.targetId)) || null\r\n          : (state.ships || []).find((sh) => sh && sh.id === ai.targetId) ||\r\n            null;\r\n    if (!target) target = chooseNewTarget(state, s);\r\n    if (target) ai.targetId = target.id;\r\n\r\n    // Set throttle and steering dynamically based on intent\r\n    const maxAccel = typeof s.accel === \"number\" ? s.accel : 100;\r\n    const maxSpeed = typeof s.maxSpeed === \"number\" ? s.maxSpeed : 160;\r\n    s.steering = typeof s.steering === \"number\" ? s.steering : 0;\r\n    s.throttle = typeof s.throttle === \"number\" ? s.throttle : 0;\r\n\r\n    if (!target) {\r\n      // Idle: no acceleration, no steering\r\n      s.throttle = 0;\r\n      s.steering = 0;\r\n      ai.state = \"idle\";\r\n    } else {\r\n      if (ai.decisionTimer <= 0) {\r\n        const hpFrac = (s.hp || 0) / Math.max(1, s.maxHp || 1);\r\n        const rnd = srandom();\r\n        if (\r\n          hpFrac < AI_THRESHOLDS.hpEvadeThreshold ||\r\n          rnd < AI_THRESHOLDS.randomLow\r\n        )\r\n          ai.state = \"evade\";\r\n        else if (rnd < AI_THRESHOLDS.randomHigh) ai.state = \"engage\";\r\n        else ai.state = \"idle\";\r\n        ai.decisionTimer =\r\n          AI_THRESHOLDS.decisionTimerMin +\r\n          srandom() *\r\n            (AI_THRESHOLDS.decisionTimerMax - AI_THRESHOLDS.decisionTimerMin);\r\n        // If ship has ready cannons and target is within any cannon's range,\r\n        // prefer engage to make immediate firing deterministic in minimal test states.\r\n        try {\r\n          if (\r\n            ai.state !== \"engage\" &&\r\n            Array.isArray(s.cannons) &&\r\n            s.cannons.length > 0\r\n          ) {\r\n            for (const c of s.cannons) {\r\n              const ready = typeof c.__cd !== \"number\" || c.__cd <= 0;\r\n              const range =\r\n                typeof c.range === \"number\" ? c.range : DEFAULT_BULLET_RANGE;\r\n              if (\r\n                ready &&\r\n                target &&\r\n                withinRange(\r\n                  s.x || 0,\r\n                  s.y || 0,\r\n                  target.x || 0,\r\n                  target.y || 0,\r\n                  range,\r\n                )\r\n              ) {\r\n                ai.state = \"engage\";\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        } catch (e) {}\r\n      }\r\n\r\n      // Calculate desired angle to target\r\n      const dx = (target.x || 0) - (s.x || 0);\r\n      const dy = (target.y || 0) - (s.y || 0);\r\n      // Ensure dx/dy order matches atan2(y, x) convention; atan2(dy, dx)\r\n      const desiredAngle = Math.atan2(dy, dx);\r\n      const currentAngle = typeof s.angle === \"number\" ? s.angle : 0;\r\n      let da = desiredAngle - currentAngle;\r\n      while (da < -Math.PI) da += Math.PI * 2;\r\n      while (da > Math.PI) da -= Math.PI * 2;\r\n      // Normalize steering to -1..1 using config\r\n      const steeringNorm = Math.PI / 2; // could be config if needed\r\n      const steering = Math.max(-1, Math.min(1, da / steeringNorm));\r\n\r\n      if (ai.state === \"engage\") {\r\n        s.throttle = 1;\r\n        s.steering = steering;\r\n        tryFire(state, s, target, dt);\r\n      } else if (ai.state === \"evade\") {\r\n        s.throttle = 0.8; // could be config if needed\r\n        // Steer away from target\r\n        const awayAngle = Math.atan2(\r\n          (s.y || 0) - (target.y || 0),\r\n          (s.x || 0) - (target.x || 0),\r\n        );\r\n        let daAway = awayAngle - currentAngle;\r\n        while (daAway < -Math.PI) daAway += Math.PI * 2;\r\n        while (daAway > Math.PI) daAway -= Math.PI * 2;\r\n        s.steering = Math.max(-1, Math.min(1, daAway / steeringNorm));\r\n      } else {\r\n        s.throttle = 0;\r\n        s.steering = 0;\r\n      }\r\n    }\r\n    clampSpeed(s, maxSpeed);\r\n  }\r\n}\r\n\r\nexport function getShipAiState(ship: ShipLike) {\r\n  if (!ship || !ship.__ai) return null;\r\n  const { targetId, ...rest } = ship.__ai;\r\n  return Object.assign({}, rest);\r\n}\r\n\r\nexport default { applySimpleAI, getShipAiState };\r\n", "// simulate.ts - TypeScript implementation ported from simulate.js\r\nimport { srange, srand, srandom } from \"./rng\";\r\nimport { createShip, updateTeamCount, normalizeTurrets } from \"./entities\";\r\nimport { getRuntimeShipConfigSafe } from \"./config/runtimeConfigResolver\";\r\nimport AssetsConfig from \"./config/assets/assetsConfig\";\r\nimport { progression as progressionCfg } from \"./config/progressionConfig\";\r\nimport { SIM, boundaryBehavior } from \"./config/simConfig\";\r\nimport { clampSpeed } from \"./behavior\";\r\nimport {\r\n  acquireBullet,\r\n  releaseBullet,\r\n  acquireExplosion,\r\n  releaseExplosion,\r\n  acquireShieldHit,\r\n  releaseShieldHit,\r\n  acquireHealthHit,\r\n  releaseHealthHit,\r\n  releaseParticle,\r\n} from \"./gamemanager\";\r\nimport type { GameState } from \"./types\";\r\nimport * as SpatialGridModule from \"./spatialGrid\";\r\n// typed as any to avoid strict import/typing issues in this hotpath\r\nconst SpatialGrid: any =\r\n  (SpatialGridModule as any).default || SpatialGridModule;\r\nconst segmentIntersectsCircle: any = (SpatialGridModule as any)\r\n  .segmentIntersectsCircle;\r\n\r\nexport type Bounds = { W: number; H: number };\r\n\r\n// SIM constants migrated to simConfig.ts\r\n// Use SIM.DT_MS and SIM.MAX_ACC_MS instead\r\n\r\nfunction dist2(a: { x: number; y: number }, b: { x: number; y: number }) {\r\n  const dx = a.x - b.x;\r\n  const dy = a.y - b.y;\r\n  return dx * dx + dy * dy;\r\n}\r\n\r\nexport function simulateStep(\r\n  state: GameState,\r\n  dtSeconds: number,\r\n  bounds: Bounds,\r\n) {\r\n  pruneAll(state, dtSeconds, bounds);\r\n  // Advance time\r\n  state.t = (state.t || 0) + dtSeconds;\r\n\r\n  // Move bullets and handle boundary behavior\r\n  for (let i = (state.bullets || []).length - 1; i >= 0; i--) {\r\n    const b = state.bullets[i];\r\n    // store previous position for swept collision tests (both legacy and\r\n    // internal names). Some compiled code reads _prevX/_prevY while other\r\n    // paths read prevX/prevY; keep them synchronized.\r\n    const prevXVal = typeof b.x === \"number\" ? b.x : 0;\r\n    const prevYVal = typeof b.y === \"number\" ? b.y : 0;\r\n    b.prevX = prevXVal;\r\n    b.prevY = prevYVal;\r\n    (b as any)._prevX = prevXVal;\r\n    (b as any)._prevY = prevYVal;\r\n    b.x += (b.vx || 0) * dtSeconds;\r\n    b.y += (b.vy || 0) * dtSeconds;\r\n    b.ttl = (b.ttl || 0) - dtSeconds;\r\n    let outX = b.x < 0 || b.x >= bounds.W;\r\n    let outY = b.y < 0 || b.y >= bounds.H;\r\n    let outOfBounds = outX || outY;\r\n    let remove = false;\r\n    if (b.ttl <= 0) remove = true;\r\n    else if (outOfBounds) {\r\n      switch (boundaryBehavior.bullets) {\r\n        case \"remove\":\r\n          remove = true;\r\n          break;\r\n        case \"wrap\":\r\n          if (b.x < 0) b.x += bounds.W;\r\n          if (b.x >= bounds.W) b.x -= bounds.W;\r\n          if (b.y < 0) b.y += bounds.H;\r\n          if (b.y >= bounds.H) b.y -= bounds.H;\r\n          break;\r\n        case \"bounce\":\r\n          if (outX) {\r\n            b.vx = -(b.vx || 0);\r\n            b.x = Math.max(0, Math.min(bounds.W, b.x));\r\n          }\r\n          if (outY) {\r\n            b.vy = -(b.vy || 0);\r\n            b.y = Math.max(0, Math.min(bounds.H, b.y));\r\n          }\r\n          break;\r\n      }\r\n    }\r\n    if (remove) {\r\n      try {\r\n        releaseBullet(state, b);\r\n      } catch (e) {}\r\n    }\r\n  }\r\n  // Batched in-place pruning for all high-frequency event arrays\r\n  function pruneAll(state: GameState, dtSeconds: number, bounds: Bounds) {\r\n    // Ensure all event arrays are initialized\r\n    state.particles = state.particles || [];\r\n    state.explosions = state.explosions || [];\r\n    state.shieldHits = state.shieldHits || [];\r\n    state.healthHits = state.healthHits || [];\r\n    state.flashes = state.flashes || [];\r\n    state.shieldFlashes = state.shieldFlashes || [];\r\n    state.healthFlashes = state.healthFlashes || [];\r\n    // Bullets: prune expired/out-of-bounds\r\n    let writeBullet = 0;\r\n    for (let read = 0; read < state.bullets.length; read++) {\r\n      const b = state.bullets[read];\r\n      const prevXVal = typeof b.x === \"number\" ? b.x : 0;\r\n      const prevYVal = typeof b.y === \"number\" ? b.y : 0;\r\n      b.prevX = prevXVal;\r\n      b.prevY = prevYVal;\r\n      (b as any)._prevX = prevXVal;\r\n      (b as any)._prevY = prevYVal;\r\n      b.x += (b.vx || 0) * dtSeconds;\r\n      b.y += (b.vy || 0) * dtSeconds;\r\n      b.ttl = (b.ttl || 0) - dtSeconds;\r\n      let outX = b.x < 0 || b.x >= bounds.W;\r\n      let outY = b.y < 0 || b.y >= bounds.H;\r\n      let outOfBounds = outX || outY;\r\n      let remove = false;\r\n      if (b.ttl <= 0) remove = true;\r\n      else if (outOfBounds) {\r\n        switch (boundaryBehavior.bullets) {\r\n          case \"remove\":\r\n            remove = true;\r\n            break;\r\n          case \"wrap\":\r\n            if (b.x < 0) b.x += bounds.W;\r\n            if (b.x >= bounds.W) b.x -= bounds.W;\r\n            if (b.y < 0) b.y += bounds.H;\r\n            if (b.y >= bounds.H) b.y -= bounds.H;\r\n            break;\r\n          case \"bounce\":\r\n            if (outX) {\r\n              b.vx = -(b.vx || 0);\r\n              b.x = Math.max(0, Math.min(bounds.W, b.x));\r\n            }\r\n            if (outY) {\r\n              b.vy = -(b.vy || 0);\r\n              b.y = Math.max(0, Math.min(bounds.H, b.y));\r\n            }\r\n            break;\r\n        }\r\n      }\r\n      if (!remove) {\r\n        state.bullets[writeBullet++] = b;\r\n      } else {\r\n        releaseBullet(state, b);\r\n      }\r\n    }\r\n    state.bullets.length = writeBullet;\r\n\r\n    // Particles: prune expired\r\n    let writeParticle = 0;\r\n    for (let read = 0; read < state.particles.length; read++) {\r\n      const p = state.particles[read];\r\n      p.life = (p.life || p.ttl || 0) - dtSeconds;\r\n      if (p.life > 0) {\r\n        state.particles[writeParticle++] = p;\r\n      } else {\r\n        releaseParticle(p);\r\n      }\r\n    }\r\n    state.particles.length = writeParticle;\r\n\r\n    // Explosions: prune expired\r\n    let writeExplosion = 0;\r\n    for (let read = 0; read < state.explosions.length; read++) {\r\n      const e = state.explosions[read];\r\n      e.life = (e.life || e.ttl || 0) - dtSeconds;\r\n      if (e.life > 0) {\r\n        state.explosions[writeExplosion++] = e;\r\n      } else {\r\n        releaseExplosion(e);\r\n      }\r\n    }\r\n    state.explosions.length = writeExplosion;\r\n\r\n    // ShieldHits: prune out-of-bounds\r\n    let writeShield = 0;\r\n    for (let read = 0; read < state.shieldHits.length; read++) {\r\n      const sh = state.shieldHits[read];\r\n      if (\r\n        typeof sh.x === \"number\" &&\r\n        typeof sh.y === \"number\" &&\r\n        sh.x >= 0 &&\r\n        sh.x < bounds.W &&\r\n        sh.y >= 0 &&\r\n        sh.y < bounds.H\r\n      ) {\r\n        state.shieldHits[writeShield++] = sh;\r\n      } else {\r\n        releaseShieldHit(sh);\r\n      }\r\n    }\r\n    state.shieldHits.length = writeShield;\r\n\r\n    // HealthHits: prune out-of-bounds\r\n    let writeHealth = 0;\r\n    for (let read = 0; read < state.healthHits.length; read++) {\r\n      const hh = state.healthHits[read];\r\n      if (\r\n        typeof hh.x === \"number\" &&\r\n        typeof hh.y === \"number\" &&\r\n        hh.x >= 0 &&\r\n        hh.x < bounds.W &&\r\n        hh.y >= 0 &&\r\n        hh.y < bounds.H\r\n      ) {\r\n        state.healthHits[writeHealth++] = hh;\r\n      } else {\r\n        releaseHealthHit(hh);\r\n      }\r\n    }\r\n    state.healthHits.length = writeHealth;\r\n  }\r\n\r\n  // Move ships and update heading\r\n  // Precompute parent->fighter count map once per frame to avoid O(N) filters per carrier\r\n  const fighterCountsByParent: Map<number, number> = new Map();\r\n  try {\r\n    for (const sh of state.ships || []) {\r\n      if (sh && sh.parentId && sh.type === \"fighter\") {\r\n        const pid = Number(sh.parentId);\r\n        fighterCountsByParent.set(pid, (fighterCountsByParent.get(pid) || 0) + 1);\r\n      }\r\n    }\r\n  } catch (e) {}\r\n  for (let si = (state.ships || []).length - 1; si >= 0; si--) {\r\n    const s = state.ships[si];\r\n    // --- Physics-based movement ---\r\n    const throttle = typeof s.throttle === \"number\" ? s.throttle : 0;\r\n    const steering = typeof s.steering === \"number\" ? s.steering : 0;\r\n    const accel = typeof s.accel === \"number\" ? s.accel : 0;\r\n    const turnRate = typeof s.turnRate === \"number\" ? s.turnRate : 3;\r\n    const maxSpeed = typeof s.maxSpeed === \"number\" ? s.maxSpeed : 160;\r\n    const angle = typeof s.angle === \"number\" ? s.angle : 0;\r\n\r\n    // Update angle based on steering\r\n    const maxTurn = turnRate * Math.abs(steering) * dtSeconds;\r\n    if (steering !== 0) {\r\n      let a = angle + Math.sign(steering) * maxTurn;\r\n      while (a < -Math.PI) a += Math.PI * 2;\r\n      while (a > Math.PI) a -= Math.PI * 2;\r\n      s.angle = a;\r\n    }\r\n\r\n    // Update velocity based on throttle and angle\r\n    const actualAccel = accel * throttle;\r\n    if (actualAccel > 0) {\r\n      s.vx = (s.vx || 0) + Math.cos(s.angle || 0) * actualAccel * dtSeconds;\r\n      s.vy = (s.vy || 0) + Math.sin(s.angle || 0) * actualAccel * dtSeconds;\r\n    }\r\n\r\n    // Apply friction/damping to velocity (from simConfig)\r\n    const friction = typeof SIM.friction === \"number\" ? SIM.friction : 0.98;\r\n    s.vx = (s.vx || 0) * friction;\r\n    s.vy = (s.vy || 0) * friction;\r\n\r\n    // Clamp speed using shared function\r\n    clampSpeed(s, maxSpeed);\r\n\r\n    // Move ship\r\n    s.x += (s.vx || 0) * dtSeconds;\r\n    s.y += (s.vy || 0) * dtSeconds;\r\n    // Boundary behavior for ships\r\n    const r = typeof s.radius === \"number\" ? s.radius : 12;\r\n    let outX = s.x < -r || s.x > bounds.W + r;\r\n    let outY = s.y < -r || s.y > bounds.H + r;\r\n    let outOfBounds = outX || outY;\r\n    let remove = false;\r\n    if (outOfBounds) {\r\n      switch (boundaryBehavior.ships) {\r\n        case \"remove\":\r\n          remove = true;\r\n          break;\r\n        case \"wrap\":\r\n          if (s.x < -r) s.x += bounds.W + r * 2;\r\n          if (s.x > bounds.W + r) s.x -= bounds.W + r * 2;\r\n          if (s.y < -r) s.y += bounds.H + r * 2;\r\n          if (s.y > bounds.H + r) s.y -= bounds.H + r * 2;\r\n          break;\r\n        case \"bounce\":\r\n          if (outX) {\r\n            s.vx = -(s.vx || 0);\r\n            s.x = Math.max(-r, Math.min(bounds.W + r, s.x));\r\n          }\r\n          if (outY) {\r\n            s.vy = -(s.vy || 0);\r\n            s.y = Math.max(-r, Math.min(bounds.H + r, s.y));\r\n          }\r\n          break;\r\n      }\r\n    }\r\n    if (remove) {\r\n      const rem = state.ships.splice(si, 1);\r\n      if (rem && rem.length) {\r\n        try {\r\n          (state as any).shipMap && (state as any).shipMap.delete(rem[0].id);\r\n        } catch (e) {}\r\n        try {\r\n          if (rem[0] && rem[0].team)\r\n            state.teamCounts[rem[0].team] = Math.max(\r\n              0,\r\n              (state.teamCounts[rem[0].team] || 0) - 1,\r\n            );\r\n        } catch (e) {}\r\n      }\r\n    }\r\n    // --- Turret per-frame integration: advance turret.angle toward targetAngle using turnRate ---\r\n    try {\r\n      // Normalize turret definitions via single helper so tuple shorthand\r\n      // ([x,y]) and object turrets are made consistent across systems before AI\r\n      try {\r\n        normalizeTurrets(s as any);\r\n      } catch (e) {}\r\n      // Basic turret AI: if turret has no explicit targetAngle, aim at nearest enemy ship\r\n      try {\r\n        if (\r\n          Array.isArray(state.ships) &&\r\n          Array.isArray((s as any).turrets) &&\r\n          (s as any).turrets.length\r\n        ) {\r\n          for (let ti = 0; ti < (s as any).turrets.length; ti++) {\r\n            try {\r\n              const t = (s as any).turrets[ti];\r\n              if (!t || Array.isArray(t)) continue; // skip tuple mounts\r\n              // If caller already provided a targetAngle, don't override\r\n              if (typeof t.targetAngle === \"number\") continue;\r\n              // Find nearest enemy ship (team different from s.team)\r\n              let best: any = null;\r\n              let bestDist = Infinity;\r\n              for (const other of state.ships || []) {\r\n                if (!other || other.id === s.id) continue;\r\n                if (other.team === s.team) continue;\r\n                const dx = (other.x || 0) - (s.x || 0);\r\n                const dy = (other.y || 0) - (s.y || 0);\r\n                const d2 = dx * dx + dy * dy;\r\n                if (d2 < bestDist) {\r\n                  bestDist = d2;\r\n                  best = other;\r\n                }\r\n              }\r\n              if (best) {\r\n                // Compute desired world angle from turret mount to target\r\n                const mount = Array.isArray(t.position)\r\n                  ? {\r\n                      x:\r\n                        (Math.cos(s.angle || 0) * t.position[0] -\r\n                          Math.sin(s.angle || 0) * t.position[1]) *\r\n                          (s.radius || 12) +\r\n                        (s.x || 0),\r\n                      y:\r\n                        (Math.sin(s.angle || 0) * t.position[0] +\r\n                          Math.cos(s.angle || 0) * t.position[1]) *\r\n                          (s.radius || 12) +\r\n                        (s.y || 0),\r\n                    }\r\n                  : { x: s.x || 0, y: s.y || 0 };\r\n                const desiredWorld = Math.atan2(\r\n                  (best.y || 0) - mount.y,\r\n                  (best.x || 0) - mount.x,\r\n                );\r\n                // Store targetAngle as local angle relative to ship (so simulate integration uses local space)\r\n                // Store targetAngle as local angle relative to ship (so simulate integration uses local space)\r\n                // Note: ensure we normalize into -PI..PI to avoid opposite-angle miswrap\r\n                let local = desiredWorld - (s.angle || 0);\r\n                while (local < -Math.PI) local += Math.PI * 2;\r\n                while (local > Math.PI) local -= Math.PI * 2;\r\n                t.targetAngle = local;\r\n              }\r\n            } catch (e) {}\r\n          }\r\n        }\r\n      } catch (e) {}\r\n      // Normalize turret definitions via single helper so tuple shorthand\r\n      // ([x,y]) and object turrets are made consistent across systems.\r\n      try {\r\n        normalizeTurrets(s as any);\r\n      } catch (e) {}\r\n      // Ensure per-turret numeric fields and integrate turret angles\r\n      if (Array.isArray((s as any).turrets) && (s as any).turrets.length) {\r\n        const turretDefs = (s as any).turrets;\r\n        for (let ti = 0; ti < turretDefs.length; ti++) {\r\n          try {\r\n            const t = turretDefs[ti];\r\n            if (!t) continue;\r\n            // Ensure numeric fields exist and perform per-turret integration\r\n            t.angle =\r\n              typeof t.angle === \"number\"\r\n                ? t.angle\r\n                : typeof (s as any).turretAngle === \"number\"\r\n                  ? (s as any).turretAngle\r\n                  : s.angle || 0;\r\n            t.targetAngle =\r\n              typeof t.targetAngle === \"number\"\r\n                ? t.targetAngle\r\n                : typeof t.desiredAngle === \"number\"\r\n                  ? t.desiredAngle\r\n                  : t.angle;\r\n            // Determine turret turnRate: use instance value, else turretDefaults by kind, else fallback\r\n            let defaultTurn = Math.PI * 1.5;\r\n            try {\r\n              const td =\r\n                (AssetsConfig as any).turretDefaults &&\r\n                (AssetsConfig as any).turretDefaults[t.kind || \"basic\"];\r\n              if (td && typeof td.turnRate === \"number\")\r\n                defaultTurn = td.turnRate;\r\n            } catch (e) {}\r\n            const maxTurn =\r\n              (typeof t.turnRate === \"number\" ? t.turnRate : defaultTurn) *\r\n              dtSeconds;\r\n            // Shortest angular difference\r\n            let diff = t.targetAngle - t.angle;\r\n            while (diff < -Math.PI) diff += Math.PI * 2;\r\n            while (diff > Math.PI) diff -= Math.PI * 2;\r\n            const step = Math.sign(diff) * Math.min(Math.abs(diff), maxTurn);\r\n            t.angle = t.angle + step;\r\n            // Normalize angle into -PI..PI\r\n            while (t.angle < -Math.PI) t.angle += Math.PI * 2;\r\n            while (t.angle > Math.PI) t.angle -= Math.PI * 2;\r\n            turretDefs[ti] = t;\r\n          } catch (e) {}\r\n        }\r\n      }\r\n    } catch (e) {}\r\n    // Carrier spawning: if this ship type has a carrier config, accumulate\r\n    // a per-ship timer and spawn fighters as children up to maxFighters.\r\n    try {\r\n      // Resolve ship config via centralized, ESM/CJS-safe runtime resolver\r\n      const shipCfg: any = getRuntimeShipConfigSafe();\r\n      const typeCfg = shipCfg && s.type ? shipCfg[s.type] : undefined;\r\n      // Treat ships explicitly typed as 'carrier' as carrier-capable even if config missing\r\n      if (s.type === \"carrier\" || (typeCfg && (typeCfg as any).carrier)) {\r\n        const carrierCfg = (typeCfg && (typeCfg as any).carrier) || {\r\n          fighterCooldown: 1.5,\r\n          maxFighters: 6,\r\n          spawnPerCooldown: 2,\r\n        };\r\n        // ensure timer exists\r\n        (s as any)._carrierTimer = (s as any)._carrierTimer || 0;\r\n        (s as any)._carrierTimer += dtSeconds;\r\n        const cooldown = Number(carrierCfg.fighterCooldown) || 1.5;\r\n        if ((s as any)._carrierTimer >= cooldown) {\r\n          (s as any)._carrierTimer = 0;\r\n          // use precomputed count map instead of per-carrier filter\r\n          const existing = fighterCountsByParent.get(s.id) || 0;\r\n          const maxF = Number(carrierCfg.maxFighters) || 0;\r\n          const spawnPer = Number(carrierCfg.spawnPerCooldown) || 1;\r\n          const canSpawn = Math.max(0, maxF - existing);\r\n          let toSpawn = Math.min(canSpawn, spawnPer);\r\n          while (toSpawn > 0) {\r\n            const angle = srandom() * Math.PI * 2;\r\n            const dist = (s.radius || 20) + 8 + srandom() * 8;\r\n            const nx = (s.x || 0) + Math.cos(angle) * dist;\r\n            const ny = (s.y || 0) + Math.sin(angle) * dist;\r\n            try {\r\n              const f = createShip(\"fighter\", nx, ny, s.team);\r\n              f.parentId = s.id;\r\n              f.angle = s.angle;\r\n              (state.ships ||= []).push(f);\r\n              // update cached fighter count for this parent\r\n              fighterCountsByParent.set(s.id, (fighterCountsByParent.get(s.id) || 0) + 1);\r\n              try {\r\n                (state as any).shipMap && (state as any).shipMap.set(f.id, f);\r\n              } catch (e) {}\r\n              try {\r\n                updateTeamCount(state as any, undefined, String(f.team));\r\n              } catch (e) {}\r\n            } catch (e) {}\r\n            toSpawn--;\r\n          }\r\n        }\r\n      }\r\n    } catch (e) {}\r\n  }\r\n\r\n  // Bullet collisions\r\n  // Use spatial grid to reduce collision checks from O(N*M) to local queries\r\n  // Acquire a pooled grid instance and reuse it between frames to avoid allocations\r\n  const cellSize = (SIM && (SIM as any).gridCellSize) || 64;\r\n  const grid = SpatialGrid.acquire(cellSize);\r\n  const ships = state.ships || [];\r\n  for (let i = 0; i < ships.length; i++) grid.insert(ships[i]);\r\n  // Track ships removed during collision processing to avoid double-collision\r\n  const removedShipIds = new Set<any>();\r\n\r\n  for (let bi = (state.bullets || []).length - 1; bi >= 0; bi--) {\r\n    const b = state.bullets[bi];\r\n    const searchRadius = (b.radius || 1) + 64; // conservative search radius (cell-sized)\r\n    const candidates = grid.queryRadius(b.x || 0, b.y || 0, searchRadius);\r\n    let collided = false;\r\n    for (let ci = 0; ci < candidates.length; ci++) {\r\n      const s = candidates[ci];\r\n      if (!s || removedShipIds.has(s.id)) continue;\r\n      if (s.team === b.team) continue;\r\n      const r = (s.radius || 6) + (b.radius || 1);\r\n      // Swept collision: check segment from previous bullet pos (if available) to current pos\r\n      const bxPrev =\r\n        typeof (b as any)._prevX === \"number\"\r\n          ? (b as any)._prevX\r\n          : b.x - (b.vx || 0) * dtSeconds;\r\n      const byPrev =\r\n        typeof (b as any)._prevY === \"number\"\r\n          ? (b as any)._prevY\r\n          : b.y - (b.vy || 0) * dtSeconds;\r\n      const didHit =\r\n        dist2(b, s) <= r * r ||\r\n        segmentIntersectsCircle(\r\n          bxPrev,\r\n          byPrev,\r\n          b.x || 0,\r\n          b.y || 0,\r\n          s.x || 0,\r\n          s.y || 0,\r\n          r,\r\n        );\r\n      if (didHit) {\r\n        const attacker =\r\n          typeof b.ownerId === \"number\" || typeof b.ownerId === \"string\"\r\n            ? (state as any).shipMap &&\r\n              (state as any).shipMap.get(Number(b.ownerId))\r\n            : (undefined as any);\r\n        let dealtToShield = 0;\r\n        let dealtToHealth = 0;\r\n        const shield = s.shield || 0;\r\n        if (shield > 0) {\r\n          const absorbed = Math.min(shield, b.damage || 0);\r\n          s.shield = shield - absorbed;\r\n          const hitAngle = Math.atan2(\r\n            (b.y || 0) - (s.y || 0),\r\n            (b.x || 0) - (s.x || 0),\r\n          );\r\n          (state.shieldHits ||= []).push(\r\n            acquireShieldHit(state, {\r\n              id: s.id,\r\n              x: b.x,\r\n              y: b.y,\r\n              team: s.team,\r\n              amount: absorbed,\r\n              hitAngle,\r\n            }),\r\n          );\r\n          // expose damage event for renderer (shield hit)\r\n          (state.damageEvents ||= []).push({\r\n            id: s.id,\r\n            type: \"shield\",\r\n            amount: absorbed,\r\n            x: b.x,\r\n            y: b.y,\r\n            team: s.team,\r\n            attackerId: attacker && attacker.id,\r\n          });\r\n          const remaining = (b.damage || 0) - absorbed;\r\n          if (remaining > 0) {\r\n            // Apply armor reduction to damage dealt to hull. Each armor point\r\n            // reduces incoming hull damage by 10% (config uses small integers).\r\n            const armor = s.armor || 0;\r\n            const dmgMul = Math.max(0, 1 - 0.1 * armor);\r\n            const dealt = Math.max(0, remaining * dmgMul);\r\n            s.hp -= dealt;\r\n            (state.healthHits ||= []).push(\r\n              acquireHealthHit(state, {\r\n                id: s.id,\r\n                x: b.x,\r\n                y: b.y,\r\n                team: s.team,\r\n                amount: dealt,\r\n              }),\r\n            );\r\n            // expose damage event for renderer (health hit)\r\n            (state.damageEvents ||= []).push({\r\n              id: s.id,\r\n              type: \"hp\",\r\n              amount: dealt,\r\n              x: b.x,\r\n              y: b.y,\r\n              team: s.team,\r\n              attackerId: attacker && attacker.id,\r\n            });\r\n          }\r\n          dealtToShield = absorbed;\r\n          // remaining damage after shields, reduced by armor\r\n          const remainingAfterShield = Math.max(0, (b.damage || 0) - absorbed);\r\n          const armorAfterShield = s.armor || 0;\r\n          dealtToHealth = Math.max(\r\n            0,\r\n            remainingAfterShield * Math.max(0, 1 - 0.1 * armorAfterShield),\r\n          );\r\n        } else {\r\n          // No shields - apply armor reduction directly to bullet damage\r\n          const armor = s.armor || 0;\r\n          const dmgMulNoShield = Math.max(0, 1 - 0.1 * armor);\r\n          const dealtNoShield = Math.max(0, (b.damage || 0) * dmgMulNoShield);\r\n          s.hp -= dealtNoShield;\r\n          (state.healthHits ||= []).push(\r\n            acquireHealthHit(state, {\r\n              id: s.id,\r\n              x: b.x,\r\n              y: b.y,\r\n              team: s.team,\r\n              amount: dealtNoShield,\r\n            }),\r\n          );\r\n          // expose damage event for renderer (health hit)\r\n          (state.damageEvents ||= []).push({\r\n            id: s.id,\r\n            type: \"hp\",\r\n            amount: dealtNoShield,\r\n            x: b.x,\r\n            y: b.y,\r\n            team: s.team,\r\n            attackerId: attacker && attacker.id,\r\n          });\r\n          dealtToHealth = dealtNoShield;\r\n        }\r\n\r\n        // Update percent fields for renderer convenience\r\n        s.hpPercent = Math.max(0, Math.min(1, (s.hp || 0) / (s.maxHp || 1)));\r\n        s.shieldPercent =\r\n          typeof s.maxShield === \"number\" && s.maxShield > 0\r\n            ? Math.max(0, Math.min(1, (s.shield || 0) / s.maxShield))\r\n            : 0;\r\n        // XP for damage\r\n        if (attacker) {\r\n          attacker.xp =\r\n            (attacker.xp || 0) +\r\n            (dealtToShield + dealtToHealth) * (progressionCfg.xpPerDamage || 0);\r\n          while (\r\n            (attacker.xp || 0) >= progressionCfg.xpToLevel(attacker.level || 1)\r\n          ) {\r\n            attacker.xp -= progressionCfg.xpToLevel(attacker.level || 1);\r\n            attacker.level = (attacker.level || 1) + 1;\r\n            // Support function or number scalars for progression\r\n            const resolveScalar = (s: any, lvl: number) =>\r\n              typeof s === \"function\" ? s(lvl) : s || 0;\r\n            const lvl = attacker.level || 1;\r\n            const hpScalar = resolveScalar(\r\n              progressionCfg.hpPercentPerLevel,\r\n              lvl,\r\n            );\r\n            const shScalar = resolveScalar(\r\n              progressionCfg.shieldPercentPerLevel,\r\n              lvl,\r\n            );\r\n            const dmgScalar = resolveScalar(\r\n              progressionCfg.dmgPercentPerLevel,\r\n              lvl,\r\n            );\r\n            const speedScalar = resolveScalar(\r\n              (progressionCfg as any).speedPercentPerLevel,\r\n              lvl,\r\n            );\r\n            const regenScalar = resolveScalar(\r\n              (progressionCfg as any).regenPercentPerLevel,\r\n              lvl,\r\n            );\r\n\r\n            const hpMul = 1 + hpScalar;\r\n            const shMul = 1 + shScalar;\r\n            const dmgMul = 1 + dmgScalar;\r\n\r\n            attacker.maxHp = (attacker.maxHp || 0) * hpMul;\r\n            attacker.hp = Math.min(attacker.maxHp, (attacker.hp || 0) * hpMul);\r\n            if (typeof attacker.maxShield === \"number\") {\r\n              attacker.maxShield = (attacker.maxShield || 0) * shMul;\r\n              attacker.shield = Math.min(\r\n                attacker.maxShield,\r\n                (attacker.shield || 0) * shMul,\r\n              );\r\n            }\r\n            if (Array.isArray(attacker.cannons)) {\r\n              for (const c of attacker.cannons) {\r\n                if (typeof c.damage === \"number\") c.damage *= dmgMul;\r\n              }\r\n            }\r\n            // Apply optional speed and shield regen increases\r\n            if (\r\n              typeof speedScalar === \"number\" &&\r\n              typeof attacker.accel === \"number\"\r\n            )\r\n              attacker.accel = attacker.accel * (1 + speedScalar);\r\n            if (\r\n              typeof regenScalar === \"number\" &&\r\n              typeof attacker.shieldRegen === \"number\"\r\n            )\r\n              attacker.shieldRegen = attacker.shieldRegen * (1 + regenScalar);\r\n          }\r\n        }\r\n\r\n        try {\r\n          releaseBullet(state, b);\r\n        } catch (e) {\r\n          try {\r\n            state.bullets.splice(bi, 1);\r\n          } catch (e) {}\r\n        }\r\n        collided = true;\r\n        // No need to check other candidates for this bullet\r\n        if (s.hp <= 0) {\r\n          if (attacker) {\r\n            attacker.xp = (attacker.xp || 0) + (progressionCfg.xpPerKill || 0);\r\n            while (\r\n              (attacker.xp || 0) >=\r\n              progressionCfg.xpToLevel(attacker.level || 1)\r\n            ) {\r\n              attacker.xp -= progressionCfg.xpToLevel(attacker.level || 1);\r\n              attacker.level = (attacker.level || 1) + 1;\r\n              const resolveScalar = (s: any, lvl: number) =>\r\n                typeof s === \"function\" ? s(lvl) : s || 0;\r\n              const lvl = attacker.level || 1;\r\n              const hpScalar = resolveScalar(\r\n                progressionCfg.hpPercentPerLevel,\r\n                lvl,\r\n              );\r\n              const shScalar = resolveScalar(\r\n                progressionCfg.shieldPercentPerLevel,\r\n                lvl,\r\n              );\r\n              const dmgScalar = resolveScalar(\r\n                progressionCfg.dmgPercentPerLevel,\r\n                lvl,\r\n              );\r\n              const speedScalar = resolveScalar(\r\n                (progressionCfg as any).speedPercentPerLevel,\r\n                lvl,\r\n              );\r\n              const regenScalar = resolveScalar(\r\n                (progressionCfg as any).regenPercentPerLevel,\r\n                lvl,\r\n              );\r\n\r\n              const hpMul = 1 + hpScalar;\r\n              const shMul = 1 + shScalar;\r\n              const dmgMul = 1 + dmgScalar;\r\n              attacker.maxHp = (attacker.maxHp || 0) * hpMul;\r\n              attacker.hp = Math.min(\r\n                attacker.maxHp,\r\n                (attacker.hp || 0) * hpMul,\r\n              );\r\n              if (typeof attacker.maxShield === \"number\") {\r\n                attacker.maxShield = (attacker.maxShield || 0) * shMul;\r\n                attacker.shield = Math.min(\r\n                  attacker.maxShield,\r\n                  (attacker.shield || 0) * shMul,\r\n                );\r\n              }\r\n              if (Array.isArray(attacker.cannons)) {\r\n                for (const c of attacker.cannons) {\r\n                  if (typeof c.damage === \"number\") c.damage *= dmgMul;\r\n                }\r\n              }\r\n              if (\r\n                typeof speedScalar === \"number\" &&\r\n                typeof attacker.accel === \"number\"\r\n              )\r\n                attacker.accel = attacker.accel * (1 + speedScalar);\r\n              if (\r\n                typeof regenScalar === \"number\" &&\r\n                typeof attacker.shieldRegen === \"number\"\r\n              )\r\n                attacker.shieldRegen = attacker.shieldRegen * (1 + regenScalar);\r\n            }\r\n          }\r\n          (state.explosions ||= []).push(\r\n            acquireExplosion(state, {\r\n              x: s.x,\r\n              y: s.y,\r\n              team: s.team,\r\n              life: 0.5,\r\n              ttl: 0.5,\r\n            }),\r\n          );\r\n          // remove from ships array and mark as removed for this frame\r\n          const idx = (state.ships || []).findIndex(\r\n            (sh: any) => sh && sh.id === s.id,\r\n          );\r\n          if (idx >= 0) {\r\n            state.ships.splice(idx, 1);\r\n            try {\r\n              (state as any).shipMap && (state as any).shipMap.delete(s.id);\r\n            } catch (e) {}\r\n            try {\r\n              if (s && s.team)\r\n                state.teamCounts[s.team] = Math.max(\r\n                  0,\r\n                  (state.teamCounts[s.team] || 0) - 1,\r\n                );\r\n            } catch (e) {}\r\n          }\r\n          removedShipIds.add(s.id);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n    // continue to next bullet\r\n  }\r\n  // release pooled grid for reuse next frame\r\n  SpatialGrid.release(grid);\r\n\r\n  // Shield regen\r\n  for (const s of state.ships || []) {\r\n    if (s.maxShield)\r\n      s.shield = Math.min(\r\n        s.maxShield,\r\n        (s.shield || 0) + (s.shieldRegen || 0) * dtSeconds,\r\n      );\r\n  }\r\n\r\n  // refresh percent convenience fields after regen\r\n  for (const s of state.ships || []) {\r\n    s.hpPercent = Math.max(0, Math.min(1, (s.hp || 0) / (s.maxHp || 1)));\r\n    s.shieldPercent =\r\n      typeof s.maxShield === \"number\" && s.maxShield > 0\r\n        ? Math.max(0, Math.min(1, (s.shield || 0) / s.maxShield))\r\n        : 0;\r\n  }\r\n\r\n  return state;\r\n}\r\n\r\nexport default { simulateStep };\r\n", "// Enhanced progression with diminishing returns and extra per-level scalars\r\nexport const progression = {\r\n  xpPerDamage: 1,\r\n  xpPerKill: 50,\r\n  xpToLevel: (level: number) => 100 * Math.pow(1.25, level - 1),\r\n  hpPercentPerLevel: (level: number) => Math.min(0.10, 0.05 + 0.05 / Math.sqrt(level)),\r\n  dmgPercentPerLevel: 0.08,\r\n  shieldPercentPerLevel: 0.06,\r\n  speedPercentPerLevel: 0.03,\r\n  regenPercentPerLevel: 0.04,\r\n};\r\n\r\nexport default progression;\r\n", "// Lightweight spatial grid for 2D entity partitioning\r\n// Lightweight spatial grid for 2D entity partitioning\r\nexport default class SpatialGrid {\r\n  private cellSize: number;\r\n  private grid: Map<string, any[]>;\r\n\r\n  // simple pooled instances to avoid per-frame allocations\r\n  // pool keyed by cellSize to avoid reuse mismatch; cap instances per key\r\n  private static _pools: Map<number, SpatialGrid[]> = new Map();\r\n  private static _perKeyCap = 4;\r\n\r\n  static acquire(cellSize: number = 64) {\r\n    const key = cellSize | 0;\r\n    const pool = this._pools.get(key) || [];\r\n    const inst = pool.pop();\r\n    if (inst) {\r\n      inst.cellSize = cellSize;\r\n      return inst;\r\n    }\r\n    return new SpatialGrid(cellSize);\r\n  }\r\n\r\n  static release(inst: SpatialGrid) {\r\n    const key = (inst.cellSize || 64) | 0;\r\n    inst.clear();\r\n    let pool = this._pools.get(key);\r\n    if (!pool) {\r\n      pool = [];\r\n      this._pools.set(key, pool);\r\n    }\r\n    if (pool.length < this._perKeyCap) pool.push(inst);\r\n    // else drop instance and let GC collect\r\n  }\r\n\r\n  constructor(cellSize: number = 64) {\r\n    this.cellSize = cellSize;\r\n    this.grid = new Map();\r\n  }\r\n\r\n  private key(cx: number, cy: number) {\r\n    return cx + \",\" + cy;\r\n  }\r\n\r\n  insert(entity: any) {\r\n    const cx = Math.floor((entity.x || 0) / this.cellSize);\r\n    const cy = Math.floor((entity.y || 0) / this.cellSize);\r\n    const k = this.key(cx, cy);\r\n    let bucket = this.grid.get(k);\r\n    if (!bucket) {\r\n      bucket = [];\r\n      this.grid.set(k, bucket);\r\n    }\r\n    bucket.push(entity);\r\n  }\r\n\r\n  queryRadius(x: number, y: number, radius: number) {\r\n    const minCx = Math.floor((x - radius) / this.cellSize);\r\n    const maxCx = Math.floor((x + radius) / this.cellSize);\r\n    const minCy = Math.floor((y - radius) / this.cellSize);\r\n    const maxCy = Math.floor((y + radius) / this.cellSize);\r\n    const results: any[] = [];\r\n    const seen = new Set<any>();\r\n    for (let cx = minCx; cx <= maxCx; cx++) {\r\n      for (let cy = minCy; cy <= maxCy; cy++) {\r\n        const bucket = this.grid.get(this.key(cx, cy));\r\n        if (!bucket) continue;\r\n        for (const e of bucket) {\r\n          if (!seen.has(e)) {\r\n            seen.add(e);\r\n            results.push(e);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return results;\r\n  }\r\n\r\n  // clear internal storage for reuse\r\n  clear() {\r\n    this.grid.clear();\r\n  }\r\n}\r\n\r\n// Utility: segment-circle intersection test used for swept collisions\r\nexport function segmentIntersectsCircle(\r\n  x1: number,\r\n  y1: number,\r\n  x2: number,\r\n  y2: number,\r\n  cx: number,\r\n  cy: number,\r\n  r: number,\r\n) {\r\n  // Translate so circle at origin\r\n  const dx = x2 - x1;\r\n  const dy = y2 - y1;\r\n  const fx = x1 - cx;\r\n  const fy = y1 - cy;\r\n\r\n  const a = dx * dx + dy * dy;\r\n  const b = 2 * (fx * dx + fy * dy);\r\n  const c = fx * fx + fy * fy - r * r;\r\n\r\n  // Solve quadratic a*t^2 + b*t + c = 0\r\n  let discriminant = b * b - 4 * a * c;\r\n  if (discriminant < 0) return false;\r\n  discriminant = Math.sqrt(discriminant);\r\n  const t1 = (-b - discriminant) / (2 * a);\r\n  const t2 = (-b + discriminant) / (2 * a);\r\n  // If either t within [0,1], segment intersects\r\n  if ((t1 >= 0 && t1 <= 1) || (t2 >= 0 && t2 <= 1)) return true;\r\n  return false;\r\n}\r\n", "// src/createSimWorker.ts - TypeScript helper to create and manage the sim Worker\r\nexport type SimMessage = any;\r\n\r\nexport function createSimWorker(url: string = './simWorker.js') {\r\n  const worker = new Worker(url, { type: 'module' });\r\n  const listeners = new Map<string, (msg: any) => void>();\r\n\r\n  worker.onmessage = (ev: MessageEvent) => {\r\n    const msg = ev.data;\r\n    const cb = listeners.get(msg && msg.type);\r\n    if (cb) cb(msg);\r\n  };\r\n\r\n  return {\r\n    post(msg: SimMessage) { worker.postMessage(msg); },\r\n    on(type: string, cb: (msg: any) => void) { listeners.set(type, cb); },\r\n    terminate() { worker.terminate(); }\r\n  };\r\n}\r\n\r\nexport default createSimWorker;\r\n", "import type { PoolEntry, PoolConfig, Disposer } from '../types/pool';\r\n\r\n// Lightweight PoolManager helpers. These are intentionally small and\r\n// runtime-friendly so they can be used in both renderer and simulation code.\r\n\r\nexport const DEFAULT_CONFIG: PoolConfig = {\r\n  max: undefined,\r\n  strategy: 'discard-oldest',\r\n  min: 0,\r\n};\r\n\r\nfunction _incCount(map: Map<string, number> | undefined, key: string, delta: number) {\r\n  if (!map) return;\r\n  const cur = map.get(key) || 0;\r\n  const next = cur + delta;\r\n  if (next <= 0) map.delete(key);\r\n  else map.set(key, next);\r\n}\r\n\r\nexport function makePoolEntry<T>(opts?: {\r\n  config?: Partial<PoolConfig>;\r\n  disposer?: Disposer<T>;\r\n}): PoolEntry<T> {\r\n  return {\r\n    freeList: [],\r\n    allocated: 0,\r\n    config: Object.assign({}, DEFAULT_CONFIG, opts?.config || {}),\r\n    disposer: opts?.disposer,\r\n  } as PoolEntry<T>;\r\n}\r\n\r\nexport function ensureEntryForKey<T>(\r\n  map: Map<string, PoolEntry<T>>,\r\n  key: string,\r\n  opts?: { config?: Partial<PoolConfig>; disposer?: Disposer<T> },\r\n): PoolEntry<T> {\r\n  let e = map.get(key) as PoolEntry<T> | undefined;\r\n  if (!e) {\r\n    e = makePoolEntry<T>(opts);\r\n    map.set(key, e);\r\n  }\r\n  return e;\r\n}\r\n\r\n// Simple helper to release all freeList items via disposer (if present)\r\n// and clear freeList. Returns number of disposed items.\r\nexport async function clearEntryFreeList<T>(entry: PoolEntry<T>): Promise<number> {\r\n  const list = entry.freeList.splice(0);\r\n  let disposed = 0;\r\n  if (entry.disposer) {\r\n    for (const it of list) {\r\n      await entry.disposer(it);\r\n      disposed++;\r\n    }\r\n  }\r\n  return disposed;\r\n}\r\n\r\n// Generic acquire/release helpers implementing overflow semantics.\r\nexport function acquireItem<T>(params: {\r\n  map: Map<string, PoolEntry<T>>;\r\n  counts?: Map<string, number>;\r\n  key: string;\r\n  createFn: () => T;\r\n  globalMax?: number; // fallback max when entry.config.max not set\r\n  globalStrategy?: PoolConfig['strategy'];\r\n  initFn?: (obj: T, initArgs?: any) => void;\r\n  initArgs?: any;\r\n}): T {\r\n  const { map, counts, key, createFn, globalMax, globalStrategy, initFn, initArgs } = params;\r\n  let entry = map.get(key) as PoolEntry<T> | undefined;\r\n  if (!entry) {\r\n    entry = makePoolEntry<T>({ config: { max: globalMax, strategy: globalStrategy } });\r\n    map.set(key, entry);\r\n  }\r\n  const free = entry.freeList;\r\n  if (free.length) {\r\n    const obj = free.pop()! as T;\r\n    try {\r\n      if (initFn) initFn(obj, initArgs);\r\n      else if (initArgs && typeof obj === 'object') Object.assign(obj as any, initArgs);\r\n    } catch {}\r\n    return obj;\r\n  }\r\n  const max = (entry.config && typeof entry.config.max === 'number') ? entry.config.max : (globalMax ?? Infinity);\r\n  const strategy = entry.config?.strategy ?? globalStrategy ?? 'discard-oldest';\r\n  const total = entry.allocated || (counts ? counts.get(key) || 0 : 0);\r\n  if (total < (max || Infinity) || strategy === 'grow') {\r\n    const e = createFn();\r\n    try {\r\n      if (initFn) initFn(e, initArgs);\r\n      else if (initArgs && typeof e === 'object') Object.assign(e as any, initArgs);\r\n    } catch {}\r\n    entry.allocated = (entry.allocated || 0) + 1;\r\n    if (counts) _incCount(counts, key, 1);\r\n    return e;\r\n  }\r\n  if (strategy === 'error') throw new Error(`Pool exhausted for key \"${key}\" (max=${max})`);\r\n  const e = createFn();\r\n  entry.allocated = (entry.allocated || 0) + 1;\r\n  if (counts) _incCount(counts, key, 1);\r\n  return e;\r\n}\r\n\r\nexport function releaseItem<T>(params: {\r\n  map: Map<string, PoolEntry<T>>;\r\n  counts?: Map<string, number>;\r\n  key: string;\r\n  item: T;\r\n  disposeFn?: (t: T) => void;\r\n  globalMax?: number;\r\n  globalStrategy?: PoolConfig['strategy'];\r\n}) {\r\n  const { map, counts, key, item, disposeFn, globalMax, globalStrategy } = params;\r\n  let entry = map.get(key) as PoolEntry<T> | undefined;\r\n  if (!entry) {\r\n    entry = makePoolEntry<T>({ config: { max: globalMax, strategy: globalStrategy } });\r\n    map.set(key, entry);\r\n  }\r\n  const free = entry.freeList;\r\n  if (!free.includes(item as any)) free.push(item as any);\r\n  const max = (entry.config && typeof entry.config.max === 'number') ? entry.config.max : (globalMax ?? Infinity);\r\n  const strategy = entry.config?.strategy ?? globalStrategy ?? 'discard-oldest';\r\n  if (strategy === 'grow') return;\r\n  const countsMap = counts || undefined;\r\n  while (free.length > (max || Infinity)) {\r\n    const victim = strategy === 'discard-oldest' ? free.shift()! : free.pop()!;\r\n    try {\r\n      if (entry!.disposer) entry!.disposer(victim as any);\r\n      else if (disposeFn) disposeFn(victim as any);\r\n    } catch {}\r\n    if (countsMap) _incCount(countsMap, key, -1);\r\n    entry.allocated = Math.max(0, (entry.allocated || 0) - 1);\r\n  }\r\n  if (strategy === 'error' && free.length > (max || Infinity)) {\r\n    const victim = free.pop()!;\r\n    try {\r\n      if (entry!.disposer) entry!.disposer(victim as any);\r\n      else if (disposeFn) disposeFn(victim as any);\r\n    } catch {}\r\n    if (countsMap) _incCount(countsMap, key, -1);\r\n    entry.allocated = Math.max(0, (entry.allocated || 0) - 1);\r\n  }\r\n}\r\n\r\nexport default {\r\n  DEFAULT_CONFIG,\r\n  makePoolEntry,\r\n  ensureEntryForKey,\r\n  clearEntryFreeList,\r\n};\r\n", "import type { GameState } from \"../types\";\r\nimport { acquireItem, releaseItem } from './PoolManager';\r\n\r\n// PoolEntry and Pooled types\r\nexport type PoolEntry<T> = {\r\n  freeList: T[];\r\n  allocated: number;\r\n  config?: { max?: number; strategy?: \"discard-oldest\" | \"grow\" | \"error\" };\r\n  disposer?: (item: T) => void;\r\n};\r\nexport type TexturePoolEntry = PoolEntry<WebGLTexture>;\r\n\r\nexport interface Pooled<T = Record<string, unknown>> {\r\n  reset?: (initArgs?: Partial<T>) => void;\r\n}\r\n\r\nfunction _getStrategy(v: unknown, def: \"discard-oldest\" | \"grow\" | \"error\") {\r\n  return v === \"grow\" || v === \"error\" || v === \"discard-oldest\"\r\n    ? (v as \"discard-oldest\" | \"grow\" | \"error\")\r\n    : def;\r\n}\r\nfunction _incCount(map: Map<string, number>, key: string, delta: number) {\r\n  const cur = map.get(key) || 0;\r\n  const next = cur + delta;\r\n  if (next <= 0) map.delete(key);\r\n  else map.set(key, next);\r\n}\r\n\r\n// Helper: prefer per-entry config.max if set, otherwise use the named global config\r\nfunction entryConfigOr(state: any, key: string, globalName: 'texturePoolSize' | 'spritePoolSize' | 'effectPoolSize') {\r\n  const poolMap = (globalName === 'texturePoolSize' ? state.assetPool.textures : globalName === 'spritePoolSize' ? state.assetPool.sprites : state.assetPool.effects) as Map<string, PoolEntry<any>>;\r\n  const entry = poolMap && poolMap.get ? poolMap.get(key) : undefined;\r\n  if (entry && entry.config && typeof entry.config.max === 'number') return entry.config.max;\r\n  return state.assetPool.config ? state.assetPool.config[globalName] : undefined;\r\n}\r\n\r\nfunction entryStrategyOr(state: any, key: string, globalName: 'textureOverflowStrategy' | 'spriteOverflowStrategy' | 'effectOverflowStrategy') {\r\n  const poolMap = (globalName === 'textureOverflowStrategy' ? state.assetPool.textures : globalName === 'spriteOverflowStrategy' ? state.assetPool.sprites : state.assetPool.effects) as Map<string, PoolEntry<any>>;\r\n  const entry = poolMap && poolMap.get ? poolMap.get(key) : undefined;\r\n  if (entry && entry.config && entry.config.strategy) return entry.config.strategy;\r\n  return state.assetPool.config ? state.assetPool.config[globalName] : undefined;\r\n}\r\n\r\nexport function makePooled<T extends object>(\r\n  obj: T,\r\n  resetFn?: (obj: T, initArgs?: Partial<T>) => void,\r\n): T & Pooled<T> {\r\n  const o = obj as T & Pooled<T>;\r\n  if (typeof o.reset !== \"function\") {\r\n    if (typeof resetFn === \"function\") {\r\n      o.reset = function (initArgs?: Partial<T>) {\r\n        try {\r\n          resetFn(o, initArgs);\r\n        } catch {}\r\n      };\r\n    } else {\r\n      o.reset = function (initArgs?: Partial<T>) {\r\n        if (initArgs && typeof initArgs === \"object\") Object.assign(o, initArgs);\r\n      };\r\n    }\r\n  }\r\n  return o;\r\n}\r\n\r\nexport type PooledFactory<T extends object> = {\r\n  create: () => T;\r\n  reset?: (obj: T, initArgs?: Partial<T>) => void;\r\n};\r\nexport function createPooledFactory<T extends object>(\r\n  createOrFactory: (() => T) | PooledFactory<T>,\r\n  resetFn?: (obj: T, initArgs?: Partial<T>) => void,\r\n): PooledFactory<T> {\r\n  if (typeof createOrFactory === \"function\")\r\n    return { create: createOrFactory as () => T, reset: resetFn };\r\n  const f = createOrFactory as PooledFactory<T>;\r\n  return { create: f.create, reset: f.reset };\r\n}\r\n\r\n// Ensure state.assetPool shape exists and has sensible defaults\r\nexport function ensureAssetPool(state: any) {\r\n  if (!state) return;\r\n  if (!state.assetPool || typeof state.assetPool !== \"object\") {\r\n    state.assetPool = {\r\n      textures: new Map<string, PoolEntry<WebGLTexture>>(),\r\n      sprites: new Map<string, PoolEntry<any>>(),\r\n      effects: new Map<string, PoolEntry<any>>(),\r\n      counts: {\r\n        textures: new Map<string, number>(),\r\n        sprites: new Map<string, number>(),\r\n        effects: new Map<string, number>(),\r\n      },\r\n      config: {\r\n        texturePoolSize: 128,\r\n        spritePoolSize: 256,\r\n        effectPoolSize: 128,\r\n        textureOverflowStrategy: \"discard-oldest\",\r\n        spriteOverflowStrategy: \"discard-oldest\",\r\n        effectOverflowStrategy: \"discard-oldest\",\r\n      },\r\n    } as any;\r\n  } else {\r\n    state.assetPool.textures = state.assetPool.textures || new Map();\r\n    state.assetPool.sprites = state.assetPool.sprites || new Map();\r\n    state.assetPool.effects = state.assetPool.effects || new Map();\r\n    state.assetPool.counts = state.assetPool.counts || {\r\n      textures: new Map<string, number>(),\r\n      sprites: new Map<string, number>(),\r\n      effects: new Map<string, number>(),\r\n    };\r\n    state.assetPool.config = state.assetPool.config || {\r\n      texturePoolSize: 128,\r\n      spritePoolSize: 256,\r\n      effectPoolSize: 128,\r\n      textureOverflowStrategy: \"discard-oldest\",\r\n      spriteOverflowStrategy: \"discard-oldest\",\r\n      effectOverflowStrategy: \"discard-oldest\",\r\n    };\r\n  }\r\n}\r\n\r\nexport function acquireEffect<T extends object>(\r\n  state: GameState,\r\n  key: string,\r\n  createFn: () => T & Pooled<T>,\r\n  initArgs?: Partial<T>,\r\n): T & Pooled<T> {\r\n  ensureAssetPool(state);\r\n  // Delegate to PoolManager.acquireItem to centralize overflow semantics\r\n  const poolMap = state.assetPool.effects as Map<string, PoolEntry<T & Pooled<T>>>;\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const counts = state.assetPool.counts!.effects as Map<string, number>;\r\n  return acquireItem<T & Pooled<T>>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    createFn: createFn as any,\r\n    globalMax: state.assetPool.config.effectPoolSize,\r\n    globalStrategy: _getStrategy(state.assetPool.config.effectOverflowStrategy, 'discard-oldest'),\r\n    initFn: (obj: T & Pooled<T>, args?: Partial<T>) => {\r\n      try {\r\n        if (typeof obj.reset === 'function') obj.reset(args);\r\n        else if (args && typeof args === 'object') Object.assign(obj as any, args);\r\n      } catch {}\r\n    },\r\n    initArgs,\r\n  }) as T & Pooled<T>;\r\n}\r\n\r\nexport function releaseEffect<T extends object>(\r\n  state: GameState,\r\n  key: string,\r\n  effect: T & Pooled<T>,\r\n  disposeFn?: (e: T) => void,\r\n) {\r\n  ensureAssetPool(state);\r\n  const poolMap = state.assetPool.effects as Map<string, PoolEntry<T & Pooled<T>>>;\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const counts = state.assetPool.counts!.effects as Map<string, number>;\r\n  return releaseItem<T & Pooled<T>>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    item: effect,\r\n    disposeFn: disposeFn as any,\r\n    globalMax: state.assetPool.config.effectPoolSize,\r\n    globalStrategy: _getStrategy(state.assetPool.config.effectOverflowStrategy, 'discard-oldest'),\r\n  });\r\n}\r\n\r\nexport function acquireTexture(\r\n  state: GameState,\r\n  key: string,\r\n  createFn: () => WebGLTexture,\r\n): WebGLTexture {\r\n  ensureAssetPool(state);\r\n  const poolMap = state.assetPool.textures as Map<string, TexturePoolEntry>;\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const counts = state.assetPool.counts!.textures as Map<string, number>;\r\n  return acquireItem<WebGLTexture>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    createFn: createFn as any,\r\n    globalMax: entryConfigOr(state, key, 'texturePoolSize'),\r\n    globalStrategy: entryStrategyOr(state, key, 'textureOverflowStrategy'),\r\n  });\r\n}\r\n\r\nexport function releaseTexture(\r\n  state: GameState,\r\n  key: string,\r\n  tex: WebGLTexture,\r\n  disposeFn?: (t: WebGLTexture) => void,\r\n) {\r\n  ensureAssetPool(state);\r\n  const poolMap = state.assetPool.textures as Map<string, TexturePoolEntry>;\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const counts = state.assetPool.counts!.textures as Map<string, number>;\r\n  return releaseItem<WebGLTexture>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    item: tex,\r\n    disposeFn: disposeFn as any,\r\n    globalMax: entryConfigOr(state, key, 'texturePoolSize'),\r\n    globalStrategy: entryStrategyOr(state, key, 'textureOverflowStrategy'),\r\n  });\r\n}\r\n\r\nexport function acquireSprite<T extends object>(\r\n  state: GameState,\r\n  key: string,\r\n  createFn: () => T & Pooled<T>,\r\n  initArgs?: Partial<T>,\r\n): T & Pooled<T> {\r\n  ensureAssetPool(state);\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const poolMap = state.assetPool.sprites as Map<string, PoolEntry<T & Pooled<T>>>;\r\n  const counts = state.assetPool.counts!.sprites as Map<string, number>;\r\n  return acquireItem<T & Pooled<T>>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    createFn: createFn as any,\r\n    globalMax: state.assetPool.config.spritePoolSize,\r\n    globalStrategy: _getStrategy(state.assetPool.config.spriteOverflowStrategy, 'discard-oldest'),\r\n    initFn: (obj: T & Pooled<T>, args?: Partial<T>) => {\r\n      try {\r\n        if (typeof obj.reset === 'function') obj.reset(args);\r\n        else if (args && typeof args === 'object') Object.assign(obj as any, args);\r\n      } catch {}\r\n    },\r\n    initArgs,\r\n  }) as T & Pooled<T>;\r\n}\r\n\r\nexport function releaseSprite<T extends object>(\r\n  state: GameState,\r\n  key: string,\r\n  sprite: T & Pooled<T>,\r\n  disposeFn?: (s: T) => void,\r\n) {\r\n  ensureAssetPool(state);\r\n  state.assetPool.counts = state.assetPool.counts || { textures: new Map(), sprites: new Map(), effects: new Map() } as any;\r\n  const poolMap = state.assetPool.sprites as Map<string, PoolEntry<T & Pooled<T>>>;\r\n  const counts = state.assetPool.counts!.sprites as Map<string, number>;\r\n  return releaseItem<T & Pooled<T>>({\r\n    map: poolMap,\r\n    counts,\r\n    key,\r\n    item: sprite,\r\n    disposeFn: disposeFn as any,\r\n    globalMax: state.assetPool.config.spritePoolSize,\r\n    globalStrategy: _getStrategy(state.assetPool.config.spriteOverflowStrategy, 'discard-oldest'),\r\n  });\r\n}\r\n\r\nexport default {} as any;\r\n", "export const SHIELD = {\r\n  ttl: 0.4, particleCount: 6, particleTTL: 0.5, particleColor: '#88ccff', particleSize: 2,\r\n  // arcWidth (radians) for shield hit visual/particle spread centered on hitAngle\r\n  // NOTE: Used in assetsConfig.ts visualStateDefaults and renderer logic. If not consumed, consider removing.\r\n  arcWidth: Math.PI / 6, // TODO: Ensure renderer/particle logic uses this or remove if redundant\r\n};\r\n\r\nexport const HEALTH = {\r\n  ttl: 0.6, particleCount: 8, particleTTL: 0.6, particleColor: '#ffb3b3', particleSize: 2.5,\r\n};\r\n\r\nexport const EXPLOSION = {\r\n  particleCount: 30, particleTTL: 1.2, particleColor: '#ffaa33', particleSize: 3, minSpeed: 20, maxSpeed: 140,\r\n  // TODO: Unify particle effect configs with assetsConfig.ts animations for maintainability\r\n};\r\n\r\nexport const FALLBACK_POSITIONS = [\r\n  { x: 100, y: 100, team: 'red' },\r\n  { x: 700, y: 500, team: 'blue' }\r\n];\r\n\r\nexport const STARS = { twinkle: true, redrawInterval: 500, count: 140 };\r\n\r\nexport default { SHIELD, HEALTH, EXPLOSION, STARS, FALLBACK_POSITIONS };\r\n", "// Use shared helper for default ship type\r\nimport { getDefaultShipTypeSafe } from \"./config/runtimeConfigResolver\";\r\n\r\nexport function createGameManager({\r\n  useWorker = false,\r\n  renderer = null,\r\n  seed = 12345,\r\n  createSimWorker: createSimWorkerFactory,\r\n}: any = {}) {\r\n  function _evaluateAndEmit(dt: number) {\r\n    const result = evaluateReinforcement(dt, state, continuousOptions);\r\n    if (result && Array.isArray(result.spawned) && result.spawned.length) {\r\n      lastReinforcement = {\r\n        spawned: result.spawned,\r\n        timestamp: Date.now(),\r\n        options: { ...continuousOptions },\r\n      };\r\n      emit(\"reinforcements\", { spawned: result.spawned });\r\n    }\r\n  }\r\n  let state: GameState = makeInitialState();\r\n  let running = false;\r\n  const listeners = new Map<string, Function[]>();\r\n  const workerReadyCbs: Function[] = [];\r\n  let simWorker: any = null;\r\n  let _workerReadyHandler: Function | null = null;\r\n  let _workerSnapshotHandler: Function | null = null;\r\n  let _pendingRender = false;\r\n  let _workerReinforcementsHandler: Function | null = null;\r\n  let workerReady = false;\r\n  let lastReinforcement: { spawned: any[]; timestamp: number; options: any } = {\r\n    spawned: [],\r\n    timestamp: 0,\r\n    options: {},\r\n  };\r\n  let continuous = false;\r\n  let continuousOptions: any = {};\r\n  let last =\r\n    typeof performance !== \"undefined\" && performance.now\r\n      ? performance.now()\r\n      : Date.now();\r\n  let acc = 0;\r\n  const score = { red: 0, blue: 0 };\r\n  const internal = { state, bounds: SIM.bounds };\r\n\r\n  function emit(type: string, msg: any) {\r\n    emitManagerEvent(listeners, type, msg);\r\n  }\r\n  function on(evt: string, cb: Function) {\r\n    const arr = listeners.get(evt) || [];\r\n    arr.push(cb);\r\n    listeners.set(evt, arr);\r\n  }\r\n  function off(evt: string, cb: Function) {\r\n    const arr = listeners.get(evt) || [];\r\n    const i = arr.indexOf(cb);\r\n    if (i !== -1) arr.splice(i, 1);\r\n  }\r\n  function destroy() {\r\n    running = false;\r\n    try {\r\n      if (simWorker) {\r\n        try {\r\n          if (typeof simWorker.off === \"function\") {\r\n            try {\r\n              if (_workerReadyHandler)\r\n                simWorker.off(\"ready\", _workerReadyHandler);\r\n            } catch (e) {}\r\n            try {\r\n              if (_workerSnapshotHandler)\r\n                simWorker.off(\"snapshot\", _workerSnapshotHandler);\r\n            } catch (e) {}\r\n            try {\r\n              if (_workerReinforcementsHandler)\r\n                simWorker.off(\"reinforcements\", _workerReinforcementsHandler);\r\n            } catch (e) {}\r\n          }\r\n        } catch (e) {}\r\n        try {\r\n          if (typeof simWorker.terminate === \"function\") simWorker.terminate();\r\n          else if (typeof simWorker.close === \"function\") simWorker.close();\r\n          else if (typeof simWorker.post === \"function\")\r\n            simWorker.post({ type: \"stop\" });\r\n        } catch (e) {}\r\n        simWorker = null;\r\n      }\r\n    } catch (e) {}\r\n    workerReady = false;\r\n    workerReadyCbs.length = 0;\r\n  }\r\n  function start() {\r\n    if (!running) {\r\n      running = true;\r\n      last =\r\n        typeof performance !== \"undefined\" && performance.now\r\n          ? performance.now()\r\n          : Date.now();\r\n      runLoop();\r\n    }\r\n  }\r\n  function pause() {\r\n    running = false;\r\n  }\r\n  function resetManager() {\r\n    state = makeInitialState();\r\n    if (simWorker)\r\n      try {\r\n        simWorker.post({ type: \"command\", cmd: \"setState\", args: { state } });\r\n      } catch (e) {}\r\n  }\r\n  function stepOnce(dt = SIM.DT_MS / 1000) {\r\n    const n = Number(dt) || SIM.DT_MS / 1000;\r\n    step(n);\r\n  }\r\n  function step(dtSeconds: number) {\r\n    const clampedDt = Math.min(dtSeconds, 0.05);\r\n    if (!simWorker) {\r\n      try {\r\n        applySimpleAI(state, clampedDt, SIM.bounds);\r\n      } catch (e) {}\r\n      try {\r\n        simulateStep(state, clampedDt, SIM.bounds);\r\n      } catch (e) {}\r\n    } else {\r\n      try {\r\n        simWorker.post && simWorker.post({ type: \"snapshotRequest\" });\r\n      } catch (e) {}\r\n    }\r\n    _evaluateAndEmit(clampedDt);\r\n    // Coalesce renders on main-thread path to at most one RAF per frame\r\n    if (renderer && typeof renderer.renderState === \"function\") {\r\n      try {\r\n        if (!_pendingRender) {\r\n          _pendingRender = true;\r\n          try {\r\n            requestAnimationFrame(() => {\r\n              try {\r\n                renderer.renderState({\r\n                  ships: state.ships,\r\n                  bullets: state.bullets,\r\n                  flashes: state.flashes,\r\n                  shieldFlashes: state.shieldFlashes,\r\n                  healthFlashes: state.healthFlashes,\r\n                  t: state.t,\r\n                });\r\n              } catch (e) {}\r\n              _pendingRender = false;\r\n            });\r\n          } catch (e) {\r\n            setTimeout(() => {\r\n              try {\r\n                renderer.renderState({\r\n                  ships: state.ships,\r\n                  bullets: state.bullets,\r\n                  flashes: state.flashes,\r\n                  shieldFlashes: state.shieldFlashes,\r\n                  healthFlashes: state.healthFlashes,\r\n                  t: state.t,\r\n                });\r\n              } catch (e) {}\r\n              _pendingRender = false;\r\n            }, 0);\r\n          }\r\n        }\r\n      } catch (e) {}\r\n    }\r\n  }\r\n  function runLoop() {\r\n    if (!running) return;\r\n    const now =\r\n      typeof performance !== \"undefined\" && performance.now\r\n        ? performance.now()\r\n        : Date.now();\r\n    acc += now - last;\r\n    last = now;\r\n    if (acc > 250) acc = 250;\r\n    while (acc >= SIM.DT_MS) {\r\n      step(SIM.DT_MS / 1000);\r\n      acc -= SIM.DT_MS;\r\n    }\r\n    try {\r\n      requestAnimationFrame(runLoop);\r\n    } catch (e) {\r\n      setTimeout(runLoop, SIM.DT_MS);\r\n    }\r\n  }\r\n  function setContinuousEnabled(v: boolean = false) {\r\n    continuous = !!v;\r\n    if (simWorker) {\r\n      try {\r\n        simWorker.post({ type: \"setContinuous\", value: !!v });\r\n      } catch (e) {}\r\n    } else {\r\n      if (continuous) {\r\n        const result = evaluateReinforcement(\r\n          SIM.DT_MS / 1000,\r\n          state,\r\n          continuousOptions,\r\n        );\r\n        if (result && Array.isArray(result.spawned) && result.spawned.length) {\r\n          lastReinforcement = {\r\n            spawned: result.spawned,\r\n            timestamp: Date.now(),\r\n            options: { ...continuousOptions },\r\n          };\r\n          emit(\"reinforcements\", { spawned: result.spawned });\r\n        }\r\n      }\r\n    }\r\n  }\r\n  function isContinuousEnabled() {\r\n    return !!continuous;\r\n  }\r\n  function setContinuousOptions(opts: any = {}) {\r\n    continuousOptions = { ...continuousOptions, ...opts };\r\n    if (simWorker)\r\n      try {\r\n        simWorker.post({\r\n          type: \"setContinuousOptions\",\r\n          opts: continuousOptions,\r\n        });\r\n      } catch (e) {}\r\n  }\r\n  function getContinuousOptions() {\r\n    return { ...continuousOptions };\r\n  }\r\n  function setReinforcementIntervalManager(seconds: number) {\r\n    setReinforcementInterval(seconds);\r\n    if (simWorker)\r\n      try {\r\n        simWorker.post({ type: \"setReinforcementInterval\", seconds });\r\n      } catch (e) {}\r\n  }\r\n  function getReinforcementIntervalManager() {\r\n    return getReinforcementInterval();\r\n  }\r\n  function isRunning() {\r\n    return running;\r\n  }\r\n  function isWorker() {\r\n    return !!simWorker && !!workerReady;\r\n  }\r\n  function onWorkerReady(cb: Function) {\r\n    if (typeof cb === \"function\") workerReadyCbs.push(cb);\r\n  }\r\n  function offWorkerReady(cb: Function) {\r\n    const i = workerReadyCbs.indexOf(cb);\r\n    if (i !== -1) workerReadyCbs.splice(i, 1);\r\n  }\r\n  function spawnShip(team: string = \"red\", type?: string) {\r\n    try {\r\n      // Resolve default ship type safely across ESM/CJS; fallback to 'fighter'\r\n      const shipType = type || getDefaultShipTypeSafe();\r\n      const b = SIM.bounds;\r\n      const x = Math.max(0, Math.min(b.W - 1e-6, srandom() * b.W));\r\n      const y = Math.max(0, Math.min(b.H - 1e-6, srandom() * b.H));\r\n      const ship = createShip(shipType, x, y, team);\r\n      state.ships.push(ship);\r\n      try {\r\n        (state as any).shipMap && (state as any).shipMap.set(ship.id, ship);\r\n      } catch (e) {}\r\n      try {\r\n        updateTeamCount(state as any, undefined, String(ship.team));\r\n      } catch (e) {}\r\n      return ship;\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n  function formFleets() {\r\n    try {\r\n      state.ships.length = 0;\r\n      const bounds = SIM.bounds;\r\n      const seedVal = Math.floor(srandom() * 0xffffffff) >>> 0;\r\n      const ships = makeInitialFleets(seedVal, bounds, createShip);\r\n      for (const ship of ships) {\r\n        state.ships.push(ship);\r\n      }\r\n      try {\r\n        normalizeStateShips(state);\r\n      } catch (e) {}\r\n    } catch (e) {}\r\n  }\r\n  function reseedManager(newSeed: number = Math.floor(srandom() * 0xffffffff)) {\r\n    _seed = newSeed >>> 0;\r\n    srand(_seed);\r\n    if (simWorker)\r\n      try {\r\n        simWorker.post({ type: \"setSeed\", seed: _seed });\r\n      } catch (e) {}\r\n  }\r\n  function getLastReinforcement() {\r\n    return { ...lastReinforcement };\r\n  }\r\n  function snapshot() {\r\n    return {\r\n      ships: state.ships.slice(),\r\n      bullets: state.bullets.slice(),\r\n      t: state.t,\r\n      teamCounts: state.teamCounts ? { ...state.teamCounts } : {},\r\n      flashes: state.flashes ? state.flashes.slice() : [],\r\n      shieldFlashes: state.shieldFlashes ? state.shieldFlashes.slice() : [],\r\n      healthFlashes: state.healthFlashes ? state.healthFlashes.slice() : [],\r\n    };\r\n  }\r\n  // Worker setup (optional, not used in current UI)\r\n  try {\r\n    if (useWorker) {\r\n      const factory = createSimWorkerFactory || createSimWorker;\r\n      let simWorkerUrl;\r\n      try {\r\n        simWorkerUrl =\r\n          typeof import.meta !== \"undefined\" && import.meta.url\r\n            ? new URL(\"./simWorker.js\", import.meta.url).href\r\n            : \"./simWorker.js\";\r\n      } catch (e) {\r\n        simWorkerUrl = \"./simWorker.js\";\r\n      }\r\n      simWorker = factory(simWorkerUrl);\r\n      _workerReadyHandler = () => {\r\n        workerReady = true;\r\n        for (const cb of workerReadyCbs.slice()) {\r\n          try {\r\n            cb();\r\n          } catch (e) {}\r\n        }\r\n      };\r\n      simWorker.on && simWorker.on(\"ready\", _workerReadyHandler);\r\n      _workerSnapshotHandler = (m: any) => {\r\n        try {\r\n          if (m && m.state) {\r\n            state = m.state;\r\n            try {\r\n              normalizeStateShips(state);\r\n            } catch (e) {}\r\n            try {\r\n              internal.state = state;\r\n            } catch (e) {}\r\n            // Coalesce render to next RAF so UI updates once per frame\r\n            try {\r\n              if (renderer && typeof renderer.renderState === \"function\") {\r\n                if (!_pendingRender) {\r\n                  _pendingRender = true;\r\n                  try {\r\n                    requestAnimationFrame(() => {\r\n                      try {\r\n                        renderer.renderState({\r\n                          ships: state.ships,\r\n                          bullets: state.bullets,\r\n                          flashes: state.flashes,\r\n                          shieldFlashes: state.shieldFlashes,\r\n                          healthFlashes: state.healthFlashes,\r\n                          t: state.t,\r\n                        });\r\n                      } catch (e) {}\r\n                      _pendingRender = false;\r\n                    });\r\n                  } catch (e) {\r\n                    setTimeout(() => {\r\n                      try {\r\n                        renderer.renderState({\r\n                          ships: state.ships,\r\n                          bullets: state.bullets,\r\n                          flashes: state.flashes,\r\n                          shieldFlashes: state.shieldFlashes,\r\n                          healthFlashes: state.healthFlashes,\r\n                          t: state.t,\r\n                        });\r\n                      } catch (e) {}\r\n                      _pendingRender = false;\r\n                    }, 0);\r\n                  }\r\n                }\r\n              }\r\n            } catch (e) {}\r\n          }\r\n        } catch (e) {}\r\n      };\r\n      simWorker.on && simWorker.on(\"snapshot\", _workerSnapshotHandler);\r\n      _workerReinforcementsHandler = (m: any) => {\r\n        emit(\"reinforcements\", m);\r\n      };\r\n      simWorker.on &&\r\n        simWorker.on(\"reinforcements\", _workerReinforcementsHandler);\r\n      try {\r\n        simWorker.post({\r\n          type: \"init\",\r\n          seed,\r\n          bounds: SIM.bounds,\r\n          simDtMs: SIM.DT_MS,\r\n          state,\r\n        });\r\n        simWorker.post({ type: \"start\" });\r\n      } catch (e) {}\r\n    }\r\n  } catch (e) {\r\n    simWorker = null;\r\n  }\r\n\r\n  return {\r\n    // Allow external callers (tests) to push snapshots into the manager\r\n    onSnapshot: (m: any) => {\r\n      try {\r\n        if (m && m.state) {\r\n          state = m.state;\r\n          try {\r\n            normalizeStateShips(state);\r\n          } catch (e) {}\r\n          try {\r\n            internal.state = state;\r\n          } catch (e) {}\r\n          if (renderer && typeof renderer.renderState === \"function\") {\r\n            try {\r\n              if (!_pendingRender) {\r\n                _pendingRender = true;\r\n                try {\r\n                  requestAnimationFrame(() => {\r\n                    try {\r\n                      renderer.renderState({\r\n                        ships: state.ships,\r\n                        bullets: state.bullets,\r\n                        flashes: state.flashes,\r\n                        shieldFlashes: state.shieldFlashes,\r\n                        healthFlashes: state.healthFlashes,\r\n                        t: state.t,\r\n                      });\r\n                    } catch (e) {}\r\n                    _pendingRender = false;\r\n                  });\r\n                } catch (e) {\r\n                  setTimeout(() => {\r\n                    try {\r\n                      renderer.renderState({\r\n                        ships: state.ships,\r\n                        bullets: state.bullets,\r\n                        flashes: state.flashes,\r\n                        shieldFlashes: state.shieldFlashes,\r\n                        healthFlashes: state.healthFlashes,\r\n                        t: state.t,\r\n                      });\r\n                    } catch (e) {}\r\n                    _pendingRender = false;\r\n                  }, 0);\r\n                }\r\n              }\r\n            } catch (e) {}\r\n          }\r\n        }\r\n      } catch (e) {}\r\n    },\r\n    on,\r\n    off,\r\n    start,\r\n    pause,\r\n    reset: resetManager,\r\n    stepOnce,\r\n    setContinuousEnabled,\r\n    isContinuousEnabled,\r\n    setContinuousOptions,\r\n    getContinuousOptions,\r\n    setReinforcementInterval: setReinforcementIntervalManager,\r\n    getReinforcementInterval: getReinforcementIntervalManager,\r\n    isRunning,\r\n    isWorker,\r\n    onWorkerReady,\r\n    offWorkerReady,\r\n    spawnShip,\r\n    reseed: reseedManager,\r\n    getLastReinforcement,\r\n    snapshot,\r\n    score,\r\n    formFleets,\r\n    destroy,\r\n    _internal: internal,\r\n  };\r\n}\r\n\r\nexport default createGameManager;\r\n// Convenience runtime reset function used by tests (delegates to internal resetManager when using default manager instance)\r\nexport function reset(seed: number | null = null) {\r\n  // Resetting global manager state is test-specific; callers use makeInitialState directly in many tests.\r\n  // Provide a no-op reset to satisfy legacy tests that import reset from the module.\r\n  if (typeof seed === \"number\") {\r\n    try {\r\n      /* reseed global RNG if exposed */\r\n    } catch (e) {}\r\n  }\r\n}\r\nexport function releaseParticle(state: GameState, p?: Particle) {\r\n  if (!p) return;\r\n  const key = \"particle\";\r\n  try {\r\n    releaseEffect(state, key, p, (x) => {\r\n      /* no-op */\r\n    });\r\n  } catch {}\r\n  const idx = (state.particles || []).indexOf(p);\r\n  if (idx !== -1) (state.particles || []).splice(idx, 1);\r\n}\r\n// Minimal TypeScript shim that re-exports the existing JavaScript runtime implementation.\r\n// Import the runtime as a namespace and re-export value bindings to avoid\r\n// circular alias issues. Types are defined in `gamemanager.d.ts`.\r\n\r\n// Ported from gamemanager.js, now canonical TypeScript implementation\r\nimport {\r\n  makeInitialState,\r\n  createShip,\r\n  Ship,\r\n  Bullet,\r\n  genId,\r\n  ExplosionEffect,\r\n  ShieldHitEffect,\r\n  HealthHitEffect,\r\n  createExplosionEffect,\r\n  resetExplosionEffect,\r\n  createShieldHitEffect,\r\n  resetShieldHitEffect,\r\n  createHealthHitEffect,\r\n  resetHealthHitEffect,\r\n  normalizeTurrets,\r\n  normalizeStateShips,\r\n} from \"./entities\";\r\nimport { updateTeamCount } from \"./entities\";\r\nimport { getRuntimeShipConfigSafe } from \"./config/runtimeConfigResolver\";\r\nimport { applySimpleAI } from \"./behavior\";\r\nimport { simulateStep } from \"./simulate\";\r\nimport { SIM } from \"./config/simConfig\";\r\nimport { srand, srandom } from \"./rng\";\r\nimport { createSimWorker } from \"./createSimWorker\";\r\nimport {\r\n  acquireEffect,\r\n  releaseEffect,\r\n  acquireSprite,\r\n  releaseSprite,\r\n  makePooled,\r\n} from \"./pools\";\r\nimport {\r\n  SHIELD,\r\n  HEALTH,\r\n  EXPLOSION,\r\n  STARS,\r\n  FALLBACK_POSITIONS,\r\n} from \"./config/gamemanagerConfig\";\r\nimport type { ShipConfigMap, GameState } from \"./types\";\r\nimport * as EntitiesConfigESM from \"./config/entitiesConfig\";\r\nimport {\r\n  chooseReinforcementsWithManagerSeed,\r\n  makeInitialFleets,\r\n  TeamsConfig,\r\n} from \"./config/teamsConfig\";\r\n\r\n// All runtime arrays are now managed via GameState for determinism and lifecycle control.\r\n// Bullet pooling\r\n// Bullets: support optional GameState-backed pooling. If `state` is provided,\r\n// use state.assetPool.sprites keyed by 'bullet', otherwise fallback to legacy in-memory pool.\r\nexport function acquireBullet(\r\n  state: GameState,\r\n  opts: Partial<Bullet> = {},\r\n): Bullet {\r\n  // Defensive: accept minimal/mocked state objects in tests by ensuring\r\n  // required collections exist. Do not overwrite existing richer assetPool.\r\n  if (!state) state = makeInitialState() as GameState;\r\n  (state as any).bullets = (state as any).bullets || [];\r\n  (state as any).assetPool = (state as any).assetPool || {\r\n    textures: new Map(),\r\n    sprites: new Map(),\r\n    effects: new Map(),\r\n    counts: {\r\n      textures: new Map(),\r\n      sprites: new Map(),\r\n      effects: new Map(),\r\n    },\r\n    config: {\r\n      texturePoolSize: 128,\r\n      spritePoolSize: 256,\r\n      effectPoolSize: 128,\r\n      textureOverflowStrategy: \"discard-oldest\",\r\n      spriteOverflowStrategy: \"discard-oldest\",\r\n      effectOverflowStrategy: \"discard-oldest\",\r\n    },\r\n  };\r\n  // Use state-backed sprite pool keyed by 'bullet'\r\n  const key = \"bullet\";\r\n  const b = acquireSprite(\r\n    state,\r\n    key,\r\n    () =>\r\n      makePooled(\r\n        { ...opts, id: genId(), alive: true } as any,\r\n        (o: any, initArgs?: any) => Object.assign(o, initArgs),\r\n      ),\r\n    opts,\r\n  ) as Bullet & any;\r\n  // push into the state-active array so simulation sees it\r\n  (state.bullets ||= []).push(b as Bullet);\r\n  return b;\r\n}\r\n\r\nexport function releaseBullet(state: GameState, b?: Bullet): void {\r\n  if (!b) return;\r\n  if (!b.alive) return; // Prevent double-free\r\n  b.alive = false;\r\n  // remove from the state's active bullets\r\n  const arr = state.bullets || ([] as Bullet[]);\r\n  const idx = arr.indexOf(b as Bullet);\r\n  if (idx !== -1) arr.splice(idx, 1);\r\n  releaseSprite(state, \"bullet\", b as any, undefined);\r\n}\r\n\r\n// Explosion pooling\r\nexport function acquireExplosion(\r\n  state: GameState,\r\n  opts: Partial<ExplosionEffect> = {},\r\n): ExplosionEffect {\r\n  const key = \"explosion\";\r\n  const e = acquireEffect<ExplosionEffect>(\r\n    state,\r\n    key,\r\n    () => makePooled(createExplosionEffect(opts), resetExplosionEffect),\r\n    opts,\r\n  );\r\n  (state.explosions ||= []).push(e);\r\n  return e;\r\n}\r\n\r\nexport function releaseExplosion(state: GameState, e?: ExplosionEffect) {\r\n  if (!e) return;\r\n  if (e._pooled) return;\r\n  if (!e.alive) return;\r\n  e.alive = false;\r\n  e._pooled = true;\r\n  const arr = state.explosions || ([] as ExplosionEffect[]);\r\n  const idx = arr.indexOf(e);\r\n  if (idx !== -1) arr.splice(idx, 1);\r\n  releaseEffect(state, \"explosion\", e, undefined);\r\n}\r\n\r\n// ShieldHit pooling\r\nexport function acquireShieldHit(\r\n  state: GameState,\r\n  opts: Partial<ShieldHitEffect> = {},\r\n): ShieldHitEffect {\r\n  const key = \"shieldHit\";\r\n  const sh = acquireEffect<ShieldHitEffect>(\r\n    state,\r\n    key,\r\n    () => makePooled(createShieldHitEffect(opts), resetShieldHitEffect),\r\n    opts,\r\n  );\r\n  (state.shieldHits ||= []).push(sh);\r\n  return sh;\r\n}\r\n\r\nexport function releaseShieldHit(state: GameState, sh?: ShieldHitEffect) {\r\n  if (!sh) return;\r\n  if (sh._pooled) return;\r\n  const arr = state.shieldHits || ([] as ShieldHitEffect[]);\r\n  const i = arr.indexOf(sh);\r\n  if (i !== -1) arr.splice(i, 1);\r\n  sh.alive = false;\r\n  sh._pooled = true;\r\n  releaseEffect(state, \"shieldHit\", sh, undefined);\r\n}\r\n\r\n// HealthHit pooling\r\nexport function acquireHealthHit(\r\n  state: GameState,\r\n  opts: Partial<HealthHitEffect> = {},\r\n): HealthHitEffect {\r\n  const key = \"healthHit\";\r\n  const hh = acquireEffect<HealthHitEffect>(\r\n    state,\r\n    key,\r\n    () => makePooled(createHealthHitEffect(opts), resetHealthHitEffect),\r\n    opts,\r\n  );\r\n  (state.healthHits ||= []).push(hh);\r\n  return hh;\r\n}\r\n\r\nexport function releaseHealthHit(state: GameState, hh?: HealthHitEffect) {\r\n  if (!hh) return;\r\n  if (hh._pooled) return;\r\n  const arr = state.healthHits || ([] as HealthHitEffect[]);\r\n  const i = arr.indexOf(hh);\r\n  if (i !== -1) arr.splice(i, 1);\r\n  hh.alive = false;\r\n  hh._pooled = true;\r\n  releaseEffect(state, \"healthHit\", hh, undefined);\r\n}\r\n\r\nexport const config = {\r\n  shield: { ...SHIELD },\r\n  health: { ...HEALTH },\r\n  explosion: { ...EXPLOSION },\r\n  stars: { ...STARS },\r\n};\r\n\r\nlet _seed: number | null = null;\r\nlet _reinforcementInterval: number =\r\n  TeamsConfig.continuousReinforcement?.interval ?? 5.0;\r\nlet _reinforcementAccumulator = 0;\r\nlet _starCanvasVersion = 0;\r\nlet starCanvas: HTMLCanvasElement | null = null;\r\nlet _lastSimulateFrameId: number | null = null;\r\nlet _doubleSimStrict = false;\r\n\r\nexport function setDoubleSimStrict(v: boolean = false) {\r\n  _doubleSimStrict = !!v;\r\n}\r\n\r\nexport class Particle {\r\n  x: number;\r\n  y: number;\r\n  vx: number;\r\n  vy: number;\r\n  ttl: number;\r\n  life: number;\r\n  color: string;\r\n  size: number;\r\n  alive: boolean;\r\n  _pooled?: boolean; // Add pooled flag to prevent double-free\r\n  constructor(x = 0, y = 0, vx = 0, vy = 0, ttl = 1, color = \"#fff\", size = 2) {\r\n    this.x = x;\r\n    this.y = y;\r\n    this.vx = vx;\r\n    this.vy = vy;\r\n    this.ttl = ttl;\r\n    this.life = ttl;\r\n    this.color = color;\r\n    this.size = size;\r\n    this.alive = true;\r\n    this._pooled = false;\r\n  }\r\n}\r\n\r\nexport function acquireParticle(\r\n  state: GameState,\r\n  x: number,\r\n  y: number,\r\n  opts: Partial<Particle> = {},\r\n): Particle {\r\n  // Resolve PARTICLE_DEFAULTS safely to handle any ESM/CJS interop hiccups during tests\r\n  const PARTICLE_DEFAULTS_SAFE = (() => {\r\n    try {\r\n      const mod: any = (EntitiesConfigESM as any) || {};\r\n      const v =\r\n        mod.BULLET_DEFAULTS && mod.PARTICLE_DEFAULTS\r\n          ? mod.PARTICLE_DEFAULTS\r\n          : mod.default && mod.default.PARTICLE_DEFAULTS\r\n            ? mod.default.PARTICLE_DEFAULTS\r\n            : undefined;\r\n      if (v && typeof v.ttl === \"number\" && typeof v.size !== \"undefined\")\r\n        return v;\r\n    } catch (e) {}\r\n    return { ttl: 1, color: \"#fff\", size: 2 } as const;\r\n  })();\r\n  const key = \"particle\";\r\n  const poolConfig = state.assetPool?.config || {};\r\n  const maxSize = poolConfig.effectPoolSize ?? 128;\r\n  const overflowStrategy =\r\n    poolConfig.effectOverflowStrategy ?? \"discard-oldest\";\r\n  // Defensive: prune oldest if pool is full\r\n  if ((state.particles?.length ?? 0) >= maxSize) {\r\n    if (overflowStrategy === \"discard-oldest\" && state.particles?.length) {\r\n      state.particles?.shift();\r\n    } else if (overflowStrategy === \"error\") {\r\n      // Do not add new particle, return null\r\n      return null as any;\r\n    } // \"grow\" allows pool to grow\r\n  }\r\n  // Create a pooled Particle instance\r\n  const p = acquireEffect<Particle>(\r\n    state,\r\n    key,\r\n    () =>\r\n      makePooled(\r\n        new Particle(\r\n          x,\r\n          y,\r\n          opts.vx ?? 0,\r\n          opts.vy ?? 0,\r\n          opts.ttl ?? PARTICLE_DEFAULTS_SAFE.ttl,\r\n          opts.color ?? PARTICLE_DEFAULTS_SAFE.color,\r\n          opts.size ?? PARTICLE_DEFAULTS_SAFE.size,\r\n        ),\r\n        undefined,\r\n      ),\r\n    {\r\n      x,\r\n      y,\r\n      vx: opts.vx ?? 0,\r\n      vy: opts.vy ?? 0,\r\n      ttl: opts.ttl ?? PARTICLE_DEFAULTS_SAFE.ttl,\r\n      color: opts.color ?? PARTICLE_DEFAULTS_SAFE.color,\r\n      size: opts.size ?? PARTICLE_DEFAULTS_SAFE.size,\r\n    },\r\n  );\r\n  // Rehydrate properties\r\n  p.x = x;\r\n  p.y = y;\r\n  p.vx = opts.vx ?? 0;\r\n  p.vy = opts.vy ?? 0;\r\n  p.ttl = opts.ttl ?? PARTICLE_DEFAULTS_SAFE.ttl;\r\n  p.life = p.ttl;\r\n  p.color = opts.color ?? PARTICLE_DEFAULTS_SAFE.color;\r\n  p.size = opts.size ?? PARTICLE_DEFAULTS_SAFE.size;\r\n  p.alive = true;\r\n  (state.particles ||= []).push(p);\r\n  return p;\r\n}\r\n\r\nexport function createStarCanvas(\r\n  state: GameState,\r\n  W = 800,\r\n  H = 600,\r\n  bg = \"#041018\",\r\n): HTMLCanvasElement | null {\r\n  if (!state || !Array.isArray(state.stars)) return null;\r\n  try {\r\n    const c =\r\n      typeof document !== \"undefined\" && document.createElement\r\n        ? document.createElement(\"canvas\")\r\n        : null;\r\n    if (!c) return null;\r\n    c.width = Math.max(1, Math.floor(W));\r\n    c.height = Math.max(1, Math.floor(H));\r\n    const ctx = c.getContext && c.getContext(\"2d\");\r\n    if (ctx) {\r\n      ctx.fillStyle = bg;\r\n      ctx.fillRect(0, 0, c.width, c.height);\r\n      for (const s of state.stars) {\r\n        const alpha = Math.max(\r\n          0,\r\n          Math.min(1, s.a != null ? s.a : s.baseA != null ? s.baseA : 1),\r\n        );\r\n        ctx.beginPath();\r\n        ctx.fillStyle = `rgba(255,255,255,${alpha})`;\r\n        const rr = Math.max(0.2, s.r || 0.5);\r\n        ctx.arc(s.x || 0, s.y || 0, rr, 0, Math.PI * 2);\r\n        ctx.fill();\r\n      }\r\n    }\r\n    _starCanvasVersion = (_starCanvasVersion || 0) + 1;\r\n    (c as any)._version = _starCanvasVersion;\r\n    starCanvas = c;\r\n    return c;\r\n  } catch (e) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function getStarCanvasVersion() {\r\n  return _starCanvasVersion;\r\n}\r\n\r\nexport function setReinforcementInterval(seconds: number) {\r\n  _reinforcementInterval =\r\n    Number(seconds) || (TeamsConfig.continuousReinforcement?.interval ?? 5.0);\r\n}\r\nexport function getReinforcementInterval() {\r\n  return _reinforcementInterval;\r\n}\r\n\r\nfunction emitManagerEvent(\r\n  map: Map<string, Function[]>,\r\n  type: string,\r\n  data: any,\r\n) {\r\n  const arr = map.get(type) || [];\r\n  for (const cb of arr.slice()) {\r\n    try {\r\n      if (typeof cb === \"function\") cb(data);\r\n    } catch (e) {}\r\n  }\r\n}\r\n\r\nfunction evaluateReinforcement(\r\n  dt: number,\r\n  state: GameState,\r\n  continuousOptions: any = {},\r\n): { spawned: any[] } | null {\r\n  _reinforcementAccumulator += dt;\r\n  if (_reinforcementAccumulator >= _reinforcementInterval) {\r\n    _reinforcementAccumulator = 0;\r\n    try {\r\n      if (typeof chooseReinforcementsWithManagerSeed === \"function\") {\r\n        const orders = chooseReinforcementsWithManagerSeed(state, {\r\n          ...continuousOptions,\r\n          bounds: SIM.bounds,\r\n          enabled: true,\r\n        });\r\n        if (Array.isArray(orders) && orders.length) {\r\n          const spawned: any[] = [];\r\n          for (const o of orders) {\r\n            try {\r\n              const ship = createShip(\r\n                o.type || getDefaultShipTypeSafe(),\r\n                o.x || 100,\r\n                o.y || 100,\r\n                o.team || \"red\",\r\n              );\r\n              state.ships.push(ship);\r\n              try {\r\n                (state as any).shipMap &&\r\n                  (state as any).shipMap.set(ship.id, ship);\r\n              } catch (e) {}\r\n              try {\r\n                updateTeamCount(state, undefined, ship.team);\r\n              } catch (e) {}\r\n              spawned.push(ship);\r\n            } catch (e) {}\r\n          }\r\n          return { spawned };\r\n        }\r\n      }\r\n      const fallback = getDefaultShipTypeSafe();\r\n      const r = createShip(\r\n        fallback,\r\n        FALLBACK_POSITIONS[0].x,\r\n        FALLBACK_POSITIONS[0].y,\r\n        FALLBACK_POSITIONS[0].team,\r\n      );\r\n      const b = createShip(\r\n        fallback,\r\n        FALLBACK_POSITIONS[1].x,\r\n        FALLBACK_POSITIONS[1].y,\r\n        FALLBACK_POSITIONS[1].team,\r\n      );\r\n      state.ships.push(r);\r\n      try {\r\n        (state as any).shipMap && (state as any).shipMap.set(r.id, r);\r\n      } catch (e) {}\r\n      try {\r\n        updateTeamCount(state, undefined, String(r.team));\r\n      } catch (e) {}\r\n      state.ships.push(b);\r\n      try {\r\n        (state as any).shipMap && (state as any).shipMap.set(b.id, b);\r\n      } catch (e) {}\r\n      try {\r\n        updateTeamCount(state, undefined, String(b.team));\r\n      } catch (e) {}\r\n      return { spawned: [r, b] };\r\n    } catch (e) {\r\n      return null;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function simulate(dt: number, W = 800, H = 600) {\r\n  try {\r\n    const now =\r\n      typeof performance !== \"undefined\" && performance.now\r\n        ? performance.now()\r\n        : Date.now();\r\n    const frame = Math.floor(now / 4);\r\n    if (_lastSimulateFrameId === frame) {\r\n      const msg =\r\n        \"[gamemanager] detected simulate() called multiple times in same frame\";\r\n      try {\r\n        const _isProd =\r\n          (typeof process !== \"undefined\" &&\r\n            process.env &&\r\n            process.env.NODE_ENV === \"production\") ||\r\n          (typeof (globalThis as any).NODE_ENV !== \"undefined\" &&\r\n            (globalThis as any).NODE_ENV === \"production\");\r\n        if (_doubleSimStrict) throw new Error(msg);\r\n        else if (!_isProd) console.warn(msg);\r\n      } catch (e) {\r\n        // ignore environment detection errors and avoid noisy logs in production\r\n      }\r\n    }\r\n    _lastSimulateFrameId = frame;\r\n  } catch (e) {}\r\n  // Build a canonical GameState using makeInitialState to ensure assetPool exists\r\n  const state: GameState = makeInitialState();\r\n  (state as any).t = 0;\r\n  // No global arrays; all arrays are managed via GameState\r\n  evaluateReinforcement(dt, state);\r\n  try {\r\n    simulateStep(state, dt, SIM.bounds);\r\n  } catch (e) {}\r\n  // No global state to clear; callers should pass `state` explicitly to helpers.\r\n  return state;\r\n}\r\n\r\nexport function processStateEvents(state: any, dt: number = 0) {\r\n  return state;\r\n}\r\n", "// Helper: get SVG asset or warn if missing\r\nexport function getSvgAssetOrWarn(type: string): string {\r\n  const assetsConfig =\r\n    typeof globalThis !== \"undefined\" && (globalThis as any).AssetsConfig\r\n      ? (globalThis as any).AssetsConfig\r\n      : undefined;\r\n  const svg = assetsConfig?.svgAssets?.[type] ?? \"\";\r\n  if (!svg) {\r\n    try {\r\n      const _isProd =\r\n        (typeof process !== \"undefined\" &&\r\n          process.env &&\r\n          process.env.NODE_ENV === \"production\") ||\r\n        (typeof (globalThis as any).NODE_ENV !== \"undefined\" &&\r\n          (globalThis as any).NODE_ENV === \"production\");\r\n      if (!_isProd) {\r\n        console.warn(\r\n          `[CanvasRenderer] WARNING: SVG asset for type '${type}' is missing or empty.`,\r\n        );\r\n      }\r\n    } catch (e) {\r\n      // ignore environment detection errors\r\n    }\r\n  }\r\n  return svg;\r\n}\r\n// Imports required by the renderer (kept after helper to avoid import hoisting issues in some loaders)\r\nimport type { GameState } from \"./types\";\r\nimport {\r\n  createExplosionEffect,\r\n  resetExplosionEffect,\r\n  createHealthHitEffect,\r\n  resetHealthHitEffect,\r\n  ExplosionEffect,\r\n  HealthHitEffect,\r\n} from \"./entities\";\r\nimport {\r\n  acquireSprite,\r\n  releaseSprite,\r\n  acquireEffect,\r\n  releaseEffect,\r\n  makePooled,\r\n} from \"./pools\";\r\nimport RendererConfig from \"./config/rendererConfig\";\r\nimport { getDefaultBounds } from \"./config/simConfig\";\r\nimport AssetsConfig, {\r\n  getVisualConfig,\r\n  getShipAsset,\r\n  getBulletAsset,\r\n  getTurretAsset,\r\n  getEngineTrailConfig,\r\n  getSpriteAsset,\r\n} from \"./config/assets/assetsConfig\";\r\nimport * as svgLoader from \"./assets/svgLoader\";\r\nimport TeamsConfig from \"./config/teamsConfig\";\r\nimport TintedHullPool from \"./pools/tintedHullPool\";\r\nimport {\r\n  getRuntimeShipConfigSafe,\r\n  getDefaultShipTypeSafe,\r\n} from \"./config/runtimeConfigResolver\";\r\nfunction getShipConfigSafe() {\r\n  return getRuntimeShipConfigSafe() || {};\r\n}\r\n\r\n// Helper: produce a mapping object that maps common SVG data-team-slot\r\n// role names to the provided team color. Many SVGs use different role\r\n// names (hull, primary, hangar, trim, etc.) \u2014 map them all so a single\r\n// team color will recolor any of those slots.\r\nfunction teamMapping(color: string) {\r\n  return {\r\n    primary: color,\r\n    hull: color,\r\n    trim: color,\r\n    hangar: color,\r\n    launch: color,\r\n    engine: color,\r\n    glow: color,\r\n    turret: color,\r\n    panel: color,\r\n    secondary: color,\r\n    accent: color,\r\n    weapon: color,\r\n    detail: color,\r\n  } as Record<string, string>;\r\n}\r\n\r\nexport class CanvasRenderer {\r\n  canvas: HTMLCanvasElement;\r\n  ctx: CanvasRenderingContext2D | null = null;\r\n  bufferCanvas: HTMLCanvasElement;\r\n  bufferCtx: CanvasRenderingContext2D | null = null;\r\n  providesOwnLoop = false;\r\n  type = \"canvas\";\r\n  // ratio between backing store pixels and CSS (logical) pixels\r\n  pixelRatio = 1;\r\n  // cache for svg-extracted turret mountpoints in ship-local radius units\r\n  _svgMountCache: Record<string, [number, number][]> | null = null;\r\n  // cache for svg-extracted engine mountpoints in ship-local radius units\r\n  _svgEngineMountCache: Record<string, [number, number][]> | null = null;\r\n  // rasterized turret sprite cache: kind -> offscreen canvas\r\n  _turretSpriteCache: Record<string, HTMLCanvasElement> | null = null;\r\n  // rasterized hull-only SVG cache: shipType -> offscreen canvas\r\n  _svgHullCache: Record<string, HTMLCanvasElement | undefined> = {};\r\n  // tinted hull cache implemented as a per-team capped pool for canvases\r\n  _tintedHullPool: TintedHullPool | null = null;\r\n  // Backwards-compatible Map-like facade for tests that expect _tintedHullCache\r\n  get _tintedHullCache(): Map<string, HTMLCanvasElement> {\r\n    const self = this;\r\n    // Minimal Map-like wrapper exposing iterable behaviour backed by _tintedHullPool\r\n    class MapWrapper {\r\n      [Symbol.toStringTag] = \"Map\";\r\n      constructor() {}\r\n      get size() {\r\n        try {\r\n          return self._tintedHullPool\r\n            ? (self._tintedHullPool as any).size || 0\r\n            : 0;\r\n        } catch (e) {\r\n          return 0;\r\n        }\r\n      }\r\n      clear(): void {\r\n        if (self._tintedHullPool) (self._tintedHullPool as any).clear();\r\n      }\r\n      delete(key: string): boolean {\r\n        if (!self._tintedHullPool) return false;\r\n        return !!(\r\n          self._tintedHullPool.has(key) &&\r\n          (self._tintedHullPool.delete(key), true)\r\n        );\r\n      }\r\n      forEach(\r\n        cb: (\r\n          value: HTMLCanvasElement,\r\n          key: string,\r\n          map: Map<string, HTMLCanvasElement>,\r\n        ) => void,\r\n        thisArg?: any,\r\n      ): void {\r\n        if (!self._tintedHullPool) return;\r\n        for (const k of (self._tintedHullPool as any).keys()) {\r\n          const v = (self._tintedHullPool as any).get(k);\r\n          cb.call(thisArg, v, k as string, this as any);\r\n        }\r\n      }\r\n      get(key: string): HTMLCanvasElement | undefined {\r\n        return self._tintedHullPool\r\n          ? ((self._tintedHullPool as any).get(key) as\r\n              | HTMLCanvasElement\r\n              | undefined)\r\n          : undefined;\r\n      }\r\n      has(key: string): boolean {\r\n        return !!(\r\n          self._tintedHullPool && (self._tintedHullPool as any).has(key)\r\n        );\r\n      }\r\n      set(key: string, value: HTMLCanvasElement): this {\r\n        self._setTintedCanvas(key, value);\r\n        return this;\r\n      }\r\n      *entries(): IterableIterator<[string, HTMLCanvasElement]> {\r\n        if (!self._tintedHullPool) return;\r\n        for (const k of (self._tintedHullPool as any).keys()) {\r\n          yield [\r\n            k as string,\r\n            (self._tintedHullPool as any).get(k) as HTMLCanvasElement,\r\n          ];\r\n        }\r\n      }\r\n      *keys(): IterableIterator<string> {\r\n        if (!self._tintedHullPool) return;\r\n        for (const k of (self._tintedHullPool as any).keys()) yield k as string;\r\n      }\r\n      *values(): IterableIterator<HTMLCanvasElement> {\r\n        if (!self._tintedHullPool) return;\r\n        for (const k of (self._tintedHullPool as any).keys())\r\n          yield (self._tintedHullPool as any).get(k) as HTMLCanvasElement;\r\n      }\r\n      [Symbol.iterator](): IterableIterator<[string, HTMLCanvasElement]> {\r\n        return this.entries();\r\n      }\r\n    }\r\n    return new MapWrapper() as any;\r\n  }\r\n\r\n  // Clear the tinted hull cache (useful when palette/team colors change)\r\n  clearTintedHullCache(): void {\r\n    try {\r\n      if (this._tintedHullPool) this._tintedHullPool.clear();\r\n    } catch (e) {}\r\n  }\r\n\r\n  // Internal helper: set a tinted canvas in the Map and enforce LRU cap.\r\n  private _setTintedCanvas(key: string, canvas: HTMLCanvasElement) {\r\n    if (!this._tintedHullPool)\r\n      this._tintedHullPool = new TintedHullPool({\r\n        globalCap: 256,\r\n        perTeamCap: 64,\r\n      });\r\n    this._tintedHullPool.set(key, canvas);\r\n  }\r\n\r\n  // Test helper: allow tests to inject entries deterministically without TS private access errors.\r\n  // Kept separate so production code still uses private _setTintedCanvas.\r\n  _testSetTintedCanvas(key: string, canvas: HTMLCanvasElement) {\r\n    this._setTintedCanvas(key, canvas);\r\n  }\r\n\r\n  constructor(canvas: HTMLCanvasElement) {\r\n    this.canvas = canvas;\r\n    // Create offscreen buffer sized at logical map \u00D7 renderer scale\r\n    this.bufferCanvas = document.createElement(\"canvas\");\r\n    this.bufferCtx = this.bufferCanvas.getContext(\"2d\");\r\n  }\r\n\r\n  // Dev-only: warn once per asset key when an SVG fetch fails.\r\n  private static _warnedSvgKeys: Set<string> = new Set();\r\n  private _devWarnSvgFetchFail(assetKey: string, rel: string, err?: unknown) {\r\n    try {\r\n      // Suppress in production and test environments\r\n      const isProd =\r\n        (typeof process !== \"undefined\" &&\r\n          process.env &&\r\n          process.env.NODE_ENV === \"production\") ||\r\n        (typeof (globalThis as any).NODE_ENV !== \"undefined\" &&\r\n          (globalThis as any).NODE_ENV === \"production\");\r\n      const isTest =\r\n        (typeof process !== \"undefined\" &&\r\n          process.env &&\r\n          (process.env.VITEST || process.env.VITEST_WORKER_ID)) ||\r\n        typeof (globalThis as any).vitest !== \"undefined\";\r\n      if (isProd || isTest) return;\r\n      if (!assetKey) assetKey = \"<unknown>\";\r\n      const key = `${assetKey}::${rel}`;\r\n      if (CanvasRenderer._warnedSvgKeys.has(key)) return;\r\n      CanvasRenderer._warnedSvgKeys.add(key);\r\n      // eslint-disable-next-line no-console\r\n      console.warn(\r\n        `[CanvasRenderer] Failed to load SVG for '${assetKey}' from '${rel}'. Falling back to vector shape.`,\r\n        err ? err : \"\",\r\n      );\r\n    } catch (e) {}\r\n  }\r\n\r\n  init(): boolean {\r\n    this.ctx = this.canvas.getContext(\"2d\");\r\n    // If running in a test environment (DOM emulation) getContext may be unimplemented.\r\n    // Provide a minimal no-op 2D context so renderState can still resize buffers and run logic.\r\n    if (!this.ctx) {\r\n      // create a lightweight no-op ctx that satisfies the subset used by the renderer\r\n      const noop = () => {};\r\n      const noOpCtx: any = {\r\n        setTransform: noop,\r\n        imageSmoothingEnabled: true,\r\n        clearRect: noop,\r\n        save: noop,\r\n        restore: noop,\r\n        fillRect: noop,\r\n        beginPath: noop,\r\n        moveTo: noop,\r\n        lineTo: noop,\r\n        closePath: noop,\r\n        fill: noop,\r\n        stroke: noop,\r\n        arc: noop,\r\n        translate: noop,\r\n        rotate: noop,\r\n        drawImage: noop,\r\n        globalAlpha: 1,\r\n        strokeStyle: \"#000\",\r\n        fillStyle: \"#000\",\r\n        lineWidth: 1,\r\n        globalCompositeOperation: \"source-over\",\r\n      };\r\n      this.ctx = noOpCtx as unknown as CanvasRenderingContext2D;\r\n    }\r\n    this.bufferCtx = this.bufferCanvas.getContext(\"2d\") || this.ctx;\r\n    // bufferCtx must be present (either real or no-op) for renderState to proceed\r\n    if (!this.bufferCtx) return false;\r\n    // compute pixelRatio from renderScale only\r\n    try {\r\n      const renderScale =\r\n        RendererConfig &&\r\n        typeof (RendererConfig as any).renderScale === \"number\"\r\n          ? (RendererConfig as any).renderScale\r\n          : 1;\r\n      this.pixelRatio = renderScale;\r\n      this.ctx.setTransform(1, 0, 0, 1, 0, 0); // No scaling here; only when compositing buffer\r\n      this.ctx.imageSmoothingEnabled = true;\r\n    } catch (e) {\r\n      this.pixelRatio = 1;\r\n    }\r\n    // Kick off async preload of SVG assets to extract turret mountpoints.\r\n    // Run async but don't block init; cache will populate when ready.\r\n    try {\r\n      // call and ignore promise errors to avoid breaking init\r\n      (this as any).preloadAllAssets &&\r\n        (this as any).preloadAllAssets().catch(() => {});\r\n    } catch (e) {}\r\n    return true;\r\n  }\r\n\r\n  // Preload SVG assets listed in AssetsConfig.svgAssets, extract mountpoints\r\n  // and normalize them into radius-unit coordinates compatible with shapes2d\r\n  async preloadAllAssets(): Promise<void> {\r\n    try {\r\n      const svgAssets = (AssetsConfig as any).svgAssets || {};\r\n      // Compute team colors up-front so we can do a deterministic placeholder\r\n      // pre-warm for headless/test environments before any async rasterization.\r\n      const teams =\r\n        TeamsConfig && (TeamsConfig as any).teams\r\n          ? (TeamsConfig as any).teams\r\n          : {};\r\n      const teamColors: string[] = [];\r\n      for (const tName of Object.keys(teams)) {\r\n        const t = teams[tName];\r\n        if (t && t.color) teamColors.push(t.color);\r\n      }\r\n      if (teamColors.length === 0) {\r\n        const p = (AssetsConfig as any).palette || {};\r\n        if (p.shipHull) teamColors.push(p.shipHull);\r\n        if (p.shipAccent) teamColors.push(p.shipAccent);\r\n      }\r\n      // Ensure a placeholder tinted canvas exists for each declared shipType/teamColor\r\n      try {\r\n        if (!this._tintedHullPool)\r\n          this._tintedHullPool = new TintedHullPool({\r\n            globalCap: 256,\r\n            perTeamCap: 64,\r\n          });\r\n        for (const shipType of Object.keys(svgAssets)) {\r\n          try {\r\n            for (const col of teamColors) {\r\n              const k = `${shipType}::${col}`;\r\n              if (!this._tintedHullPool.has(k)) {\r\n                const pc = document.createElement(\"canvas\");\r\n                pc.width = 16;\r\n                pc.height = 16;\r\n                try {\r\n                  this._setTintedCanvas(k, pc);\r\n                } catch (e) {\r\n                  if (this._tintedHullPool) this._tintedHullPool.set(k, pc);\r\n                }\r\n              }\r\n            }\r\n          } catch (e) {}\r\n        }\r\n      } catch (e) {}\r\n      // In headless/test environments, rasterization can be async. Create\r\n      // immediate placeholder canvases for declared svg assets so tests\r\n      // that inspect _svgHullCache see entries synchronously.\r\n      try {\r\n        this._svgHullCache = this._svgHullCache || {};\r\n        for (const k of Object.keys(svgAssets)) {\r\n          if (\r\n            !this._svgHullCache[k] &&\r\n            typeof (svgAssets as any)[k] === \"string\"\r\n          ) {\r\n            const ph = document.createElement(\"canvas\");\r\n            ph.width = 128;\r\n            ph.height = 128;\r\n            const pctx = ph.getContext(\"2d\");\r\n            if (pctx) {\r\n              pctx.fillStyle = \"#fff\";\r\n              pctx.fillRect(0, 0, ph.width, ph.height);\r\n            }\r\n            // Tag as placeholder so runtime draw can skip using it as a real hull\r\n            try {\r\n              (ph as any)._placeholder = true;\r\n            } catch (e) {}\r\n            this._svgHullCache[k] = ph;\r\n          }\r\n        }\r\n      } catch (e) {}\r\n      this._svgMountCache = this._svgMountCache || {};\r\n      for (const key of Object.keys(svgAssets)) {\r\n        try {\r\n          const rel = (svgAssets as any)[key];\r\n          let svgText = \"\";\r\n          // If svgAssets contains an inlined SVG string (standalone build\r\n          // injection), use it directly. Otherwise try fetch(rel) as a URL.\r\n          try {\r\n            if (typeof rel === \"string\" && rel.trim().startsWith(\"<svg\")) {\r\n              svgText = rel;\r\n            } else {\r\n              if (typeof fetch === \"function\") {\r\n                const resp = await fetch(rel as string);\r\n                if (resp && resp.ok) {\r\n                  svgText = await resp.text();\r\n                } else {\r\n                  this._devWarnSvgFetchFail(\r\n                    key,\r\n                    String(rel),\r\n                    resp && !(resp as any).ok ? resp.status : undefined,\r\n                  );\r\n                }\r\n              }\r\n            }\r\n          } catch (e) {\r\n            this._devWarnSvgFetchFail(key, String(rel), e);\r\n            svgText = \"\";\r\n          }\r\n          // If fetch failed or not available, skip Node-specific disk read in browser build\r\n          if (!svgText) continue;\r\n          const parsed = svgLoader.parseSvgForMounts(svgText);\r\n          const mounts = parsed.mounts || [];\r\n          const engineMounts = parsed.engineMounts || [];\r\n          const vb = parsed.viewBox || { w: 128, h: 128 };\r\n          // Compute shape extent from shapes2d config so that normalized coords\r\n          // map to the same scale used by shapes2d points. Fallback to 1.\r\n          const shapeEntry: any =\r\n            AssetsConfig.shapes2d && (AssetsConfig as any).shapes2d[key];\r\n          let extent = 1;\r\n          if (shapeEntry) {\r\n            let maxv = 0;\r\n            if (\r\n              shapeEntry.type === \"compound\" &&\r\n              Array.isArray(shapeEntry.parts)\r\n            ) {\r\n              for (const p of shapeEntry.parts) {\r\n                if (p.type === \"circle\")\r\n                  maxv = Math.max(maxv, Math.abs(p.r || 0));\r\n                else if (p.type === \"polygon\")\r\n                  for (const pt of p.points || []) {\r\n                    maxv = Math.max(\r\n                      maxv,\r\n                      Math.abs(pt[0] || 0),\r\n                      Math.abs(pt[1] || 0),\r\n                    );\r\n                  }\r\n              }\r\n            } else if (shapeEntry.type === \"polygon\") {\r\n              for (const pt of shapeEntry.points || []) {\r\n                maxv = Math.max(\r\n                  maxv,\r\n                  Math.abs(pt[0] || 0),\r\n                  Math.abs(pt[1] || 0),\r\n                );\r\n              }\r\n            } else if (shapeEntry.type === \"circle\")\r\n              maxv = Math.max(maxv, Math.abs(shapeEntry.r || 0));\r\n            extent = maxv || 1;\r\n          }\r\n          // Normalize turret mountpoints: convert from SVG viewBox coords to shape units\r\n          const norm: [number, number][] = mounts.map((m: any) => {\r\n            const nx = ((m.x || 0) - vb.w / 2) / (vb.w / 2 || 1);\r\n            const ny = ((m.y || 0) - vb.h / 2) / (vb.h / 2 || 1);\r\n            return [nx * extent, ny * extent];\r\n          });\r\n          this._svgMountCache[key] = norm;\r\n          // Normalize engine mountpoints\r\n          const engineNorm: [number, number][] = engineMounts.map((m: any) => {\r\n            const nx = ((m.x || 0) - vb.w / 2) / (vb.w / 2 || 1);\r\n            const ny = ((m.y || 0) - vb.h / 2) / (vb.h / 2 || 1);\r\n            return [nx * extent, ny * extent];\r\n          });\r\n          this._svgEngineMountCache = this._svgEngineMountCache || {};\r\n          this._svgEngineMountCache[key] = engineNorm;\r\n          // Attempt to asynchronously rasterize and cache a hull-only canvas\r\n          // using the higher-level svgRenderer. This ensures _svgHullCache\r\n          // is populated with a resolved canvas (not a blank placeholder)\r\n          // so sync reads later (getCachedHullCanvasSync) can draw immediately.\r\n          try {\r\n            // use static import for svgRenderer (synchronous require fallback)\r\n            let svgRenderer: any = undefined;\r\n            try {\r\n              // prefer static ES import resolved via svgLoader proxy\r\n              svgRenderer = undefined;\r\n              // dynamic import may be async; attempt non-blocking import and use when ready\r\n              try {\r\n                import(\"./assets/svgRenderer\").then(\r\n                  (m) => (svgRenderer = m.default || m),\r\n                );\r\n              } catch (e) {\r\n                svgRenderer = undefined;\r\n              }\r\n            } catch (e) {\r\n              try {\r\n                svgRenderer = (await import(\"./assets/svgRenderer\")) as any;\r\n              } catch (e) {\r\n                svgRenderer = undefined;\r\n              }\r\n            }\r\n            // If the dynamic import didn't produce a usable module (bundling/module\r\n            // instance isolation), try the global bridge which other bundles may\r\n            // have populated so we can discover cached canvases across instances.\r\n            try {\r\n              if (!svgRenderer && (globalThis as any).__SpaceAutoBattler_svgRenderer) {\r\n                svgRenderer = (globalThis as any).__SpaceAutoBattler_svgRenderer;\r\n              }\r\n            } catch (e) {}\r\n            if (\r\n              svgRenderer &&\r\n              typeof svgRenderer.rasterizeSvgWithTeamColors === \"function\"\r\n            ) {\r\n              // Use the viewBox dimensions if available\r\n              const outW = (vb && vb.w) || 128;\r\n              const outH = (vb && vb.h) || 128;\r\n              // Request rasterization with no mapping (hull-only baseline)\r\n              (async () => {\r\n                try {\r\n                  const canvas = await svgRenderer.rasterizeSvgWithTeamColors(\r\n                    svgText,\r\n                    {},\r\n                    outW,\r\n                    outH,\r\n                    { applyTo: \"both\", assetKey: key },\r\n                  );\r\n                  try {\r\n                    this._svgHullCache = this._svgHullCache || {};\r\n                    this._svgHullCache[key] = canvas;\r\n                  } catch (e) {}\r\n                } catch (e) {\r\n                  // ignore async raster errors \u2014 fallback placeholders remain\r\n                }\r\n              })();\r\n            }\r\n          } catch (e) {}\r\n          // Try to rasterize hull-only SVG proactively for faster first-draw\r\n          try {\r\n            const outW = vb.w || 128;\r\n            const outH = vb.h || 128;\r\n            // Kick off background rasterization only when no placeholder exists\r\n            try {\r\n              if (!this._svgHullCache || !this._svgHullCache[key]) {\r\n                const outW = vb.w || 128;\r\n                const outH = vb.h || 128;\r\n                (async () => {\r\n                  try {\r\n                    let hullCanvas: HTMLCanvasElement | undefined = undefined;\r\n                    try {\r\n                      if (\r\n                        typeof (svgLoader as any)\r\n                          .rasterizeHullOnlySvgToCanvasAsync === \"function\"\r\n                      ) {\r\n                        hullCanvas = await (\r\n                          svgLoader as any\r\n                        ).rasterizeHullOnlySvgToCanvasAsync(\r\n                          svgText,\r\n                          outW,\r\n                          outH,\r\n                        );\r\n                      } else {\r\n                        hullCanvas = svgLoader.rasterizeHullOnlySvgToCanvas(\r\n                          svgText,\r\n                          outW,\r\n                          outH,\r\n                        ) as HTMLCanvasElement;\r\n                      }\r\n                    } catch (e) {\r\n                      hullCanvas = undefined;\r\n                    }\r\n                    if (hullCanvas) {\r\n                      try {\r\n                        this._svgHullCache = this._svgHullCache || {};\r\n                        this._svgHullCache[key] = hullCanvas;\r\n                      } catch (e) {}\r\n                      try {\r\n                        let svgRenderer: any = undefined;\r\n                        try {\r\n                          import(\"./assets/svgRenderer\").then(\r\n                            (m) => (svgRenderer = m.default || m),\r\n                          );\r\n                        } catch (e) {\r\n                          svgRenderer = undefined;\r\n                        }\r\n                        try {\r\n                          if (!svgRenderer && (globalThis as any).__SpaceAutoBattler_svgRenderer) {\r\n                            svgRenderer = (globalThis as any).__SpaceAutoBattler_svgRenderer;\r\n                          }\r\n                        } catch (e) {}\r\n                        if (\r\n                          svgRenderer &&\r\n                          typeof svgRenderer.cacheCanvasForAsset === \"function\"\r\n                        ) {\r\n                          svgRenderer.cacheCanvasForAsset(\r\n                            key,\r\n                            {},\r\n                            hullCanvas.width,\r\n                            hullCanvas.height,\r\n                            hullCanvas,\r\n                          );\r\n                        }\r\n                      } catch (e) {}\r\n                    }\r\n                  } catch (e) {}\r\n                })();\r\n              }\r\n            } catch (e) {}\r\n          } catch (e) {\r\n            // ignore rasterization errors here; will fallback to lazy raster later\r\n          }\r\n          // Optionally, populate AssetsConfig.svgEngineMounts for backward compatibility\r\n          try {\r\n            (AssetsConfig as any).svgEngineMounts =\r\n              (AssetsConfig as any).svgEngineMounts || {};\r\n            (AssetsConfig as any).svgEngineMounts[key] = engineNorm;\r\n          } catch (e) {}\r\n        } catch (e) {\r\n          // ignore per-asset errors\r\n          // console.warn('Failed to preload SVG for', key, e);\r\n        }\r\n      }\r\n      // Pre-warm tinted hull cache for known teams/types\r\n      try {\r\n        if (!this._tintedHullPool)\r\n          this._tintedHullPool = new TintedHullPool({\r\n            globalCap: 256,\r\n            perTeamCap: 64,\r\n          });\r\n        const teams =\r\n          TeamsConfig && (TeamsConfig as any).teams\r\n            ? (TeamsConfig as any).teams\r\n            : {};\r\n        const teamColors: string[] = [];\r\n        for (const tName of Object.keys(teams)) {\r\n          const t = teams[tName];\r\n          if (t && t.color) teamColors.push(t.color);\r\n        }\r\n        // Fallback to palette shipHull and shipAccent if no teams defined\r\n        if (teamColors.length === 0) {\r\n          const p = (AssetsConfig as any).palette || {};\r\n          if (p.shipHull) teamColors.push(p.shipHull);\r\n          if (p.shipAccent) teamColors.push(p.shipAccent);\r\n        }\r\n        const declaredSvgAssets = (AssetsConfig as any).svgAssets || {};\r\n        for (const shipType of Object.keys(declaredSvgAssets)) {\r\n          try {\r\n            let hullCanvas = (this._svgHullCache as any)[shipType] as\r\n              | HTMLCanvasElement\r\n              | undefined;\r\n            if (!hullCanvas) {\r\n              try {\r\n                const rel = (declaredSvgAssets as any)[shipType];\r\n                if (typeof rel === \"string\" && rel.trim().startsWith(\"<svg\")) {\r\n                  const vbMatch =\r\n                    /viewBox\\s*=\\s*\"(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)\"/.exec(\r\n                      rel,\r\n                    );\r\n                  let outW = 128,\r\n                    outH = 128;\r\n                  if (vbMatch) {\r\n                    outW = parseInt(vbMatch[3]) || 128;\r\n                    outH = parseInt(vbMatch[4]) || 128;\r\n                  }\r\n                  try {\r\n                    if (\r\n                      typeof (svgLoader as any)\r\n                        .rasterizeHullOnlySvgToCanvasAsync === \"function\"\r\n                    ) {\r\n                      try {\r\n                        hullCanvas = await (\r\n                          svgLoader as any\r\n                        ).rasterizeHullOnlySvgToCanvasAsync(rel, outW, outH);\r\n                      } catch (e) {\r\n                        hullCanvas = undefined;\r\n                      }\r\n                    } else {\r\n                      hullCanvas = svgLoader.rasterizeHullOnlySvgToCanvas(\r\n                        rel,\r\n                        outW,\r\n                        outH,\r\n                      );\r\n                    }\r\n                  } catch (e) {\r\n                    hullCanvas = undefined;\r\n                  }\r\n                  if (!hullCanvas) {\r\n                    const ph = document.createElement(\"canvas\");\r\n                    ph.width = outW;\r\n                    ph.height = outH;\r\n                    const pctx = ph.getContext(\"2d\");\r\n                    if (pctx) {\r\n                      pctx.fillStyle = \"#fff\";\r\n                      pctx.fillRect(0, 0, outW, outH);\r\n                    }\r\n                    try {\r\n                      (ph as any)._placeholder = true;\r\n                    } catch (e) {}\r\n                    hullCanvas = ph;\r\n                  }\r\n                  this._svgHullCache = this._svgHullCache || {};\r\n                  this._svgHullCache[shipType] = hullCanvas;\r\n                }\r\n              } catch (e) {}\r\n            }\r\n            if (!hullCanvas) continue;\r\n            for (const col of teamColors) {\r\n              const k = `${shipType}::${col}`;\r\n              if (this._tintedHullPool && this._tintedHullPool.has(k)) continue;\r\n              try {\r\n                const tc = document.createElement(\"canvas\");\r\n                tc.width = hullCanvas.width;\r\n                tc.height = hullCanvas.height;\r\n                const tctx = tc.getContext(\"2d\");\r\n                if (tctx) {\r\n                  tctx.clearRect(0, 0, tc.width, tc.height);\r\n                  tctx.drawImage(hullCanvas, 0, 0);\r\n                  tctx.globalCompositeOperation = \"source-atop\";\r\n                  tctx.fillStyle = col;\r\n                  tctx.fillRect(0, 0, tc.width, tc.height);\r\n                  tctx.globalCompositeOperation = \"source-over\";\r\n                  this._setTintedCanvas(k, tc);\r\n                    try {\r\n                      let svgRenderer: any = undefined;\r\n                      try {\r\n                        svgRenderer = await import(\r\n                          \"./assets/svgRenderer\"\r\n                        ).then((m) => m.default || m);\r\n                      } catch (e) {\r\n                        svgRenderer = undefined;\r\n                      }\r\n                      try {\r\n                        if (!svgRenderer && (globalThis as any).__SpaceAutoBattler_svgRenderer) {\r\n                          svgRenderer = (globalThis as any).__SpaceAutoBattler_svgRenderer;\r\n                        }\r\n                      } catch (e) {}\r\n                      if (\r\n                        svgRenderer &&\r\n                        typeof svgRenderer.cacheCanvasForAsset === \"function\"\r\n                      ) {\r\n                        svgRenderer.cacheCanvasForAsset(\r\n                          shipType,\r\n                          teamMapping(col),\r\n                          tc.width,\r\n                          tc.height,\r\n                          tc,\r\n                        );\r\n                      }\r\n                    } catch (e) {}\r\n                }\r\n              } catch (e) {\r\n                /* ignore pre-warm errors */\r\n              }\r\n            }\r\n          } catch (e) {\r\n            /* ignore per-type pre-warm errors */\r\n          }\r\n        }\r\n        // Ensure any declared assets that still lack hull canvases get a placeholder\r\n        try {\r\n          const declaredSvgAssets2 = (AssetsConfig as any).svgAssets || {};\r\n          for (const shipType of Object.keys(declaredSvgAssets2)) {\r\n            if (!this._svgHullCache || !this._svgHullCache[shipType]) {\r\n              const ph = document.createElement(\"canvas\");\r\n              ph.width = 128;\r\n              ph.height = 128;\r\n              const pctx = ph.getContext(\"2d\");\r\n              if (pctx) {\r\n                pctx.fillStyle = \"#fff\";\r\n                pctx.fillRect(0, 0, ph.width, ph.height);\r\n              }\r\n              try {\r\n                (ph as any)._placeholder = true;\r\n              } catch (e) {}\r\n              this._svgHullCache = this._svgHullCache || {};\r\n              this._svgHullCache[shipType] = ph;\r\n              for (const col of teamColors) {\r\n                const k = `${shipType}::${col}`;\r\n                if (this._tintedHullPool && this._tintedHullPool.has(k))\r\n                  continue;\r\n                try {\r\n                  const tc = document.createElement(\"canvas\");\r\n                  tc.width = ph.width;\r\n                  tc.height = ph.height;\r\n                  const tctx = tc.getContext(\"2d\");\r\n                  if (tctx) {\r\n                    tctx.clearRect(0, 0, tc.width, tc.height);\r\n                    try {\r\n                      tctx.drawImage(ph, 0, 0);\r\n                    } catch (e) {}\r\n                    try {\r\n                      tctx.globalCompositeOperation = \"source-atop\";\r\n                      tctx.fillStyle = col;\r\n                      tctx.fillRect(0, 0, tc.width, tc.height);\r\n                      tctx.globalCompositeOperation = \"source-over\";\r\n                    } catch (e) {}\r\n                  }\r\n                  this._setTintedCanvas(k, tc);\r\n                  try {\r\n                    const svgRenderer = await import(\r\n                      \"./assets/svgRenderer\"\r\n                    ).then((m) => m.default || m);\r\n                    if (\r\n                      svgRenderer &&\r\n                      typeof svgRenderer.cacheCanvasForAsset === \"function\"\r\n                    ) {\r\n                      svgRenderer.cacheCanvasForAsset(\r\n                        shipType,\r\n                        teamMapping(col),\r\n                        tc.width,\r\n                        tc.height,\r\n                        tc,\r\n                      );\r\n                    }\r\n                  } catch (e) {}\r\n                } catch (e) {\r\n                  /* ignore per-key placeholder errors */\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } catch (e) {}\r\n      } catch (e) {\r\n        /* ignore pre-warm errors */\r\n      }\r\n      // Rasterize turret sprites for kinds listed in turretDefaults (or default 'basic')\r\n      try {\r\n        this._turretSpriteCache = this._turretSpriteCache || {};\r\n        const turretDefs = (AssetsConfig as any).turretDefaults || {\r\n          basic: { sprite: \"turretBasic\" },\r\n        };\r\n        const kinds = Object.keys(turretDefs);\r\n        for (const k of kinds) {\r\n          try {\r\n            const spriteKey = (turretDefs as any)[k].sprite || \"turretBasic\";\r\n            const tshape: any =\r\n              (AssetsConfig as any).shapes2d &&\r\n              (AssetsConfig as any).shapes2d[spriteKey];\r\n            if (!tshape) continue;\r\n            // Create offscreen canvas sized using renderer renderScale and a modest base\r\n            const basePx = Math.max(\r\n              24,\r\n              Math.round(24 * (RendererConfig as any).renderScale || 1),\r\n            );\r\n            const canvas = document.createElement(\"canvas\");\r\n            const size = Math.max(16, basePx * 2);\r\n            canvas.width = size;\r\n            canvas.height = size;\r\n            const ctx2 = canvas.getContext(\"2d\");\r\n            if (!ctx2) continue;\r\n            ctx2.clearRect(0, 0, canvas.width, canvas.height);\r\n            ctx2.translate(size / 2, size / 2);\r\n            ctx2.fillStyle = (AssetsConfig as any).palette?.turret || \"#94a3b8\";\r\n            // Determine a scale factor to map shape unit coords into pixel space\r\n            const scale = size / 2 / 2; // heuristic: shape unit ~2 units radius\r\n            if (tshape.type === \"circle\") {\r\n              ctx2.beginPath();\r\n              ctx2.arc(0, 0, (tshape.r || 1) * scale, 0, Math.PI * 2);\r\n              ctx2.fill();\r\n            } else if (tshape.type === \"polygon\") {\r\n              ctx2.beginPath();\r\n              const pts = tshape.points || [];\r\n              if (pts.length) {\r\n                ctx2.moveTo((pts[0][0] || 0) * scale, (pts[0][1] || 0) * scale);\r\n                for (let i = 1; i < pts.length; i++)\r\n                  ctx2.lineTo(\r\n                    (pts[i][0] || 0) * scale,\r\n                    (pts[i][1] || 0) * scale,\r\n                  );\r\n                ctx2.closePath();\r\n                ctx2.fill();\r\n              }\r\n            } else if (tshape.type === \"compound\") {\r\n              for (const part of tshape.parts || []) {\r\n                if (part.type === \"circle\") {\r\n                  ctx2.beginPath();\r\n                  ctx2.arc(0, 0, (part.r || 1) * scale, 0, Math.PI * 2);\r\n                  ctx2.fill();\r\n                } else if (part.type === \"polygon\") {\r\n                  ctx2.beginPath();\r\n                  const pts = part.points || [];\r\n                  if (pts.length) {\r\n                    ctx2.moveTo(\r\n                      (pts[0][0] || 0) * scale,\r\n                      (pts[0][1] || 0) * scale,\r\n                    );\r\n                    for (let i = 1; i < pts.length; i++)\r\n                      ctx2.lineTo(\r\n                        (pts[i][0] || 0) * scale,\r\n                        (pts[i][1] || 0) * scale,\r\n                      );\r\n                    ctx2.closePath();\r\n                    ctx2.fill();\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            this._turretSpriteCache[k] = canvas;\r\n          } catch (e) {\r\n            /* ignore turret raster errors */\r\n          }\r\n        }\r\n      } catch (e) {}\r\n    } catch (e) {\r\n      // ignore global errors\r\n    }\r\n  }\r\n\r\n  isRunning(): boolean {\r\n    return false;\r\n  }\r\n\r\n  renderState(state: GameState, interpolation = 0): void {\r\n    // helper: draw a stroked ring (used for explosions / flashes)\r\n    function drawRing(\r\n      x: number,\r\n      y: number,\r\n      R: number,\r\n      color: string,\r\n      alpha = 1.0,\r\n      thickness = 2,\r\n    ) {\r\n      try {\r\n        withContext(() => {\r\n          activeBufferCtx.globalAlpha = Math.max(0, Math.min(1, alpha));\r\n          activeBufferCtx.strokeStyle = color;\r\n          activeBufferCtx.lineWidth = thickness * renderScale;\r\n          activeBufferCtx.beginPath();\r\n          activeBufferCtx.arc(\r\n            x * renderScale,\r\n            y * renderScale,\r\n            Math.max(1, R * renderScale),\r\n            0,\r\n            Math.PI * 2,\r\n          );\r\n          activeBufferCtx.stroke();\r\n        });\r\n      } catch (e) {\r\n        /* ignore draw errors */\r\n      }\r\n    }\r\n    // --- Offscreen buffer rendering ---\r\n    // 1. Resize bufferCanvas to logical size \u00D7 renderer scale BEFORE any drawing\r\n    // 2. Draw all simulation visuals to bufferCanvas\r\n    // 3. Copy bufferCanvas to main canvas ONLY after all drawing is finished\r\n    const ctx = this.ctx!;\r\n    const bufferCtx = this.bufferCtx!;\r\n    if (!ctx || !bufferCtx) return;\r\n    // Prefer canonical logical bounds from simConfig so renderer matches simulation\r\n    // defaults. If unavailable, fall back to previous hard-coded values.\r\n    const defaultBounds =\r\n      typeof getDefaultBounds === \"function\"\r\n        ? getDefaultBounds()\r\n        : { W: 1920, H: 1080 };\r\n    const LOGICAL_W =\r\n      defaultBounds && typeof defaultBounds.W === \"number\"\r\n        ? defaultBounds.W\r\n        : 1920;\r\n    const LOGICAL_H =\r\n      defaultBounds && typeof defaultBounds.H === \"number\"\r\n        ? defaultBounds.H\r\n        : 1080;\r\n    const renderScale =\r\n      RendererConfig && typeof (RendererConfig as any).renderScale === \"number\"\r\n        ? (RendererConfig as any).renderScale\r\n        : 1;\r\n    const fitScale = (RendererConfig as any)._fitScale || 1;\r\n    // Resize bufferCanvas if needed (before any drawing)\r\n    const bufferW = Math.round(LOGICAL_W * renderScale);\r\n    const bufferH = Math.round(LOGICAL_H * renderScale);\r\n    if (\r\n      this.bufferCanvas.width !== bufferW ||\r\n      this.bufferCanvas.height !== bufferH\r\n    ) {\r\n      this.bufferCanvas.width = bufferW;\r\n      this.bufferCanvas.height = bufferH;\r\n      // After resizing, need to re-acquire bufferCtx\r\n      this.bufferCtx = this.bufferCanvas.getContext(\"2d\");\r\n      if (!this.bufferCtx) return;\r\n    }\r\n    // Always use latest bufferCtx after possible resize\r\n    const activeBufferCtx = this.bufferCtx!;\r\n    // Draw simulation to bufferCanvas\r\n    activeBufferCtx.setTransform(1, 0, 0, 1, 0, 0); // No scaling here; scale coordinates instead\r\n    activeBufferCtx.clearRect(0, 0, bufferW, bufferH);\r\n    withContext(() => {\r\n      activeBufferCtx.fillStyle =\r\n        (AssetsConfig as any).palette?.background || \"#0b1220\";\r\n      activeBufferCtx.fillRect(0, 0, bufferW, bufferH);\r\n    });\r\n\r\n    // Ensure procedural starfield exists on renderer (base and bloom)\r\n    try {\r\n      // Throttle starfield generation to avoid noisy regeneration every sim step.\r\n      // Use a renderer-level cooldown counter measured in milliseconds.\r\n      const STAR_COOLDOWN_DEFAULT = 300; // milliseconds\r\n      // Initialize renderer-level fields if missing\r\n      if ((this as any)._starCanvas === undefined)\r\n        (this as any)._starCanvas = null;\r\n      if ((this as any)._starBloomCanvas === undefined)\r\n        (this as any)._starBloomCanvas = null;\r\n      if ((this as any)._starCooldownMs === undefined)\r\n        (this as any)._starCooldownMs = 0;\r\n      // Decrement renderer cooldown if active using state's dt/simDt (normalize to ms)\r\n      if ((this as any)._starCooldownMs > 0) {\r\n        const rawDt =\r\n          typeof (state as any).dt === \"number\"\r\n            ? (state as any).dt\r\n            : typeof (state as any).simDt === \"number\"\r\n              ? (state as any).simDt\r\n              : 1 / 60;\r\n        const dtMs = rawDt > 1 ? rawDt : rawDt * 1000;\r\n        const before = (this as any)._starCooldownMs;\r\n        (this as any)._starCooldownMs = Math.max(\r\n          0,\r\n          (this as any)._starCooldownMs - dtMs,\r\n        );\r\n        try {\r\n          const isTest =\r\n            (typeof process !== \"undefined\" &&\r\n              (process as any).env &&\r\n              ((process as any).env.VITEST ||\r\n                (process as any).env.VITEST_WORKER_ID)) ||\r\n            typeof (globalThis as any).vitest !== \"undefined\";\r\n          if (!isTest) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(\"canvasrenderer: starCooldown (renderer)\", {\r\n              before,\r\n              after: (this as any)._starCooldownMs,\r\n              rawDt,\r\n              dtMs,\r\n              t: state && (state as any).t,\r\n            });\r\n          }\r\n        } catch (e) {}\r\n      }\r\n      // Regenerate if missing and cooldown expired\r\n      if (!(this as any)._starCanvas && (this as any)._starCooldownMs <= 0) {\r\n        const size = Math.max(1024, Math.max(bufferW, bufferH));\r\n        const sc = document.createElement(\"canvas\");\r\n        sc.width = size;\r\n        sc.height = size;\r\n        const sctx = sc.getContext(\"2d\")!;\r\n        const g = sctx.createLinearGradient(0, 0, 0, size);\r\n        g.addColorStop(0, \"#001020\");\r\n        g.addColorStop(1, \"#000010\");\r\n        sctx.fillStyle = g;\r\n        sctx.fillRect(0, 0, size, size);\r\n        const stars = Math.floor(size * size * 0.00035);\r\n        for (let i = 0; i < stars; i++) {\r\n          const x = Math.random() * size;\r\n          const y = Math.random() * size;\r\n          const r = Math.random() * 1.2;\r\n          const bright = 0.5 + Math.random() * 0.5;\r\n          sctx.fillStyle = `rgba(255,255,255,${bright})`;\r\n          sctx.beginPath();\r\n          sctx.arc(x, y, r, 0, Math.PI * 2);\r\n          sctx.fill();\r\n        }\r\n        // bloom canvas: draw brighter spots and blur\r\n        const bc = document.createElement(\"canvas\");\r\n        bc.width = size;\r\n        bc.height = size;\r\n        const bctx = bc.getContext(\"2d\")!;\r\n        bctx.fillStyle = \"transparent\";\r\n        bctx.fillRect(0, 0, size, size);\r\n        for (let i = 0; i < 120; i++) {\r\n          const x = Math.random() * size;\r\n          const y = Math.random() * size;\r\n          const r = 1.6 + Math.random() * 2.4;\r\n          bctx.fillStyle = \"rgba(255,244,200,0.95)\";\r\n          bctx.beginPath();\r\n          bctx.arc(x, y, r, 0, Math.PI * 2);\r\n          bctx.fill();\r\n        }\r\n        // apply blur by drawing scaled-down/up trick for softer glow\r\n        const tmp = document.createElement(\"canvas\");\r\n        tmp.width = Math.max(64, Math.floor(size / 8));\r\n        tmp.height = Math.max(64, Math.floor(size / 8));\r\n        const tctx = tmp.getContext(\"2d\")!;\r\n        tctx.drawImage(bc, 0, 0, tmp.width, tmp.height);\r\n        bctx.clearRect(0, 0, size, size);\r\n        bctx.globalAlpha = 0.85;\r\n        bctx.drawImage(tmp, 0, 0, tmp.width, tmp.height, 0, 0, size, size);\r\n        bctx.globalAlpha = 1.0;\r\n        (this as any)._starCanvas = sc;\r\n        (this as any)._starBloomCanvas = bc;\r\n        try {\r\n          // eslint-disable-next-line no-console\r\n          console.log(\"canvasrenderer: regenerated starfield (renderer)\", {\r\n            width: (this as any)._starCanvas?.width,\r\n            height: (this as any)._starCanvas?.height,\r\n            time:\r\n              typeof performance !== \"undefined\" && performance.now\r\n                ? performance.now()\r\n                : Date.now(),\r\n          });\r\n        } catch (e) {}\r\n        (this as any)._starCooldownMs = STAR_COOLDOWN_DEFAULT;\r\n      }\r\n    } catch (e) {}\r\n\r\n    // helper: draw a polygon path from points (already scaled/rotated by transform)\r\n    function drawPolygon(points: number[][]) {\r\n      if (!points || points.length === 0) return;\r\n      activeBufferCtx.beginPath();\r\n      activeBufferCtx.moveTo(\r\n        points[0][0] * renderScale,\r\n        points[0][1] * renderScale,\r\n      );\r\n      for (let i = 1; i < points.length; i++)\r\n        activeBufferCtx.lineTo(\r\n          points[i][0] * renderScale,\r\n          points[i][1] * renderScale,\r\n        );\r\n      activeBufferCtx.closePath();\r\n      activeBufferCtx.fill();\r\n    }\r\n\r\n    // background starCanvas if present\r\n    if (state && state.starCanvas) {\r\n      if (state.starCanvas) {\r\n        withContext(() => {\r\n          activeBufferCtx.globalAlpha = 0.5;\r\n          activeBufferCtx.drawImage(\r\n            state.starCanvas as CanvasImageSource,\r\n            0,\r\n            0,\r\n            bufferW,\r\n            bufferH,\r\n          );\r\n        });\r\n      }\r\n      // composite bloom additively to approximate WebGL's SRC_ALPHA, ONE\r\n      if ((state as any).starBloomCanvas) {\r\n        try {\r\n          withContext(() => {\r\n            activeBufferCtx.globalCompositeOperation = \"lighter\"; // additive\r\n            try {\r\n              const bloom =\r\n                RendererConfig &&\r\n                (RendererConfig as any).starfield &&\r\n                typeof (RendererConfig as any).starfield.bloomIntensity ===\r\n                  \"number\"\r\n                  ? (RendererConfig as any).starfield.bloomIntensity\r\n                  : 0.9;\r\n              activeBufferCtx.globalAlpha = Math.max(0, Math.min(1, bloom));\r\n            } catch (e) {\r\n              activeBufferCtx.globalAlpha = 0.9;\r\n            }\r\n            activeBufferCtx.drawImage(\r\n              (state as any).starBloomCanvas as CanvasImageSource,\r\n              0,\r\n              0,\r\n              bufferW,\r\n              bufferH,\r\n            );\r\n            activeBufferCtx.globalCompositeOperation = \"source-over\";\r\n            activeBufferCtx.globalAlpha = 1.0;\r\n          });\r\n        } catch (e) {}\r\n      }\r\n    }\r\n\r\n    // helper: current time for animation pulses\r\n    const now = (state && state.t) || 0;\r\n\r\n    // Spawn damage particles from recent damage events (renderer-owned particle bursts)\r\n    try {\r\n      const dmgAnim =\r\n        AssetsConfig.animations && AssetsConfig.animations.damageParticles;\r\n      if (Array.isArray(state.damageEvents) && dmgAnim) {\r\n        state.particles = state.particles || [];\r\n        for (const ev of state.damageEvents) {\r\n          const count = dmgAnim.count || 6;\r\n          for (let i = 0; i < count; i++) {\r\n            const angle = Math.random() * Math.PI * 2;\r\n            const speed = Math.random() * (dmgAnim.spread || 0.6);\r\n            state.particles.push({\r\n              x: ev.x || 0,\r\n              y: ev.y || 0,\r\n              vx: Math.cos(angle) * speed,\r\n              vy: Math.sin(angle) * speed,\r\n              r: 0.6 + Math.random() * 0.8,\r\n              color:\r\n                dmgAnim.color ||\r\n                (AssetsConfig as any).palette?.shipAccent ||\r\n                \"#ff6b6b\",\r\n              lifetime: dmgAnim.lifetime || 0.8,\r\n              age: 0,\r\n              shape: \"circle\",\r\n            });\r\n          }\r\n        }\r\n        // clear damageEvents after spawning so they are one-shot\r\n        state.damageEvents = [];\r\n      }\r\n    } catch (e) {\r\n      /* ignore particle spawn errors */\r\n    }\r\n\r\n    // Engine trail rendering (config-driven, per ship)\r\n    // Helper to perform ship-local drawing with guaranteed save/restore.\r\n    function withShipContext(s: any, fn: () => void) {\r\n      activeBufferCtx.save();\r\n      try {\r\n        activeBufferCtx.translate(\r\n          (s.x || 0) * renderScale,\r\n          (s.y || 0) * renderScale,\r\n        );\r\n        activeBufferCtx.rotate(s.angle || 0);\r\n        fn();\r\n      } finally {\r\n        try {\r\n          activeBufferCtx.restore();\r\n        } catch (e) {\r\n          /* ignore restore errors */\r\n        }\r\n      }\r\n    }\r\n\r\n    // Generic helper to run a callback with save/restore around it.\r\n    function withContext(fn: () => void) {\r\n      activeBufferCtx.save();\r\n      try {\r\n        fn();\r\n      } finally {\r\n        try {\r\n          activeBufferCtx.restore();\r\n        } catch (e) {\r\n          /* ignore */\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const s of state.ships || []) {\r\n      const sx = (s.x || 0) * renderScale;\r\n      const sy = (s.y || 0) * renderScale;\r\n      if (sx < 0 || sx >= bufferW || sy < 0 || sy >= bufferH) continue;\r\n      // Update trail history (store in s.trail)\r\n      if (state.engineTrailsEnabled) {\r\n        s.trail = s.trail || [];\r\n        // Only add new trail point if ship moved\r\n        const last = s.trail.length ? s.trail[s.trail.length - 1] : null;\r\n        if (!last || last.x !== s.x || last.y !== s.y) {\r\n          s.trail.push({ x: s.x, y: s.y });\r\n        }\r\n        // Limit trail length using config\r\n        const trailConfig = getEngineTrailConfig(\r\n          s.type || getDefaultShipTypeSafe(),\r\n        );\r\n        const maxTrail = trailConfig?.maxLength || 40;\r\n        while (s.trail.length > maxTrail) s.trail.shift();\r\n      }\r\n\r\n      // Draw engine trail (configurable shape, color, width, fade)\r\n      if (Array.isArray(s.trail)) {\r\n        const trailConfig = getEngineTrailConfig(\r\n          s.type || getDefaultShipTypeSafe(),\r\n        );\r\n        const color =\r\n          trailConfig?.color ||\r\n          (AssetsConfig as any).palette?.bullet ||\r\n          \"#aee1ff\";\r\n        const width =\r\n          (trailConfig?.width || 0.35) * (s.radius || 12) * renderScale;\r\n        const fade = trailConfig?.fade || 0.35;\r\n        // Use SVG engine mountpoints if available\r\n        const engineMounts =\r\n          this._svgEngineMountCache &&\r\n          this._svgEngineMountCache[s.type || getDefaultShipTypeSafe()];\r\n        if (Array.isArray(engineMounts) && engineMounts.length > 0) {\r\n          for (const [emx, emy] of engineMounts) {\r\n            for (let i = 0; i < s.trail.length; i++) {\r\n              // Place trail at engine mount offset, rotated by ship angle\r\n              const angle = s.angle || 0;\r\n              const tx =\r\n                s.x +\r\n                (Math.cos(angle) * emx - Math.sin(angle) * emy) *\r\n                  (s.radius || 12);\r\n              const ty =\r\n                s.y +\r\n                (Math.sin(angle) * emx + Math.cos(angle) * emy) *\r\n                  (s.radius || 12);\r\n              // Fade alpha from fade to 1.0\r\n              const tAlpha = fade + (1 - fade) * (i / s.trail.length);\r\n              const txx = tx * renderScale;\r\n              const tyy = ty * renderScale;\r\n              if (txx < 0 || txx >= bufferW || tyy < 0 || tyy >= bufferH)\r\n                continue;\r\n              withContext(() => {\r\n                activeBufferCtx.globalAlpha = tAlpha;\r\n                activeBufferCtx.fillStyle = color;\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(txx, tyy, width, 0, Math.PI * 2);\r\n                activeBufferCtx.fill();\r\n              });\r\n            }\r\n          }\r\n        } else {\r\n          // Fallback: single trail at ship center\r\n          for (let i = 0; i < s.trail.length; i++) {\r\n            const tx = s.trail[i].x || 0;\r\n            const ty = s.trail[i].y || 0;\r\n            // Fade alpha from fade to 1.0\r\n            const tAlpha = fade + (1 - fade) * (i / s.trail.length);\r\n            const txx = tx * renderScale;\r\n            const tyy = ty * renderScale;\r\n            if (txx < 0 || txx >= bufferW || tyy < 0 || tyy >= bufferH)\r\n              continue;\r\n            withContext(() => {\r\n              activeBufferCtx.globalAlpha = tAlpha;\r\n              activeBufferCtx.fillStyle = color;\r\n              activeBufferCtx.beginPath();\r\n              activeBufferCtx.arc(txx, tyy, width, 0, Math.PI * 2);\r\n              activeBufferCtx.fill();\r\n            });\r\n          }\r\n        }\r\n      }\r\n\r\n      // Draw ship hull using asset-agnostic sprite provider inside a ship-local\r\n      // context so shapes can be drawn around (0,0).\r\n      const sprite = getSpriteAsset(s.type || getDefaultShipTypeSafe());\r\n      withShipContext(s, () => {\r\n        // Resolve team color via TeamsConfig if available; fall back to palette\r\n        let teamColor = (AssetsConfig as any).palette?.shipHull || \"#888\";\r\n        try {\r\n          if (s && s.team && TeamsConfig && (TeamsConfig as any).teams) {\r\n            const teamEntry = (TeamsConfig as any).teams[s.team];\r\n            if (teamEntry && teamEntry.color) teamColor = teamEntry.color;\r\n          }\r\n        } catch {}\r\n        activeBufferCtx.fillStyle = teamColor;\r\n        // --- SVG hull rendering ---\r\n        let hullDrawn = false;\r\n        // Prefer using a cached hull canvas for this type (preloaded), even if sprite.svg isn't present.\r\n        this._svgHullCache = this._svgHullCache || {};\r\n        const cacheKey = s.type || getDefaultShipTypeSafe();\r\n        let hullCanvas = this._svgHullCache[cacheKey];\r\n        // Detect and ignore placeholder canvases (blank prewarm) to avoid drawing them\r\n        if (hullCanvas && (hullCanvas as any)._placeholder) {\r\n          hullCanvas = undefined;\r\n        }\r\n        if (sprite.svg || hullCanvas) {\r\n          if (!hullCanvas && sprite.svg) {\r\n            try {\r\n              // Use svgLoader to rasterize hull-only SVG\r\n              const svgText = sprite.svg;\r\n              // Use a reasonable size for rasterization (match viewBox or default)\r\n              let outW = 128,\r\n                outH = 128;\r\n              const vbMatch =\r\n                /viewBox\\s*=\\s*\"(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)\"/.exec(\r\n                  svgText,\r\n                );\r\n              if (vbMatch) {\r\n                outW = parseInt(vbMatch[3]) || 128;\r\n                outH = parseInt(vbMatch[4]) || 128;\r\n              }\r\n              // Prefer a synchronously-available cached canvas from svgRenderer\r\n              hullCanvas = (svgLoader as any).getCachedHullCanvasSync\r\n                ? (svgLoader as any).getCachedHullCanvasSync(\r\n                    svgText,\r\n                    outW,\r\n                    outH,\r\n                    cacheKey,\r\n                  )\r\n                : undefined;\r\n              if (!hullCanvas) {\r\n                // If no sync cached canvas, try local synchronous rasterization as a fallback\r\n                try {\r\n                  hullCanvas = svgLoader.rasterizeHullOnlySvgToCanvas(\r\n                    svgText,\r\n                    outW,\r\n                    outH,\r\n                  ) as HTMLCanvasElement;\r\n                } catch (e) {\r\n                  hullCanvas = undefined;\r\n                }\r\n              }\r\n              this._svgHullCache[cacheKey] = hullCanvas;\r\n            } catch (e) {\r\n              hullCanvas = undefined;\r\n            }\r\n          }\r\n          if (hullCanvas) {\r\n            const hc = hullCanvas as HTMLCanvasElement;\r\n            // Center and scale hullCanvas to ship radius\r\n            const scale = ((s.radius || 12) * renderScale) / (hc.width / 2);\r\n            // Prepare tinted cache (per-team pool)\r\n            if (!this._tintedHullPool)\r\n              this._tintedHullPool = new TintedHullPool({\r\n                globalCap: 256,\r\n                perTeamCap: 64,\r\n              });\r\n            const tintedKey = `${cacheKey}::${teamColor}`;\r\n            // Try to read and promote existing entry to MRU via pool\r\n            let tintedCanvas: HTMLCanvasElement | undefined = undefined;\r\n            if (this._tintedHullPool.has(tintedKey)) {\r\n              const existing = this._tintedHullPool.get(tintedKey) as\r\n                | HTMLCanvasElement\r\n                | undefined;\r\n              if (existing) {\r\n                // If the existing cached canvas matches the desired size,\r\n                // promote to MRU and use it. If it doesn't match (e.g. a\r\n                // small placeholder pre-warmed during init), remove it so\r\n                // we can generate or fetch a correctly-sized tinted canvas.\r\n                try {\r\n                  if (\r\n                    existing.width === hullCanvas.width &&\r\n                    existing.height === hullCanvas.height\r\n                  ) {\r\n                    // Promote to MRU by re-setting the entry\r\n                    this._tintedHullPool.delete(tintedKey);\r\n                    this._tintedHullPool.set(tintedKey, existing);\r\n                    tintedCanvas = existing;\r\n                  } else {\r\n                    // size mismatch -> remove placeholder so we can create real one\r\n                    try {\r\n                      this._tintedHullPool.delete(tintedKey);\r\n                    } catch (ee) {}\r\n                  }\r\n                } catch (e) {\r\n                  // On any errors, fall back to treating as missing\r\n                  try {\r\n                    this._tintedHullPool.delete(tintedKey);\r\n                  } catch (ee) {}\r\n                }\r\n              }\r\n            }\r\n            if (!tintedCanvas) {\r\n              try {\r\n                // lazy require to avoid circular imports at module load time\r\n                let svgRenderer: any = undefined;\r\n                try {\r\n                  import(\"./assets/svgRenderer\").then(\r\n                    (m) => (svgRenderer = m.default || m),\r\n                  );\r\n                } catch (e) {\r\n                  svgRenderer = undefined;\r\n                }\r\n                if (\r\n                  svgRenderer &&\r\n                  typeof svgRenderer.getCanvas === \"function\"\r\n                ) {\r\n                  const assetKey = cacheKey; // reuse cacheKey (shipType)\r\n                  const mapping = teamMapping(teamColor);\r\n                  // Prefer synchronous cached canvas if available\r\n                  try {\r\n                    const c = svgRenderer.getCanvas(\r\n                      assetKey,\r\n                      mapping,\r\n                      hullCanvas.width,\r\n                      hullCanvas.height,\r\n                    );\r\n                    // If the svgRenderer returned a ready-to-use canvas that matches\r\n                    // the desired size, use it directly. Otherwise create a local\r\n                    // tinted canvas from the hullCanvas so we can draw this frame.\r\n                    if (c && (c.width === hullCanvas.width && c.height === hullCanvas.height)) {\r\n                      try {\r\n                        // Promote to cached tinted canvas for this key\r\n                        this._setTintedCanvas(tintedKey, c as HTMLCanvasElement);\r\n                        tintedCanvas = c as HTMLCanvasElement;\r\n                      } catch (e) {\r\n                        // ignore set/cache errors and fall through to local tint\r\n                        tintedCanvas = c as HTMLCanvasElement;\r\n                      }\r\n                      try {\r\n                        (svgLoader as any).ensureRasterizedAndCached &&\r\n                          (svgLoader as any).ensureRasterizedAndCached(\r\n                            sprite.svg,\r\n                            mapping,\r\n                            hullCanvas.width,\r\n                            hullCanvas.height,\r\n                            { assetKey, applyTo: \"both\" },\r\n                          );\r\n                      } catch (e) {}\r\n                    } else {\r\n                      // No synchronous cached canvas available (or size mismatch).\r\n                      // Create a temporary canvas and attempt a multiply+mask tint\r\n                      // which preserves luminosity. Fall back to source-atop if\r\n                      // composite operations fail.\r\n                      try {\r\n                        const tc = document.createElement(\"canvas\");\r\n                        tc.width = hullCanvas.width;\r\n                        tc.height = hullCanvas.height;\r\n                        const tctx = tc.getContext(\"2d\");\r\n                        const col = teamColor;\r\n                        const k = tintedKey;\r\n                        if (tctx) {\r\n                              try {\r\n                                // HSL hue-shift approach: preserve per-pixel lightness\r\n                                // while changing hue to the team color. This tends to\r\n                                // preserve highlights/dark regions better than simple\r\n                                // multiply composites.\r\n                                tctx.clearRect(0, 0, tc.width, tc.height);\r\n                                tctx.drawImage(hullCanvas, 0, 0);\r\n\r\n                                // Helper: parse hex color to rgb\r\n                                const hexToRgb = (hex: string) => {\r\n                                  if (!hex) return null;\r\n                                  let h = hex.replace(/^#/, \"\");\r\n                                  if (h.length === 3)\r\n                                    h = h.split(\"\").map((c) => c + c).join(\"\");\r\n                                  if (h.length !== 6) return null;\r\n                                  const r = parseInt(h.substring(0, 2), 16);\r\n                                  const g = parseInt(h.substring(2, 4), 16);\r\n                                  const b = parseInt(h.substring(4, 6), 16);\r\n                                  return { r, g, b };\r\n                                };\r\n\r\n                                const rgbToHsl = (r: number, g: number, b: number) => {\r\n                                  r /= 255;\r\n                                  g /= 255;\r\n                                  b /= 255;\r\n                                  const max = Math.max(r, g, b);\r\n                                  const min = Math.min(r, g, b);\r\n                                  let h = 0;\r\n                                  let s = 0;\r\n                                  const l = (max + min) / 2;\r\n                                  if (max !== min) {\r\n                                    const d = max - min;\r\n                                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n                                    switch (max) {\r\n                                      case r:\r\n                                        h = (g - b) / d + (g < b ? 6 : 0);\r\n                                        break;\r\n                                      case g:\r\n                                        h = (b - r) / d + 2;\r\n                                        break;\r\n                                      case b:\r\n                                        h = (r - g) / d + 4;\r\n                                        break;\r\n                                    }\r\n                                    h = h * 60;\r\n                                  }\r\n                                  return [h, s, l] as [number, number, number];\r\n                                };\r\n\r\n                                const hslToRgb = (h: number, s: number, l: number) => {\r\n                                  h = (h % 360 + 360) % 360;\r\n                                  const c = (1 - Math.abs(2 * l - 1)) * s;\r\n                                  const x = c * (1 - Math.abs(((h / 60) % 2) - 1));\r\n                                  const m = l - c / 2;\r\n                                  let r1 = 0,\r\n                                    g1 = 0,\r\n                                    b1 = 0;\r\n                                  if (h < 60) {\r\n                                    r1 = c;\r\n                                    g1 = x;\r\n                                    b1 = 0;\r\n                                  } else if (h < 120) {\r\n                                    r1 = x;\r\n                                    g1 = c;\r\n                                    b1 = 0;\r\n                                  } else if (h < 180) {\r\n                                    r1 = 0;\r\n                                    g1 = c;\r\n                                    b1 = x;\r\n                                  } else if (h < 240) {\r\n                                    r1 = 0;\r\n                                    g1 = x;\r\n                                    b1 = c;\r\n                                  } else if (h < 300) {\r\n                                    r1 = x;\r\n                                    g1 = 0;\r\n                                    b1 = c;\r\n                                  } else {\r\n                                    r1 = c;\r\n                                    g1 = 0;\r\n                                    b1 = x;\r\n                                  }\r\n                                  const r = Math.round((r1 + m) * 255);\r\n                                  const g = Math.round((g1 + m) * 255);\r\n                                  const b = Math.round((b1 + m) * 255);\r\n                                  return [r, g, b] as [number, number, number];\r\n                                };\r\n\r\n                                const teamRgb = hexToRgb(col);\r\n                                let teamHue = 0;\r\n                                if (teamRgb) {\r\n                                  teamHue = rgbToHsl(teamRgb.r, teamRgb.g, teamRgb.b)[0];\r\n                                }\r\n\r\n                                try {\r\n                                  const img = tctx.getImageData(0, 0, tc.width, tc.height);\r\n                                  const data = img.data;\r\n                                  for (let i = 0; i < data.length; i += 4) {\r\n                                    const alpha = data[i + 3];\r\n                                    if (alpha < 8) continue; // skip near-transparent\r\n                                    const r = data[i];\r\n                                    const g = data[i + 1];\r\n                                    const b = data[i + 2];\r\n                                    const [h, s, l] = rgbToHsl(r, g, b);\r\n                                    // Replace hue with team hue; keep original saturation and lightness\r\n                                    const [nr, ng, nb] = hslToRgb(teamHue, s, l);\r\n                                    data[i] = nr;\r\n                                    data[i + 1] = ng;\r\n                                    data[i + 2] = nb;\r\n                                  }\r\n                                  tctx.putImageData(img, 0, 0);\r\n                                  this._setTintedCanvas(k, tc);\r\n                                  tintedCanvas = tc;\r\n                                } catch (e) {\r\n                                  // If pixel manipulation fails, fallback to source-atop\r\n                                  tctx.clearRect(0, 0, tc.width, tc.height);\r\n                                  tctx.drawImage(hullCanvas, 0, 0);\r\n                                  tctx.globalCompositeOperation = \"source-atop\";\r\n                                  tctx.fillStyle = col;\r\n                                  tctx.fillRect(0, 0, tc.width, tc.height);\r\n                                  tctx.globalCompositeOperation = \"source-over\";\r\n                                  this._setTintedCanvas(k, tc);\r\n                                  tintedCanvas = tc;\r\n                                }\r\n                              } catch (e) {\r\n                                // Give up on local tint; leave tintedCanvas undefined\r\n                              }\r\n                        }\r\n                      } catch (e) {\r\n                        /* ignore local tint errors */\r\n                      }\r\n                    }\r\n                  } catch (e) {\r\n                    /* ignore cache lookup errors */\r\n                  }\r\n                }\r\n              } catch (e) {}\r\n\r\n              // If the raster cache did not provide a synchronous canvas, create\r\n              // a local tinted copy so we can draw this frame while the async\r\n              // cached raster is produced for future frames.\r\n              if (!tintedCanvas) {\r\n                try {\r\n                  const tc = document.createElement(\"canvas\");\r\n                  tc.width = hullCanvas.width;\r\n                  tc.height = hullCanvas.height;\r\n                  const tctx = tc.getContext(\"2d\");\r\n                  if (tctx) {\r\n                    tctx.clearRect(0, 0, tc.width, tc.height);\r\n                    tctx.drawImage(hullCanvas, 0, 0);\r\n                    tctx.globalCompositeOperation = \"source-in\";\r\n                    tctx.fillStyle = teamColor;\r\n                    tctx.fillRect(0, 0, tc.width, tc.height);\r\n                    tctx.globalCompositeOperation = \"source-over\";\r\n                    tintedCanvas = tc;\r\n                    this._setTintedCanvas(tintedKey, tc);\r\n                  }\r\n                } catch (e) {\r\n                  /* ignore local tint errors */\r\n                }\r\n              }\r\n            }\r\n\r\n            // Draw the tinted (or original) canvas centered and scaled\r\n            withContext(() => {\r\n              activeBufferCtx.save();\r\n              activeBufferCtx.scale(scale, scale);\r\n              try {\r\n                activeBufferCtx.drawImage(\r\n                  (tintedCanvas || hc) as HTMLCanvasElement,\r\n                  -hc.width / 2,\r\n                  -hc.height / 2,\r\n                );\r\n              } catch (e) {\r\n                // fallback to drawing original if tinted draw fails\r\n                try {\r\n                  activeBufferCtx.drawImage(hc, -hc.width / 2, -hc.height / 2);\r\n                } catch (e) {}\r\n              }\r\n              activeBufferCtx.restore();\r\n            });\r\n            hullDrawn = true;\r\n          }\r\n        }\r\n        // Fallback: draw shape if SVG hull not drawn\r\n        if (!hullDrawn) {\r\n          const shape = sprite.shape;\r\n          if (shape) {\r\n            if (shape.type === \"circle\") {\r\n              activeBufferCtx.beginPath();\r\n              activeBufferCtx.arc(\r\n                0,\r\n                0,\r\n                (s.radius || 12) * renderScale,\r\n                0,\r\n                Math.PI * 2,\r\n              );\r\n              activeBufferCtx.fill();\r\n            } else if (shape.type === \"polygon\") {\r\n              drawPolygon(shape.points as number[][]);\r\n            } else if (shape.type === \"compound\") {\r\n              for (const part of shape.parts) {\r\n                if (part.type === \"circle\") {\r\n                  activeBufferCtx.beginPath();\r\n                  activeBufferCtx.arc(\r\n                    0,\r\n                    0,\r\n                    (part.r || 1) * (s.radius || 12) * renderScale,\r\n                    0,\r\n                    Math.PI * 2,\r\n                  );\r\n                  activeBufferCtx.fill();\r\n                } else if (part.type === \"polygon\") {\r\n                  drawPolygon(part.points as number[][]);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n        // Draw engine flare if configured (local-space polygon offset behind/forward of ship)\r\n        try {\r\n          const vconf = getVisualConfig(s.type || getDefaultShipTypeSafe());\r\n          const engineName =\r\n            vconf && vconf.visuals && vconf.visuals.engine\r\n              ? vconf.visuals.engine\r\n              : \"engineFlare\";\r\n          const engAnim =\r\n            (AssetsConfig as any).animations &&\r\n            (AssetsConfig as any).animations[engineName];\r\n          if (engAnim && Array.isArray(engAnim.points)) {\r\n            const radius = s.radius || 12;\r\n            const offsetLocal =\r\n              typeof engAnim.offset === \"number\"\r\n                ? engAnim.offset * radius * renderScale\r\n                : 0;\r\n            withContext(() => {\r\n              activeBufferCtx.translate(offsetLocal, 0);\r\n              activeBufferCtx.globalAlpha =\r\n                typeof engAnim.alpha === \"number\" ? engAnim.alpha : 1.0;\r\n              activeBufferCtx.fillStyle =\r\n                engAnim.color ||\r\n                (AssetsConfig as any).palette?.shipAccent ||\r\n                \"#ffffff\";\r\n              activeBufferCtx.beginPath();\r\n              const pts: number[][] = engAnim.points || [];\r\n              if (pts.length) {\r\n                activeBufferCtx.moveTo(\r\n                  (pts[0][0] || 0) * radius * renderScale,\r\n                  (pts[0][1] || 0) * radius * renderScale,\r\n                );\r\n                for (let pi = 1; pi < pts.length; pi++)\r\n                  activeBufferCtx.lineTo(\r\n                    (pts[pi][0] || 0) * radius * renderScale,\r\n                    (pts[pi][1] || 0) * radius * renderScale,\r\n                  );\r\n                activeBufferCtx.closePath();\r\n                activeBufferCtx.fill();\r\n              }\r\n            });\r\n          }\r\n        } catch (e) {\r\n          /* ignore engine flare draw errors */\r\n        }\r\n        // Draw turrets. Turrets may have independent angles (turret.angle) and\r\n        // turnRate. Mount positions can come from the ship instance, shapes2d\r\n        // config, or extracted from SVGs (svgMounts). We prefer instance\r\n        // positions, then shape config, then svgMounts as a last resort.\r\n        const shipType = s.type || \"fighter\";\r\n        const shipCfg = getShipConfigSafe()[shipType];\r\n        const configRadius =\r\n          shipCfg && typeof shipCfg.radius === \"number\"\r\n            ? shipCfg.radius\r\n            : s.radius || 12;\r\n        const shapeEntry: any =\r\n          AssetsConfig.shapes2d && (AssetsConfig.shapes2d as any)[shipType];\r\n        const svgMounts =\r\n          (AssetsConfig as any).svgMounts &&\r\n          (AssetsConfig as any).svgMounts[shipType];\r\n        const instanceTurrets = Array.isArray((s as any).turrets)\r\n          ? (s as any).turrets\r\n          : (shapeEntry && shapeEntry.turrets) || [];\r\n        for (let ti = 0; ti < instanceTurrets.length; ti++) {\r\n          try {\r\n            const turret = instanceTurrets[ti];\r\n            // If turret is a simple position tuple from svgMounts, normalize to object\r\n            let turretObj: any = turret;\r\n            if (!turretObj) continue;\r\n            if (\r\n              !turretObj.position &&\r\n              Array.isArray(turret) &&\r\n              turret.length === 2\r\n            ) {\r\n              turretObj = { kind: \"basic\", position: turret };\r\n            }\r\n            // As a last resort, try to use svgMounts mapping for this index\r\n            if (\r\n              (!turretObj.position || turretObj.position.length !== 2) &&\r\n              Array.isArray(svgMounts) &&\r\n              svgMounts[ti]\r\n            ) {\r\n              turretObj.position = svgMounts[ti];\r\n            }\r\n            if (!turretObj.position) continue;\r\n            const turretKind = turretObj.kind || \"basic\";\r\n            const turretShape = getTurretAsset(turretKind as any);\r\n            // Turret angle: instance-provided turret.angle if present, else default to ship angle\r\n            // turretObj.angle is stored as local turret rotation relative to ship\r\n            const turretLocalAngle =\r\n              typeof turretObj.angle === \"number\"\r\n                ? turretObj.angle\r\n                : typeof (s as any).turretAngle === \"number\"\r\n                  ? (s as any).turretAngle\r\n                  : 0;\r\n            // Turret turnRate: instance value, else assets-config default, else fallback\r\n            const turretTurnRate =\r\n              typeof turretObj.turnRate === \"number\"\r\n                ? turretObj.turnRate\r\n                : ((AssetsConfig as any).turretDefaults &&\r\n                    (AssetsConfig as any).turretDefaults[turretKind] &&\r\n                    (AssetsConfig as any).turretDefaults[turretKind]\r\n                      .turnRate) ||\r\n                  Math.PI * 1.5;\r\n            const [tx, ty] = turretObj.position; // mount local coords (radius units)\r\n            // Convert mount local coords (radius units) into ship-local pixels and rotate by ship heading\r\n            const angle = s.angle || 0;\r\n            const turretX =\r\n              (Math.cos(angle) * tx - Math.sin(angle) * ty) *\r\n              configRadius *\r\n              renderScale;\r\n            const turretY =\r\n              (Math.sin(angle) * tx + Math.cos(angle) * ty) *\r\n              configRadius *\r\n              renderScale;\r\n            const turretScale = configRadius * renderScale * 0.5;\r\n            withContext(() => {\r\n              activeBufferCtx.translate(turretX, turretY);\r\n              // Rotate turret independently by turretAngle (relative to world)\r\n              activeBufferCtx.rotate(turretLocalAngle - (s.angle || 0));\r\n              // Try to draw cached rasterized turret sprite for this kind\r\n              const spriteCanvas =\r\n                this._turretSpriteCache && this._turretSpriteCache[turretKind];\r\n              if (spriteCanvas) {\r\n                try {\r\n                  const pw = spriteCanvas.width;\r\n                  const ph = spriteCanvas.height;\r\n                  activeBufferCtx.drawImage(\r\n                    spriteCanvas,\r\n                    -pw / 2,\r\n                    -ph / 2,\r\n                    pw,\r\n                    ph,\r\n                  );\r\n                  return;\r\n                } catch (e) {}\r\n              }\r\n              // Fallback vector draw\r\n              activeBufferCtx.fillStyle =\r\n                (AssetsConfig as any).palette?.turret || \"#94a3b8\";\r\n              if (turretShape.type === \"circle\") {\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(\r\n                  0,\r\n                  0,\r\n                  (turretShape.r || 1) * turretScale,\r\n                  0,\r\n                  Math.PI * 2,\r\n                );\r\n                activeBufferCtx.fill();\r\n              } else if (turretShape.type === \"polygon\") {\r\n                withContext(() => {\r\n                  activeBufferCtx.scale(turretScale, turretScale);\r\n                  drawPolygon(turretShape.points as number[][]);\r\n                });\r\n              } else if (turretShape.type === \"compound\") {\r\n                for (const part of turretShape.parts) {\r\n                  if (part.type === \"circle\") {\r\n                    activeBufferCtx.beginPath();\r\n                    activeBufferCtx.arc(\r\n                      0,\r\n                      0,\r\n                      (part.r || 1) * turretScale,\r\n                      0,\r\n                      Math.PI * 2,\r\n                    );\r\n                    activeBufferCtx.fill();\r\n                  } else if (part.type === \"polygon\") {\r\n                    withContext(() => {\r\n                      activeBufferCtx.scale(turretScale, turretScale);\r\n                      drawPolygon(part.points as number[][]);\r\n                    });\r\n                  }\r\n                }\r\n              }\r\n            });\r\n          } catch (e) {\r\n            /* ignore turret draw errors per turret */\r\n          }\r\n        }\r\n\r\n        // Draw shield effect (outline) in ship-local coords at 0,0\r\n        if ((s.shield ?? 0) > 0) {\r\n          const shAnim =\r\n            (AssetsConfig as any).animations &&\r\n            (AssetsConfig as any).animations.shieldEffect;\r\n          try {\r\n            // Compute alpha and stroke params from animation config if present\r\n            const pulse =\r\n              shAnim && typeof shAnim.pulseRate === \"number\"\r\n                ? 0.5 + 0.5 * Math.sin(now * shAnim.pulseRate)\r\n                : 1.0;\r\n            const shieldNorm = Math.max(\r\n              0,\r\n              Math.min(1, (s.shield || 0) / (s.maxShield || s.shield || 1)),\r\n            );\r\n            const alphaBase =\r\n              shAnim && typeof shAnim.alphaBase === \"number\"\r\n                ? shAnim.alphaBase\r\n                : (shAnim && shAnim.alpha) || 0.25;\r\n            const alphaScale =\r\n              shAnim && typeof shAnim.alphaScale === \"number\"\r\n                ? shAnim.alphaScale\r\n                : 0.75;\r\n            const alpha = Math.max(\r\n              0,\r\n              Math.min(1, alphaBase + alphaScale * pulse * shieldNorm),\r\n            );\r\n            const strokeColor =\r\n              (shAnim && shAnim.color) ||\r\n              (AssetsConfig as any).palette?.shipAccent ||\r\n              \"#3ab6ff\";\r\n            const strokeWidth =\r\n              (shAnim &&\r\n                (shAnim.strokeWidth || 0.08) *\r\n                  (s.radius || 12) *\r\n                  renderScale) ||\r\n              3 * renderScale;\r\n\r\n            // Try to extract SVG hull outline for shield stroke\r\n            let stroked = false;\r\n            try {\r\n              const getHullOutlineFromSvg =\r\n                svgLoader && (svgLoader as any).getHullOutlineFromSvg\r\n                  ? (svgLoader as any).getHullOutlineFromSvg\r\n                  : (svgText: string, tol?: number) => {\r\n                      try {\r\n                        return (svgLoader as any).getHullOutlineFromSvg(\r\n                          svgText,\r\n                          tol,\r\n                        );\r\n                      } catch (e) {\r\n                        return { contours: [] };\r\n                      }\r\n                    };\r\n              const svgText = getShipAsset(s.type);\r\n              if (svgText) {\r\n                const outline = getHullOutlineFromSvg(svgText, 1.5);\r\n                if (outline && outline.contours && outline.contours.length) {\r\n                  withContext(() => {\r\n                    activeBufferCtx.globalAlpha = alpha;\r\n                    activeBufferCtx.strokeStyle = strokeColor;\r\n                    activeBufferCtx.lineWidth = strokeWidth;\r\n                    for (const contour of outline.contours) {\r\n                      if (contour.length) {\r\n                        activeBufferCtx.beginPath();\r\n                        activeBufferCtx.moveTo(\r\n                          (contour[0][0] || 0) * (s.radius || 12) * renderScale,\r\n                          (contour[0][1] || 0) * (s.radius || 12) * renderScale,\r\n                        );\r\n                        for (let i = 1; i < contour.length; i++)\r\n                          activeBufferCtx.lineTo(\r\n                            (contour[i][0] || 0) *\r\n                              (s.radius || 12) *\r\n                              renderScale,\r\n                            (contour[i][1] || 0) *\r\n                              (s.radius || 12) *\r\n                              renderScale,\r\n                          );\r\n                        activeBufferCtx.closePath();\r\n                        activeBufferCtx.stroke();\r\n                      }\r\n                    }\r\n                  });\r\n                  stroked = true;\r\n                }\r\n              }\r\n            } catch (e) {\r\n              /* ignore shield draw errors */\r\n            }\r\n            // Fallback: legacy circle stroke if no polygon\r\n            if (!stroked) {\r\n              withContext(() => {\r\n                activeBufferCtx.globalAlpha = alpha;\r\n                activeBufferCtx.strokeStyle = strokeColor;\r\n                activeBufferCtx.lineWidth = strokeWidth;\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(\r\n                  0,\r\n                  0,\r\n                  (s.radius || 12) * renderScale,\r\n                  0,\r\n                  Math.PI * 2,\r\n                );\r\n                activeBufferCtx.stroke();\r\n              });\r\n            }\r\n            // HP/shield bar rendering (restored baseline)\r\n            const baseW = Math.max(20, (s.radius || 12) * 1.6);\r\n            const baseH = Math.max(4, Math.round((s.radius || 12) * 0.25));\r\n            const dx = -Math.round(baseW / 2);\r\n            const dy = -(s.radius || 12) - baseH - 6;\r\n            const hbBg = (AssetsConfig as any).palette?.background || \"#222\";\r\n            const hbFill = (AssetsConfig as any).palette?.shipHull || \"#4caf50\";\r\n            const hpPct =\r\n              typeof (s as any).hpPercent === \"number\"\r\n                ? (s as any).hpPercent\r\n                : Math.max(0, Math.min(1, (s.hp || 0) / (s.maxHp || 1)));\r\n            const shPct =\r\n              typeof (s as any).shieldPercent === \"number\"\r\n                ? (s as any).shieldPercent\r\n                : typeof s.maxShield === \"number\" && s.maxShield > 0\r\n                  ? Math.max(0, Math.min(1, (s.shield || 0) / s.maxShield))\r\n                  : 0;\r\n            const w = Math.max(1, Math.round(baseW * renderScale));\r\n            const h = Math.max(1, Math.round(baseH * renderScale));\r\n            const ox = Math.round(dx * renderScale);\r\n            const oy = Math.round(dy * renderScale);\r\n            const sx = Math.round((s.x || 0) * renderScale);\r\n            const sy = Math.round((s.y || 0) * renderScale);\r\n            withContext(() => {\r\n              // Draw UI bars in screen space (non-rotating): reset transform to identity\r\n              // so these rects are not affected by the ship's local rotation/translation.\r\n              try {\r\n                activeBufferCtx.setTransform(1, 0, 0, 1, 0, 0);\r\n              } catch (e) {}\r\n              // Background\r\n              activeBufferCtx.fillStyle = hbBg;\r\n              activeBufferCtx.fillRect(sx + ox, sy + oy, w, h);\r\n              // HP fill (left-to-right)\r\n              activeBufferCtx.fillStyle = hbFill;\r\n              activeBufferCtx.fillRect(\r\n                sx + ox,\r\n                sy + oy,\r\n                Math.max(1, Math.round(w * hpPct)),\r\n                h,\r\n              );\r\n              // Shield overlay: thin bar above HP bar\r\n              if (shPct > 0) {\r\n                const shH = Math.max(1, Math.round(h * 0.5));\r\n                activeBufferCtx.fillStyle =\r\n                  (AssetsConfig as any).palette?.shipAccent || \"#3ab6ff\";\r\n                activeBufferCtx.fillRect(\r\n                  sx + ox,\r\n                  sy + oy - shH - 2,\r\n                  Math.max(1, Math.round(w * shPct)),\r\n                  shH,\r\n                );\r\n              }\r\n            });\r\n          } catch (e) {\r\n            /* ignore shield draw errors */\r\n          }\r\n        }\r\n      }); // end withShipContext for this ship\r\n\r\n      // Health hits: render freshest per-ship health flash using index (reddish rings), pooled\r\n      try {\r\n        const nowT = state.t || 0;\r\n        for (const s of state.ships || []) {\r\n          try {\r\n            let flash: any = null;\r\n            const arr = Array.isArray(state.healthFlashes)\r\n              ? state.healthFlashes.filter((f: any) => f.id === s.id)\r\n              : [];\r\n            let bestTs = -Infinity;\r\n            for (const f of arr) {\r\n              if (!f) continue;\r\n              const fTs = typeof f._ts === \"number\" ? f._ts : 0;\r\n              const fTtl = typeof f.ttl === \"number\" ? f.ttl : 0.4;\r\n              if (fTs + fTtl >= nowT - 1e-6 && fTs > bestTs) {\r\n                bestTs = fTs;\r\n                flash = f;\r\n              }\r\n            }\r\n            if (flash) {\r\n              // Use pooled effect for health flash\r\n              const pooledFlash = acquireEffect(\r\n                state,\r\n                \"healthFlash\",\r\n                () =>\r\n                  makePooled(\r\n                    // Use typed factory to create base health effect and attach render fields via reset\r\n                    createHealthHitEffect({\r\n                      x: flash.x || s.x || 0,\r\n                      y: flash.y || s.y || 0,\r\n                    }),\r\n                    (obj, initArgs) => {\r\n                      // rehydrate base health fields\r\n                      resetHealthHitEffect(obj, initArgs as any);\r\n                      // attach/rehydrate render-specific fields\r\n                      (obj as any).ttl = initArgs?.ttl ?? 0.4;\r\n                      (obj as any).life = initArgs?.life ?? (obj as any).ttl;\r\n                      (obj as any).color = \"#ff7766\";\r\n                      (obj as any).radius = 6;\r\n                    },\r\n                  ),\r\n                flash,\r\n              );\r\n              type RenderHealthFlash = HealthHitEffect & {\r\n                ttl: number;\r\n                life: number;\r\n                color: string;\r\n                radius: number;\r\n              };\r\n              const pf = pooledFlash as unknown as RenderHealthFlash;\r\n              const t = Math.max(0, Math.min(1, pf.life / pf.ttl));\r\n              const R = (pf.radius as number) + (1 - t) * 18;\r\n              const alpha = 0.9 * t;\r\n              const fx = (pf.x as number) * renderScale;\r\n              const fy = (pf.y as number) * renderScale;\r\n              if (fx >= 0 && fx < bufferW && fy >= 0 && fy < bufferH) {\r\n                withContext(() => {\r\n                  activeBufferCtx.globalAlpha = Math.max(0, Math.min(1, alpha));\r\n                  activeBufferCtx.strokeStyle = pf.color;\r\n                  activeBufferCtx.lineWidth = 2 * renderScale;\r\n                  activeBufferCtx.beginPath();\r\n                  activeBufferCtx.arc(\r\n                    fx,\r\n                    fy,\r\n                    Math.max(1, R * renderScale),\r\n                    0,\r\n                    Math.PI * 2,\r\n                  );\r\n                  activeBufferCtx.stroke();\r\n                });\r\n              }\r\n              releaseEffect(state, \"healthFlash\", pooledFlash);\r\n            }\r\n          } catch (e) {}\r\n        }\r\n      } catch (e) {}\r\n\r\n      // bullets\r\n      for (const b of state.bullets || []) {\r\n        try {\r\n          const bx = (b.x || 0) * renderScale;\r\n          const by = (b.y || 0) * renderScale;\r\n          if (bx < 0 || bx >= bufferW || by < 0 || by >= bufferH) continue;\r\n          const r = b.radius || b.bulletRadius || 1.5;\r\n          const kind =\r\n            typeof b.bulletRadius === \"number\"\r\n              ? b.bulletRadius < 2\r\n                ? \"small\"\r\n                : b.bulletRadius < 3\r\n                  ? \"medium\"\r\n                  : \"large\"\r\n              : \"small\";\r\n          const shape = getBulletAsset(kind as any);\r\n          withContext(() => {\r\n            activeBufferCtx.translate(bx, by);\r\n            const px = Math.max(1, r * renderScale);\r\n            activeBufferCtx.fillStyle = AssetsConfig.palette.bullet;\r\n            if (shape.type === \"circle\") {\r\n              activeBufferCtx.beginPath();\r\n              activeBufferCtx.arc(0, 0, px, 0, Math.PI * 2);\r\n              activeBufferCtx.fill();\r\n            } else if (shape.type === \"polygon\") {\r\n              drawPolygon(shape.points as number[][]);\r\n            } else if (shape.type === \"compound\") {\r\n              for (const part of shape.parts) {\r\n                if (part.type === \"circle\") {\r\n                  activeBufferCtx.beginPath();\r\n                  activeBufferCtx.arc(0, 0, (part.r || 1) * px, 0, Math.PI * 2);\r\n                  activeBufferCtx.fill();\r\n                } else if (part.type === \"polygon\") {\r\n                  drawPolygon(part.points as number[][]);\r\n                }\r\n              }\r\n            }\r\n          });\r\n        } catch (e) {}\r\n      }\r\n      // particles (pooled)\r\n      try {\r\n        const shapes = (AssetsConfig as any).shapes2d || {};\r\n        for (const p of state.particles || []) {\r\n          try {\r\n            // Use pooled sprite for particle visuals\r\n            const particle = acquireSprite(\r\n              state,\r\n              \"particle\",\r\n              () =>\r\n                makePooled(\r\n                  {\r\n                    x: p.x || 0,\r\n                    y: p.y || 0,\r\n                    r: p.r || 1,\r\n                    color:\r\n                      p.color ||\r\n                      (AssetsConfig as any).palette?.bullet ||\r\n                      \"#ffdca8\",\r\n                    age: p.age || 0,\r\n                    lifetime: p.lifetime || 1,\r\n                    assetShape: p.assetShape,\r\n                  },\r\n                  (obj, initArgs) => {\r\n                    obj.x = initArgs?.x ?? 0;\r\n                    obj.y = initArgs?.y ?? 0;\r\n                    obj.r = initArgs?.r ?? 1;\r\n                    obj.color = initArgs?.color ?? \"#ffdca8\";\r\n                    obj.age = initArgs?.age ?? 0;\r\n                    obj.lifetime = initArgs?.lifetime ?? 1;\r\n                    obj.assetShape = initArgs?.assetShape;\r\n                  },\r\n                ),\r\n              p,\r\n            );\r\n            const px = particle.x * renderScale;\r\n            const py = particle.y * renderScale;\r\n            if (px < 0 || px >= bufferW || py < 0 || py >= bufferH) continue;\r\n            withContext(() => {\r\n              const shapeName =\r\n                particle.assetShape ||\r\n                (particle.r > 0.5 ? \"particleMedium\" : \"particleSmall\");\r\n              const shape = shapes[shapeName];\r\n              activeBufferCtx.fillStyle = particle.color;\r\n              activeBufferCtx.globalAlpha = Math.max(\r\n                0,\r\n                Math.min(1, 1 - particle.age / particle.lifetime),\r\n              );\r\n              activeBufferCtx.translate(px, py);\r\n              if (shape) {\r\n                if (shape.type === \"circle\") {\r\n                  const rr = (shape.r || 0.12) * particle.r * renderScale * 6;\r\n                  activeBufferCtx.beginPath();\r\n                  activeBufferCtx.arc(0, 0, rr, 0, Math.PI * 2);\r\n                  activeBufferCtx.fill();\r\n                } else if (shape.type === \"polygon\") {\r\n                  activeBufferCtx.beginPath();\r\n                  const pts = shape.points || [];\r\n                  if (pts.length) {\r\n                    activeBufferCtx.moveTo(\r\n                      (pts[0][0] || 0) * renderScale,\r\n                      (pts[0][1] || 0) * renderScale,\r\n                    );\r\n                    for (let i = 1; i < pts.length; i++)\r\n                      activeBufferCtx.lineTo(\r\n                        (pts[i][0] || 0) * renderScale,\r\n                        (pts[i][1] || 0) * renderScale,\r\n                      );\r\n                    activeBufferCtx.closePath();\r\n                    activeBufferCtx.fill();\r\n                  }\r\n                } else if (shape.type === \"compound\") {\r\n                  for (const part of shape.parts || []) {\r\n                    if (part.type === \"circle\") {\r\n                      const rr =\r\n                        (part.r || 0.12) * particle.r * renderScale * 6;\r\n                      activeBufferCtx.beginPath();\r\n                      activeBufferCtx.arc(0, 0, rr, 0, Math.PI * 2);\r\n                      activeBufferCtx.fill();\r\n                    } else if (part.type === \"polygon\") {\r\n                      activeBufferCtx.beginPath();\r\n                      const pts = part.points || [];\r\n                      if (pts.length) {\r\n                        activeBufferCtx.moveTo(\r\n                          (pts[0][0] || 0) * renderScale,\r\n                          (pts[0][1] || 0) * renderScale,\r\n                        );\r\n                        for (let i = 1; i < pts.length; i++)\r\n                          activeBufferCtx.lineTo(\r\n                            (pts[i][0] || 0) * renderScale,\r\n                            (pts[i][1] || 0) * renderScale,\r\n                          );\r\n                        activeBufferCtx.closePath();\r\n                        activeBufferCtx.fill();\r\n                      }\r\n                    }\r\n                  }\r\n                } else {\r\n                  activeBufferCtx.beginPath();\r\n                  activeBufferCtx.arc(\r\n                    0,\r\n                    0,\r\n                    (particle.r || 2) * renderScale,\r\n                    0,\r\n                    Math.PI * 2,\r\n                  );\r\n                  activeBufferCtx.fill();\r\n                }\r\n              } else {\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(\r\n                  0,\r\n                  0,\r\n                  (particle.r || 2) * renderScale,\r\n                  0,\r\n                  Math.PI * 2,\r\n                );\r\n                activeBufferCtx.fill();\r\n              }\r\n            });\r\n            releaseSprite(state, \"particle\", particle);\r\n          } catch (e) {}\r\n        }\r\n      } catch (e) {\r\n        /* ignore particle render errors */\r\n      }\r\n\r\n      // Explosions (flashes) use explosionParticle if available, pooled via acquireEffect\r\n      try {\r\n        const expShape =\r\n          (AssetsConfig as any).shapes2d &&\r\n          (AssetsConfig as any).shapes2d.explosionParticle;\r\n        for (const ex of state.explosions || []) {\r\n          try {\r\n            // Use pooled effect for explosion visuals\r\n            const effect = acquireEffect(\r\n              state,\r\n              \"explosion\",\r\n              () =>\r\n                makePooled(\r\n                  createExplosionEffect({\r\n                    x: ex.x || 0,\r\n                    y: ex.y || 0,\r\n                    r: (expShape && expShape.r) || 0.32,\r\n                  }),\r\n                  (obj, initArgs) => {\r\n                    // rehydrate base explosion fields\r\n                    resetExplosionEffect(obj, initArgs as any);\r\n                    // attach/rehydrate render-specific fields\r\n                    (obj as any).scale = initArgs?.scale ?? 1;\r\n                    (obj as any).color = initArgs?.color ?? \"#ffd089\";\r\n                    (obj as any).alpha =\r\n                      initArgs?.alpha ??\r\n                      (1 - (ex.life || 0.5) / (ex.ttl || 0.5)) * 0.9;\r\n                  },\r\n                ),\r\n              ex,\r\n            );\r\n            type RenderExplosion = ExplosionEffect & {\r\n              scale?: number;\r\n              color?: string;\r\n              alpha?: number;\r\n            };\r\n            const ef = effect as unknown as RenderExplosion;\r\n            withContext(() => {\r\n              activeBufferCtx.globalAlpha = (ef.alpha as number) || 0;\r\n              activeBufferCtx.translate(\r\n                (ef.x as number) * renderScale,\r\n                (ef.y as number) * renderScale,\r\n              );\r\n              activeBufferCtx.fillStyle =\r\n                ef.color || (AssetsConfig as any).palette?.bullet || \"#ffd089\";\r\n              if (expShape && expShape.type === \"circle\") {\r\n                const rr = (ef.r || 0.32) * (ef.scale || 1) * renderScale * 6;\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(\r\n                  0,\r\n                  0,\r\n                  rr * (1 + (1 - (ex.life || 0.5) / (ex.ttl || 0.5))),\r\n                  0,\r\n                  Math.PI * 2,\r\n                );\r\n                activeBufferCtx.fill();\r\n              } else {\r\n                activeBufferCtx.beginPath();\r\n                activeBufferCtx.arc(\r\n                  0,\r\n                  0,\r\n                  Math.max(\r\n                    2,\r\n                    (ef.scale || 1) *\r\n                      12 *\r\n                      (1 - (ex.life || 0.5) / (ex.ttl || 0.5)),\r\n                  ),\r\n                  0,\r\n                  Math.PI * 2,\r\n                );\r\n                activeBufferCtx.fill();\r\n              }\r\n            });\r\n            releaseEffect(state, \"explosion\", effect);\r\n          } catch (e) {}\r\n        }\r\n      } catch (e) {}\r\n\r\n      // --- Copy bufferCanvas to main canvas, scaling to fit window ---\r\n      // Only copy after all drawing is finished\r\n      ctx.save();\r\n      ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform for drawImage\r\n      ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n      ctx.imageSmoothingEnabled = false;\r\n      // Copy buffer to canvas at 1:1 scaling; let CSS handle visual scaling if needed\r\n      ctx.drawImage(\r\n        this.bufferCanvas,\r\n        0,\r\n        0,\r\n        this.bufferCanvas.width,\r\n        this.bufferCanvas.height,\r\n        0,\r\n        0,\r\n        this.canvas.width,\r\n        this.canvas.height,\r\n      );\r\n      ctx.restore();\r\n    }\r\n  }\r\n}\r\n\r\nexport default CanvasRenderer;\r\n", "// Lightweight per-team capped pool for tinted hull canvases.\r\n// Keeps insertion order and enforces a per-team cap and a global cap.\r\nexport type TintedHullPoolOptions = {\r\n  globalCap?: number;\r\n  perTeamCap?: number;\r\n};\r\n\r\nexport default class TintedHullPool {\r\n  private map: Map<string, HTMLCanvasElement> = new Map();\r\n  private teamMap: Map<string, string[]> = new Map(); // teamColor -> array of keys (in insertion order)\r\n  // expose caps so callers/tests can read/update them if needed\r\n  public globalCap: number;\r\n  public perTeamCap: number;\r\n\r\n  constructor(opts?: TintedHullPoolOptions) {\r\n    this.globalCap = opts?.globalCap ?? 256;\r\n    this.perTeamCap = opts?.perTeamCap ?? 64;\r\n  }\r\n\r\n  get size(): number {\r\n    return this.map.size;\r\n  }\r\n\r\n  has(key: string): boolean {\r\n    return this.map.has(key);\r\n  }\r\n\r\n  get(key: string): HTMLCanvasElement | undefined {\r\n    return this.map.get(key);\r\n  }\r\n\r\n  // set a canvas and enforce caps\r\n  set(key: string, canvas: HTMLCanvasElement): this {\r\n    // If already present, delete so we re-insert (move to MRU)\r\n    if (this.map.has(key)) {\r\n      this._removeKeyFromTeam(key);\r\n      this.map.delete(key);\r\n    }\r\n    // Development-time assert: detect if the same canvas object is being reused\r\n    // across different keys. This usually indicates accidental shared mutable\r\n    // canvas instances which lead to tint/caching bugs.\r\n    const nodeEnv = (typeof process !== 'undefined' && (process.env && process.env.NODE_ENV)) ? process.env.NODE_ENV : (typeof (globalThis as any).NODE_ENV !== 'undefined' ? (globalThis as any).NODE_ENV : 'development');\r\n    const throwFlag = (typeof process !== 'undefined' && process.env && process.env.THROW_ON_SHARED_TINT) ? process.env.THROW_ON_SHARED_TINT : (typeof (globalThis as any).THROW_ON_SHARED_TINT !== 'undefined' ? (globalThis as any).THROW_ON_SHARED_TINT : undefined);\r\n    const shouldCheck = nodeEnv !== 'production';\r\n    if (shouldCheck) {\r\n      for (const [k, v] of this.map.entries()) {\r\n        if (v === canvas && k !== key) {\r\n          const msg = `[TintedHullPool] Detected shared canvas instance across keys: existing='${k}' new='${key}'. Avoid reusing the same HTMLCanvasElement for different tinted keys.`;\r\n          if (throwFlag === '1' || String(throwFlag).toLowerCase() === 'true') {\r\n            throw new Error(msg);\r\n          } else {\r\n            // eslint-disable-next-line no-console\r\n            console.warn(msg);\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    this.map.set(key, canvas);\r\n    const team = this._teamForKey(key);\r\n    if (!this.teamMap.has(team)) this.teamMap.set(team, []);\r\n    this.teamMap.get(team)!.push(key);\r\n\r\n    // Enforce per-team cap\r\n    const arr = this.teamMap.get(team)!;\r\n    while (arr.length > this.perTeamCap) {\r\n      const oldestKey = arr.shift();\r\n      if (oldestKey) this.map.delete(oldestKey);\r\n    }\r\n\r\n    // Enforce global cap (evict oldest broadly)\r\n    while (this.map.size > this.globalCap) {\r\n      const it = this.map.keys();\r\n      const oldest = it.next().value as string | undefined;\r\n      if (!oldest) break;\r\n      this._removeKeyFromTeam(oldest);\r\n      this.map.delete(oldest);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  delete(key: string): boolean {\r\n    this._removeKeyFromTeam(key);\r\n    return this.map.delete(key);\r\n  }\r\n\r\n  clear(): void {\r\n    this.map.clear();\r\n    this.teamMap.clear();\r\n  }\r\n\r\n  keys(): IterableIterator<string> {\r\n    return this.map.keys();\r\n  }\r\n\r\n  // Helper: extract team color from key formatted as \"<shipType>::<teamColor>\"\r\n  private _teamForKey(key: string): string {\r\n    const parts = key.split('::');\r\n    return parts.length >= 2 ? parts.slice(1).join('::') : '';\r\n  }\r\n\r\n  private _removeKeyFromTeam(key: string) {\r\n    const team = this._teamForKey(key);\r\n    const arr = this.teamMap.get(team);\r\n    if (!arr) return;\r\n    const idx = arr.indexOf(key);\r\n    if (idx >= 0) arr.splice(idx, 1);\r\n    if (arr.length === 0) this.teamMap.delete(team);\r\n  }\r\n}\r\n", "// Minimal, typed WebGL renderer focused on texture baking and lifecycle\r\n// Implements the public API expected by main.ts and tests.\r\n\r\nimport { AssetsConfig, Shape2D } from \"./config/assets/assetsConfig\";\r\nimport RendererConfig from \"./config/rendererConfig\";\r\nimport TeamsConfig from \"./config/teamsConfig\";\r\nimport type { GameState } from \"./types\";\r\nimport {\r\n  createExplosionEffect,\r\n  resetExplosionEffect,\r\n  ExplosionEffect,\r\n} from \"./entities\";\r\nimport {\r\n  acquireTexture,\r\n  releaseTexture,\r\n  acquireSprite,\r\n  releaseSprite,\r\n  acquireEffect,\r\n  releaseEffect,\r\n  makePooled,\r\n} from \"./pools\";\r\n\r\nexport class WebGLRenderer {\r\n  private canvas: HTMLCanvasElement;\r\n  private gl: WebGL2RenderingContext | WebGLRenderingContext | null = null;\r\n  // Renderer may run its own loop in advanced impls (not used here)\r\n  public providesOwnLoop = false;\r\n\r\n  // Cache of baked textures keyed by asset key\r\n  private shapeTextures: Record<string, WebGLTexture> = {};\r\n  // Last-seen GameState (to support release to pool during dispose)\r\n  private gameState: GameState | null = null;\r\n  // Optional textured-quad resources (not required by tests)\r\n  private quadVBO: WebGLBuffer | null = null;\r\n  private quadProg: WebGLProgram | null = null;\r\n  // Optional FBO resources for render-to-texture\r\n  private fbo: WebGLFramebuffer | null = null;\r\n  private fboTex: WebGLTexture | null = null;\r\n\r\n  constructor(canvas: HTMLCanvasElement) {\r\n    this.canvas = canvas;\r\n  }\r\n\r\n  // Initialize GL context and basic state\r\n  init(): boolean {\r\n    try {\r\n      const gl =\r\n        (this.canvas.getContext(\"webgl2\") as WebGL2RenderingContext | null) ||\r\n        (this.canvas.getContext(\"webgl\") as WebGLRenderingContext | null);\r\n      if (!gl) return false;\r\n      this.gl = gl;\r\n      gl.clearColor(0.02, 0.03, 0.06, 1.0);\r\n      // Prepare starfield texture (procedural) lazily\r\n      (this as any)._starfield = (this as any)._starfield || null;\r\n      (this as any)._starfieldSize = (this as any)._starfieldSize || 1024;\r\n      // Lazily initialize optional programs/buffers when used\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n\r\n    // Post-init create GL resources for fullscreen quad used to draw starfield\r\n    try {\r\n      this.quadVBO = (this.gl as WebGLRenderingContext).createBuffer();\r\n      const glr = this.gl as WebGLRenderingContext;\r\n      const verts = new Float32Array([\r\n        -1, -1, 0, 0, 1, -1, 1, 0, -1, 1, 0, 1, 1, 1, 1, 1,\r\n      ]);\r\n      glr.bindBuffer(glr.ARRAY_BUFFER, this.quadVBO);\r\n      glr.bufferData(glr.ARRAY_BUFFER, verts, glr.STATIC_DRAW);\r\n      // Simple textured quad shader\r\n      const vsSrc =\r\n        \"attribute vec2 aPos; attribute vec2 aUV; varying vec2 vUV; void main(){ vUV = aUV; gl_Position = vec4(aPos,0.0,1.0); }\";\r\n      const fsSrc =\r\n        \"precision mediump float; varying vec2 vUV; uniform sampler2D uTex; uniform vec2 uUVOffset; void main(){ vec2 uv = vUV + uUVOffset; gl_FragColor = texture2D(uTex, uv); }\";\r\n      const vs = glr.createShader(glr.VERTEX_SHADER)!;\r\n      const fs = glr.createShader(glr.FRAGMENT_SHADER)!;\r\n      glr.shaderSource(vs, vsSrc);\r\n      glr.shaderSource(fs, fsSrc);\r\n      glr.compileShader(vs);\r\n      glr.compileShader(fs);\r\n      const prog = glr.createProgram()!;\r\n      glr.attachShader(prog, vs);\r\n      glr.attachShader(prog, fs);\r\n      glr.linkProgram(prog);\r\n      this.quadProg = prog;\r\n    } catch {}\r\n    return true;\r\n  }\r\n\r\n  // Called when canvas backing store size changes\r\n  updateScale(): void {\r\n    if (!this.gl) return;\r\n    try {\r\n      this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);\r\n    } catch {}\r\n  }\r\n\r\n  isRunning(): boolean {\r\n    return false;\r\n  }\r\n\r\n  // Render a state frame. This stub clears the screen and ensures\r\n  // textures for present ship types are baked and cached.\r\n  renderState(state: GameState, _interpolation = 0): void {\r\n    if (!this.gl) return;\r\n    // Remember the state so dispose can release assets back to the pool\r\n    this.gameState = state;\r\n    const gl = this.gl as WebGLRenderingContext;\r\n    gl.viewport(0, 0, this.canvas.width, this.canvas.height);\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    // Ensure starfield texture exists and draw it first\r\n    try {\r\n      if (!(this as any)._starfield) {\r\n        const size = (this as any)._starfieldSize || 1024;\r\n        const cvs = document.createElement(\"canvas\");\r\n        cvs.width = size;\r\n        cvs.height = size;\r\n        const ctx = cvs.getContext(\"2d\")!;\r\n        // Fill gradient background\r\n        const g = ctx.createLinearGradient(0, 0, 0, size);\r\n        g.addColorStop(0, \"#001020\");\r\n        g.addColorStop(1, \"#000010\");\r\n        ctx.fillStyle = g;\r\n        ctx.fillRect(0, 0, size, size);\r\n        // Draw procedural stars (density from rendererConfig.starfield.density if available)\r\n        let density = 0.0004;\r\n        try {\r\n          const rc = RendererConfig;\r\n          if (rc && rc.starfield && typeof rc.starfield.density === \"number\")\r\n            density = rc.starfield.density;\r\n        } catch {}\r\n        const stars = Math.floor(size * size * density); // density\r\n        for (let i = 0; i < stars; i++) {\r\n          const x = Math.random() * size;\r\n          const y = Math.random() * size;\r\n          const r = Math.random() * 1.2;\r\n          const bright = 0.6 + Math.random() * 0.4;\r\n          ctx.fillStyle = `rgba(255,255,255,${bright})`;\r\n          ctx.beginPath();\r\n          ctx.arc(x, y, r, 0, Math.PI * 2);\r\n          ctx.fill();\r\n        }\r\n        // Add a few brighter stars\r\n        for (let i = 0; i < 80; i++) {\r\n          const x = Math.random() * size;\r\n          const y = Math.random() * size;\r\n          ctx.fillStyle = \"rgba(255,244,200,1)\";\r\n          ctx.beginPath();\r\n          ctx.arc(x, y, 1.6 + Math.random() * 1.8, 0, Math.PI * 2);\r\n          ctx.fill();\r\n        }\r\n        const tex = gl.createTexture()!;\r\n        gl.bindTexture(gl.TEXTURE_2D, tex);\r\n        gl.pixelStorei((gl as any).UNPACK_PREMULTIPLY_ALPHA_WEBGL ?? 0x8063, 0);\r\n        gl.texImage2D(\r\n          gl.TEXTURE_2D,\r\n          0,\r\n          gl.RGBA,\r\n          gl.RGBA,\r\n          gl.UNSIGNED_BYTE,\r\n          cvs,\r\n        );\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\r\n        (this as any)._starfield = tex;\r\n      }\r\n\r\n      // Draw fullscreen textured quad with starfield (supports parallax via state.camera)\r\n      if (this.quadProg && this.quadVBO) {\r\n        try {\r\n          gl.useProgram(this.quadProg);\r\n          gl.bindBuffer((gl as any).ARRAY_BUFFER, this.quadVBO);\r\n          const aPos = gl.getAttribLocation(this.quadProg, \"aPos\");\r\n          const aUV = gl.getAttribLocation(this.quadProg, \"aUV\");\r\n          gl.enableVertexAttribArray(aPos);\r\n          gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 16, 0);\r\n          gl.enableVertexAttribArray(aUV);\r\n          gl.vertexAttribPointer(aUV, 2, gl.FLOAT, false, 16, 8);\r\n          // compute parallax offset from state.camera if present\r\n          let ox = 0,\r\n            oy = 0;\r\n          try {\r\n            const cam = (state as any)?.camera;\r\n            if (cam && typeof cam.x === \"number\" && typeof cam.y === \"number\") {\r\n              // parallax factor from config if available\r\n              const pf =\r\n                (typeof (require(\"./config/rendererConfig\") as any).default !==\r\n                \"undefined\"\r\n                  ? (require(\"./config/rendererConfig\") as any).default\r\n                      .starfield.parallaxFactor\r\n                  : 0.1) || 0.1;\r\n              ox = ((cam.x || 0) * pf) / (this.canvas.width || 1);\r\n              oy = ((cam.y || 0) * pf) / (this.canvas.height || 1);\r\n            }\r\n          } catch {}\r\n          // set a simple uniform for uv offset if the shader supports it; fallback to binding texture only\r\n          const uvOffLoc = gl.getUniformLocation(this.quadProg, \"uUVOffset\");\r\n          if (uvOffLoc) gl.uniform2f(uvOffLoc, ox, oy);\r\n\r\n          gl.activeTexture((gl as any).TEXTURE0);\r\n          gl.bindTexture(gl.TEXTURE_2D, (this as any)._starfield);\r\n          const loc = gl.getUniformLocation(this.quadProg, \"uTex\");\r\n          gl.uniform1i(loc, 0);\r\n          gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n\r\n          // Draw additive bloom layer if present\r\n          if ((this as any)._starBloom) {\r\n            try {\r\n              gl.enable(gl.BLEND);\r\n              gl.blendFunc(gl.SRC_ALPHA, gl.ONE);\r\n              gl.activeTexture((gl as any).TEXTURE0);\r\n              gl.bindTexture(gl.TEXTURE_2D, (this as any)._starBloom);\r\n              gl.uniform1i(loc, 0);\r\n              gl.uniform2f(uvOffLoc, ox * 0.6, oy * 0.6);\r\n              gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n              gl.disable(gl.BLEND);\r\n            } catch {}\r\n          }\r\n        } catch {}\r\n      }\r\n    } catch {}\r\n\r\n    try {\r\n      const ships = (state && state.ships) || [];\r\n      for (const s of ships) {\r\n        const type = (s && s.type) || \"fighter\";\r\n        // Determine team color (fall back to palette.shipHull)\r\n        let teamColor = (AssetsConfig as any).palette?.shipHull || \"#b0b7c3\";\r\n        try {\r\n          if (s && s.team && TeamsConfig && (TeamsConfig as any).teams) {\r\n            const t = (TeamsConfig as any).teams[s.team];\r\n            if (t && t.color) teamColor = t.color;\r\n          }\r\n        } catch {}\r\n        this.bakeShapeToTexture(state, type, teamColor);\r\n        // Acquire a transient sprite object for this ship and rehydrate it.\r\n        try {\r\n          const key = `ship:${type}`;\r\n          const sprite = acquireSprite(\r\n            this.gameState || (state as any),\r\n            key,\r\n            () => ({ type }),\r\n          );\r\n          // Reset/rehydrate runtime fields used by renderer\r\n          type RenderSprite = {\r\n            type: string;\r\n            x?: number;\r\n            y?: number;\r\n            angle?: number;\r\n          };\r\n          const sp = sprite as unknown as RenderSprite;\r\n          try {\r\n            sp.x = s.x || 0;\r\n            sp.y = s.y || 0;\r\n            sp.angle = s.angle || 0;\r\n          } catch {}\r\n          try {\r\n            releaseSprite(this.gameState || (state as any), key, sprite);\r\n          } catch {}\r\n        } catch {}\r\n      }\r\n      // Process visual flashes/effects and use effect pooling for transient objects\r\n      try {\r\n        const flashes = state.flashes || [];\r\n        for (const f of flashes) {\r\n          try {\r\n            const key = `flash`;\r\n            const pooled = acquireEffect(\r\n              this.gameState || (state as any),\r\n              key,\r\n              () =>\r\n                makePooled(\r\n                  createExplosionEffect({ x: f.x || 0, y: f.y || 0 }),\r\n                  (obj, initArgs) => {\r\n                    resetExplosionEffect(obj, initArgs as any);\r\n                    // attach render-only fields\r\n                    (obj as any).ttl = initArgs?.ttl ?? 0.5;\r\n                  },\r\n                ),\r\n              f,\r\n            );\r\n            type RenderFlash = ExplosionEffect & { ttl?: number };\r\n            const ef = pooled as unknown as RenderFlash;\r\n            try {\r\n              if (ef) {\r\n                // ef.x/ef.y already set by reset on acquire; ensure numeric\r\n                ef.x = ef.x || 0;\r\n                ef.y = ef.y || 0;\r\n                ef.ttl = ef.ttl ?? 0.5;\r\n              }\r\n            } catch {}\r\n            try {\r\n              releaseEffect(this.gameState || (state as any), key, pooled);\r\n            } catch {}\r\n          } catch {}\r\n        }\r\n      } catch {}\r\n    } catch {}\r\n  }\r\n\r\n  // Pre-bake textures for all known shapes\r\n  preloadAllAssets(): void {\r\n    if (!this.gl) return;\r\n    try {\r\n      const shapes = (AssetsConfig as any).shapes2d || {};\r\n      for (const key of Object.keys(shapes))\r\n        this.bakeShapeToTexture(this.gameState, key);\r\n    } catch {}\r\n  }\r\n\r\n  // Testing helper: check if we have a cached texture for a key\r\n  hasCachedTexture(key: string): boolean {\r\n    return !!this.shapeTextures[key];\r\n  }\r\n\r\n  // Dispose all GL resources and clear caches\r\n  dispose(): void {\r\n    if (this.gl) {\r\n      try {\r\n        for (const key of Object.keys(this.shapeTextures)) {\r\n          const tex = this.shapeTextures[key];\r\n          if (!tex) continue;\r\n          if (this.gameState) {\r\n            try {\r\n              const gl = this.gl as WebGLRenderingContext;\r\n              releaseTexture(this.gameState, key, tex, (t) => {\r\n                try {\r\n                  gl.deleteTexture(t);\r\n                } catch {}\r\n              });\r\n            } catch {}\r\n          } else {\r\n            try {\r\n              (this.gl as WebGLRenderingContext).deleteTexture(tex);\r\n            } catch {}\r\n          }\r\n        }\r\n        // Optional resources cleanup\r\n        try {\r\n          if (this.quadVBO)\r\n            (this.gl as WebGLRenderingContext).deleteBuffer(this.quadVBO);\r\n        } catch {}\r\n        try {\r\n          if (this.quadProg)\r\n            (this.gl as WebGLRenderingContext).deleteProgram(this.quadProg);\r\n        } catch {}\r\n        try {\r\n          if (this.fboTex)\r\n            (this.gl as WebGLRenderingContext).deleteTexture(this.fboTex);\r\n        } catch {}\r\n        try {\r\n          if (this.fbo)\r\n            (this.gl as WebGLRenderingContext).deleteFramebuffer(this.fbo);\r\n        } catch {}\r\n        // Remove starfield texture if present\r\n        try {\r\n          if ((this as any)._starfield)\r\n            (this.gl as WebGLRenderingContext).deleteTexture(\r\n              (this as any)._starfield,\r\n            );\r\n        } catch {}\r\n      } catch {}\r\n    }\r\n    this.shapeTextures = {};\r\n    this.quadVBO = null;\r\n    this.quadProg = null;\r\n    this.fbo = null;\r\n    this.fboTex = null;\r\n    (this as any)._starfield = null;\r\n    this.gl = null;\r\n  }\r\n\r\n  // Internal: bake a simple 2D shape into a texture and cache it\r\n  private bakeShapeToTexture(\r\n    state: GameState | null,\r\n    key: string,\r\n    teamColor?: string,\r\n  ): WebGLTexture | null {\r\n    if (!this.gl) return null;\r\n    const cacheKey = teamColor ? `${key}::${teamColor}` : key;\r\n    if (this.shapeTextures[cacheKey]) return this.shapeTextures[cacheKey];\r\n    try {\r\n      const gl = this.gl as WebGLRenderingContext;\r\n      const shapes = (AssetsConfig as any).shapes2d || {};\r\n      const shape: Shape2D | undefined = shapes[key];\r\n      // Offscreen rasterization canvas\r\n      const size = 128;\r\n      const cvs = document.createElement(\"canvas\");\r\n      cvs.width = size;\r\n      cvs.height = size;\r\n      const ctx = cvs.getContext(\"2d\");\r\n      if (!ctx) return null;\r\n      ctx.clearRect(0, 0, size, size);\r\n      ctx.save();\r\n      ctx.translate(size / 2, size / 2);\r\n      const scale = size / 4;\r\n      // Use provided team color if present, otherwise fall back to palette\r\n      ctx.fillStyle =\r\n        teamColor ||\r\n        (AssetsConfig.palette && (AssetsConfig.palette as any).shipHull) ||\r\n        \"#b0b7c3\";\r\n      // Basic vector draw covering circle, polygon and compound\r\n      if (!shape) {\r\n        ctx.beginPath();\r\n        ctx.arc(0, 0, Math.max(4, size * 0.12), 0, Math.PI * 2);\r\n        ctx.fill();\r\n      } else if ((shape as any).type === \"circle\") {\r\n        const r = ((shape as any).r ?? 0.5) * scale;\r\n        ctx.beginPath();\r\n        ctx.arc(0, 0, r, 0, Math.PI * 2);\r\n        ctx.fill();\r\n      } else if ((shape as any).type === \"polygon\") {\r\n        const pts: number[][] = (shape as any).points || [];\r\n        if (pts.length) {\r\n          ctx.beginPath();\r\n          ctx.moveTo((pts[0][0] || 0) * scale, (pts[0][1] || 0) * scale);\r\n          for (let i = 1; i < pts.length; i++)\r\n            ctx.lineTo((pts[i][0] || 0) * scale, (pts[i][1] || 0) * scale);\r\n          ctx.closePath();\r\n          ctx.fill();\r\n        }\r\n      } else if ((shape as any).type === \"compound\") {\r\n        const parts = (shape as any).parts || [];\r\n        for (const part of parts) {\r\n          if ((part as any).type === \"circle\") {\r\n            const r = ((part as any).r ?? 0.5) * scale;\r\n            ctx.beginPath();\r\n            ctx.arc(0, 0, r, 0, Math.PI * 2);\r\n            ctx.fill();\r\n          } else if ((part as any).type === \"polygon\") {\r\n            const pts: number[][] = (part as any).points || [];\r\n            if (pts.length) {\r\n              ctx.beginPath();\r\n              ctx.moveTo((pts[0][0] || 0) * scale, (pts[0][1] || 0) * scale);\r\n              for (let i = 1; i < pts.length; i++)\r\n                ctx.lineTo((pts[i][0] || 0) * scale, (pts[i][1] || 0) * scale);\r\n              ctx.closePath();\r\n              ctx.fill();\r\n            }\r\n          }\r\n        }\r\n      }\r\n      ctx.restore();\r\n\r\n      // Create or acquire texture via pool when state is available\r\n      const createTex = (): WebGLTexture => {\r\n        const t = gl.createTexture()!;\r\n        gl.bindTexture(gl.TEXTURE_2D, t);\r\n        gl.pixelStorei((gl as any).UNPACK_PREMULTIPLY_ALPHA_WEBGL ?? 0x8063, 0);\r\n        gl.texImage2D(\r\n          gl.TEXTURE_2D,\r\n          0,\r\n          gl.RGBA,\r\n          gl.RGBA,\r\n          gl.UNSIGNED_BYTE,\r\n          cvs,\r\n        );\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        return t;\r\n      };\r\n\r\n      let tex: WebGLTexture | null = null;\r\n      if (state) {\r\n        try {\r\n          tex = acquireTexture(state, cacheKey, createTex);\r\n        } catch {\r\n          // Fallback to direct creation if pooling fails\r\n          tex = createTex();\r\n        }\r\n      } else {\r\n        tex = createTex();\r\n      }\r\n      if (!tex) return null;\r\n      gl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n      this.shapeTextures[cacheKey] = tex;\r\n      return tex;\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Optional future path: draw a textured quad (not used in tests yet)\r\n  // Keeping a stub to document intent and ease future extension.\r\n  // private drawTexturedQuad(_tex: WebGLTexture, _x: number, _y: number, _w: number, _h: number): void {\r\n  //   // Intentionally empty in minimal stub\r\n  // }\r\n}\r\n\r\nexport default WebGLRenderer;\r\n", "// This allows the build to treat the app as TypeScript while we incrementally port internals.\r\n// main.ts \u2014 TypeScript entrypoint (ported from main.js). Uses TS imports so\r\n// the module graph resolves to .ts sources during migration.\r\nimport { createGameManager } from \"./gamemanager\";\r\nimport { makeInitialState } from \"./entities\";\r\nimport type { GameState } from \"./types\";\r\nimport { CanvasRenderer } from \"./canvasrenderer\";\r\nimport { WebGLRenderer } from \"./webglrenderer\";\r\nimport { getDefaultBounds } from \"./config/simConfig\";\r\nimport { SIM } from \"./config/simConfig\";\r\nimport { getPreferredRenderer, RendererConfig } from \"./config/rendererConfig\";\r\nimport { getRuntimeShipConfigSafe } from \"./config/runtimeConfigResolver\";\r\n// Ensure svgRenderer module evaluates and installs its global bridge at startup.\r\n// This side-effect import makes globalThis.__SpaceAutoBattler_svgRenderer available\r\n// before renderers attempt to consult it (helps with cross-bundle cache discovery).\r\nimport \"./assets/svgRenderer\";\r\nimport svgRenderer from \"./assets/svgRenderer\";\r\nimport AssetsConfig from \"./config/assets/assetsConfig\";\r\n\r\n// Allow temporary extension of window.gm used by the app during migration.\r\ndeclare global {\r\n  interface Window {\r\n    gm?: any;\r\n  }\r\n}\r\n\r\nexport async function startApp(rootDocument: Document = document) {\r\n  // Instantiate canonical GameState at startup\r\n  const gameState: GameState = makeInitialState();\r\n\r\n  let canvas = rootDocument.getElementById(\"world\") as HTMLCanvasElement | null;\r\n  // If the host document doesn't already have a canvas#world (some DOM emulators\r\n  // may provide a fresh document per test), create one so renderers can attach.\r\n  if (!canvas) {\r\n    try {\r\n      const el = rootDocument.createElement(\"canvas\");\r\n      el.id = \"world\";\r\n      rootDocument.body.appendChild(el);\r\n      canvas = el as HTMLCanvasElement;\r\n    } catch (e) {\r\n      canvas = null;\r\n    }\r\n  }\r\n  const ui: any = {\r\n    startPause: rootDocument.getElementById(\"startPause\"),\r\n    reset: rootDocument.getElementById(\"reset\"),\r\n    addRed: rootDocument.getElementById(\"addRed\"),\r\n    addBlue: rootDocument.getElementById(\"addBlue\"),\r\n    toggleTrails: rootDocument.getElementById(\"toggleTrails\"),\r\n    speed: rootDocument.getElementById(\"speed\"),\r\n    redScore: rootDocument.getElementById(\"redScore\"),\r\n    blueScore: rootDocument.getElementById(\"blueScore\"),\r\n    stats: rootDocument.getElementById(\"stats\"),\r\n    continuousCheckbox: rootDocument.getElementById(\"continuousCheckbox\"),\r\n    seedBtn: rootDocument.getElementById(\"seedBtn\"),\r\n    formationBtn: rootDocument.getElementById(\"formationBtn\"),\r\n  };\r\n\r\n  try {\r\n    if (ui.stats) ui.stats.textContent = \"Ships: 0 (R:0 B:0) Bullets: 0\";\r\n  } catch (e) {}\r\n\r\n  // Always use fixed logical bounds for simulation/game loop\r\n  const LOGICAL_BOUNDS = getDefaultBounds();\r\n\r\n  // --- Disposable tracking helpers to avoid memory leaks ---\r\n  const disposables: Array<() => void> = [];\r\n  let uiRaf: number | null = null;\r\n  let workerIndicatorRaf: number | null = null;\r\n  const pendingTimers = new Set<number>();\r\n  let isUiTickRunning = false;\r\n\r\n  function addListener(\r\n    target: EventTarget | null,\r\n    type: string,\r\n    handler: EventListenerOrEventListenerObject,\r\n  ) {\r\n    if (!target) return;\r\n    try {\r\n      target.addEventListener(type, handler as EventListener);\r\n      disposables.push(() => {\r\n        try {\r\n          target.removeEventListener(type, handler as EventListener);\r\n        } catch (e) {}\r\n      });\r\n    } catch (e) {}\r\n  }\r\n\r\n  function clearAllTimers() {\r\n    for (const id of Array.from(pendingTimers)) {\r\n      try {\r\n        clearTimeout(id as unknown as number);\r\n      } catch (e) {}\r\n      pendingTimers.delete(id);\r\n    }\r\n  }\r\n\r\n  // Only update backing store when renderScale changes\r\n  function updateCanvasBackingStore() {\r\n    const dpr = window.devicePixelRatio || 1;\r\n    const renderScale =\r\n      RendererConfig && typeof (RendererConfig as any).renderScale === \"number\"\r\n        ? (RendererConfig as any).renderScale\r\n        : 1;\r\n    const logicalW = LOGICAL_BOUNDS.W;\r\n    const logicalH = LOGICAL_BOUNDS.H;\r\n    if (canvas) {\r\n      const bufferW = Math.round((logicalW * renderScale) / dpr);\r\n      const bufferH = Math.round((logicalH * renderScale) / dpr);\r\n      canvas.width = bufferW;\r\n      canvas.height = bufferH;\r\n      canvas.style.width = bufferW + \"px\";\r\n      canvas.style.height = bufferH + \"px\";\r\n      const dimsEl = document.getElementById(\"rendererDims\");\r\n      if (dimsEl) {\r\n        dimsEl.textContent = `${canvas.width} x ${canvas.height} px @ ${dpr}x`;\r\n      }\r\n    }\r\n    (RendererConfig as any)._renderScale = renderScale;\r\n    (RendererConfig as any)._offsetX = 0;\r\n    (RendererConfig as any)._offsetY = 0;\r\n    const scaleVal = rootDocument.getElementById(\"rendererScaleValue\");\r\n    if (scaleVal) scaleVal.textContent = renderScale.toFixed(2);\r\n  }\r\n\r\n  // Only update CSS size on window resize\r\n  function fitCanvasToWindow() {\r\n    const winW = window.innerWidth;\r\n    const winH = window.innerHeight;\r\n    const bufferW = canvas ? canvas.width : LOGICAL_BOUNDS.W;\r\n    const bufferH = canvas ? canvas.height : LOGICAL_BOUNDS.H;\r\n    // Compute scale to fit buffer into window, preserving aspect ratio\r\n    const scale = Math.min(winW / bufferW, winH / bufferH);\r\n    const scaledW = bufferW * scale;\r\n    const scaledH = bufferH * scale;\r\n    const offsetX = Math.round((winW - scaledW) / 2);\r\n    const offsetY = Math.round((winH - scaledH) / 2);\r\n    if (canvas) {\r\n      // Set width/height to buffer size, but use transform for scaling\r\n      canvas.style.width = `${bufferW}px`;\r\n      canvas.style.height = `${bufferH}px`;\r\n      canvas.style.position = \"absolute\";\r\n      canvas.style.left = `${offsetX}px`;\r\n      canvas.style.top = `${offsetY}px`;\r\n      canvas.style.transformOrigin = \"top left\";\r\n      canvas.style.transform = `scale(${scale})`;\r\n    }\r\n    // Prevent scrollbars\r\n    document.body.style.overflow = \"hidden\";\r\n  }\r\n  // Renderer scale slider and dynamic scaling wiring\r\n  const scaleSlider = rootDocument.getElementById(\"rendererScaleRange\");\r\n  const dynamicCheckbox = rootDocument.getElementById(\"dynamicScaleCheckbox\");\r\n  let internalScaleUpdate = false;\r\n  if (scaleSlider) {\r\n    const onScaleInput = (ev: any) => {\r\n      if (internalScaleUpdate) return; // ignore internal updates\r\n      const val = parseFloat(ev.target.value);\r\n      if (!isNaN(val)) {\r\n        (RendererConfig as any).renderScale = val;\r\n        (RendererConfig as any).dynamicScaleEnabled = false;\r\n        if (dynamicCheckbox)\r\n          (dynamicCheckbox as HTMLInputElement).checked = false;\r\n        updateCanvasBackingStore();\r\n        fitCanvasToWindow();\r\n      }\r\n    };\r\n    addListener(scaleSlider, \"input\", onScaleInput);\r\n    // Set initial value display\r\n    const scaleVal = rootDocument.getElementById(\"rendererScaleValue\");\r\n    if (scaleVal)\r\n      scaleVal.textContent = (scaleSlider as HTMLInputElement).value;\r\n    // Ensure initial fit-to-window calculation uses current scale\r\n    updateCanvasBackingStore();\r\n    fitCanvasToWindow();\r\n  }\r\n  if (dynamicCheckbox) {\r\n    const onDynamicChange = (ev: any) => {\r\n      const enabled = !!ev.target.checked;\r\n      (RendererConfig as any).dynamicScaleEnabled = enabled;\r\n    };\r\n    addListener(dynamicCheckbox, \"change\", onDynamicChange);\r\n    (dynamicCheckbox as HTMLInputElement).checked = !!(RendererConfig as any)\r\n      .dynamicScaleEnabled;\r\n  }\r\n\r\n  fitCanvasToWindow();\r\n  addListener(window, \"resize\", fitCanvasToWindow);\r\n\r\n  let renderer: any = null;\r\n  const pref = getPreferredRenderer();\r\n  if (canvas) {\r\n    if (pref === \"webgl\") {\r\n      try {\r\n        const w = new WebGLRenderer(canvas);\r\n        if (w && w.init && w.init()) renderer = w;\r\n      } catch (e) {}\r\n    }\r\n    if (!renderer) {\r\n      try {\r\n        renderer = new CanvasRenderer(canvas);\r\n        renderer.init && renderer.init();\r\n      } catch (e) {\r\n        renderer = null;\r\n      }\r\n    }\r\n  }\r\n  // Preload all assets if renderer supports it\r\n  if (renderer && typeof renderer.preloadAllAssets === \"function\") {\r\n    try {\r\n      renderer.preloadAllAssets();\r\n    } catch (e) {}\r\n  }\r\n  // Kick off a lightweight pre-warm of the svg raster cache so synchronous\r\n  // lookups performed by svgLoader.getCachedHullCanvasSync can succeed on\r\n  // first draw. Only run in browser environments.\r\n  try {\r\n    if (typeof window !== 'undefined' && svgRenderer && typeof svgRenderer.prewarmAssets === 'function') {\r\n      try {\r\n  const assetsConfig = AssetsConfig || (globalThis as any).AssetsConfig || {};\r\n  const svgAssets = assetsConfig.svgAssets || {};\r\n        // Pick a small set of commonly used ship types (fallback to keys)\r\n        const keys = Object.keys(svgAssets).slice(0, 8);\r\n        // Gather declared team colors\r\n        const teams = (globalThis as any).TeamsConfig && (globalThis as any).TeamsConfig.teams ? (globalThis as any).TeamsConfig.teams : {};\r\n        const teamColors: string[] = [];\r\n        for (const tName of Object.keys(teams)) {\r\n          const t = teams[tName]; if (t && t.color) teamColors.push(t.color);\r\n        }\r\n        if (teamColors.length === 0) {\r\n          const p = assetsConfig.palette || {};\r\n          if (p.shipHull) teamColors.push(p.shipHull);\r\n          if (p.shipAccent) teamColors.push(p.shipAccent);\r\n        }\r\n        // Don't await on startup; let it run in background but call to ensure\r\n        // module loads and global bridge is used early. Prefer the global\r\n        // bridge object so the exact same raster cache instance is populated\r\n        // that svgLoader.getCachedHullCanvasSync will consult.\r\n        try {\r\n          const g = (globalThis as any).__SpaceAutoBattler_svgRenderer;\r\n          if (g && typeof g.prewarmAssets === 'function') {\r\n            try {\r\n              g.prewarmAssets(keys, teamColors, 128, 128).catch(() => {});\r\n            } catch (e) {}\r\n          } else {\r\n            svgRenderer.prewarmAssets(keys, teamColors).catch(() => {});\r\n          }\r\n        } catch (e) {\r\n          try { svgRenderer.prewarmAssets(keys, teamColors).catch(() => {}); } catch (ee) {}\r\n        }\r\n      } catch (e) {}\r\n    }\r\n  } catch (e) {}\r\n  // If we don't have a canvas (or renderer failed), provide a minimal no-op renderer\r\n  if (!renderer) {\r\n    renderer = {\r\n      type: \"noop\",\r\n      init: () => false,\r\n      renderState: (_: any) => {},\r\n      isRunning: () => false,\r\n    };\r\n  }\r\n\r\n  try {\r\n    window.gm = window.gm || {};\r\n  } catch (e) {}\r\n  // Pass fixed logical bounds and canonical GameState to game manager\r\n  const gm = createGameManager({ renderer, useWorker: false, seed: 12345 });\r\n  if (gm && gm._internal) {\r\n    gm._internal.bounds = LOGICAL_BOUNDS;\r\n    gm._internal.state = gameState;\r\n  }\r\n  try {\r\n    if (typeof window !== \"undefined\" && (window as any).gm)\r\n      Object.assign((window as any).gm, gm);\r\n    // Expose renderer for debugging on localhost only. This allows us to\r\n    // inspect caches and mapping at runtime without permanently leaking\r\n    // internals in production bundles.\r\n    try {\r\n      const host = (location && location.hostname) || \"\";\r\n      if (host === \"127.0.0.1\" || host === \"localhost\") {\r\n        try {\r\n          // Attach a non-enumerable debug handle\r\n          Object.defineProperty(window, \"__renderer\", {\r\n            value: renderer,\r\n            writable: false,\r\n            configurable: true,\r\n            enumerable: false,\r\n          });\r\n        } catch (e) {\r\n          try {\r\n            (window as any).__renderer = renderer;\r\n          } catch (err) {}\r\n        }\r\n      }\r\n    } catch (e) {}\r\n  } catch (e) {}\r\n\r\n  // Initialize dev overlay (toggle with ?devShipTable=1)\r\n  try {\r\n    if (typeof window !== \"undefined\") {\r\n      // Enable overlay in non-production builds or when URL param present\r\n      // Runtime-only check: enable overlay on localhost or when URL param devShipTable=1\r\n      const host = (location && location.hostname) || \"\";\r\n      const urlParams =\r\n        typeof URLSearchParams !== \"undefined\"\r\n          ? new URLSearchParams(location.search)\r\n          : null;\r\n      const enabled =\r\n        host === \"127.0.0.1\" ||\r\n        host === \"localhost\" ||\r\n        urlParams?.get(\"devShipTable\") === \"1\";\r\n      if (enabled) {\r\n        // Lazy import to avoid affecting production bundles when tree-shaken\r\n        import(\"./dev/shipPipelineOverlay\")\r\n          .then((m) => {\r\n            try {\r\n              m.default && m.default();\r\n            } catch (e) {}\r\n          })\r\n          .catch((e) => {\r\n            console.warn(\"Failed to load dev overlay\", e);\r\n          });\r\n      }\r\n    }\r\n  } catch (e) {}\r\n\r\n  // Speed multiplier logic\r\n  let simSpeedMultiplier = 1;\r\n  if (ui.speed) {\r\n    const onSpeedClick = () => {\r\n      simSpeedMultiplier =\r\n        simSpeedMultiplier >= 4 ? 0.25 : simSpeedMultiplier * 2;\r\n      ui.speed.textContent = `Speed: ${simSpeedMultiplier}\u00D7`;\r\n    };\r\n    addListener(ui.speed, \"click\", onSpeedClick);\r\n    ui.speed.textContent = `Speed: ${simSpeedMultiplier}\u00D7`;\r\n  }\r\n\r\n  // Patch stepOnce to use multiplier\r\n  if (gm && typeof gm.stepOnce === \"function\") {\r\n    const origStepOnce = gm.stepOnce.bind(gm);\r\n    // Use canonical SIM.DT_MS (millisecond timestep) converted to seconds\r\n    // as the default step size so the UI multiplier wraps the same base dt\r\n    // the simulation run-loop uses. This prevents hard-coded mismatches.\r\n    gm.stepOnce = (dt: number = SIM.DT_MS / 1000) =>\r\n      origStepOnce(dt * simSpeedMultiplier);\r\n  }\r\n\r\n  // Fleet formation logic\r\n  if (ui.formationBtn) {\r\n    const onFormationClick = () => {\r\n      if (gm && typeof gm.formFleets === \"function\") {\r\n        gm.formFleets();\r\n      }\r\n    };\r\n    addListener(ui.formationBtn, \"click\", onFormationClick);\r\n  }\r\n\r\n  // Engine trail UI toggle state\r\n  let engineTrailsEnabled = true;\r\n  gameState.engineTrailsEnabled = engineTrailsEnabled;\r\n  if (ui.toggleTrails) {\r\n    const onToggleTrails = () => {\r\n      engineTrailsEnabled = !engineTrailsEnabled;\r\n      gameState.engineTrailsEnabled = engineTrailsEnabled;\r\n      ui.toggleTrails.textContent = engineTrailsEnabled\r\n        ? \"\u2604 Trails: On\"\r\n        : \"\u2604 Trails: Off\";\r\n    };\r\n    addListener(ui.toggleTrails, \"click\", onToggleTrails);\r\n    ui.toggleTrails.textContent = engineTrailsEnabled\r\n      ? \"\u2604 Trails: On\"\r\n      : \"\u2604 Trails: Off\";\r\n  }\r\n\r\n  try {\r\n    const host = (location && location.hostname) || \"\";\r\n    const urlParams =\r\n      typeof URLSearchParams !== \"undefined\"\r\n        ? new URLSearchParams(location.search)\r\n        : null;\r\n    const autotest =\r\n      (urlParams && urlParams.get(\"autotest\") === \"1\") ||\r\n      !!(window as any).__AUTO_REINFORCE_DEV__;\r\n    if ((host === \"127.0.0.1\" || host === \"localhost\") && autotest) {\r\n      try {\r\n        if (gm && typeof gm.setContinuousEnabled === \"function\")\r\n          gm.setContinuousEnabled(true);\r\n      } catch (e) {}\r\n      try {\r\n        if (gm && typeof gm.setReinforcementInterval === \"function\")\r\n          gm.setReinforcementInterval(0.01);\r\n      } catch (e) {}\r\n      try {\r\n        if (gm && typeof gm.stepOnce === \"function\") gm.stepOnce(0.02);\r\n      } catch (e) {}\r\n    }\r\n  } catch (e) {}\r\n\r\n  let lastReinforcementSummary = \"\";\r\n  let reinforcementsHandler: ((msg: any) => void) | null = null;\r\n  try {\r\n    if (gm && typeof gm.on === \"function\") {\r\n      reinforcementsHandler = (msg: any) => {\r\n        const list = (msg && msg.spawned) || [];\r\n        const types = list.map((s: any) => s.type).filter(Boolean);\r\n        const summary = `Reinforcements: spawned ${list.length} ships (${types.join(\", \")})`;\r\n        lastReinforcementSummary = summary;\r\n        try {\r\n          const tid = setTimeout(() => {\r\n            lastReinforcementSummary = \"\";\r\n          }, 3000);\r\n          pendingTimers.add(tid as unknown as number);\r\n        } catch (e) {}\r\n        try {\r\n          if (ui && ui.stats)\r\n            ui.stats.textContent = `${ui.stats.textContent} | ${summary}`;\r\n        } catch (e) {}\r\n      };\r\n      gm.on(\"reinforcements\", reinforcementsHandler);\r\n    }\r\n  } catch (e) {}\r\n\r\n  const workerIndicator = rootDocument.getElementById(\"workerIndicator\");\r\n  let toastContainer = rootDocument.getElementById(\"toastContainer\");\r\n  if (!toastContainer) {\r\n    try {\r\n      toastContainer = rootDocument.createElement(\"div\");\r\n      toastContainer.id = \"toastContainer\";\r\n      toastContainer.style.position = \"fixed\";\r\n      toastContainer.style.right = \"16px\";\r\n      toastContainer.style.top = \"16px\";\r\n      toastContainer.style.zIndex = \"9999\";\r\n      toastContainer.style.pointerEvents = \"none\";\r\n      rootDocument.body.appendChild(toastContainer);\r\n      disposables.push(() => {\r\n        try {\r\n          if (toastContainer && toastContainer.parentNode)\r\n            toastContainer.parentNode.removeChild(toastContainer);\r\n        } catch (e) {}\r\n      });\r\n    } catch (e) {\r\n      toastContainer = null;\r\n    }\r\n  }\r\n\r\n  function showToast(msg: string, opts: any = {}) {\r\n    try {\r\n      if (!toastContainer) return;\r\n      const ttl = typeof opts.ttl === \"number\" ? opts.ttl : 2000;\r\n      const el = rootDocument.createElement(\"div\");\r\n      el.style.background = \"rgba(20,20,30,0.9)\";\r\n      el.style.color = \"#fff\";\r\n      el.style.padding = \"8px 12px\";\r\n      el.style.marginTop = \"6px\";\r\n      el.style.borderRadius = \"6px\";\r\n      el.style.boxShadow = \"0 2px 8px rgba(0,0,0,0.5)\";\r\n      el.style.fontFamily = \"sans-serif\";\r\n      el.style.fontSize = \"13px\";\r\n      el.style.pointerEvents = \"auto\";\r\n      el.textContent = msg;\r\n      toastContainer.appendChild(el);\r\n      const tid = setTimeout(() => {\r\n        try {\r\n          el.style.transition = \"opacity 300ms ease\";\r\n          el.style.opacity = \"0\";\r\n        } catch (e) {}\r\n        setTimeout(() => {\r\n          try {\r\n            if (el && el.parentNode) el.parentNode.removeChild(el);\r\n          } catch (err) {}\r\n        }, 350);\r\n      }, ttl);\r\n      pendingTimers.add(tid as unknown as number);\r\n    } catch (e) {}\r\n  }\r\n\r\n  let levelupHandler: ((m: any) => void) | null = null;\r\n  try {\r\n    if (gm && typeof gm.on === \"function\") {\r\n      levelupHandler = (m: any) => {\r\n        try {\r\n          const ship = (m && m.ship) || null;\r\n          const lvl =\r\n            (m && m.newLevel) || (m && m.newLevel === 0 ? 0 : undefined);\r\n          const who = ship && ship.team ? `${ship.team} ship` : \"Ship\";\r\n          const msg = `${who} leveled up to ${lvl}`;\r\n          showToast(msg, { ttl: 2200 });\r\n        } catch (e) {}\r\n      };\r\n      gm.on(\"levelup\", levelupHandler);\r\n    }\r\n  } catch (e) {}\r\n\r\n  if (workerIndicator) {\r\n    try {\r\n      const refresh = () => {\r\n        try {\r\n          workerIndicator.textContent =\r\n            gm.isWorker && gm.isWorker() ? \"Worker\" : \"Main\";\r\n        } catch (e) {}\r\n        try {\r\n          workerIndicatorRaf = requestAnimationFrame(refresh);\r\n        } catch (e) {\r\n          workerIndicatorRaf = null;\r\n        }\r\n      };\r\n      refresh();\r\n    } catch (e) {\r\n      workerIndicator.textContent = \"Unknown\";\r\n    }\r\n  }\r\n\r\n  try {\r\n    if (ui.startPause)\r\n      addListener(ui.startPause, \"click\", () => {\r\n        if (gm.isRunning()) {\r\n          gm.pause();\r\n          ui.startPause.textContent = \"\u25B6 Start\";\r\n        } else {\r\n          gm.start();\r\n          ui.startPause.textContent = \"\u23F8 Pause\";\r\n        }\r\n      });\r\n  } catch (e) {}\r\n  try {\r\n    if (ui.reset) addListener(ui.reset, \"click\", () => gm.reset());\r\n  } catch (e) {}\r\n  // Populate ship type selector (for deterministic, seeded spawns)\r\n  try {\r\n    const cfg = getRuntimeShipConfigSafe();\r\n    const selectEl = rootDocument.getElementById(\r\n      \"shipTypeSelect\",\r\n    ) as HTMLSelectElement | null;\r\n    if (selectEl && cfg) {\r\n      // Clear existing\r\n      selectEl.innerHTML = \"\";\r\n      for (const key of Object.keys(cfg)) {\r\n        try {\r\n          const opt = rootDocument.createElement(\"option\");\r\n          opt.value = key;\r\n          opt.textContent = key;\r\n          selectEl.appendChild(opt);\r\n        } catch (e) {}\r\n      }\r\n    }\r\n  } catch (e) {}\r\n\r\n  // Generic spawn helper that respects seeded RNG via gm.spawnShip's internal use of srandom\r\n  function spawnSelected(team: string) {\r\n    try {\r\n      const selectEl = rootDocument.getElementById(\r\n        \"shipTypeSelect\",\r\n      ) as HTMLSelectElement | null;\r\n      const selectedType = selectEl ? selectEl.value : null;\r\n      // If gm.spawnShip supports (team, type) signature, prefer that\r\n      try {\r\n        if (gm && typeof gm.spawnShip === \"function\") {\r\n          // Try calling with (team, type) if supported\r\n          if (selectedType) {\r\n            try {\r\n              const maybe = (gm as any).spawnShip(team, selectedType);\r\n              if (maybe) return maybe;\r\n            } catch (e) {\r\n              // ignore and fall back\r\n            }\r\n          }\r\n          const ship = gm.spawnShip(team);\r\n          if (ship && selectedType) {\r\n            try {\r\n              ship.type = selectedType;\r\n              // attach config snapshot if available\r\n              try {\r\n                const scfg = getRuntimeShipConfigSafe();\r\n                if (scfg && scfg[selectedType])\r\n                  (ship as any)._config = scfg[selectedType];\r\n              } catch (e) {}\r\n            } catch (e) {}\r\n          }\r\n          return ship;\r\n        }\r\n      } catch (e) {}\r\n    } catch (e) {}\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    if (ui.addRed) addListener(ui.addRed, \"click\", () => spawnSelected(\"red\"));\r\n  } catch (e) {}\r\n  try {\r\n    if (ui.addBlue)\r\n      addListener(ui.addBlue, \"click\", () => spawnSelected(\"blue\"));\r\n  } catch (e) {}\r\n  function onSeedBtnClick() {\r\n    try {\r\n      const raw =\r\n        typeof window !== \"undefined\" && typeof window.prompt === \"function\"\r\n          ? window.prompt(\"Enter new seed (leave blank for random):\", \"\")\r\n          : null;\r\n      if (raw == null) return;\r\n      const trimmed = String(raw).trim();\r\n      if (trimmed === \"\") {\r\n        try {\r\n          gm.reseed();\r\n          showToast(\"Reseeded with random seed\");\r\n        } catch (e) {}\r\n        return;\r\n      }\r\n      const asNum = Number(trimmed);\r\n      if (!Number.isFinite(asNum) || Math.floor(asNum) !== asNum) {\r\n        try {\r\n          showToast(\"Invalid seed. Please enter an integer.\");\r\n        } catch (e) {}\r\n        return;\r\n      }\r\n      try {\r\n        gm.reseed(asNum >>> 0);\r\n        showToast(`Reseeded with ${asNum >>> 0}`);\r\n      } catch (e) {}\r\n    } catch (e) {}\r\n  }\r\n  try {\r\n    if (ui.seedBtn) addListener(ui.seedBtn, \"click\", onSeedBtnClick);\r\n  } catch (e) {}\r\n  // try { ui.formationBtn.addEventListener('click', () => gm.formFleets()); } catch (e) {}\r\n  try {\r\n    if (ui.continuousCheckbox) {\r\n      addListener(ui.continuousCheckbox, \"change\", (ev: any) => {\r\n        const v = !!ev.target.checked;\r\n        if (gm && typeof gm.setContinuousEnabled === \"function\")\r\n          gm.setContinuousEnabled(v);\r\n      });\r\n    }\r\n  } catch (e) {}\r\n\r\n  function uiTick() {\r\n    if (isUiTickRunning) return; // Prevent multiple loops\r\n    isUiTickRunning = true;\r\n    const startTick = performance.now();\r\n    let skipRender = false;\r\n    try {\r\n      const s = gm.snapshot();\r\n      ui.redScore.textContent = `Red ${gm.score.red}`;\r\n      ui.blueScore.textContent = `Blue ${gm.score.blue}`;\r\n      const redCount = (s.teamCounts && (s.teamCounts as any).red) || 0;\r\n      const blueCount = (s.teamCounts && (s.teamCounts as any).blue) || 0;\r\n      ui.stats.textContent =\r\n        `Ships: ${s.ships.length} (R:${redCount} B:${blueCount}) Bullets: ${s.bullets.length}` +\r\n        (lastReinforcementSummary ? ` | ${lastReinforcementSummary}` : \"\");\r\n    } catch (e) {}\r\n    const endTick = performance.now();\r\n    const tickTime = endTick - startTick;\r\n    if (tickTime > SIM.DT_MS) {\r\n      skipRender = true;\r\n    }\r\n    // --- Dynamic buffer scaling logic ---\r\n    const dynamicEnabled = !!(RendererConfig as any).dynamicScaleEnabled;\r\n    const scaleSliderEl = rootDocument.getElementById(\r\n      \"rendererScaleRange\",\r\n    ) as HTMLInputElement;\r\n    const scaleValEl = rootDocument.getElementById(\"rendererScaleValue\");\r\n    // Track frame time\r\n    const now = performance.now();\r\n    (RendererConfig as any)._lastUiTick =\r\n      (RendererConfig as any)._lastUiTick || now;\r\n    const dt = now - (RendererConfig as any)._lastUiTick;\r\n    (RendererConfig as any)._lastUiTick = now;\r\n    (RendererConfig as any).lastFrameTime = dt;\r\n    // Score frame time\r\n    let frameScore = \"green\";\r\n    if (dt > 33) frameScore = \"red\";\r\n    else if (dt > 20) frameScore = \"yellow\";\r\n    (RendererConfig as any).frameScore = frameScore;\r\n    // Color slider value for feedback\r\n    if (scaleValEl) {\r\n      scaleValEl.style.color =\r\n        frameScore === \"green\"\r\n          ? \"#4caf50\"\r\n          : frameScore === \"yellow\"\r\n            ? \"#ffd600\"\r\n            : \"#ff1744\";\r\n    }\r\n    // Dynamic scaling logic\r\n    if (dynamicEnabled && scaleSliderEl) {\r\n      let scale = (RendererConfig as any).renderScale;\r\n      // If frame is slow, reduce scale; if fast, increase scale\r\n      if (frameScore === \"red\" && scale > 0.25)\r\n        scale = Math.max(0.25, scale - 0.05);\r\n      else if (frameScore === \"green\" && scale < 2.0)\r\n        scale = Math.min(2.0, scale + 0.01);\r\n      // Only update if changed\r\n      if (scale !== (RendererConfig as any).renderScale) {\r\n        (RendererConfig as any).renderScale = scale;\r\n        internalScaleUpdate = true;\r\n        scaleSliderEl.value = scale.toFixed(2);\r\n        if (scaleValEl) scaleValEl.textContent = scale.toFixed(2);\r\n        fitCanvasToWindow();\r\n        internalScaleUpdate = false;\r\n      }\r\n    }\r\n    if (!skipRender) {\r\n      try {\r\n        uiRaf = requestAnimationFrame(() => {\r\n          isUiTickRunning = false;\r\n          uiTick();\r\n        });\r\n      } catch (e) {\r\n        uiRaf = null;\r\n        isUiTickRunning = false;\r\n      }\r\n    } else {\r\n      // Only update simulation, skip rendering for this frame\r\n      const tid = setTimeout(() => {\r\n        isUiTickRunning = false;\r\n        uiTick();\r\n      }, SIM.DT_MS);\r\n      if (typeof tid === \"number\") pendingTimers.add(tid as number);\r\n    }\r\n  }\r\n  uiRaf = requestAnimationFrame(uiTick);\r\n\r\n  function dispose() {\r\n    // First, destroy game manager resources (worker, handlers)\r\n    try {\r\n      if (gm && typeof gm.destroy === \"function\") gm.destroy();\r\n    } catch (e) {}\r\n\r\n    // Stop the game manager run loop\r\n    try {\r\n      if (gm && typeof gm.pause === \"function\") gm.pause();\r\n    } catch (e) {}\r\n\r\n    // Unregister gm-level listeners we added\r\n    try {\r\n      if (gm && typeof gm.off === \"function\") {\r\n        if (reinforcementsHandler)\r\n          gm.off(\"reinforcements\", reinforcementsHandler);\r\n        if (levelupHandler) gm.off(\"levelup\", levelupHandler);\r\n      }\r\n    } catch (e) {}\r\n\r\n    // Cancel RAFs started here\r\n    if (uiRaf != null) {\r\n      try {\r\n        cancelAnimationFrame(uiRaf);\r\n      } catch (e) {}\r\n      uiRaf = null;\r\n    }\r\n    isUiTickRunning = false;\r\n    if (workerIndicatorRaf != null) {\r\n      try {\r\n        cancelAnimationFrame(workerIndicatorRaf);\r\n      } catch (e) {}\r\n      workerIndicatorRaf = null;\r\n    }\r\n\r\n    // Clear timers\r\n    try {\r\n      clearAllTimers();\r\n    } catch (e) {}\r\n\r\n    // Run registered disposables (removes DOM listeners, etc)\r\n    for (const fn of disposables.slice()) {\r\n      try {\r\n        fn();\r\n      } catch (e) {}\r\n    }\r\n    disposables.length = 0;\r\n\r\n    // Optionally clear global gm reference (defensive)\r\n    try {\r\n      if (typeof window !== \"undefined\" && (window as any).gm) {\r\n        // Only remove properties we assigned (don't blow away other properties)\r\n        try {\r\n          delete (window as any).gm;\r\n        } catch (e) {}\r\n      }\r\n    } catch (e) {}\r\n  }\r\n\r\n  return { gm, renderer, dispose };\r\n}\r\n\r\nif (typeof window !== \"undefined\") {\r\n  let appInstance: { gm: any; renderer: any; dispose: () => void } | null =\r\n    null;\r\n  function safeStartApp(doc: Document) {\r\n    if (appInstance && typeof appInstance.dispose === \"function\") {\r\n      appInstance.dispose();\r\n    }\r\n    startApp(doc).then((instance) => {\r\n      appInstance = instance;\r\n    });\r\n  }\r\n  if (document.readyState === \"loading\")\r\n    document.addEventListener(\"DOMContentLoaded\", () => safeStartApp(document));\r\n  else safeStartApp(document);\r\n  window.addEventListener(\"beforeunload\", () => {\r\n    if (appInstance && typeof appInstance.dispose === \"function\") {\r\n      appInstance.dispose();\r\n    }\r\n  });\r\n}\r\n\r\nexport default startApp;\r\n"],
  "mappings": "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",
  "names": ["out", "e", "ux", "uy", "vx", "vy", "entry", "mulberry32", "__nodeRequire", "SpatialGrid", "segmentIntersectsCircle", "state", "dtSeconds", "bounds", "maxTurn", "angle", "s", "lvl", "e", "e", "e", "_seed", "_seed", "getShipConfigSafe", "e", "outW", "outH", "teams", "teamColors", "c", "s", "getHullOutlineFromSvg", "svgText", "sx", "sy", "safeStartApp"]
}
