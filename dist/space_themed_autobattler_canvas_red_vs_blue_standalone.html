<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Space Autobattler ‚Äì Red vs Blue (standalone)</title>
  <style>
    html, body { height: 100%; margin: 0; background: radial-gradient(1200px 800px at 50% 40%, #0b1220, #05070c); color: #eaeff8; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    #ui { position: fixed; top: 12px; left: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; z-index: 10; background: rgba(10,12,20,0.5); border: 1px solid rgba(255,255,255,0.08); padding: 10px; border-radius: 14px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .btn { cursor: pointer; padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: linear-gradient(#1b2335,#141b2a); color: #eaeff8; font-weight: 600; letter-spacing: .2px; }
    .btn:hover { filter: brightness(1.15); }
    .btn:active { transform: translateY(1px); }
    .badge { font-weight: 700; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.1); }
    .red { color:#ffd1d1; background: linear-gradient(180deg, rgba(255,79,79,0.2), rgba(255,79,79,0.05)); border-color: rgba(255,79,79,0.35); }
    .blue { color:#cfe0ff; background: linear-gradient(180deg, rgba(64,160,255,0.2), rgba(64,160,255,0.05)); border-color: rgba(64,160,255,0.35); }
    #stats { margin-left: 8px; font-variant-numeric: tabular-nums; opacity:.95 }
    #bottomRight { position: fixed; right: 12px; bottom: 12px; z-index: 10; display: flex; gap: 8px; align-items: center; background: rgba(10,12,20,0.5); border-radius: 14px; padding: 8px 10px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px); }
  /* moved inline styles into CSS to satisfy linter */
  #bottomRight .continuous-label { color: var(--ui-color,#eaeff8); margin-right: 6px; }
  #bottomRight .muted { opacity: .7; }
    #world { position: fixed; inset: 0; display:block; }
    #toast { position: fixed; top: 12px; right: 12px; background: rgba(15,18,30,.85); border: 1px solid rgba(255,255,255,0.08); padding: 10px 14px; border-radius: 12px; opacity: 0; transform: translateY(-8px); transition: all .35s ease; pointer-events: none; }
    #toast.show { opacity: 1; transform: translateY(0); }
    a { color: #9ecbff; text-decoration: none; }
  </style>
</head>
<body>
  <canvas id="world"></canvas>
  <div id="ui">
    <button id="startPause" class="btn">‚ñ∂ Start</button>
    <button id="reset" class="btn">‚Ü∫ Reset</button>
    <button id="addRed" class="btn" title="Add Red ship">+ Red</button>
    <button id="addBlue" class="btn" title="Add Blue ship">+ Blue</button>
    <button id="toggleTrails" class="btn">‚òÑ Trails: On</button>
    <div class="btn" id="speed">Speed: 1√ó</div>
    <div class="badge red" id="redScore">Red 0</div>
    <div class="badge blue" id="blueScore">Blue 0</div>
    <div id="stats"></div>
  </div>
  <div id="bottomRight">
  <input id="continuousCheckbox" type="checkbox" />
  <label for="continuousCheckbox" class="continuous-label">Continuous</label>
  <button id="seedBtn" class="btn" title="Re-seed RNG for reproducible battles">üé≤ Seed</button>
    <button id="formationBtn" class="btn" title="Re-form fleets">üõ∞Ô∏è Form</button>
    <span class="muted">Space Autobattler</span>
  </div>
  <div id="toast"></div>

  <!-- Use module imports so this page loads the current source files (renderer -> simulate -> entities -> rng). -->
  



















































<!-- BEGIN_INLINED_BUNDLE -->
<script type="module">
var pe=Object.defineProperty;var Ve=(i,e,a)=>e in i?pe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[e]=a;var $e=(i,e)=>()=>(i&&(e=i(i=0)),e);var xe=(i,e)=>{for(var a in e)pe(i,a,{get:e[a],enumerable:!0})};var ye=(i,e,a)=>Ve(i,typeof e!="symbol"?e+"":e,a);var Me={};xe(Me,{createWebGLRenderer:()=>Be,default:()=>fi});function Le(i,e,a){let s=i.createShader(e);if(i.shaderSource(s,a),i.compileShader(s),!i.getShaderParameter(s,i.COMPILE_STATUS)){let o=i.getShaderInfoLog(s);throw i.deleteShader(s),new Error("Shader compile error: "+o)}return s}function Ce(i,e,a){let s=Le(i,i.VERTEX_SHADER,e),o=Le(i,i.FRAGMENT_SHADER,a),t=i.createProgram();if(i.attachShader(t,s),i.attachShader(t,o),i.linkProgram(t),!i.getProgramParameter(t,i.LINK_STATUS)){let n=i.getProgramInfoLog(t);throw i.deleteProgram(t),new Error("Program link error: "+n)}return t}function Be(i,e={}){let{webgl2:a=!1}=e,s=e.atlasAccessor||null,o=e.atlasLODs||[12,20,36],t=null,n=null,f=null,h=null,_=null,l=null,y=null,v=null,b=null,w=null,E=null,F=null,m=null,T=null,k=null,c=null,H=!1,X=1,it=null;return{type:"webgl",webgl2:a,init(){try{if(t=i.getContext(a?"webgl2":"webgl"),!t)return;X=typeof window<"u"&&window.devicePixelRatio?window.devicePixelRatio:1,i.width=Math.max(1,Math.floor((i.clientWidth||i.width)*X)),i.height=Math.max(1,Math.floor((i.clientHeight||i.height)*X));let j="clamp(max(0.5, v_radius * 0.01), 0.5, 3.0)",gt=`
          attribute vec2 a_quadPos; // -0.5..0.5 unit quad
          attribute vec2 a_instPos; // per-instance pixel center
          attribute vec3 a_instColor;
          attribute float a_instSize; // ship radius in pixels
          attribute float a_instAngle; // ship orientation (radians)
          attribute float a_instShield; // shield fraction 0..1
          attribute float a_instType; // shape type id
          uniform vec2 u_resolution;
          varying vec3 v_color;
          varying vec2 v_local; // local space after scale & rotation (diameter scale)
          varying float v_shield;
          varying float v_radius;
          varying float v_type;
          varying float v_angle;
          void main(){
            float c = cos(a_instAngle);
            float s = sin(a_instAngle);
            vec2 rotated = vec2(
              a_quadPos.x * c - a_quadPos.y * s,
              a_quadPos.x * s + a_quadPos.y * c
            );
              vec2 pixelPos = a_instPos + rotated * a_instSize * 2.0; // diameter scaling (vertex position)
            vec2 zeroToOne = pixelPos / u_resolution;
            vec2 clip = zeroToOne * 2.0 - 1.0;
            gl_Position = vec4(clip * vec2(1.0, -1.0), 0.0, 1.0);
            v_color = a_instColor;
              // v_local should be in pixels from center to match v_radius (radius in pixels).
              // Use scale = a_instSize (radius) so length(v_local) ranges ~0..v_radius.
              v_local = rotated * a_instSize; // used for circle SDF (pixels)
            v_shield = a_instShield;
            v_radius = a_instSize;
            v_type = a_instType;
            v_angle = a_instAngle;
          }
        `,pt=`precision mediump float;
          varying vec3 v_color;
          varying vec2 v_local;
          varying float v_shield;
          varying float v_radius; // true circle radius in pixels
          varying float v_type;
          varying float v_angle;
          void main(){
            float d = length(v_local); // distance from center
            float edge = ${j}; // widen edge slightly for smoother look
            // Shape modulation: vary effective radius by angle to approximate different hull silhouettes.
            float theta = atan(v_local.y, v_local.x) - v_angle;
            float modFactor = 1.0;
            // type mapping: 0 circle, 1 corvette (arrow), 2 frigate (sleek), 3 destroyer (broad), 4 carrier (ellipse), 5 fighter (small triangle)
            if (v_type < 0.5) {
              modFactor = 1.0; // circle
            } else if (v_type < 1.5) {
              // corvette: pointed front \u2014 use 3-lobed variation
              modFactor = 1.0 + 0.45 * cos(3.0 * theta);
            } else if (v_type < 2.5) {
              // frigate: smoother elongation
              modFactor = 1.0 + 0.20 * cos(2.0 * theta);
            } else if (v_type < 3.5) {
              // destroyer: wider body with subtle faceting
              modFactor = 1.0 + 0.28 * cos(4.0 * theta);
            } else if (v_type < 4.5) {
              // carrier: near-ellipse (scale x by 1.6)
              // emulate by shrinking radius along lateral axis
              float ex = cos(theta);
              float ey = sin(theta);
              float scale = 1.0 + 0.6 * ex * ex; // wider on x
              modFactor = scale;
            } else {
              // fighter: small pointed triangle-ish
              modFactor = 1.0 + 0.6 * cos(3.0 * theta);
            }
            float effRadius = v_radius * modFactor;
            float alpha = 1.0 - smoothstep(effRadius - edge, effRadius + edge, d);
            if (alpha <= 0.001) discard;
            vec3 base = v_color;
            // Optional shield ring: show thin ring if shield fraction > 0
            if (v_shield > 0.0) {
              float ringOuter = v_radius * 1.05; // just outside body
              float ringInner = v_radius * 0.90; // inside overlap
              float ringEdge = ${j};
              float ringMask = smoothstep(ringInner - ringEdge, ringInner + ringEdge, d) * (1.0 - smoothstep(ringOuter - ringEdge, ringOuter + ringEdge, d));
              // ring color blend (cyan-like) scaled by shield fraction
              vec3 ringColor = mix(base, vec3(0.3,0.9,1.0), 0.6 * v_shield);
              base = mix(base, ringColor, clamp(ringMask,0.0,1.0));
            }
            gl_FragColor = vec4(base, alpha);
          }
        `;n=Ce(t,gt,pt);let ht=`
          attribute vec2 a_quadPos;
          attribute vec2 a_instPos;
          attribute vec3 a_instColor;
          attribute float a_instSize;
          attribute float a_instAngle;
          attribute float a_instShield;
          uniform vec2 u_resolution;
          varying vec2 v_uv;
          varying vec3 v_color;
          varying float v_shield;
          void main(){
            float c = cos(a_instAngle);
            float s = sin(a_instAngle);
            vec2 rotated = vec2(
              a_quadPos.x * c - a_quadPos.y * s,
              a_quadPos.x * s + a_quadPos.y * c
            );
            vec2 pixelPos = a_instPos + rotated * a_instSize * 2.0;
            vec2 zeroToOne = pixelPos / u_resolution;
            vec2 clip = zeroToOne * 2.0 - 1.0;
            gl_Position = vec4(clip * vec2(1.0, -1.0), 0.0, 1.0);
            v_uv = a_quadPos + vec2(0.5, 0.5);
            v_color = a_instColor;
            v_shield = a_instShield;
          }
        `,Ct=`precision mediump float;
          varying vec2 v_uv;
          varying vec3 v_color;
          varying float v_shield;
          uniform sampler2D u_atlas;
          void main(){
            vec4 tex = texture2D(u_atlas, v_uv);
            float alpha = tex.a * tex.r; // atlas is white/alpha mask; use r as mask fallback
            if (alpha <= 0.001) discard;
            vec3 col = v_color * tex.rgb;
            // subtle shield tint
            if (v_shield > 0.0) col = mix(col, vec3(0.3,0.9,1.0), 0.25 * v_shield);
            gl_FragColor = vec4(col, alpha);
          }
        `,q=null;try{q=Ce(t,ht,Ct)}catch{q=null}f=t.createBuffer();let ct=new Float32Array([-.5,-.5,.5,-.5,-.5,.5,.5,.5]);t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,ct,t.STATIC_DRAW),h=t.createBuffer(),_=t.createBuffer(),l=t.createBuffer(),y=t.createBuffer(),v=t.createBuffer(),b=t.createBuffer(),w=t.createBuffer(),E=t.createBuffer(),F=t.createBuffer(),m=t.createBuffer(),T=t.createBuffer(),c=null,a||(c=t.getExtension("ANGLE_instanced_arrays")),this.a_quadPos=t.getAttribLocation(n,"a_quadPos"),this.a_instPos=t.getAttribLocation(n,"a_instPos"),this.a_instColor=t.getAttribLocation(n,"a_instColor"),this.a_instSize=t.getAttribLocation(n,"a_instSize"),this.a_instAngle=t.getAttribLocation(n,"a_instAngle"),this.a_instShield=t.getAttribLocation(n,"a_instShield"),this.a_instType=t.getAttribLocation(n,"a_instType"),this.u_resolution=t.getUniformLocation(n,"u_resolution"),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),k=t.createTexture(),t.bindTexture(t.TEXTURE_2D,k);let bt=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,bt),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this._atlasTextures={},this._ensureAtlasTexture=(K,Bt,C)=>{try{this._atlasTextures[K]=this._atlasTextures[K]||{};let I=String(Bt);if(this._atlasTextures[K][I])return this._atlasTextures[K][I];let D=t.createTexture();return t.bindTexture(t.TEXTURE_2D,D),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,C.canvas),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),this._atlasTextures[K][I]={tex:D,atlas:C},this._atlasTextures[K][I]}catch(I){return console.warn("Failed to create atlas texture",I),null}},this._texturedProgram=q,q&&(this._t_a_quadPos=t.getAttribLocation(q,"a_quadPos"),this._t_a_instPos=t.getAttribLocation(q,"a_instPos"),this._t_a_instColor=t.getAttribLocation(q,"a_instColor"),this._t_a_instSize=t.getAttribLocation(q,"a_instSize"),this._t_a_instAngle=t.getAttribLocation(q,"a_instAngle"),this._t_a_instShield=t.getAttribLocation(q,"a_instShield"),this._t_u_resolution=t.getUniformLocation(q,"u_resolution"),this._t_u_atlas=t.getUniformLocation(q,"u_atlas")),typeof window<"u"&&(it=()=>{let K=window.devicePixelRatio||1;K!==X&&(X=K);let Bt=i.clientWidth||i.width/X,C=i.clientHeight||i.height/X,I=Math.max(1,Math.floor(Bt*X)),D=Math.max(1,Math.floor(C*X));(I!==i.width||D!==i.height)&&(i.width=I,i.height=D,t&&t.viewport(0,0,I,D))},window.addEventListener("resize",it))}catch(j){t=null,console.warn("WebGL init failed:",j.message||j)}},start(j){H=!0,typeof j=="function"&&j()},stop(){H=!1},isRunning(){return H},render(j){if(!t)return;let{W:gt,H:pt,ships:ht,bullets:Ct=[],stars:q=[]}=j,ct=ht.length,bt=Ct.length,K=q.length;if(ct+bt+K!==0){if(t.viewport(0,0,i.width,i.height),t.clearColor(.02,.02,.03,1),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(n),t.uniform2f(this.u_resolution,gt,pt),t.bindBuffer(t.ARRAY_BUFFER,f),this.a_quadPos>=0&&(t.enableVertexAttribArray(this.a_quadPos),t.vertexAttribPointer(this.a_quadPos,2,t.FLOAT,!1,0,0)),s&&this._texturedProgram){let C=Object.create(null);for(let S=0;S<ct;S++){let P=ht[S],B=s?s(P.type,P.radius||8):null;if(!B)continue;let z=P.type+"|"+String(B.baseRadius)+"|"+String(B.size||B.canvas&&B.canvas.width),x=C[z];x||(x=C[z]={atlas:B,ships:[]}),x.ships.push(P)}let I=0;for(let S in C)I+=C[S].ships.length;if(I!==ct){let S=ct;if(S>0){let P=new Float32Array(S*2),B=new Float32Array(S*3),z=new Float32Array(S),x=new Float32Array(S),g=new Float32Array(S),R=new Float32Array(S);for(let d=0;d<S;d++){let u=ht[d];P[d*2]=u.x,P[d*2+1]=u.y,B[d*3]=u.team===0?1:.31,B[d*3+1]=u.team===0?.35:.63,B[d*3+2]=u.team===0?.35:1,z[d]=u.radius||8,x[d]=u.vx||u.vy?Math.atan2(u.vy,u.vx):u.angle||0;let V=0;typeof u.shield=="number"&&typeof u.shieldMax=="number"&&u.shieldMax>0&&(V=Math.min(1,Math.max(0,u.shield/u.shieldMax))),g[d]=V;let Y=1;u.type==="corvette"?Y=1:u.type==="frigate"?Y=2:u.type==="destroyer"?Y=3:u.type==="carrier"?Y=4:u.type==="fighter"&&(Y=5),R[d]=Y}if(t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,P,t.DYNAMIC_DRAW),this.a_instPos>=0&&(t.enableVertexAttribArray(this.a_instPos),t.vertexAttribPointer(this.a_instPos,2,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,B,t.DYNAMIC_DRAW),this.a_instColor>=0&&(t.enableVertexAttribArray(this.a_instColor),t.vertexAttribPointer(this.a_instColor,3,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,z,t.DYNAMIC_DRAW),this.a_instSize>=0&&(t.enableVertexAttribArray(this.a_instSize),t.vertexAttribPointer(this.a_instSize,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,y),t.bufferData(t.ARRAY_BUFFER,x,t.DYNAMIC_DRAW),this.a_instAngle>=0&&(t.enableVertexAttribArray(this.a_instAngle),t.vertexAttribPointer(this.a_instAngle,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,v),t.bufferData(t.ARRAY_BUFFER,g,t.DYNAMIC_DRAW),this.a_instShield>=0&&(t.enableVertexAttribArray(this.a_instShield),t.vertexAttribPointer(this.a_instShield,1,t.FLOAT,!1,0,0)),this.a_instType>=0&&(t.bindBuffer(t.ARRAY_BUFFER,T),t.bufferData(t.ARRAY_BUFFER,R,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.a_instType),t.vertexAttribPointer(this.a_instType,1,t.FLOAT,!1,0,0)),a)this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,1),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,1),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,1),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,1),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,1),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,1),t.drawArraysInstanced(t.TRIANGLE_STRIP,0,4,S),this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,0),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,0),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,0),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,0),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,0),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,0);else if(c)this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,1),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,1),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,1),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,1),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,1),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,1),c.drawArraysInstancedANGLE(t.TRIANGLE_STRIP,0,4,S),this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,0),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,0),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,0),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,0),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,0),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,0);else for(let d=0;d<S;d++){let u=P[d*2+0],V=P[d*2+1],Y=B[d*3+0],L=B[d*3+1],N=B[d*3+2],ft=z[d],Et=x[d],Rt=g[d];this.a_instPos>=0&&t.vertexAttrib2f(this.a_instPos,u,V),this.a_instColor>=0&&t.vertexAttrib3f(this.a_instColor,Y,L,N),this.a_instSize>=0&&t.vertexAttrib1f(this.a_instSize,ft),this.a_instAngle>=0&&t.vertexAttrib1f(this.a_instAngle,Et),this.a_instShield>=0&&t.vertexAttrib1f(this.a_instShield,Rt),this.a_instType>=0&&t.vertexAttrib1f(this.a_instType,R[d]),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}}else{for(let S in C){let P=C[S],B=P.atlas,z=this._ensureAtlasTexture?this._ensureAtlasTexture(P.ships[0].type,B.baseRadius,B):null;if(!z)continue;let x=z.tex||z,g=P.ships.length,R=new Float32Array(g*2),d=new Float32Array(g*3),u=new Float32Array(g),V=new Float32Array(g),Y=new Float32Array(g);for(let L=0;L<g;L++){let N=P.ships[L];R[L*2]=N.x,R[L*2+1]=N.y,d[L*3]=N.team===0?1:.31,d[L*3+1]=N.team===0?.35:.63,d[L*3+2]=N.team===0?.35:1,u[L]=N.radius||8,V[L]=N.vx||N.vy?Math.atan2(N.vy,N.vx):N.angle||0;let ft=0;typeof N.shield=="number"&&typeof N.shieldMax=="number"&&N.shieldMax>0&&(ft=Math.min(1,Math.max(0,N.shield/N.shieldMax))),Y[L]=ft}if(t.useProgram(this._texturedProgram),t.uniform2f(this._t_u_resolution,gt,pt),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,x),this._t_u_atlas&&t.uniform1i(this._t_u_atlas,0),t.bindBuffer(t.ARRAY_BUFFER,f),this._t_a_quadPos>=0&&(t.enableVertexAttribArray(this._t_a_quadPos),t.vertexAttribPointer(this._t_a_quadPos,2,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,R,t.DYNAMIC_DRAW),this._t_a_instPos>=0&&(t.enableVertexAttribArray(this._t_a_instPos),t.vertexAttribPointer(this._t_a_instPos,2,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,d,t.DYNAMIC_DRAW),this._t_a_instColor>=0&&(t.enableVertexAttribArray(this._t_a_instColor),t.vertexAttribPointer(this._t_a_instColor,3,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,u,t.DYNAMIC_DRAW),this._t_a_instSize>=0&&(t.enableVertexAttribArray(this._t_a_instSize),t.vertexAttribPointer(this._t_a_instSize,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,y),t.bufferData(t.ARRAY_BUFFER,V,t.DYNAMIC_DRAW),this._t_a_instAngle>=0&&(t.enableVertexAttribArray(this._t_a_instAngle),t.vertexAttribPointer(this._t_a_instAngle,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,v),t.bufferData(t.ARRAY_BUFFER,Y,t.DYNAMIC_DRAW),this._t_a_instShield>=0&&(t.enableVertexAttribArray(this._t_a_instShield),t.vertexAttribPointer(this._t_a_instShield,1,t.FLOAT,!1,0,0)),a)this._t_a_instPos>=0&&t.vertexAttribDivisor(this._t_a_instPos,1),this._t_a_instColor>=0&&t.vertexAttribDivisor(this._t_a_instColor,1),this._t_a_instSize>=0&&t.vertexAttribDivisor(this._t_a_instSize,1),this._t_a_instAngle>=0&&t.vertexAttribDivisor(this._t_a_instAngle,1),this._t_a_instShield>=0&&t.vertexAttribDivisor(this._t_a_instShield,1),t.drawArraysInstanced(t.TRIANGLE_STRIP,0,4,g),this._t_a_instPos>=0&&t.vertexAttribDivisor(this._t_a_instPos,0),this._t_a_instColor>=0&&t.vertexAttribDivisor(this._t_a_instColor,0),this._t_a_instSize>=0&&t.vertexAttribDivisor(this._t_a_instSize,0),this._t_a_instAngle>=0&&t.vertexAttribDivisor(this._t_a_instAngle,0),this._t_a_instShield>=0&&t.vertexAttribDivisor(this._t_a_instShield,0);else if(c)this._t_a_instPos>=0&&c.vertexAttribDivisorANGLE(this._t_a_instPos,1),this._t_a_instColor>=0&&c.vertexAttribDivisorANGLE(this._t_a_instColor,1),this._t_a_instSize>=0&&c.vertexAttribDivisorANGLE(this._t_a_instSize,1),this._t_a_instAngle>=0&&c.vertexAttribDivisorANGLE(this._t_a_instAngle,1),this._t_a_instShield>=0&&c.vertexAttribDivisorANGLE(this._t_a_instShield,1),c.drawArraysInstancedANGLE(t.TRIANGLE_STRIP,0,4,g),this._t_a_instPos>=0&&c.vertexAttribDivisorANGLE(this._t_a_instPos,0),this._t_a_instColor>=0&&c.vertexAttribDivisorANGLE(this._t_a_instColor,0),this._t_a_instSize>=0&&c.vertexAttribDivisorANGLE(this._t_a_instSize,0),this._t_a_instAngle>=0&&c.vertexAttribDivisorANGLE(this._t_a_instAngle,0),this._t_a_instShield>=0&&c.vertexAttribDivisorANGLE(this._t_a_instShield,0);else for(let L=0;L<g;L++){let N=R[L*2+0],ft=R[L*2+1],Et=d[L*3+0],Rt=d[L*3+1],We=d[L*3+2],Oe=u[L],Xe=V[L],qe=Y[L];this._t_a_instPos>=0&&t.vertexAttrib2f(this._t_a_instPos,N,ft),this._t_a_instColor>=0&&t.vertexAttrib3f(this._t_a_instColor,Et,Rt,We),this._t_a_instSize>=0&&t.vertexAttrib1f(this._t_a_instSize,Oe),this._t_a_instAngle>=0&&t.vertexAttrib1f(this._t_a_instAngle,Xe),this._t_a_instShield>=0&&t.vertexAttrib1f(this._t_a_instShield,qe),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}t.useProgram(n)}let D=bt+K;if(D>0){let S=new Float32Array(D*2),P=new Float32Array(D*3),B=new Float32Array(D),z=new Float32Array(D),x=new Float32Array(D),g=new Float32Array(D),R=0;for(let d=0;d<bt;d++,R++){let u=Ct[d];S[R*2]=u.x,S[R*2+1]=u.y,P[R*3]=u.team===0?1:.35,P[R*3+1]=u.team===0?.35:.63,P[R*3+2]=u.team===0?.35:1,B[R]=u.radius||2.2,z[R]=u.vx||u.vy?Math.atan2(u.vy,u.vx):0,x[R]=0,g[R]=0}for(let d=0;d<K;d++,R++){let u=q[d];S[R*2]=u.x,S[R*2+1]=u.y;let V=u.phase!=null?.6+.4*Math.sin(u.phase):1,Y=.85+.15*V;P[R*3]=Y,P[R*3+1]=Y,P[R*3+2]=1,B[R]=(u.r||1)+.5*V,z[R]=0,x[R]=0,g[R]=0}if(t.bindBuffer(t.ARRAY_BUFFER,b),t.bufferData(t.ARRAY_BUFFER,S,t.DYNAMIC_DRAW),this.a_instPos>=0&&(t.enableVertexAttribArray(this.a_instPos),t.vertexAttribPointer(this.a_instPos,2,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,w),t.bufferData(t.ARRAY_BUFFER,P,t.DYNAMIC_DRAW),this.a_instColor>=0&&(t.enableVertexAttribArray(this.a_instColor),t.vertexAttribPointer(this.a_instColor,3,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,E),t.bufferData(t.ARRAY_BUFFER,B,t.DYNAMIC_DRAW),this.a_instSize>=0&&(t.enableVertexAttribArray(this.a_instSize),t.vertexAttribPointer(this.a_instSize,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,F),t.bufferData(t.ARRAY_BUFFER,z,t.DYNAMIC_DRAW),this.a_instAngle>=0&&(t.enableVertexAttribArray(this.a_instAngle),t.vertexAttribPointer(this.a_instAngle,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,m),t.bufferData(t.ARRAY_BUFFER,x,t.DYNAMIC_DRAW),this.a_instShield>=0&&(t.enableVertexAttribArray(this.a_instShield),t.vertexAttribPointer(this.a_instShield,1,t.FLOAT,!1,0,0)),this.a_instType>=0&&(t.bindBuffer(t.ARRAY_BUFFER,T),t.bufferData(t.ARRAY_BUFFER,g,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.a_instType),t.vertexAttribPointer(this.a_instType,1,t.FLOAT,!1,0,0)),a)this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,1),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,1),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,1),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,1),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,1),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,1),t.drawArraysInstanced(t.TRIANGLE_STRIP,0,4,D),this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,0),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,0),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,0),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,0),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,0),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,0);else if(c)this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,1),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,1),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,1),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,1),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,1),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,1),c.drawArraysInstancedANGLE(t.TRIANGLE_STRIP,0,4,D),this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,0),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,0),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,0),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,0),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,0),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,0);else for(let d=0;d<D;d++){let u=S[d*2+0],V=S[d*2+1],Y=P[d*3+0],L=P[d*3+1],N=P[d*3+2],ft=B[d],Et=z[d],Rt=x[d];this.a_instPos>=0&&t.vertexAttrib2f(this.a_instPos,u,V),this.a_instColor>=0&&t.vertexAttrib3f(this.a_instColor,Y,L,N),this.a_instSize>=0&&t.vertexAttrib1f(this.a_instSize,ft),this.a_instAngle>=0&&t.vertexAttrib1f(this.a_instAngle,Et),this.a_instShield>=0&&t.vertexAttrib1f(this.a_instShield,Rt),this.a_instType>=0&&t.vertexAttrib1f(this.a_instType,g[d]),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}}else{let C=ct;if(C>0){let I=new Float32Array(C*2),D=new Float32Array(C*3),S=new Float32Array(C),P=new Float32Array(C),B=new Float32Array(C),z=new Float32Array(C);for(let x=0;x<C;x++){let g=ht[x];I[x*2]=g.x,I[x*2+1]=g.y,D[x*3]=g.team===0?1:.31,D[x*3+1]=g.team===0?.35:.63,D[x*3+2]=g.team===0?.35:1,S[x]=g.radius||8,P[x]=g.vx||g.vy?Math.atan2(g.vy,g.vx):g.angle||0;let R=0;typeof g.shield=="number"&&typeof g.shieldMax=="number"&&g.shieldMax>0&&(R=Math.min(1,Math.max(0,g.shield/g.shieldMax))),B[x]=R;let d=1;g.type==="corvette"?d=1:g.type==="frigate"?d=2:g.type==="destroyer"?d=3:g.type==="carrier"?d=4:g.type==="fighter"&&(d=5),z[x]=d}if(t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,I,t.DYNAMIC_DRAW),this.a_instPos>=0&&(t.enableVertexAttribArray(this.a_instPos),t.vertexAttribPointer(this.a_instPos,2,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,_),t.bufferData(t.ARRAY_BUFFER,D,t.DYNAMIC_DRAW),this.a_instColor>=0&&(t.enableVertexAttribArray(this.a_instColor),t.vertexAttribPointer(this.a_instColor,3,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,S,t.DYNAMIC_DRAW),this.a_instSize>=0&&(t.enableVertexAttribArray(this.a_instSize),t.vertexAttribPointer(this.a_instSize,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,y),t.bufferData(t.ARRAY_BUFFER,P,t.DYNAMIC_DRAW),this.a_instAngle>=0&&(t.enableVertexAttribArray(this.a_instAngle),t.vertexAttribPointer(this.a_instAngle,1,t.FLOAT,!1,0,0)),t.bindBuffer(t.ARRAY_BUFFER,v),t.bufferData(t.ARRAY_BUFFER,B,t.DYNAMIC_DRAW),this.a_instShield>=0&&(t.enableVertexAttribArray(this.a_instShield),t.vertexAttribPointer(this.a_instShield,1,t.FLOAT,!1,0,0)),this.a_instType>=0&&(t.bindBuffer(t.ARRAY_BUFFER,T),t.bufferData(t.ARRAY_BUFFER,z,t.DYNAMIC_DRAW),t.enableVertexAttribArray(this.a_instType),t.vertexAttribPointer(this.a_instType,1,t.FLOAT,!1,0,0)),a)this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,1),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,1),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,1),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,1),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,1),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,1),t.drawArraysInstanced(t.TRIANGLE_STRIP,0,4,C),this.a_instPos>=0&&t.vertexAttribDivisor(this.a_instPos,0),this.a_instColor>=0&&t.vertexAttribDivisor(this.a_instColor,0),this.a_instSize>=0&&t.vertexAttribDivisor(this.a_instSize,0),this.a_instAngle>=0&&t.vertexAttribDivisor(this.a_instAngle,0),this.a_instShield>=0&&t.vertexAttribDivisor(this.a_instShield,0),this.a_instType>=0&&t.vertexAttribDivisor(this.a_instType,0);else if(c)this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,1),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,1),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,1),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,1),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,1),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,1),c.drawArraysInstancedANGLE(t.TRIANGLE_STRIP,0,4,C),this.a_instPos>=0&&c.vertexAttribDivisorANGLE(this.a_instPos,0),this.a_instColor>=0&&c.vertexAttribDivisorANGLE(this.a_instColor,0),this.a_instSize>=0&&c.vertexAttribDivisorANGLE(this.a_instSize,0),this.a_instAngle>=0&&c.vertexAttribDivisorANGLE(this.a_instAngle,0),this.a_instShield>=0&&c.vertexAttribDivisorANGLE(this.a_instShield,0),this.a_instType>=0&&c.vertexAttribDivisorANGLE(this.a_instType,0);else for(let x=0;x<C;x++){let g=I[x*2+0],R=I[x*2+1],d=D[x*3+0],u=D[x*3+1],V=D[x*3+2],Y=S[x],L=P[x],N=B[x];this.a_instPos>=0&&t.vertexAttrib2f(this.a_instPos,g,R),this.a_instColor>=0&&t.vertexAttrib3f(this.a_instColor,d,u,V),this.a_instSize>=0&&t.vertexAttrib1f(this.a_instSize,Y),this.a_instAngle>=0&&t.vertexAttrib1f(this.a_instAngle,L),this.a_instShield>=0&&t.vertexAttrib1f(this.a_instShield,N),this.a_instType>=0&&t.vertexAttrib1f(this.a_instType,z[x]),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}}if(destroy(),t){try{if(f&&t.deleteBuffer(f),h&&t.deleteBuffer(h),_&&t.deleteBuffer(_),l&&t.deleteBuffer(l),y&&t.deleteBuffer(y),v&&t.deleteBuffer(v),b&&t.deleteBuffer(b),w&&t.deleteBuffer(w),E&&t.deleteBuffer(E),F&&t.deleteBuffer(F),m&&t.deleteBuffer(m),T&&t.deleteBuffer(T),n&&t.deleteProgram(n),this._texturedProgram&&t.deleteProgram(this._texturedProgram),this._atlasTextures)for(let C in this._atlasTextures){let I=this._atlasTextures[C];for(let D in I)try{I[D]&&I[D].tex&&t.deleteTexture(I[D].tex)}catch{}}k&&t.deleteTexture(k)}catch{}t=null}typeof window<"u"&&it&&window.removeEventListener("resize",it),H=!1}}}}var fi,Fe=$e(()=>{fi={createWebGLRenderer:Be}});var jt=!1,Mt=123456789;function me(i){jt=!0,Mt=i>>>0}function be(){jt=!1}function Ke(){return jt?(Mt=1664525*Mt+1013904223>>>0,Mt/4294967296):Math.random()}function A(i=0,e=1){return i+(e-i)*Ke()}function wt(i,e){return Math.floor(A(i,e+1))}var Ee={corvette:6.5,frigate:5,destroyer:3.2,carrier:2,fighter:8},Re=1.2,Jt=.6;var p={RED:0,BLUE:1},Qt=class{constructor(e,a,s,o,t,n=null){this.x=e,this.y=a,this.vx=s,this.vy=o,this.team=t,this.ownerId=n,this.life=2.5,this.radius=2.2,this.dmg=A(8,14)}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.life-=e}alive(e=null){if(this.life<=0)return!1;if(!e)return!0;let{W:a,H:s}=e;return this.x>-50&&this.x<a+50&&this.y>-50&&this.y<s+50}},Ft=class Ft{constructor(e,a,s,o="corvette"){this.team=e,this.x=a,this.y=s,this.vx=0,this.vy=0,this.angle=0,this.type=o;let t={corvette:{radius:8,maxSpeed:A(120,160),accel:240,turn:6.5,hp:A(40,70),reload:A(.18,.28),vision:220,range:140},frigate:{radius:10,maxSpeed:A(90,120),accel:200,turn:5,hp:A(80,120),reload:A(.24,.4),vision:280,range:180},destroyer:{radius:14,maxSpeed:A(60,90),accel:150,turn:3.2,hp:A(150,220),reload:A(.4,.7),vision:320,range:220},carrier:{radius:18,maxSpeed:A(40,70),accel:90,turn:2,hp:A(220,300),reload:A(.6,1.2),vision:360,range:260,launchBase:A(3.5,6)},fighter:{radius:6,maxSpeed:A(160,220),accel:300,turn:8,hp:A(18,32),reload:A(.12,.22),vision:180,range:120}},n=t[o]||t.corvette;this.radius=n.radius,this.maxSpeed=n.maxSpeed,this.accel=n.accel,this.turn=n.turn||Ee[o]||4.5,this.hpMax=n.hp,this.hp=this.hpMax,this.cooldown=0,this.reload=n.reload,this.vision=n.vision,this.range=n.range,this.id=Ft._id++,this.kills=0,this.alive=!0,this._exploded=!1,this.level=1,this.xp=0,this.baseHpMax=this.hpMax,this.baseDmg=10,this.shieldMax=Math.round(this.hpMax*.6),this.shield=this.shieldMax,this.shieldRegen=Math.max(.5,this.shieldMax*.06),this.recentHitTimer=0,o==="carrier"?(this.isCarrier=!0,this.launchCooldown=n.launchBase*A(.8,1.4),this.launchAmount=Math.max(1,Math.floor(A(1,3))),this.maxFighters=6,this.activeFighters=[]):(this.isCarrier=!1,this.launchCooldown=0)}xpToNext(e=100,a=1.35){return Math.floor(e*Math.pow(a,Math.max(0,this.level-1)))}applyLevel(){let e=.06,a=.1,s=.08;this.hpMax=Math.round(this.baseHpMax*(1+a*(this.level-1)));let o=Math.round(this.baseHpMax*.6);this.shieldMax=Math.round(o*(1+s*(this.level-1))),this.hp=Math.min(this.hp,this.hpMax),this.shield=Math.min(this.shield,this.shieldMax)}gainXp(e){if(!(e<=0))for(this.xp+=e;this.xp>=this.xpToNext();)this.xp-=this.xpToNext(),this.level++,this.applyLevel()}pickTarget(e){let a=null,s=1/0,o=this.vision*this.vision;for(let t of e){if(!t.alive||t.team===this.team)continue;let n=t.x-this.x,f=t.y-this.y,h=n*n+f*f;h<o&&h<s&&(s=h,a=t)}return a}update(e,a){if(!this.alive)return;let s=this.pickTarget(a),o=this.recentHitTimer>0,t=0,n=0,f=1;if(s&&!o){let m=s.x-this.x,T=s.y-this.y;f=Math.hypot(m,T)||1;let k=Math.max(0,Math.min(1.2,f/240)),c=s.x+(s.vx||0)*k,H=s.y+(s.vy||0)*k;t=c-this.x,n=H-this.y;let X=Math.hypot(t,n)||1;t/=X,n/=X}else if(s&&o){let m=s.x-this.x,T=s.y-this.y;f=Math.hypot(m,T)||1,t=-(m/f),n=-(T/f)}else t=Math.cos(this.angle),n=Math.sin(this.angle);let h=0,_=0,l=0,y=26;for(let m of a){if(!m.alive||m===this||m.team!==this.team)continue;let T=this.x-m.x,k=this.y-m.y,c=T*T+k*k;if(c<y*y&&c>1){let H=Math.sqrt(c);h+=T/H,_+=k/H,l++}}l>0&&(h/=l,_/=l);let b=Math.atan2(n,t)-this.angle;for(;b>Math.PI;)b-=2*Math.PI;for(;b<-Math.PI;)b+=2*Math.PI;let w=this.turn*e;b>w?b=w:b<-w&&(b=-w),this.angle+=b;let E=o?this.accel*Re:this.accel;this.vx+=Math.cos(this.angle)*E*e,this.vy+=Math.sin(this.angle)*E*e,l>0&&(this.vx+=h*(this.accel*Jt)*e,this.vy+=_*(this.accel*Jt)*e);let F=Math.hypot(this.vx,this.vy);if(F>this.maxSpeed){let m=this.maxSpeed/F;this.vx*=m,this.vy*=m}if(this.x+=this.vx*e,this.y+=this.vy*e,s){let m=s.x-this.x,T=s.y-this.y,k=Math.hypot(m,T)||1;if(k<this.range){let c=Math.cos(this.angle)*(m/k)+Math.sin(this.angle)*(T/k);if(this.cooldown<=0&&c>.2){let H=300+A(-20,20),X=m/k,it=T/k;arguments.length>=3&&Array.isArray(arguments[2])&&arguments[2].push(new Qt(this.x+X*12,this.y+it*12,X*H+this.vx*.2,it*H+this.vy*.2,this.team,this.id)),this.cooldown=this.reload}}}this.cooldown-=e,this.shield<this.shieldMax&&(this.shield=Math.min(this.shieldMax,this.shield+this.shieldRegen*e)),this.recentHitTimer>0&&(this.recentHitTimer=Math.max(0,this.recentHitTimer-e))}damage(e){let a=e,s=0;return this.shield>0&&e>0&&(s=Math.min(this.shield,e),this.shield-=s,e-=s),e>0&&(this.hp-=e),(s>0||a>0&&e>0)&&(this.recentHitTimer=Math.max(this.recentHitTimer,1.2)),this.hp<=0&&this.alive?(this.type==="fighter"&&this.ownerCarrier,this.alive=!1,this._exploded=!0,{x:this.x,y:this.y,team:this.team,id:this.id,type:this.type,ownerCarrier:this.ownerCarrier}):null}};ye(Ft,"_id",1);var lt=Ft;function It(i,e,a,s,o=80){let t=[];for(let n=0;n<e;n++){let f=n%6*20+A(-10,10),h=Math.floor(n/6)*20+A(-10,10),_=A(0,1),l="corvette";_<.45?l="corvette":_<.75?l="frigate":_<.92?l="destroyer":l="carrier",t.push(new lt(i,a+(i===p.RED?-f:f),s+h,l))}return t}var he={};xe(he,{Particle:()=>xt,acquireParticle:()=>Pt,bullets:()=>at,clamp:()=>te,evaluateReinforcement:()=>oe,flashes:()=>Z,getReinforcementInterval:()=>ne,handleReinforcement:()=>_t,healthFlashes:()=>rt,initStars:()=>Ut,particlePool:()=>At,particles:()=>tt,processStateEvents:()=>hi,releaseParticle:()=>Gt,reset:()=>re,resetReinforcementCooldowns:()=>ie,setCarrierLaunchStrategy:()=>ri,setContinuousCheckbox:()=>kt,setReinforcementInterval:()=>se,setReinforcementStrategy:()=>ai,setSpawnCompositionStrategy:()=>li,setToast:()=>ni,shieldFlashes:()=>nt,ships:()=>U,simulate:()=>le,stars:()=>ut});function we(i,e,a={W:800,H:600}){for(let s of i.ships)s.alive&&s.update(e,i.ships,i.bullets);if(a&&typeof a.W=="number"&&typeof a.H=="number"){let s=a.W,o=a.H;for(let t of i.ships){if(!t.alive)continue;let n=t.radius||0;t.x<-n?t.x+=s+n*2:t.x>s+n&&(t.x-=s+n*2),t.y<-n?t.y+=o+n*2:t.y>o+n&&(t.y-=o+n*2)}}for(let s=i.bullets.length-1;s>=0;s--){let o=i.bullets[s];o.update(e),o.alive(a)||i.bullets.splice(s,1)}for(let s=i.bullets.length-1;s>=0;s--){let o=i.bullets[s];for(let t of i.ships){if(!t.alive||t.team===o.team)continue;let n=t.x-o.x,f=t.y-o.y,h=n*n+f*f,_=t.radius+o.radius;if(h<_*_){let l=o.dmg,y=typeof t.shield=="number"?t.shield:0,v=typeof t.hp=="number"?t.hp:0,b=t.damage(l),w=Math.max(0,y-(typeof t.shield=="number"?t.shield:0)),E=Math.max(0,v-(typeof t.hp=="number"?t.hp:0));w>0&&i&&Array.isArray(i.shieldHits)&&i.shieldHits.push({id:t.id,hitX:o.x,hitY:o.y,team:t.team,amount:w}),E>0&&i&&Array.isArray(i.healthHits)&&i.healthHits.push({id:t.id,hitX:o.x,hitY:o.y,team:t.team,amount:E}),Array.isArray(i.damageEvents)||(i.damageEvents=[]),o.ownerId!=null&&i.damageEvents.push({ownerId:o.ownerId,dmg:l}),i.bullets.splice(s,1),b&&i.explosions&&i.explosions.push(b),t.alive||(Array.isArray(i.killEvents)||(i.killEvents=[]),i.killEvents.push({id:t.id,type:t.type,ownerCarrier:t.ownerCarrier,level:t.level,team:t.team,killerId:o.ownerId,killerTeam:o.team,x:t.x,y:t.y}));break}}}}var Nt=Math.PI*2,dt=(i,e)=>i+(e-i)*Math.random(),te=(i,e,a)=>Math.max(e,Math.min(a,i)),ee=i=>{if(typeof document<"u"){let e=document.getElementById("toast");e&&(e.textContent=i,e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),1400))}};function ni(i){ee=i}var ut=[];function Ut(){ut.length=0;let i=[.2,.5,1],e=typeof window<"u"?window.innerWidth:1024,a=typeof window<"u"?window.innerHeight:768;for(let s of i)for(let o=0;o<120;o++)ut.push({x:dt(0,e),y:dt(0,a),r:dt(.3,1.8)*s,d:s,tw:dt(.4,1),phase:dt(0,Nt)})}Ut();var At=[],tt=[],xt=class{constructor(e,a,s,o,t,n){this.x=e,this.y=a,this.vx=s,this.vy=o,this.life=t,this.max=t,this.color=n}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.vx*=Math.pow(.9,e*60),this.vy*=Math.pow(.9,e*60),this.life-=e}};function Pt(i,e,a,s,o,t){let n;return At.length>0?(n=At.pop(),n.x=i,n.y=e,n.vx=a,n.vy=s,n.life=o,n.max=o,n.color=t):n=new xt(i,e,a,s,o,t),tt.push(n),n}function Gt(i){At.length<2e3&&At.push(i)}var Z=[],nt=[],rt=[],U=[],at=[],Tt=0,st={[p.RED]:0,[p.BLUE]:0},St={[p.RED]:0,[p.BLUE]:0};function ie(){St[p.RED]=0,St[p.BLUE]=0}function se(i){Tt=Number(i)||0,st[p.RED]=0,st[p.BLUE]=0}function ne(){return Tt}var Zt=null;function kt(i){Zt=i}function _t(i,e=null){if(!Zt||!Zt.checked)return;let a=2,s=["frigate","corvette","destroyer","carrier"],o=(n,f)=>{for(let h=0;h<f;h++){let _=s[wt(0,s.length-1)],l=typeof window<"u"?window.innerWidth:1024,y=typeof window<"u"?window.innerHeight:768,v=n===p.RED?A(40,Math.max(120,l*.35)):A(Math.max(l*.65,l-240),l-40),b=A(80,Math.max(120,y-80));U.push(new lt(n,v,b,_))}},t=n=>{if(U.filter(h=>h.alive&&h.team===n).length<a&&(St[n]-=i,St[n]<=0)){let h=wt(1,6);o(n,h),St[n]=A(3,8),ee(`Reinforcements: +${h} ${n===p.RED?"Red":"Blue"}`)}};e===null?(t(p.RED),t(p.BLUE)):t(e)}function re(i=null){if(U.length=0,at.length=0,tt.length=0,Z.length=0,nt.length=0,rt.length=0,i!==null)me(i>>>0),ee(`Seed set to ${i>>>0}`);else try{be()}catch{}let e=typeof window<"u"?window.innerWidth:1024,a=typeof window<"u"?window.innerHeight:768;U.push(...It(p.RED,12,e*.25,a*.5)),U.push(...It(p.BLUE,12,e*.75,a*.5))}var ae=(i,e,a)=>{let s=[];if(i.launchCooldown-=a,i.launchCooldown<=0){if((Array.isArray(i.activeFighters)?i.activeFighters.length:0)<(i.maxFighters||6)){let t=Math.max(1,Math.floor(i.launchAmount||1));for(let n=0;n<t&&!(i.activeFighters.length>=(i.maxFighters||6));n++){let f=A(0,Nt),h=i.radius+12+A(4,12),_=i.x+Math.cos(f)*h,l=i.y+Math.sin(f)*h,y=new lt(i.team,_,l,"fighter"),v=A(40,120);y.vx=Math.cos(f)*v+(i.vx||0)*.2,y.vy=Math.sin(f)*v+(i.vy||0)*.2,y.ownerCarrier=i.id,i.activeFighters.push(y.id),s.push(y)}}i.launchCooldown=A(2.5,6)}return s};function ri(i){ae=i}var De=(i,e)=>{_t(i)};function ai(i){De=i}var oi=(i,e,a,s)=>It(i,e,a,s);function li(i){oi=i}function oe(i){if(Tt<=0){_t(i);return}st[p.RED]+=i,st[p.BLUE]+=i,st[p.RED]>=Tt&&(_t(st[p.RED],p.RED),st[p.RED]=0),st[p.BLUE]>=Tt&&(_t(st[p.BLUE],p.BLUE),st[p.BLUE]=0)}function le(i,e,a){for(let t of ut)t.phase+=i*.8*t.d;for(let t of U){if(!t.alive||!t.isCarrier)continue;let n=ae(t,U,i);if(Array.isArray(n)&&n.length)for(let f of n)U.push(f)}for(let t of U)t.update(i,U);for(let t=at.length-1;t>=0;t--){let n=at[t];if(n.update(i),!n.alive()){at.splice(t,1);continue}}let o={ships:U,bullets:at,score:{red:0,blue:0},particles:tt,explosions:[],shieldHits:[]};if(we(o,i,{W:e,H:a}),o.explosions&&o.explosions.length)for(let t of o.explosions){Z.push({x:t.x,y:t.y,r:2,life:.25,team:t.team});for(let n=0;n<20;n++){let f=A(0,Nt),h=A(40,220);Pt(t.x,t.y,Math.cos(f)*h,Math.sin(f)*h,dt(.2,1),"rgba(255,255,255,$a)")}}if(Array.isArray(o.shieldHits)&&o.shieldHits.length)for(let t of o.shieldHits){let n=U.find(_=>_.id===t.id),f=n?n.x:t.hitX,h=n?n.y:t.hitY;Z.push({x:f,y:h,r:6+Math.min(12,t.amount),life:.12,team:t.team,shieldHit:!0});for(let _=0;_<6;_++){let l=A(0,Nt),y=A(40,120);Pt(t.hitX,t.hitY,Math.cos(l)*y,Math.sin(l)*y,dt(.12,.4),"rgba(200,230,255,$a)")}if(n){let _=Math.atan2(t.hitY-h,t.hitX-f);nt.push({id:n.id,angle:_,life:.22,amount:t.amount})}}if(Array.isArray(o.healthHits)&&o.healthHits.length)for(let t of o.healthHits){let n=U.find(f=>f.id===t.id);n&&rt.push({id:n.id,life:.45,amount:t.amount})}if(Array.isArray(o.damageEvents)&&o.damageEvents.length){for(let t of o.damageEvents)if(t&&t.ownerId!=null&&typeof t.dmg=="number"){let n=U.find(f=>f.id===t.ownerId);n&&n.gainXp(t.dmg*.05)}}if(Array.isArray(o.killEvents)&&o.killEvents.length){for(let t of o.killEvents)if(t){if(t.killerTeam===p.RED?o.score.red++:t.killerTeam===p.BLUE&&o.score.blue++,t.killerId!=null){let n=U.find(f=>f.id===t.killerId);n&&n.gainXp(20+(t.level||1)*.2)}if(t.type==="fighter"&&typeof t.ownerCarrier=="number"){let n=U.find(f=>f.id===t.ownerCarrier);if(n&&Array.isArray(n.activeFighters)){let f=n.activeFighters.indexOf(t.id);f>=0&&n.activeFighters.splice(f,1)}}if(t.type==="carrier"){let n=t.id;for(let h of U)h.alive&&h.type==="fighter"&&h.ownerCarrier===n&&(h.ownerCarrier=null);let f=U.find(h=>h.id===n);f&&Array.isArray(f.activeFighters)&&(f.activeFighters.length=0)}}}De(i,U);for(let t=tt.length-1;t>=0;t--){let n=tt[t];n.update(i),n.life<=0&&(tt.splice(t,1),Gt(n))}for(let t=Z.length-1;t>=0;t--){let n=Z[t];n.life-=i,n.r+=600*i,n.life<=0&&Z.splice(t,1)}for(let t=nt.length-1;t>=0;t--){let n=nt[t];n.life-=i,n.life<=0&&nt.splice(t,1)}for(let t=rt.length-1;t>=0;t--){let n=rt[t];n.life-=i,n.life<=0&&rt.splice(t,1)}return{ships:U,bullets:at,particles:tt,flashes:Z,shieldFlashes:nt,healthFlashes:rt,stars:ut}}function hi(i,e=0){if(!(!i||!Array.isArray(i.ships))){for(let a of i.ships){if(!a.alive||!a.isCarrier)continue;let s=ae(a,i.ships,e);if(Array.isArray(s)&&s.length)for(let o of s)i.ships.push(o)}if(Array.isArray(i.damageEvents)&&i.damageEvents.length){for(let a of i.damageEvents)if(a&&a.ownerId!=null&&typeof a.dmg=="number"){let s=i.ships.find(o=>o.id===a.ownerId);s&&s.gainXp(a.dmg*.05)}}if(Array.isArray(i.killEvents)&&i.killEvents.length){for(let a of i.killEvents)if(a){if(i.score||(i.score={red:0,blue:0}),a.killerTeam===p.RED?i.score.red++:a.killerTeam===p.BLUE&&i.score.blue++,a.killerId!=null){let s=i.ships.find(o=>o.id===a.killerId);s&&s.gainXp(20+(a.level||1)*.2)}if(a.type==="fighter"&&typeof a.ownerCarrier=="number"){let s=i.ships.find(o=>o.id===a.ownerCarrier);if(s&&Array.isArray(s.activeFighters)){let o=s.activeFighters.indexOf(a.id);o>=0&&s.activeFighters.splice(o,1)}}if(a.type==="carrier"){let s=a.id;for(let t of i.ships)t.alive&&t.type==="fighter"&&t.ownerCarrier===s&&(t.ownerCarrier=null);let o=i.ships.find(t=>t.id===s);o&&Array.isArray(o.activeFighters)&&(o.activeFighters.length=0)}}}}}typeof window<"u"&&(window.initRenderer=He);var O=null;typeof document<"u"&&(O=document.getElementById("world"));!O&&typeof document<"u"&&(O=document.createElement("canvas"),O.id="world",document.body&&document.body.appendChild(O));if(typeof globalThis.Path2D>"u"){class i{constructor(){}moveTo(){}lineTo(){}quadraticCurveTo(){}ellipse(){}arc(){}closePath(){}}globalThis.Path2D=i}var r=null,W=O&&O.width?O.width=typeof window<"u"?window.innerWidth:1024:1024,$=O&&O.height?O.height=typeof window<"u"?window.innerHeight:768:768;typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("resize",()=>{W=O.width=window.innerWidth,$=O.height=window.innerHeight,Ge(),ci()});var J=Math.PI*2,de=te;function zt(i){let e=document.getElementById("toast");e.textContent=i,e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),1400)}var Ne=ut,ci=Ut,fe=new Map;function di(i){if(fe.has(i))return fe.get(i);let e=new Path2D;return i==="corvette"?(e.moveTo(1.5,0),e.lineTo(-1,-.7),e.lineTo(-.4,0),e.lineTo(-1,.7),e.closePath(),e.ellipse(0,0,.35,.25,0,0,J)):i==="frigate"?(e.moveTo(1.6,0),e.quadraticCurveTo(.2,-1.1,-1.1,-.6),e.lineTo(-.6,0),e.lineTo(-1.1,.6),e.quadraticCurveTo(.2,1.1,1.6,0),e.closePath()):i==="destroyer"?(e.moveTo(1.9,0),e.lineTo(.3,-1.1),e.lineTo(-1.4,-.6),e.lineTo(-1.4,.6),e.lineTo(.3,1.1),e.closePath()):i==="carrier"?e.ellipse(0,0,1.6,1,0,0,J):i==="fighter"?(e.moveTo(1.2,0),e.lineTo(-.6,-.45),e.lineTo(-.2,0),e.lineTo(-.6,.45),e.closePath(),e.ellipse(.25,0,.25,.15,0,0,J)):(e.moveTo(1.4,0),e.lineTo(-1,-.8),e.lineTo(-.4,0),e.lineTo(-1,.8),e.closePath()),fe.set(i,e),e}var qt=new Map,ve=[12,20,36];function ge(i,e){let a=qt.get(i);if(a||(a=new Map,qt.set(i,a)),a.has(e))return a.get(e);let o=Math.ceil(e*2.2*2+8),t=typeof document<"u"?document.createElement("canvas"):{width:o,height:o,getContext:()=>null};t.width=o,t.height=o;let n=t.getContext&&t.getContext("2d");if(!n){let _={canvas:t,size:o,baseRadius:e};return a.set(e,_),_}let f=o/2;n.clearRect(0,0,o,o),n.save(),n.translate(f,f),n.scale(e,e),n.fillStyle="white",n.strokeStyle="white",n.lineWidth=.02;try{n.fill(di(i))}catch{n.beginPath(),n.arc(0,0,1,0,J),n.fill()}n.fillStyle="rgba(255,255,255,0.9)",i==="corvette"||i==="fighter"?(n.beginPath(),n.ellipse(.25,0,.25,.15,0,0,J),n.fill()):i==="frigate"?n.fillRect(-.2,-.25,.6,.5):i==="destroyer"?n.fillRect(-.9,-.18,1.2,.36):i==="carrier"&&(n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(-.8,-.25,1.6,.5)),n.restore();let h={canvas:t,size:o,baseRadius:e};return a.set(e,h),h}function _i(i){for(let e of ve)ge(i,e)}function ui(i,e=ve[1]){let a=qt.get(i);return a&&a.has(e)?a.get(e):ge(i,e)}function Ue(i,e,a=typeof window<"u"&&window.devicePixelRatio||1){let s=Math.max(1,Math.round(e*a));_i(i);let o=qt.get(i)||new Map,t=null,n=1/0;for(let[f,h]of o.entries()){let _=Math.abs(f-s);_<n&&(n=_,t=h)}return t||(t=ge(i,s)),t}var Yt=null;function Ge(){if(!r||typeof r.createRadialGradient!="function"){Yt=null;return}Yt=r.createRadialGradient(W*.6,$*.3,50,W*.6,$*.3,Math.max(W,$)),Yt.addColorStop(0,"rgba(60,80,140,0.10)"),Yt.addColorStop(1,"rgba(10,12,20,0.0)")}Ge();var Vi=At,ke=Pt,$i=Gt,Ki=xt;var ot=(i,e=1)=>i===p.RED?`rgba(255,90,90,${e})`:`rgba(80,160,255,${e})`;function Ai(i){if(i.life<=0)return;let e=i.life/i.max;r.fillStyle=(i.color||"").replace?i.color.replace("$a",e.toFixed(3)):i.color,r.fillRect(i.x,i.y,2,2)}var _e=class{constructor(e){this.logic=e,this.id=e.id,this.team=e.team,this.x=e.x,this.y=e.y,this.type=e.type}syncFromLogic(){this.x=this.logic.x,this.y=this.logic.y,this.type=this.logic.type,this.alive=this.logic.alive}draw(){let e=this.logic;if(!e.alive)return;let a=Lt.some(E=>E.shieldHit&&E.x===e.x&&E.y===e.y&&E.life>0);if(Xt){let E=e.x-Math.cos(e.angle)*e.radius*1.2,F=e.y-Math.sin(e.angle)*e.radius*1.2;ke(E,F,-e.vx*.05+A(-10,10),-e.vy*.05+A(-10,10),.25,ot(e.team,"$a"))}let s=e.radius||8,o=ui(e.type),t=Ue(e.type,s,typeof window<"u"&&window.devicePixelRatio||1);if(t&&t.canvas&&r&&typeof r.drawImage=="function"){r.save(),r.translate(e.x,e.y),r.rotate(e.angle),r.shadowBlur=12,r.shadowColor=ot(e.team,.9);let E=t.size,F=s*2/(o.baseRadius*2),m=E*F,T=E*F;r.save(),r.globalCompositeOperation="source-over",r.drawImage(t.canvas,-m/2,-T/2,m,T),r.globalCompositeOperation="source-in",r.fillStyle=ot(e.team,.96),r.fillRect(-m/2,-T/2,m,T),r.restore(),r.restore()}else r.save(),r.translate(e.x,e.y),r.rotate(e.angle),r.shadowBlur=12,r.shadowColor=ot(e.team,.9),r.fillStyle=ot(e.team,.96),e.type==="corvette"?(r.beginPath(),r.moveTo(s*1.5,0),r.lineTo(-s,-s*.7),r.lineTo(-s*.4,0),r.lineTo(-s,s*.7),r.closePath(),r.fill(),r.fillStyle="rgba(255,255,255,.85)",r.beginPath(),r.ellipse(0,0,s*.35,s*.25,0,0,J),r.fill()):e.type==="frigate"?(r.beginPath(),r.moveTo(s*1.6,0),r.quadraticCurveTo(s*.2,-s*1.1,-s*1.1,-s*.6),r.lineTo(-s*.6,0),r.lineTo(-s*1.1,s*.6),r.quadraticCurveTo(s*.2,s*1.1,s*1.6,0),r.closePath(),r.fill(),r.fillStyle="rgba(255,255,255,.75)",r.fillRect(-s*.2,-s*.25,s*.6,s*.5)):e.type==="destroyer"?(r.beginPath(),r.moveTo(s*1.9,0),r.lineTo(s*.3,-s*1.1),r.lineTo(-s*1.4,-s*.6),r.lineTo(-s*1.4,s*.6),r.lineTo(s*.3,s*1.1),r.closePath(),r.fill(),r.fillStyle="rgba(255,255,255,.7)",r.fillRect(-s*.9,-s*.18,s*1.2,s*.36)):e.type==="carrier"?(r.beginPath(),r.ellipse(0,0,s*1.6,s*1,0,0,J),r.fill(),r.fillStyle="rgba(255,255,255,.18)",r.fillRect(-s*.8,-s*.25,s*1.6,s*.5)):e.type==="fighter"?(r.beginPath(),r.moveTo(s*1.2,0),r.lineTo(-s*.6,-s*.45),r.lineTo(-s*.2,0),r.lineTo(-s*.6,s*.45),r.closePath(),r.fill(),r.fillStyle="rgba(255,255,255,.9)",r.beginPath(),r.ellipse(s*.25,0,s*.25,s*.15,0,0,J),r.fill()):(r.beginPath(),r.moveTo(s*1.4,0),r.lineTo(-s,-s*.8),r.lineTo(-s*.4,0),r.lineTo(-s,s*.8),r.closePath(),r.fill()),r.restore();if(typeof e.shield=="number"&&typeof e.shieldMax=="number"){let E=e.shieldMax>0?Math.max(0,Math.min(1,e.shield/e.shieldMax)):0,F=s+4+(1-E)*2;r.save(),r.beginPath(),r.arc(e.x,e.y,F,0,J);let m=r.createRadialGradient(e.x,e.y,F*.6,e.x,e.y,F);m.addColorStop(0,`rgba(140,200,255,${.06})`),m.addColorStop(1,`rgba(80,160,255,${.02})`),r.fillStyle=m,r.globalCompositeOperation="lighter",r.fill();for(let T of ze){if(T.id!==e.id)continue;let k=Math.max(0,Math.min(1,T.life/.22)),c=e.shieldMax&&e.shieldMax>0?T.amount/e.shieldMax:Math.min(1,T.amount/(e.hpMax*.6||1)),H=Math.max(.08,Math.min(1,c)),it=(Math.PI*.25+Math.PI*.6*(1-k))*(.6+1.6*H),j=T.angle-it/2,gt=T.angle+it/2,pt=F+4*(1-k)+2*H;r.beginPath(),r.arc(e.x,e.y,pt,j,gt),r.lineWidth=(3+6*k)*(1+4*H);let ht=Math.min(1,.25+k*(.9+1.6*H));r.strokeStyle=`rgba(160,220,255,${ht})`,r.save(),r.shadowBlur=12*H,r.shadowColor="rgba(140,200,255,0.8)",r.stroke(),r.restore()}r.restore()}let n=Math.max(16,s*3.2),f=Math.max(3,s*.4),h=e.x-n/2,_=e.y-(s+12);if(typeof e.shield=="number"&&typeof e.shieldMax=="number"){let E=e.shieldMax>0?Math.max(0,Math.min(1,e.shield/e.shieldMax)):0;r.fillStyle="rgba(255,255,255,.08)",r.fillRect(h,_,n,f),r.fillStyle="rgba(80,160,255,.95)",r.fillRect(h,_,n*E,f)}let l=e.y+(s+8),y=Math.max(0,Math.min(1,e.hp/e.hpMax)),v=Math.min(6,f);r.beginPath(),r.moveTo(h+v,l),r.lineTo(h+n-v,l),r.quadraticCurveTo(h+n,l,h+n,l+v),r.lineTo(h+n,l+f-v),r.quadraticCurveTo(h+n,l+f,h+n-v,l+f),r.lineTo(h+v,l+f),r.quadraticCurveTo(h,l+f,h,l+f-v),r.lineTo(h,l+v),r.quadraticCurveTo(h,l,h+v,l),r.closePath(),r.fillStyle="rgba(255,255,255,.08)",r.fill();let b=Ye.find(E=>E.id===e.id&&E.life>0),w=`rgba(120,220,120,${.95})`;if(b){let E=Math.max(0,Math.min(1,b.life/.45)),F=Math.min(1,b.amount/(e.hpMax||1)),m=Math.floor(220*(1-F*E)),T=Math.floor(60+160*(1-E*F));w=`rgba(${Math.min(255,m)},${Math.min(255,T)},60,${.95})`}r.save(),r.beginPath(),r.moveTo(h+v,l),r.lineTo(h+n-v,l),r.quadraticCurveTo(h+n,l,h+n,l+v),r.lineTo(h+n,l+f-v),r.quadraticCurveTo(h+n,l+f,h+n-v,l+f),r.lineTo(h+v,l+f),r.quadraticCurveTo(h,l+f,h,l+f-v),r.lineTo(h,l+v),r.quadraticCurveTo(h,l,h+v,l),r.closePath(),r.clip(),r.fillStyle=w,r.fillRect(h,l,n*y,f),r.restore(),typeof e.level=="number"&&e.level>1&&(r.save(),r.fillStyle="rgba(255,255,255,0.95)",r.font="700 12px system-ui, sans-serif",r.textAlign="center",r.fillText(`Lv ${e.level}`,e.x,e.y-(s+18)),r.restore())}},Q=U,$t=at,Kt=tt,Lt=Z,ze=nt,Ye=rt,Vt={red:0,blue:0},vt=new Map,yt=!1,Ot=1,Xt=!0,Ht=0;function ue(i=null){return re(i)}function vi(i){let e=le(i,W,$);e&&e.score&&(Vt=e.score),Q=U,$t=at,Kt=tt,Lt=Z,ze=nt,Ye=rt;let a=new Set(Q.map(s=>s.id));for(let s of Q)vt.has(s.id)?vt.get(s.id).syncFromLogic():vt.set(s.id,new _e(s));for(let s of Array.from(vt.keys()))a.has(s)||vt.delete(s)}function Ie(){r.clearRect(0,0,W,$);let i=r.createRadialGradient(W*.6,$*.3,50,W*.6,$*.3,Math.max(W,$));i.addColorStop(0,"rgba(60,80,140,0.10)"),i.addColorStop(1,"rgba(10,12,20,0.0)"),r.fillStyle=i,r.fillRect(0,0,W,$);for(let s of Ne){let o=.6+.4*Math.sin(s.phase);r.globalAlpha=de(.5*o*(.6+.5*s.d),0,1),r.fillStyle="#e9f2ff",r.fillRect(s.x,s.y,s.r,s.r)}r.globalAlpha=1;for(let s of Lt){let o=de(s.life/.25,0,1);r.strokeStyle=ot(s.team,o*.6),r.lineWidth=2,r.beginPath(),r.arc(s.x,s.y,s.r,0,J),r.stroke()}for(let s of $t)r.save(),r.shadowBlur=12,r.shadowColor=ot(s.team,.9),r.fillStyle=ot(s.team,.95),r.beginPath(),r.arc(s.x,s.y,s.radius||2.2,0,J),r.fill(),r.restore();for(let s of Kt)Ai(s);for(let s of vt.values())s.draw();let e=Q.some(s=>s.alive&&s.team===p.RED),a=Q.some(s=>s.alive&&s.team===p.BLUE);if(!e||!a){r.save(),r.textAlign="center",r.font="700 36px Inter, system-ui, sans-serif";let s=e?"Red":a?"Blue":"Nobody",o=e?ot(p.RED,.95):a?ot(p.BLUE,.95):"rgba(255,255,255,.9)";r.fillStyle=o,r.shadowBlur=14,r.shadowColor=o,r.fillText(`${s} Wins!`,W/2,64),r.restore()}}function Ae(i){Ht||(Ht=i);let e=(i-Ht)/1e3;Ht=i;let a=de(e,0,.033)*(yt?Ot:0);if(vi(a),M&&M.type==="webgl"&&typeof M.render=="function")try{M.render({W,H:$,ships:Q,bullets:$t,stars:Ne,particles:Kt,flashes:Lt,shipsVMap:vt,score:Vt})}catch(s){console.error("WebGL render error, falling back to 2D render",s),Ie()}else Ie();yi(),requestAnimationFrame(Ae)}var ji=document.getElementById("startPause"),Ji=document.getElementById("reset"),Qi=document.getElementById("addRed"),Zi=document.getElementById("addBlue"),ts=document.getElementById("toggleTrails"),es=document.getElementById("speed"),gi=document.getElementById("redScore"),pi=document.getElementById("blueScore"),xi=document.getElementById("stats"),is=document.getElementById("seedBtn"),ss=document.getElementById("formationBtn"),Dt=document.getElementById("continuousCheckbox");Dt||(Dt=document.createElement("input"),Dt.type="checkbox",Dt.id="continuousCheckbox");he&&typeof kt=="function"&&kt(Dt);function yi(){gi.textContent=`Red ${Vt.red}`,pi.textContent=`Blue ${Vt.blue}`,xi.textContent=`Ships: ${Q.filter(i=>i.alive).length}  Bullets: ${$t.length}  Particles: ${Kt.length}`}function mi(){if(typeof document>"u")return null;let i=document.getElementById("rendererBackendBadge");if(!i){i=document.createElement("div"),i.id="rendererBackendBadge",i.style.position="fixed",i.style.right="12px",i.style.top="12px",i.style.padding="6px 10px",i.style.background="rgba(0,0,0,0.6)",i.style.color="#fff",i.style.fontFamily="system-ui,Segoe UI,Roboto,Arial",i.style.fontSize="12px",i.style.borderRadius="6px",i.style.zIndex="99999",i.style.pointerEvents="auto",i.style.cursor="default",i.title="Renderer backend";try{document.body.appendChild(i)}catch{}}return i}function Wt(i,e){let a=mi();a&&(a.textContent=i,e&&(a.title=e))}var ns=ie;function bi(i){return se(i)}function ce(){return ne()}var rs=oe,as=_t;function Ei(){if(typeof window>"u"||!document||window.__uiHandlersInstalled)return;Object.defineProperty(window,"__uiHandlersInstalled",{value:!0,configurable:!1,writable:!1});let i=document.getElementById("startPause");i&&i.addEventListener("click",()=>{yt=!yt,i.textContent=yt?"\u23F8 Pause":"\u25B6 Start"});let e=document.getElementById("reset");e&&e.addEventListener("click",()=>{ue()});let a=document.getElementById("addRed");a&&a.addEventListener("click",()=>{Q.push(new lt(p.RED,A(40,W*.35),A(80,$-80))),zt("+1 Red")});let s=document.getElementById("addBlue");s&&s.addEventListener("click",()=>{Q.push(new lt(p.BLUE,A(W*.65,W-40),A(80,$-80))),zt("+1 Blue")});let o=document.getElementById("toggleTrails");o&&o.addEventListener("click",()=>{Xt=!Xt,o.textContent=`\u2604 Trails: ${Xt?"On":"Off"}`});let t=document.getElementById("speed");t&&t.addEventListener("click",()=>{let l=[.5,1,2,4],y=(l.indexOf(Ot)+1)%l.length;Ot=l[y],t.textContent=`Speed: ${Ot}\xD7`});let n=document.getElementById("seedBtn");n&&n.addEventListener("click",()=>{let l=prompt("Enter numeric seed (32-bit):",Math.random()*1e9>>>0);l!==null&&ue(Number(l))});let f=document.getElementById("formationBtn");f&&f.addEventListener("click",()=>{let l=Q.filter(w=>w.alive&&w.team===p.RED),y=Q.filter(w=>w.alive&&w.team===p.BLUE),v=20,b=6;l.forEach((w,E)=>{let F=E%b,m=Math.floor(E/b);w.x=W*.25-F*20,w.y=$*.5+(m-b/2)*v,w.vx=w.vy=0}),y.forEach((w,E)=>{let F=E%b,m=Math.floor(E/b);w.x=W*.75+F*20,w.y=$*.5+(m-b/2)*v,w.vx=w.vy=0}),zt("Fleets re-formed")});let h=document.getElementById("reinforceFreqBtn"),_=[0,.5,1,2];if(h){let l=()=>{let y=ce();h.textContent=y>0?`${y}s`:"Every step"};l(),h.addEventListener("click",()=>{let y=ce(),v=(_.indexOf(y)+1)%_.length;bi(_[v]),l();let b=ce();zt(`Reinforcement check: ${b>0?b+"s":"every step"}`)})}O&&typeof O.addEventListener=="function"&&O.addEventListener("click",l=>{Lt.push({x:l.clientX,y:l.clientY,r:24,life:.25,team:wt(0,1)});for(let v=0;v<24;v++){let b=A(0,J),w=A(40,220);ke(l.clientX,l.clientY,Math.cos(b)*w,Math.sin(b)*w,A(.2,1),"rgba(255,255,255,$a)")}})}Q.length===0&&ue();var M=null,G={triedWebGL:!1,gl2:!1,gl1:!1,importError:null,used:null};try{if(typeof window<"u"&&typeof HTMLCanvasElement<"u"&&!HTMLCanvasElement.prototype.__getContextWrapped){let i=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(e,a){try{let s=i.call(this,e,a);if(!s)try{let o=new Error("getContext returned null for type "+e).stack;if(G.getContextNullStacks=G.getContextNullStacks||[],G.getContextNullStacks.push({type:e,attrs:a,stack:o,time:Date.now()}),typeof window<"u")try{window.__rendererDiag=G}catch{}console.warn("DEBUG: HTMLCanvasElement.getContext returned null for",e,a,`
stack:`,o)}catch{}return s}catch(s){try{let o=new Error("getContext threw for type "+e).stack;if(G.getContextThrowStacks=G.getContextThrowStacks||[],G.getContextThrowStacks.push({type:e,attrs:a,err:String(s),stack:o,time:Date.now()}),typeof window<"u")try{window.__rendererDiag=G}catch{}console.warn("DEBUG: HTMLCanvasElement.getContext threw",s,`
stack:`,o)}catch{}throw s}};try{Object.defineProperty(HTMLCanvasElement.prototype,"__getContextWrapped",{value:!0,configurable:!1})}catch{HTMLCanvasElement.prototype.__getContextWrapped=!0}}}catch{}var et=null,mt=!1;async function He(i={}){if(typeof window<"u"&&(window.initRenderer=He),typeof window<"u"&&window.__autoRendererStarted){if(mt&&M)return M;if(et)return await et,M}if(mt&&M)return M;if(et)return await et,M;typeof window<"u"&&(window.__autoRendererStarted=!0),et=(async()=>{let{canvas:e=O,preferWebGL:a=!0,startLoop:s=!0}=i;if(!e)throw new Error("No canvas available to initialize renderer");if(Ei(),a&&e.getContext){G.triedWebGL=!0;let o=[{},{antialias:!1},{powerPreference:"high-performance"},{antialias:!1,powerPreference:"high-performance"},{antialias:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1}],t=[],n=null;for(let _ of o)try{let l=e.getContext("webgl2",_);t.push({attrs:_,ok:!!l}),l&&!n&&(n=l)}catch(l){t.push({attrs:_,ok:!1,err:String(l)})}let f=[],h=null;if(!n)for(let _ of o)try{let l=e.getContext("webgl",_);f.push({attrs:_,ok:!!l}),l&&!h&&(h=l)}catch(l){f.push({attrs:_,ok:!1,err:String(l)})}if(G.attempts={webgl2:t,webgl:f},G.gl2=!!n,G.gl1=!!h,n||h)try{let{createWebGLRenderer:_}=await Promise.resolve().then(()=>(Fe(),Me));if(M=_(e,{webgl2:!!n,atlasAccessor:(y,v)=>Ue(y,v,typeof window<"u"&&window.devicePixelRatio||1),atlasLODs:ve}),M.init(),s&&M.start(()=>{requestAnimationFrame(Ae)}),G.used="webgl",typeof window<"u")try{window.__rendererDiag=G}catch{}console.info("Renderer: using WebGL",{webgl2:!!n});try{Wt("WebGL"+(n?"2":"1"),G.importError||"Using GPU WebGL renderer")}catch{}return M}catch(_){G.importError=String(_&&_.stack?_.stack:_),console.warn("WebGL init failed, falling back to 2D canvas renderer",_);try{Wt("Canvas (WebGL failed)",G.importError)}catch{}}else{G.importError="No WebGL context (getContext returned null)",console.info("Renderer: no WebGL context available; using Canvas 2D fallback");try{Wt("Canvas (no WebGL)",G.importError)}catch{}}}if(!M){if(M={type:"canvas"},G.used="canvas",typeof window<"u")try{window.__rendererDiag=G}catch{}console.info("Renderer: using Canvas 2D fallback");try{Wt("Canvas",G.importError||"Using Canvas 2D fallback")}catch{}s&&requestAnimationFrame(Ae)}return M})();try{let e=await et;return mt=!0,e}finally{et&&(et=null)}}function os(){return M?M.type:null}function ls(){return G}function Ri(){if(M&&typeof M.stop=="function"&&M.stop(),M&&typeof M.destroy=="function"&&M.destroy(),M=null,mt=!1,et=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}function hs(){if(Ri(),mt=!1,et=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}function fs(){if(mt=!1,et=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}typeof window<"u"&&(window.startSimulation=function(){try{yt=!0;let e=document.getElementById("startPause");e&&(e.textContent="\u23F8 Pause")}catch{}},window.stopSimulation=function(){try{yt=!1;let e=document.getElementById("startPause");e&&(e.textContent="\u25B6 Start")}catch{}});export{Ki as Particle,fs as _internal_resetInitFlags,ke as acquireParticle,Yt as backgroundGradient,$t as bullets,de as clamp,rs as evaluateReinforcement,Lt as flashes,ui as getHullAtlas,Ue as getHullAtlasForRadius,di as getHullPath,ce as getReinforcementInterval,ls as getRendererDiagnostics,os as getRendererType,as as handleReinforcement,Ye as healthFlashes,qt as hullAtlases,fe as hullPaths,He as initRenderer,ci as initStars,Vi as particlePool,Kt as particles,Ge as recomputeBackgroundGradient,$i as releaseParticle,ue as reset,ns as resetReinforcementCooldowns,bi as setReinforcementInterval,ze as shieldFlashes,Q as ships,vt as shipsVMap,Ne as stars,Ri as stopRenderer,hs as stopRendererAndAllowReinit,ot as teamColor};

// AUTO_INIT_SNIPPET_START
// Idempotent auto-init for standalone bundle: try common exported names safely.
// This variant awaits the initializer (if it returns a promise) and then
// retries clicking the start button until the UI toggles to "Pause" or
// a timeout is reached. This is more robust against handler-installation
// races caused by inlining/minification ordering.
if (typeof window !== "undefined" && !window.__autoRendererStarted) {
  window.__autoRendererStarted = true;
  Promise.resolve().then(() => {
    try {
      try {
        console.log('[AUTO_INIT] typeof window.initRenderer ->', typeof window.initRenderer);
        console.log('[AUTO_INIT] window.initRenderer ->', window.initRenderer && (window.initRenderer.name || '[function]'));
      } catch(_){ }

      const attemptStartWith = (fn, label) => {
        try {
          const p = fn({ preferWebGL: true, startLoop: true });
          // Ensure we handle both sync and promise returns
          return Promise.resolve(p).then(() => {
            // Retry clicking the start button until its text indicates running
            let attempts = 0;
            const maxAttempts = 12; // ~1 second with 80ms interval
            const tryClick = () => {
              attempts++;
              try {
                const b = document.getElementById('startPause');
                if (b && typeof b.click === 'function') {
                  b.click();
                  console.log('[AUTO_INIT] start button clicked (' + label + ') attempt', attempts);
                  // If the button text changed to Pause, we assume running started
                  if (b.textContent && b.textContent.toLowerCase().includes('pause')) {
                    console.log('[AUTO_INIT] start confirmed via button text (' + label + ')');
                    return;
                  }
                } else {
                  console.log('[AUTO_INIT] start button not found (' + label + '), attempt', attempts);
                }
              } catch (e) {
                console.log('[AUTO_INIT] click attempt error', e && e.message);
              }
              if (attempts < maxAttempts) {
                setTimeout(tryClick, 80);
              } else {
                console.log('[AUTO_INIT] failed to confirm start after', maxAttempts, 'attempts (', label, ')');
                try {
                  if (typeof window !== 'undefined' && typeof window.startSimulation === 'function') {
                    console.log('[AUTO_INIT] calling window.startSimulation() fallback');
                    window.startSimulation();
                  }
                } catch (_) {}
              }
            };
            // start first try slightly delayed to allow handlers to be installed
            setTimeout(tryClick, 60);

            // Proactive safety: also call startSimulation directly shortly after init
            // This ensures the internal 'ae' running flag is set even if click handlers
            // are not yet installed or click events are swallowed by race conditions.
            try {
              if (typeof window !== 'undefined' && typeof window.startSimulation === 'function') {
                setTimeout(() => {
                  try {
                    console.log('[AUTO_INIT] proactive window.startSimulation() call');
                    window.startSimulation();
                  } catch (__) {}
                }, 120);
                // A second attempt after a longer delay to cover slower setups
                setTimeout(() => {
                  try {
                    console.log('[AUTO_INIT] proactive window.startSimulation() call (retry)');
                    window.startSimulation();
                  } catch (__) {}
                }, 600);
              }
            } catch (_) {}
          });
        } catch (e) { console.log('[AUTO_INIT] initializer call threw (' + label + ')', e && e.message); return Promise.resolve(); }
      };

      if (typeof initRenderer === 'function') {
        console.log('[AUTO_INIT] calling initRenderer (local export)');
        attemptStartWith(initRenderer, 'initRenderer');
      } else if (typeof Li === 'function') {
        console.log('[AUTO_INIT] calling Li (minified alias)');
        attemptStartWith(Li, 'Li');
      } else if (typeof window.initRenderer === 'function') {
        console.log('[AUTO_INIT] calling window.initRenderer');
        attemptStartWith(window.initRenderer, 'window.initRenderer');
      } else {
        console.log('[AUTO_INIT] no initRenderer found to call');
      }
    } catch (e) {
      try { console.error('Auto init failed', e); } catch (_) {}
    }
  });
}
// AUTO_INIT_SNIPPET_END

</script>
<!-- END_INLINED_BUNDLE -->