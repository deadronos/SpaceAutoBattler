var Bt=Object.defineProperty;var gn=(n,e,s)=>e in n?Bt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var St=(n,e)=>()=>(n&&(e=n(n=0)),e);var Dt=(n,e)=>{for(var s in e)Bt(n,s,{get:e[s],enumerable:!0})};var Ut=(n,e,s)=>gn(n,typeof e!="symbol"?e+"":e,s);function Yt(n){if(!n)return!1;if(n instanceof WebGL2RenderingContext)return!0;try{return!!n.getExtension("OES_element_index_uint")}catch{return!1}}function qt(n,e=65535){if(n<=0)return[];let s=[],i=0;for(;n>0;){let l=Math.min(n,e);s.push({start:i,count:l}),i+=l,n-=l}return s}var $t=St(()=>{});var Kt={};Dt(Kt,{computeShipBatchRanges:()=>Sn,createWebGLRenderer:()=>Bn});function zt(n,e,s){let i=n.createShader(e);if(n.shaderSource(i,s),n.compileShader(i),!n.getShaderParameter(i,n.COMPILE_STATUS)){let l=n.getShaderInfoLog(i);throw n.deleteShader(i),new Error(`Shader compile error: ${l}`)}return i}function We(n,e,s){let i=zt(n,n.VERTEX_SHADER,e),l=zt(n,n.FRAGMENT_SHADER,s),o=n.createProgram();if(n.attachShader(o,i),n.attachShader(o,l),n.linkProgram(o),!n.getProgramParameter(o,n.LINK_STATUS)){let r=n.getProgramInfoLog(o);throw n.deleteProgram(o),new Error(`Program link error: ${r}`)}return o}function Bn(n,e={}){let{webgl2:s=!1,maxDevicePixelRatio:i=1.5,atlasAccessor:l=null,atlasLODs:o=[1],maxUploadsPerFrame:r=2,atlasUseMipmaps:d=!1,atlasMaxSize:f=2048}=e,t=n.getContext(s?"webgl2":"webgl");if(!t)return null;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);let c={textured:We(t,`
      attribute vec2 a_pos;
      attribute vec2 a_uv;
      uniform vec2 u_resolution;
      uniform vec2 u_pos;
      uniform vec2 u_scale;
      uniform float u_rotation;
      varying vec2 v_uv;
      void main() {
        vec2 p = a_pos * u_scale;
        float c = cos(u_rotation);
        float s = sin(u_rotation);
        vec2 rp = vec2(p.x * c - p.y * s, p.x * s + p.y * c);
        vec2 pixelPos = u_pos + rp;
        vec2 clip = (pixelPos / u_resolution) * 2.0 - 1.0;
        clip.y = -clip.y;
        gl_Position = vec4(clip, 0.0, 1.0);
        v_uv = a_uv;
      }`,`
      precision mediump float;
      uniform sampler2D u_tex;
      uniform vec4 u_tint;
      varying vec2 v_uv;
      void main() {
        vec4 t = texture2D(u_tex, v_uv);
        gl_FragColor = vec4(t.rgb * u_tint.rgb, t.a * u_tint.a);
      }`),batched:We(t,`
      attribute vec2 a_pos;
      attribute vec2 a_uv;
      uniform vec2 u_resolution;
      varying vec2 v_uv;
      void main() {
        vec2 clip = (a_pos / u_resolution) * 2.0 - 1.0;
        clip.y = -clip.y;
        gl_Position = vec4(clip, 0.0, 1.0);
        v_uv = a_uv;
      }`,`
      precision mediump float;
      uniform sampler2D u_tex;
      uniform vec4 u_tint;
      varying vec2 v_uv;
      void main() {
        vec4 t = texture2D(u_tex, v_uv);
        gl_FragColor = vec4(t.rgb * u_tint.rgb, t.a * u_tint.a);
      }`),instanced:s?We(t,`
      #version 300 es
      in vec2 a_pos;
      in vec2 a_uv;
      in vec2 a_off; in vec2 a_scale; in float a_rot; in vec4 a_tint; in float a_shield;
      uniform vec2 u_resolution;
      out vec2 v_uv; out vec4 v_tint; out float v_shield;
      void main() {
        vec2 p = a_pos * a_scale;
        float c = cos(a_rot);
        float s = sin(a_rot);
        vec2 rp = vec2(p.x * c - p.y * s, p.x * s + p.y * c);
        vec2 pixelPos = a_off + rp;
        vec2 clip = (pixelPos / u_resolution) * 2.0 - 1.0;
        clip.y = -clip.y;
        gl_Position = vec4(clip, 0.0, 1.0);
        v_uv = a_uv;
        v_tint = a_tint;
        v_shield = a_shield;
      }
    `,`
      #version 300 es
      precision mediump float;
      uniform sampler2D u_tex;
      in vec2 v_uv; in vec4 v_tint; in float v_shield;
      out vec4 outColor;
      void main() {
        vec4 t = texture(u_tex, v_uv);
        vec3 col = t.rgb * v_tint.rgb;
        // subtle shield tint boost
        col = mix(col, vec3(0.6,0.8,1.0), clamp(v_shield * 0.25, 0.0, 1.0));
        float a = t.a * v_tint.a;
        outColor = vec4(col, a);
      }
    `):null,disc:We(t,`
      attribute vec2 a_pos;
      attribute vec2 a_uv;
      varying vec2 v_uv;
      uniform vec2 u_resolution;
      uniform vec2 u_pos;
      uniform vec2 u_scale;
      void main() {
        v_uv = a_uv;
        vec2 p = a_pos * u_scale + u_pos;
        vec2 clip = (p / u_resolution) * 2.0 - 1.0;
        clip.y = -clip.y;
        gl_Position = vec4(clip, 0.0, 1.0);
      }`,`
      precision mediump float;
      uniform vec4 u_color;
      varying vec2 v_uv;
      void main() {
        vec2 uv = v_uv;
        vec2 d = uv - vec2(0.5,0.5);
        float dist = length(d) * 2.0;
        float alpha = 1.0 - smoothstep(0.85, 1.0, dist);
        float glow = 0.15 * (1.0 - smoothstep(0.6, 1.2, dist));
        float outA = clamp(u_color.a * alpha + glow * u_color.a, 0.0, 1.0);
        gl_FragColor = vec4(u_color.rgb * outA, outA);
      }`)},m={quadVBO:t.createBuffer(),quadIBO:t.createBuffer(),batchVBO:t.createBuffer(),batchIBO:t.createBuffer(),instanceVBO:s?t.createBuffer():null};t.bindBuffer(t.ARRAY_BUFFER,m.quadVBO),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-.5,-.5,0,1,.5,-.5,1,1,.5,.5,1,0,-.5,.5,0,0]),t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,m.quadIBO),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),t.STATIC_DRAW);let g=new Map,y=[],E=new Set;function v(x){if(!x||!x.canvas)return null;if(g.has(x.canvas))return g.get(x.canvas);if(!t)return null;let L=t.createTexture();t.bindTexture(t.TEXTURE_2D,L);try{t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0);let N=x.canvas;try{let O=N.width||x.size||0,B=N.height||x.size||0;if(f>0&&Math.max(O,B)>f&&typeof document<"u"){let R=document.createElement("canvas"),S=f/Math.max(O,B);R.width=Math.max(1,Math.floor(O*S)),R.height=Math.max(1,Math.floor(B*S));let fe=R.getContext("2d");fe&&fe.drawImage(N,0,0,R.width,R.height),N=R}}catch{}if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,N),d){let O=N.width||x.size||0,B=N.height||x.size||0,R=S=>(S&S-1)===0;R(O)&&R(B)?(t.generateMipmap(t.TEXTURE_2D),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR)):t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)}else t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR);t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}catch{let O=new Uint8Array([255,255,255,255]);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,O),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE)}let $={tex:L,size:x.size,baseRadius:x.baseRadius,canvas:x.canvas};return g.set(x.canvas,$),E.delete(x.canvas),$}function P(x,L=!1){return!x||!x.canvas?null:g.has(x.canvas)?g.get(x.canvas):t?L?v(x):(E.has(x.canvas)||(E.add(x.canvas),y.push(x)),null):null}let u={type:"webgl",webgl2:s,_supportsUint32Indices:!1,init(){try{return l&&["corvette","frigate","destroyer","carrier","fighter"].forEach(x=>{o.forEach(L=>{let $=l(x,L);$&&P($)})}),!0}catch{return t=null,!1}},render(x){if(!t)return;let L=Math.min(i,window.devicePixelRatio||1),$=n.clientWidth*L,N=n.clientHeight*L;(n.width!==$||n.height!==N)&&(n.width=$,n.height=N),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),t.clearColor(.02,.02,.03,1),t.clear(t.COLOR_BUFFER_BIT);let O=0;for(;O<r&&y.length>0;){let B=y.shift();try{v(B)}catch{}O++}if(x.bullets)for(let B of x.bullets){let R=B.team===0?[1,.35,.35,.95]:[.31,.62,1,.95];drawDisc(B.x,B.y,B.radius||2.2,R)}if(x.ships){let B=new Map;for(let R of x.ships){if(!R.alive)continue;let S=null;try{S=l?l(R.type,R.radius):null}catch{S=null}let fe=R.team===0?[1,.35,.35,.96]:[.31,.63,1,.96];if(!S||!S.canvas){drawDisc(R.x,R.y,R.radius||8,fe);continue}let de=P(S);if(!de||!de.tex){drawDisc(R.x,R.y,R.radius||8,fe);continue}let z=S.canvas&&typeof S.canvas.id<"u"?S.canvas.id:S.canvas,X=B.get(z);X||(X={atlasInfo:de,byTeam:new Map},B.set(z,X));let Ie=X.byTeam.get(R.team)||[];Ie.push(R),X.byTeam.set(R.team,Ie)}for(let[R,S]of B.entries())for(let[fe,de]of S.byTeam.entries()){let z=S.atlasInfo,X=de.length;if(X===0)continue;if(u._isWebGL2&&c.instanced&&m.instanceVBO){let re=X*10;(!u._instFloatArr||u._instCapacity<re)&&(u._instFloatArr=new Float32Array(re),u._instCapacity=re);let U=u._instFloatArr.subarray(0,re),W=0;for(let k=0;k<X;k++){let H=de[k],G=H.radius*2/(z.baseRadius*2),_e=z.size*G*L,ce=z.size*G*L;U[W++]=H.x*L,U[W++]=H.y*L,U[W++]=_e,U[W++]=ce,U[W++]=H.angle||0;let V=H.team===0?[1,.35,.35,.96]:[.31,.63,1,.96];U[W++]=V[0],U[W++]=V[1],U[W++]=V[2],U[W++]=V[3];let be=typeof H.shield=="number"&&typeof H.shieldMax=="number"&&H.shieldMax>0?Math.max(0,Math.min(1,H.shield/H.shieldMax)):0;U[W++]=be}t.useProgram(c.instanced),t.bindBuffer(t.ARRAY_BUFFER,m.quadVBO),h&&h.a_pos!==-1&&(t.enableVertexAttribArray(h.a_pos),t.vertexAttribPointer(h.a_pos,2,t.FLOAT,!1,16,0),t.vertexAttribDivisor(h.a_pos,0)),h&&h.a_uv!==-1&&(t.enableVertexAttribArray(h.a_uv),t.vertexAttribPointer(h.a_uv,2,t.FLOAT,!1,16,8),t.vertexAttribDivisor(h.a_uv,0)),t.bindBuffer(t.ARRAY_BUFFER,m.instanceVBO);let J=U.byteLength;if(J<=u._instanceVBOCapacity)t.bufferSubData(t.ARRAY_BUFFER,0,U);else{let k=Math.max(J,u._instanceVBOCapacity*2||J);t.bufferData(t.ARRAY_BUFFER,k,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,U),u._instanceVBOCapacity=k}let Z=40;h&&h.a_offset!==-1&&(t.enableVertexAttribArray(h.a_offset),t.vertexAttribPointer(h.a_offset,2,t.FLOAT,!1,Z,0),t.vertexAttribDivisor(h.a_offset,1)),h&&h.a_scale!==-1&&(t.enableVertexAttribArray(h.a_scale),t.vertexAttribPointer(h.a_scale,2,t.FLOAT,!1,Z,8),t.vertexAttribDivisor(h.a_scale,1)),h&&h.a_rotation!==-1&&(t.enableVertexAttribArray(h.a_rotation),t.vertexAttribPointer(h.a_rotation,1,t.FLOAT,!1,Z,16),t.vertexAttribDivisor(h.a_rotation,1)),h&&h.a_tint!==-1&&(t.enableVertexAttribArray(h.a_tint),t.vertexAttribPointer(h.a_tint,4,t.FLOAT,!1,Z,20),t.vertexAttribDivisor(h.a_tint,1)),h&&h.a_shield!==-1&&(t.enableVertexAttribArray(h.a_shield),t.vertexAttribPointer(h.a_shield,1,t.FLOAT,!1,Z,36),t.vertexAttribDivisor(h.a_shield,1)),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,m.quadIBO),t.uniform2f(h.u_resolution,t.drawingBufferWidth,t.drawingBufferHeight),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,z.tex),t.uniform1i(h.u_tex,0),t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,X);continue}let Ie=u._supportsUint32Indices?Number.MAX_SAFE_INTEGER:65535,et=Math.max(1,Math.floor(Ie/4));for(let re=0;re<X;re+=et){let U=Math.min(et,X-re),W=U*4,J=U*6,Z=W*4;(!u._tempVertArr||u._tempVertCapacity<Z)&&(u._tempVertArr=new Float32Array(Z),u._tempVertCapacity=Z);let k=u._tempVertArr.subarray(0,Z),H=u._supportsUint32Indices?Uint32Array:Uint16Array;!u._tempIdxArr||u._tempIdxCapacity<J?(u._tempIdxArr=new H(J),u._tempIdxCapacity=J):u._tempIdxArr instanceof H||(u._tempIdxArr=new H(J),u._tempIdxCapacity=J);let G=u._tempIdxArr.subarray(0,J),_e=0,ce=0,V=0;for(let ae=0;ae<U;ae++){let Se=de[re+ae],Tt=Se.radius*2/(z.baseRadius*2),ln=z.size*Tt*L,cn=z.size*Tt*L,De=ln*.5,Ue=cn*.5,Rt=Se.angle||0,At=Math.cos(Rt),Mt=Math.sin(Rt),fn=Se.x*L,dn=Se.y*L,Lt=[[-De,-Ue],[De,-Ue],[De,Ue],[-De,Ue]],Ct=[[0,1],[1,1],[1,0],[0,0]];for(let xe=0;xe<4;xe++){let Pt=Lt[xe][0],It=Lt[xe][1],un=Pt*At-It*Mt,hn=Pt*Mt+It*At,pn=fn+un,mn=dn+hn;k[_e++]=pn,k[_e++]=mn,k[_e++]=Ct[xe][0],k[_e++]=Ct[xe][1]}G[ce++]=V+0,G[ce++]=V+1,G[ce++]=V+2,G[ce++]=V+0,G[ce++]=V+2,G[ce++]=V+3,V+=4}t.useProgram(c.batched),t.bindBuffer(t.ARRAY_BUFFER,m.batchVBO);let be=k.byteLength;if(be<=u._batchVBOCapacity)t.bufferSubData(t.ARRAY_BUFFER,0,k);else{let ae=Math.max(be,u._batchVBOCapacity*2||be);t.bufferData(t.ARRAY_BUFFER,ae,t.DYNAMIC_DRAW),t.bufferSubData(t.ARRAY_BUFFER,0,k),u._batchVBOCapacity=ae}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,m.batchIBO);let tt=G.byteLength;if(tt<=u._batchIBOCapacity)t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,G);else{let ae=Math.max(tt,u._batchIBOCapacity*2||tt);t.bufferData(t.ELEMENT_ARRAY_BUFFER,ae,t.DYNAMIC_DRAW),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,G),u._batchIBOCapacity=ae}T.a_pos!==-1&&(t.enableVertexAttribArray(T.a_pos),t.vertexAttribPointer(T.a_pos,2,t.FLOAT,!1,16,0)),T.a_uv!==-1&&(t.enableVertexAttribArray(T.a_uv),t.vertexAttribPointer(T.a_uv,2,t.FLOAT,!1,16,8)),t.uniform2f(T.u_resolution,t.drawingBufferWidth,t.drawingBufferHeight);let Be=fe===0?[1,.35,.35,.96]:[.31,.63,1,.96];t.uniform4f(T.u_tint,Be[0],Be[1],Be[2],Be[3]),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,z.tex),t.uniform1i(T.u_tex,0);let sn=u._supportsUint32Indices?t.UNSIGNED_INT:t.UNSIGNED_SHORT;t.drawElements(t.TRIANGLES,G.length,sn,0)}}}},destroy(){t=null}},b={a_pos:t.getAttribLocation(c.textured,"a_pos"),a_uv:t.getAttribLocation(c.textured,"a_uv"),u_resolution:t.getUniformLocation(c.textured,"u_resolution"),u_pos:t.getUniformLocation(c.textured,"u_pos"),u_scale:t.getUniformLocation(c.textured,"u_scale"),u_rotation:t.getUniformLocation(c.textured,"u_rotation"),u_tint:t.getUniformLocation(c.textured,"u_tint"),u_tex:t.getUniformLocation(c.textured,"u_tex")},T={a_pos:t.getAttribLocation(c.batched,"a_pos"),a_uv:t.getAttribLocation(c.batched,"a_uv"),u_resolution:t.getUniformLocation(c.batched,"u_resolution"),u_tint:t.getUniformLocation(c.batched,"u_tint"),u_tex:t.getUniformLocation(c.batched,"u_tex")},h=null;c.instanced&&(h={a_pos:t.getAttribLocation(c.instanced,"a_pos"),a_uv:t.getAttribLocation(c.instanced,"a_uv"),a_offset:t.getAttribLocation(c.instanced,"a_offset"),a_scale:t.getAttribLocation(c.instanced,"a_scale"),a_rotation:t.getAttribLocation(c.instanced,"a_rotation"),a_tint:t.getAttribLocation(c.instanced,"a_tint"),u_resolution:t.getUniformLocation(c.instanced,"u_resolution"),u_tex:t.getUniformLocation(c.instanced,"u_tex")});let F={a_pos:t.getAttribLocation(c.disc,"a_pos"),a_uv:t.getAttribLocation(c.disc,"a_uv"),u_resolution:t.getUniformLocation(c.disc,"u_resolution"),u_pos:t.getUniformLocation(c.disc,"u_pos"),u_scale:t.getUniformLocation(c.disc,"u_scale"),u_color:t.getUniformLocation(c.disc,"u_color")};try{u._supportsUint32Indices=Yt(t)}catch{u._supportsUint32Indices=!1}return u._tmp={verts:null,indices:null,inst:null},c.instanced&&typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext&&(u._instLoc={a_pos:t.getAttribLocation(c.instanced,"a_pos"),a_uv:t.getAttribLocation(c.instanced,"a_uv"),a_off:t.getAttribLocation(c.instanced,"a_off"),a_scale:t.getAttribLocation(c.instanced,"a_scale"),a_rot:t.getAttribLocation(c.instanced,"a_rot"),a_tint:t.getAttribLocation(c.instanced,"a_tint"),a_shield:t.getAttribLocation(c.instanced,"a_shield"),u_resolution:t.getUniformLocation(c.instanced,"u_resolution"),u_tex:t.getUniformLocation(c.instanced,"u_tex")}),u._tempVertArr=null,u._tempIdxArr=null,u._tempVertCapacity=0,u._tempIdxCapacity=0,u._instFloatArr=null,u._instCapacity=0,u._dpr=1,u}function Sn(n=[],e=null,s=1,i=!1){let l=new Map;for(let r of n){if(!r||!r.alive)continue;let d=null;try{d=e?e(r.type,r.radius):null}catch{d=null}if(!d||!d.canvas)continue;let f=d.canvas&&typeof d.canvas.id<"u"?d.canvas.id:d.canvas,t=l.get(f);t||(t={atlas:d,byTeam:new Map},l.set(f,t));let c=t.byTeam.get(r.team)||[];c.push(r),t.byTeam.set(r.team,c)}let o=[];for(let[r,d]of l.entries())for(let[f,t]of d.byTeam.entries()){let c=t.length,m=c*4,g=i?Number.MAX_SAFE_INTEGER:65535,y=qt(m,g);o.push({atlasCanvas:r,team:f,totalQuads:c,totalVertices:m,ranges:y})}return o}var Qt=St(()=>{$t()});var nt=!1,Fe=123456789;function Ft(n){nt=!0,Fe=n>>>0}function kt(){nt=!1}function _n(){return nt?(Fe=1664525*Fe+1013904223>>>0,Fe/4294967296):Math.random()}function p(n=0,e=1){return n+(e-n)*_n()}function Te(n,e){return Math.floor(p(n,e+1))}var Ht={corvette:6.5,frigate:5,destroyer:3.2,carrier:2,fighter:8},Nt=1.2,it=.6;var _={RED:0,BLUE:1},ot=class{constructor(e,s,i,l,o,r=null){this.x=e,this.y=s,this.vx=i,this.vy=l,this.team=o,this.ownerId=r,this.life=2.5,this.radius=2.2,this.dmg=p(8,14)}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.life-=e}alive(e=null){if(this.life<=0)return!1;if(!e)return!0;let{W:s,H:i}=e;return this.x>-50&&this.x<s+50&&this.y>-50&&this.y<i+50}},ke=class ke{constructor(e,s,i,l="corvette"){this.team=e,this.x=s,this.y=i,this.vx=0,this.vy=0,this.angle=0,this.type=l;let o={corvette:{radius:8,maxSpeed:p(120,160),accel:240,turn:6.5,hp:p(40,70),reload:p(.18,.28),vision:220,range:140},frigate:{radius:10,maxSpeed:p(90,120),accel:200,turn:5,hp:p(80,120),reload:p(.24,.4),vision:280,range:180},destroyer:{radius:14,maxSpeed:p(60,90),accel:150,turn:3.2,hp:p(150,220),reload:p(.4,.7),vision:320,range:220},carrier:{radius:18,maxSpeed:p(40,70),accel:90,turn:2,hp:p(220,300),reload:p(.6,1.2),vision:360,range:260,launchBase:p(3.5,6)},fighter:{radius:6,maxSpeed:p(160,220),accel:300,turn:8,hp:p(18,32),reload:p(.12,.22),vision:180,range:120}},r=o[l]||o.corvette;this.radius=r.radius,this.maxSpeed=r.maxSpeed,this.accel=r.accel,this.turn=r.turn||Ht[l]||4.5,this.hpMax=r.hp,this.hp=this.hpMax,this.cooldown=0,this.reload=r.reload,this.vision=r.vision,this.range=r.range,this.id=ke._id++,this.kills=0,this.alive=!0,this._exploded=!1,this.level=1,this.xp=0,this.baseHpMax=this.hpMax,this.baseDmg=10,this.shieldMax=Math.round(this.hpMax*.6),this.shield=this.shieldMax,this.shieldRegen=Math.max(.5,this.shieldMax*.06),this.recentHitTimer=0,l==="carrier"?(this.isCarrier=!0,this.launchCooldown=r.launchBase*p(.8,1.4),this.launchAmount=Math.max(1,Math.floor(p(1,3))),this.maxFighters=6,this.activeFighters=[]):(this.isCarrier=!1,this.launchCooldown=0)}xpToNext(e=100,s=1.35){return Math.floor(e*Math.pow(s,Math.max(0,this.level-1)))}applyLevel(){let e=.06,s=.1,i=.08;this.hpMax=Math.round(this.baseHpMax*(1+s*(this.level-1)));let l=Math.round(this.baseHpMax*.6);this.shieldMax=Math.round(l*(1+i*(this.level-1))),this.hp=Math.min(this.hp,this.hpMax),this.shield=Math.min(this.shield,this.shieldMax)}gainXp(e){if(!(e<=0))for(this.xp+=e;this.xp>=this.xpToNext();)this.xp-=this.xpToNext(),this.level++,this.applyLevel()}pickTarget(e){let s=null,i=1/0,l=this.vision*this.vision;for(let o of e){if(!o.alive||o.team===this.team)continue;let r=o.x-this.x,d=o.y-this.y,f=r*r+d*d;f<l&&f<i&&(i=f,s=o)}return s}update(e,s){if(!this.alive)return;let i=this.pickTarget(s),l=this.recentHitTimer>0,o=0,r=0,d=1;if(i&&!l){let u=i.x-this.x,b=i.y-this.y;d=Math.hypot(u,b)||1;let T=Math.max(0,Math.min(1.2,d/240)),h=i.x+(i.vx||0)*T,F=i.y+(i.vy||0)*T;o=h-this.x,r=F-this.y;let x=Math.hypot(o,r)||1;o/=x,r/=x}else if(i&&l){let u=i.x-this.x,b=i.y-this.y;d=Math.hypot(u,b)||1,o=-(u/d),r=-(b/d)}else o=Math.cos(this.angle),r=Math.sin(this.angle);let f=0,t=0,c=0,m=26;for(let u of s){if(!u.alive||u===this||u.team!==this.team)continue;let b=this.x-u.x,T=this.y-u.y,h=b*b+T*T;if(h<m*m&&h>1){let F=Math.sqrt(h);f+=b/F,t+=T/F,c++}}c>0&&(f/=c,t/=c);let y=Math.atan2(r,o)-this.angle;for(;y>Math.PI;)y-=2*Math.PI;for(;y<-Math.PI;)y+=2*Math.PI;let E=this.turn*e;y>E?y=E:y<-E&&(y=-E),this.angle+=y;let v=l?this.accel*Nt:this.accel;this.vx+=Math.cos(this.angle)*v*e,this.vy+=Math.sin(this.angle)*v*e,c>0&&(this.vx+=f*(this.accel*it)*e,this.vy+=t*(this.accel*it)*e);let P=Math.hypot(this.vx,this.vy);if(P>this.maxSpeed){let u=this.maxSpeed/P;this.vx*=u,this.vy*=u}if(this.x+=this.vx*e,this.y+=this.vy*e,i){let u=i.x-this.x,b=i.y-this.y,T=Math.hypot(u,b)||1;if(T<this.range){let h=Math.cos(this.angle)*(u/T)+Math.sin(this.angle)*(b/T);if(this.cooldown<=0&&h>.2){let F=300+p(-20,20),x=u/T,L=b/T;arguments.length>=3&&Array.isArray(arguments[2])&&arguments[2].push(new ot(this.x+x*12,this.y+L*12,x*F+this.vx*.2,L*F+this.vy*.2,this.team,this.id)),this.cooldown=this.reload}}}this.cooldown-=e,this.shield<this.shieldMax&&(this.shield=Math.min(this.shieldMax,this.shield+this.shieldRegen*e)),this.recentHitTimer>0&&(this.recentHitTimer=Math.max(0,this.recentHitTimer-e))}damage(e){let s=e,i=0;return this.shield>0&&e>0&&(i=Math.min(this.shield,e),this.shield-=i,e-=i),e>0&&(this.hp-=e),(i>0||s>0&&e>0)&&(this.recentHitTimer=Math.max(this.recentHitTimer,1.2)),this.hp<=0&&this.alive?(this.type==="fighter"&&this.ownerCarrier,this.alive=!1,this._exploded=!0,{x:this.x,y:this.y,team:this.team,id:this.id,type:this.type,ownerCarrier:this.ownerCarrier}):null}};Ut(ke,"_id",1);var se=ke;function He(n,e,s,i,l=80){let o=[];for(let r=0;r<e;r++){let d=r%6*20+p(-10,10),f=Math.floor(r/6)*20+p(-10,10),t=p(0,1),c="corvette";t<.45?c="corvette":t<.75?c="frigate":t<.92?c="destroyer":c="carrier",o.push(new se(n,s+(n===_.RED?-d:d),i+f,c))}return o}var mt={};Dt(mt,{Particle:()=>ye,acquireParticle:()=>Me,bullets:()=>ie,clamp:()=>at,evaluateReinforcement:()=>ht,flashes:()=>K,getReinforcementInterval:()=>ft,handleReinforcement:()=>he,healthFlashes:()=>ne,initStars:()=>Oe,particlePool:()=>me,particles:()=>Q,processStateEvents:()=>In,releaseParticle:()=>Ge,reset:()=>dt,resetReinforcementCooldowns:()=>lt,setCarrierLaunchStrategy:()=>Mn,setContinuousCheckbox:()=>Xe,setReinforcementInterval:()=>ct,setReinforcementStrategy:()=>Ln,setSpawnCompositionStrategy:()=>Pn,setToast:()=>An,shieldFlashes:()=>te,ships:()=>M,simulate:()=>pt,stars:()=>pe});function Ot(n,e,s={W:800,H:600}){for(let i of n.ships)i.alive&&i.update(e,n.ships,n.bullets);if(s&&typeof s.W=="number"&&typeof s.H=="number"){let i=s.W,l=s.H;for(let o of n.ships){if(!o.alive)continue;let r=o.radius||0;o.x<-r?o.x+=i+r*2:o.x>i+r&&(o.x-=i+r*2),o.y<-r?o.y+=l+r*2:o.y>l+r&&(o.y-=l+r*2)}}for(let i=n.bullets.length-1;i>=0;i--){let l=n.bullets[i];l.update(e),l.alive(s)||n.bullets.splice(i,1)}for(let i=n.bullets.length-1;i>=0;i--){let l=n.bullets[i];for(let o of n.ships){if(!o.alive||o.team===l.team)continue;let r=o.x-l.x,d=o.y-l.y,f=r*r+d*d,t=o.radius+l.radius;if(f<t*t){let c=l.dmg,m=typeof o.shield=="number"?o.shield:0,g=typeof o.hp=="number"?o.hp:0,y=o.damage(c),E=Math.max(0,m-(typeof o.shield=="number"?o.shield:0)),v=Math.max(0,g-(typeof o.hp=="number"?o.hp:0));E>0&&n&&Array.isArray(n.shieldHits)&&n.shieldHits.push({id:o.id,hitX:l.x,hitY:l.y,team:o.team,amount:E}),v>0&&n&&Array.isArray(n.healthHits)&&n.healthHits.push({id:o.id,hitX:l.x,hitY:l.y,team:o.team,amount:v}),Array.isArray(n.damageEvents)||(n.damageEvents=[]),l.ownerId!=null&&n.damageEvents.push({ownerId:l.ownerId,dmg:c}),n.bullets.splice(i,1),y&&n.explosions&&n.explosions.push(y),o.alive||(Array.isArray(n.killEvents)||(n.killEvents=[]),n.killEvents.push({id:o.id,type:o.type,ownerCarrier:o.ownerCarrier,level:o.level,team:o.team,killerId:l.ownerId,killerTeam:l.team,x:o.x,y:o.y}));break}}}}var Ne=Math.PI*2,ue=(n,e)=>n+(e-n)*Math.random(),at=(n,e,s)=>Math.max(e,Math.min(s,n)),st=n=>{if(typeof document<"u"){let e=document.getElementById("toast");e&&(e.textContent=n,e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),1400))}};function An(n){st=n}var pe=[];function Oe(){pe.length=0;let n=[.2,.5,1],e=typeof window<"u"?window.innerWidth:1024,s=typeof window<"u"?window.innerHeight:768;for(let i of n)for(let l=0;l<120;l++)pe.push({x:ue(0,e),y:ue(0,s),r:ue(.3,1.8)*i,d:i,tw:ue(.4,1),phase:ue(0,Ne)})}Oe();var me=[],Q=[],ye=class{constructor(e,s,i,l,o,r){this.x=e,this.y=s,this.vx=i,this.vy=l,this.life=o,this.max=o,this.color=r}update(e){this.x+=this.vx*e,this.y+=this.vy*e,this.vx*=Math.pow(.9,e*60),this.vy*=Math.pow(.9,e*60),this.life-=e}};function Me(n,e,s,i,l,o){let r;return me.length>0?(r=me.pop(),r.x=n,r.y=e,r.vx=s,r.vy=i,r.life=l,r.max=l,r.color=o):r=new ye(n,e,s,i,l,o),Q.push(r),r}function Ge(n){me.length<2e3&&me.push(n)}var K=[],te=[],ne=[],M=[],ie=[],Re=0,ee={[_.RED]:0,[_.BLUE]:0},Ae={[_.RED]:0,[_.BLUE]:0};function lt(){Ae[_.RED]=0,Ae[_.BLUE]=0}function ct(n){Re=Number(n)||0,ee[_.RED]=0,ee[_.BLUE]=0}function ft(){return Re}var rt=null;function Xe(n){rt=n}function he(n,e=null){if(!rt||!rt.checked)return;let s=2,i=["frigate","corvette","destroyer","carrier"],l=(r,d)=>{for(let f=0;f<d;f++){let t=i[Te(0,i.length-1)],c=typeof window<"u"?window.innerWidth:1024,m=typeof window<"u"?window.innerHeight:768,g=r===_.RED?p(40,Math.max(120,c*.35)):p(Math.max(c*.65,c-240),c-40),y=p(80,Math.max(120,m-80));M.push(new se(r,g,y,t))}},o=r=>{if(M.filter(f=>f.alive&&f.team===r).length<s&&(Ae[r]-=n,Ae[r]<=0)){let f=Te(1,6);l(r,f),Ae[r]=p(3,8),st(`Reinforcements: +${f} ${r===_.RED?"Red":"Blue"}`)}};e===null?(o(_.RED),o(_.BLUE)):o(e)}function dt(n=null){if(M.length=0,ie.length=0,Q.length=0,K.length=0,te.length=0,ne.length=0,n!==null)Ft(n>>>0),st(`Seed set to ${n>>>0}`);else try{kt()}catch{}let e=typeof window<"u"?window.innerWidth:1024,s=typeof window<"u"?window.innerHeight:768;M.push(...He(_.RED,12,e*.25,s*.5)),M.push(...He(_.BLUE,12,e*.75,s*.5))}var ut=(n,e,s)=>{let i=[];if(n.launchCooldown-=s,n.launchCooldown<=0){if((Array.isArray(n.activeFighters)?n.activeFighters.length:0)<(n.maxFighters||6)){let o=Math.max(1,Math.floor(n.launchAmount||1));for(let r=0;r<o&&!(n.activeFighters.length>=(n.maxFighters||6));r++){let d=p(0,Ne),f=n.radius+12+p(4,12),t=n.x+Math.cos(d)*f,c=n.y+Math.sin(d)*f,m=new se(n.team,t,c,"fighter"),g=p(40,120);m.vx=Math.cos(d)*g+(n.vx||0)*.2,m.vy=Math.sin(d)*g+(n.vy||0)*.2,m.ownerCarrier=n.id,n.activeFighters.push(m.id),i.push(m)}}n.launchCooldown=p(2.5,6)}return i};function Mn(n){ut=n}var Vt=(n,e)=>{he(n)};function Ln(n){Vt=n}var Cn=(n,e,s,i)=>He(n,e,s,i);function Pn(n){Cn=n}function ht(n){if(Re<=0){he(n);return}ee[_.RED]+=n,ee[_.BLUE]+=n,ee[_.RED]>=Re&&(he(ee[_.RED],_.RED),ee[_.RED]=0),ee[_.BLUE]>=Re&&(he(ee[_.BLUE],_.BLUE),ee[_.BLUE]=0)}function pt(n,e,s){for(let o of pe)o.phase+=n*.8*o.d;for(let o of M){if(!o.alive||!o.isCarrier)continue;let r=ut(o,M,n);if(Array.isArray(r)&&r.length)for(let d of r)M.push(d)}for(let o of M)o.update(n,M);for(let o=ie.length-1;o>=0;o--){let r=ie[o];if(r.update(n),!r.alive()){ie.splice(o,1);continue}}let l={ships:M,bullets:ie,score:{red:0,blue:0},particles:Q,explosions:[],shieldHits:[]};if(Ot(l,n,{W:e,H:s}),l.explosions&&l.explosions.length)for(let o of l.explosions){K.push({x:o.x,y:o.y,r:2,life:.25,team:o.team});for(let r=0;r<20;r++){let d=p(0,Ne),f=p(40,220);Me(o.x,o.y,Math.cos(d)*f,Math.sin(d)*f,ue(.2,1),"rgba(255,255,255,$a)")}}if(Array.isArray(l.shieldHits)&&l.shieldHits.length)for(let o of l.shieldHits){let r=M.find(t=>t.id===o.id),d=r?r.x:o.hitX,f=r?r.y:o.hitY;K.push({x:d,y:f,r:6+Math.min(12,o.amount),life:.12,team:o.team,shieldHit:!0});for(let t=0;t<6;t++){let c=p(0,Ne),m=p(40,120);Me(o.hitX,o.hitY,Math.cos(c)*m,Math.sin(c)*m,ue(.12,.4),"rgba(200,230,255,$a)")}if(r){let t=Math.atan2(o.hitY-f,o.hitX-d);te.push({id:r.id,angle:t,life:.22,amount:o.amount})}}if(Array.isArray(l.healthHits)&&l.healthHits.length)for(let o of l.healthHits){let r=M.find(d=>d.id===o.id);r&&ne.push({id:r.id,life:.45,amount:o.amount})}if(Array.isArray(l.damageEvents)&&l.damageEvents.length){for(let o of l.damageEvents)if(o&&o.ownerId!=null&&typeof o.dmg=="number"){let r=M.find(d=>d.id===o.ownerId);r&&r.gainXp(o.dmg*.05)}}if(Array.isArray(l.killEvents)&&l.killEvents.length){for(let o of l.killEvents)if(o){if(o.killerTeam===_.RED?l.score.red++:o.killerTeam===_.BLUE&&l.score.blue++,o.killerId!=null){let r=M.find(d=>d.id===o.killerId);r&&r.gainXp(20+(o.level||1)*.2)}if(o.type==="fighter"&&typeof o.ownerCarrier=="number"){let r=M.find(d=>d.id===o.ownerCarrier);if(r&&Array.isArray(r.activeFighters)){let d=r.activeFighters.indexOf(o.id);d>=0&&r.activeFighters.splice(d,1)}}if(o.type==="carrier"){let r=o.id;for(let f of M)f.alive&&f.type==="fighter"&&f.ownerCarrier===r&&(f.ownerCarrier=null);let d=M.find(f=>f.id===r);d&&Array.isArray(d.activeFighters)&&(d.activeFighters.length=0)}}}Vt(n,M);for(let o=Q.length-1;o>=0;o--){let r=Q[o];r.update(n),r.life<=0&&(Q.splice(o,1),Ge(r))}for(let o=K.length-1;o>=0;o--){let r=K[o];r.life-=n,r.r+=600*n,r.life<=0&&K.splice(o,1)}for(let o=te.length-1;o>=0;o--){let r=te[o];r.life-=n,r.life<=0&&te.splice(o,1)}for(let o=ne.length-1;o>=0;o--){let r=ne[o];r.life-=n,r.life<=0&&ne.splice(o,1)}return{ships:M,bullets:ie,particles:Q,flashes:K,shieldFlashes:te,healthFlashes:ne,stars:pe}}function In(n,e=0){if(!(!n||!Array.isArray(n.ships))){for(let s of n.ships){if(!s.alive||!s.isCarrier)continue;let i=ut(s,n.ships,e);if(Array.isArray(i)&&i.length)for(let l of i)n.ships.push(l)}if(Array.isArray(n.damageEvents)&&n.damageEvents.length){for(let s of n.damageEvents)if(s&&s.ownerId!=null&&typeof s.dmg=="number"){let i=n.ships.find(l=>l.id===s.ownerId);i&&i.gainXp(s.dmg*.05)}}if(Array.isArray(n.killEvents)&&n.killEvents.length){for(let s of n.killEvents)if(s){if(n.score||(n.score={red:0,blue:0}),s.killerTeam===_.RED?n.score.red++:s.killerTeam===_.BLUE&&n.score.blue++,s.killerId!=null){let i=n.ships.find(l=>l.id===s.killerId);i&&i.gainXp(20+(s.level||1)*.2)}if(s.type==="fighter"&&typeof s.ownerCarrier=="number"){let i=n.ships.find(l=>l.id===s.ownerCarrier);if(i&&Array.isArray(i.activeFighters)){let l=i.activeFighters.indexOf(s.id);l>=0&&i.activeFighters.splice(l,1)}}if(s.type==="carrier"){let i=s.id;for(let o of n.ships)o.alive&&o.type==="fighter"&&o.ownerCarrier===i&&(o.ownerCarrier=null);let l=n.ships.find(o=>o.id===i);l&&Array.isArray(l.activeFighters)&&(l.activeFighters.length=0)}}}}}var w=null;typeof document<"u"&&(w=document.getElementById("world"));!w&&typeof document<"u"&&(w=document.createElement("canvas"),w.id="world",document.body&&document.body.appendChild(w));if(typeof globalThis.Path2D>"u"){class n{constructor(){}moveTo(){}lineTo(){}quadraticCurveTo(){}ellipse(){}arc(){}closePath(){}}globalThis.Path2D=n}var a=null,I=w&&w.width?w.width=typeof window<"u"?window.innerWidth:1024:1024,D=w&&w.height?w.height=typeof window<"u"?window.innerHeight:768:768;typeof window<"u"&&typeof window.addEventListener=="function"&&window.addEventListener("resize",()=>{I=w.width=window.innerWidth,D=w.height=window.innerHeight,Qe(),Le()});var Y=Math.PI*2,xt=at;function Ve(n){let e=document.getElementById("toast");e.textContent=n,e.classList.add("show"),setTimeout(()=>e.classList.remove("show"),1400)}var tn=pe,Le=Oe,gt=new Map;function Dn(n){if(gt.has(n))return gt.get(n);let e=new Path2D;return n==="corvette"?(e.moveTo(1.5,0),e.lineTo(-1,-.7),e.lineTo(-.4,0),e.lineTo(-1,.7),e.closePath(),e.ellipse(0,0,.35,.25,0,0,Y)):n==="frigate"?(e.moveTo(1.6,0),e.quadraticCurveTo(.2,-1.1,-1.1,-.6),e.lineTo(-.6,0),e.lineTo(-1.1,.6),e.quadraticCurveTo(.2,1.1,1.6,0),e.closePath()):n==="destroyer"?(e.moveTo(1.9,0),e.lineTo(.3,-1.1),e.lineTo(-1.4,-.6),e.lineTo(-1.4,.6),e.lineTo(.3,1.1),e.closePath()):n==="carrier"?e.ellipse(0,0,1.6,1,0,0,Y):n==="fighter"?(e.moveTo(1.2,0),e.lineTo(-.6,-.45),e.lineTo(-.2,0),e.lineTo(-.6,.45),e.closePath(),e.ellipse(.25,0,.25,.15,0,0,Y)):(e.moveTo(1.4,0),e.lineTo(-1,-.8),e.lineTo(-.4,0),e.lineTo(-1,.8),e.closePath()),gt.set(n,e),e}var Ke=new Map,wt=[12,20,36];function bt(n,e){let s=Ke.get(n);if(s||(s=new Map,Ke.set(n,s)),s.has(e))return s.get(e);let l=Math.ceil(e*2.2*2+8),o=typeof document<"u"?document.createElement("canvas"):{width:l,height:l,getContext:()=>null};o.width=l,o.height=l;let r=o.getContext&&o.getContext("2d");if(!r){let t={canvas:o,size:l,baseRadius:e};return s.set(e,t),t}let d=l/2;r.clearRect(0,0,l,l),r.save(),r.translate(d,d),r.scale(e,e),r.fillStyle="white",r.strokeStyle="white",r.lineWidth=.02;try{r.fill(Dn(n))}catch{r.beginPath(),r.arc(0,0,1,0,Y),r.fill()}r.fillStyle="rgba(255,255,255,0.9)",n==="corvette"||n==="fighter"?(r.beginPath(),r.ellipse(.25,0,.25,.15,0,0,Y),r.fill()):n==="frigate"?r.fillRect(-.2,-.25,.6,.5):n==="destroyer"?r.fillRect(-.9,-.18,1.2,.36):n==="carrier"&&(r.fillStyle="rgba(255,255,255,0.2)",r.fillRect(-.8,-.25,1.6,.5)),r.restore();let f={canvas:o,size:l,baseRadius:e};return s.set(e,f),f}function Un(n){for(let e of wt)bt(n,e)}function Fn(n,e=wt[1]){let s=Ke.get(n);return s&&s.has(e)?s.get(e):bt(n,e)}function nn(n,e,s=typeof window<"u"&&window.devicePixelRatio||1){let i=Math.max(1,Math.round(e*s));Un(n);let l=Ke.get(n)||new Map,o=null,r=1/0;for(let[d,f]of l.entries()){let t=Math.abs(d-i);t<r&&(r=t,o=f)}return o||(o=bt(n,i)),o}var Ee=null;function Qe(){if(!a||typeof a.createRadialGradient!="function"){Ee=null;return}Ee=a.createRadialGradient(I*.6,D*.3,50,I*.6,D*.3,Math.max(I,D)),Ee.addColorStop(0,"rgba(60,80,140,0.10)"),Ee.addColorStop(1,"rgba(10,12,20,0.0)")}Qe();var mi=me,on=Me,gi=Ge,_i=ye;var oe=(n,e=1)=>n===_.RED?`rgba(255,90,90,${e})`:`rgba(80,160,255,${e})`;function kn(n){if(n.life<=0)return;let e=n.life/n.max;a.fillStyle=(n.color||"").replace?n.color.replace("$a",e.toFixed(3)):n.color,a.fillRect(n.x,n.y,2,2)}var yt=class{constructor(e){this.logic=e,this.id=e.id,this.team=e.team,this.x=e.x,this.y=e.y,this.type=e.type}syncFromLogic(){this.x=this.logic.x,this.y=this.logic.y,this.type=this.logic.type,this.alive=this.logic.alive}draw(){let e=this.logic;if(!e.alive)return;let s=Pe.some(v=>v.shieldHit&&v.x===e.x&&v.y===e.y&&v.life>0);if(ze){let v=e.x-Math.cos(e.angle)*e.radius*1.2,P=e.y-Math.sin(e.angle)*e.radius*1.2;on(v,P,-e.vx*.05+p(-10,10),-e.vy*.05+p(-10,10),.25,oe(e.team,"$a"))}let i=e.radius||8,l=Fn(e.type),o=nn(e.type,i,typeof window<"u"&&window.devicePixelRatio||1);if(o&&o.canvas&&a&&typeof a.drawImage=="function"){a.save(),a.translate(e.x,e.y),a.rotate(e.angle),a.shadowBlur=12,a.shadowColor=oe(e.team,.9);let v=o.size,P=i*2/(l.baseRadius*2),u=v*P,b=v*P;a.save(),a.globalCompositeOperation="source-over",a.drawImage(o.canvas,-u/2,-b/2,u,b),a.globalCompositeOperation="source-in",a.fillStyle=oe(e.team,.96),a.fillRect(-u/2,-b/2,u,b),a.restore(),a.restore()}else a.save(),a.translate(e.x,e.y),a.rotate(e.angle),a.shadowBlur=12,a.shadowColor=oe(e.team,.9),a.fillStyle=oe(e.team,.96),e.type==="corvette"?(a.beginPath(),a.moveTo(i*1.5,0),a.lineTo(-i,-i*.7),a.lineTo(-i*.4,0),a.lineTo(-i,i*.7),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,.85)",a.beginPath(),a.ellipse(0,0,i*.35,i*.25,0,0,Y),a.fill()):e.type==="frigate"?(a.beginPath(),a.moveTo(i*1.6,0),a.quadraticCurveTo(i*.2,-i*1.1,-i*1.1,-i*.6),a.lineTo(-i*.6,0),a.lineTo(-i*1.1,i*.6),a.quadraticCurveTo(i*.2,i*1.1,i*1.6,0),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,.75)",a.fillRect(-i*.2,-i*.25,i*.6,i*.5)):e.type==="destroyer"?(a.beginPath(),a.moveTo(i*1.9,0),a.lineTo(i*.3,-i*1.1),a.lineTo(-i*1.4,-i*.6),a.lineTo(-i*1.4,i*.6),a.lineTo(i*.3,i*1.1),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,.7)",a.fillRect(-i*.9,-i*.18,i*1.2,i*.36)):e.type==="carrier"?(a.beginPath(),a.ellipse(0,0,i*1.6,i*1,0,0,Y),a.fill(),a.fillStyle="rgba(255,255,255,.18)",a.fillRect(-i*.8,-i*.25,i*1.6,i*.5)):e.type==="fighter"?(a.beginPath(),a.moveTo(i*1.2,0),a.lineTo(-i*.6,-i*.45),a.lineTo(-i*.2,0),a.lineTo(-i*.6,i*.45),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,.9)",a.beginPath(),a.ellipse(i*.25,0,i*.25,i*.15,0,0,Y),a.fill()):(a.beginPath(),a.moveTo(i*1.4,0),a.lineTo(-i,-i*.8),a.lineTo(-i*.4,0),a.lineTo(-i,i*.8),a.closePath(),a.fill()),a.restore();if(typeof e.shield=="number"&&typeof e.shieldMax=="number"){let v=e.shieldMax>0?Math.max(0,Math.min(1,e.shield/e.shieldMax)):0,P=i+4+(1-v)*2;a.save(),a.beginPath(),a.arc(e.x,e.y,P,0,Y);let u=a.createRadialGradient(e.x,e.y,P*.6,e.x,e.y,P);u.addColorStop(0,`rgba(140,200,255,${.06})`),u.addColorStop(1,`rgba(80,160,255,${.02})`),a.fillStyle=u,a.globalCompositeOperation="lighter",a.fill();for(let b of rn){if(b.id!==e.id)continue;let T=Math.max(0,Math.min(1,b.life/.22)),h=e.shieldMax&&e.shieldMax>0?b.amount/e.shieldMax:Math.min(1,b.amount/(e.hpMax*.6||1)),F=Math.max(.08,Math.min(1,h)),L=(Math.PI*.25+Math.PI*.6*(1-T))*(.6+1.6*F),$=b.angle-L/2,N=b.angle+L/2,O=P+4*(1-T)+2*F;a.beginPath(),a.arc(e.x,e.y,O,$,N),a.lineWidth=(3+6*T)*(1+4*F);let B=Math.min(1,.25+T*(.9+1.6*F));a.strokeStyle=`rgba(160,220,255,${B})`,a.save(),a.shadowBlur=12*F,a.shadowColor="rgba(140,200,255,0.8)",a.stroke(),a.restore()}a.restore()}let r=Math.max(16,i*3.2),d=Math.max(3,i*.4),f=e.x-r/2,t=e.y-(i+12);if(typeof e.shield=="number"&&typeof e.shieldMax=="number"){let v=e.shieldMax>0?Math.max(0,Math.min(1,e.shield/e.shieldMax)):0;a.fillStyle="rgba(255,255,255,.08)",a.fillRect(f,t,r,d),a.fillStyle="rgba(80,160,255,.95)",a.fillRect(f,t,r*v,d)}let c=e.y+(i+8),m=Math.max(0,Math.min(1,e.hp/e.hpMax)),g=Math.min(6,d);a.beginPath(),a.moveTo(f+g,c),a.lineTo(f+r-g,c),a.quadraticCurveTo(f+r,c,f+r,c+g),a.lineTo(f+r,c+d-g),a.quadraticCurveTo(f+r,c+d,f+r-g,c+d),a.lineTo(f+g,c+d),a.quadraticCurveTo(f,c+d,f,c+d-g),a.lineTo(f,c+g),a.quadraticCurveTo(f,c,f+g,c),a.closePath(),a.fillStyle="rgba(255,255,255,.08)",a.fill();let y=an.find(v=>v.id===e.id&&v.life>0),E=`rgba(120,220,120,${.95})`;if(y){let v=Math.max(0,Math.min(1,y.life/.45)),P=Math.min(1,y.amount/(e.hpMax||1)),u=Math.floor(220*(1-P*v)),b=Math.floor(60+160*(1-v*P));E=`rgba(${Math.min(255,u)},${Math.min(255,b)},60,${.95})`}a.save(),a.beginPath(),a.moveTo(f+g,c),a.lineTo(f+r-g,c),a.quadraticCurveTo(f+r,c,f+r,c+g),a.lineTo(f+r,c+d-g),a.quadraticCurveTo(f+r,c+d,f+r-g,c+d),a.lineTo(f+g,c+d),a.quadraticCurveTo(f,c+d,f,c+d-g),a.lineTo(f,c+g),a.quadraticCurveTo(f,c,f+g,c),a.closePath(),a.clip(),a.fillStyle=E,a.fillRect(f,c,r*m,d),a.restore(),typeof e.level=="number"&&e.level>1&&(a.save(),a.fillStyle="rgba(255,255,255,0.95)",a.font="700 12px system-ui, sans-serif",a.textAlign="center",a.fillText(`Lv ${e.level}`,e.x,e.y-(i+18)),a.restore())}},q=M,Je=ie,Ze=Q,Pe=K,rn=te,an=ne,je={red:0,blue:0},ge=new Map,le=!1,$e=1,ze=!0,Ye=0;function vt(n=null){return dt(n)}function Hn(n){let e=pt(n,I,D);e&&e.score&&(je=e.score),q=M,Je=ie,Ze=Q,Pe=K,rn=te,an=ne;let s=new Set(q.map(i=>i.id));for(let i of q)ge.has(i.id)?ge.get(i.id).syncFromLogic():ge.set(i.id,new yt(i));for(let i of Array.from(ge.keys()))s.has(i)||ge.delete(i)}function jt(){if(a.clearRect(0,0,I,D),Ee)a.fillStyle=Ee,a.fillRect(0,0,I,D);else{let s=a.createRadialGradient(I*.6,D*.3,50,I*.6,D*.3,Math.max(I,D));s.addColorStop(0,"rgba(60,80,140,0.10)"),s.addColorStop(1,"rgba(10,12,20,0.0)"),a.fillStyle=s,a.fillRect(0,0,I,D)}for(let s of tn){let i=.6+.4*Math.sin(s.phase);a.globalAlpha=xt(.5*i*(.6+.5*s.d),0,1),a.fillStyle="#e9f2ff",a.fillRect(s.x,s.y,s.r,s.r)}a.globalAlpha=1;for(let s of Pe){let i=xt(s.life/.25,0,1);a.strokeStyle=oe(s.team,i*.6),a.lineWidth=2,a.beginPath(),a.arc(s.x,s.y,s.r,0,Y),a.stroke()}for(let s of Je)a.save(),a.shadowBlur=12,a.shadowColor=oe(s.team,.9),a.fillStyle=oe(s.team,.95),a.beginPath(),a.arc(s.x,s.y,s.radius||2.2,0,Y),a.fill(),a.restore();for(let s of Ze)kn(s);for(let s of ge.values())s.draw();let n=q.some(s=>s.alive&&s.team===_.RED),e=q.some(s=>s.alive&&s.team===_.BLUE);if(!n||!e){a.save(),a.textAlign="center",a.font="700 36px Inter, system-ui, sans-serif";let s=n?"Red":e?"Blue":"Nobody",i=n?oe(_.RED,.95):e?oe(_.BLUE,.95):"rgba(255,255,255,.9)";a.fillStyle=i,a.shadowBlur=14,a.shadowColor=i,a.fillText(`${s} Wins!`,I/2,64),a.restore()}}function Et(n){Ye||(Ye=n);let e=(n-Ye)/1e3;Ye=n;let s=xt(e,0,.033)*(le?$e:0);if(Hn(s),A&&A.type==="webgl"&&typeof A.render=="function")try{A.render({W:I,H:D,ships:q,bullets:Je,stars:tn,particles:Ze,flashes:Pe,shipsVMap:ge,score:je})}catch(i){console.error("WebGL render error, falling back to 2D render",i),jt()}else jt();Nn(),requestAnimationFrame(Et)}var xi=document.getElementById("startPause"),yi=document.getElementById("reset"),vi=document.getElementById("addRed"),Ei=document.getElementById("addBlue"),wi=document.getElementById("toggleTrails"),bi=document.getElementById("speed"),Jt=document.getElementById("redScore"),Zt=document.getElementById("blueScore"),en=document.getElementById("stats"),Ti=document.getElementById("seedBtn"),Ri=document.getElementById("formationBtn"),Ce=document.getElementById("continuousCheckbox");Ce||(Ce=document.createElement("input"),Ce.type="checkbox",Ce.id="continuousCheckbox");mt&&typeof Xe=="function"&&Xe(Ce);function Nn(){try{let n=`Red ${je.red}`,e=`Blue ${je.blue}`,s=`Ships: ${q.filter(i=>i.alive).length}  Bullets: ${Je.length}  Particles: ${Ze.length}`;Jt.textContent!==n&&(Jt.textContent=n),Zt.textContent!==e&&(Zt.textContent=e),en.textContent!==s&&(en.textContent=s)}catch{}}function On(){if(typeof document>"u")return null;let n=document.getElementById("rendererBackendBadge");if(!n){n=document.createElement("div"),n.id="rendererBackendBadge",n.style.position="fixed",n.style.right="12px",n.style.top="12px",n.style.padding="6px 10px",n.style.background="rgba(0,0,0,0.6)",n.style.color="#fff",n.style.fontFamily="system-ui,Segoe UI,Roboto,Arial",n.style.fontSize="12px",n.style.borderRadius="6px",n.style.zIndex="99999",n.style.pointerEvents="auto",n.style.cursor="default",n.title="Renderer backend";try{document.body.appendChild(n)}catch{}}return n}function qe(n,e){let s=On();s&&(s.textContent=n,e&&(s.title=e))}var Ai=lt;function Gn(n){return ct(n)}function _t(){return ft()}var Mi=ht,Li=he;function Xn(){if(typeof window>"u"||!document||window.__uiHandlersInstalled)return;Object.defineProperty(window,"__uiHandlersInstalled",{value:!0,configurable:!1,writable:!1});let n=document.getElementById("startPause");n&&n.addEventListener("click",()=>{le=!le,n.textContent=le?"\u23F8 Pause":"\u25B6 Start"});let e=document.getElementById("reset");e&&e.addEventListener("click",()=>{vt()});let s=document.getElementById("addRed");s&&s.addEventListener("click",()=>{q.push(new se(_.RED,p(40,I*.35),p(80,D-80))),Ve("+1 Red")});let i=document.getElementById("addBlue");i&&i.addEventListener("click",()=>{q.push(new se(_.BLUE,p(I*.65,I-40),p(80,D-80))),Ve("+1 Blue")});let l=document.getElementById("toggleTrails");l&&l.addEventListener("click",()=>{ze=!ze,l.textContent=`\u2604 Trails: ${ze?"On":"Off"}`});let o=document.getElementById("speed");o&&o.addEventListener("click",()=>{let c=[.5,1,2,4],m=(c.indexOf($e)+1)%c.length;$e=c[m],o.textContent=`Speed: ${$e}\xD7`});let r=document.getElementById("seedBtn");r&&r.addEventListener("click",()=>{let c=prompt("Enter numeric seed (32-bit):",Math.random()*1e9>>>0);c!==null&&vt(Number(c))});let d=document.getElementById("formationBtn");d&&d.addEventListener("click",()=>{let c=q.filter(E=>E.alive&&E.team===_.RED),m=q.filter(E=>E.alive&&E.team===_.BLUE),g=20,y=6;c.forEach((E,v)=>{let P=v%y,u=Math.floor(v/y);E.x=I*.25-P*20,E.y=D*.5+(u-y/2)*g,E.vx=E.vy=0}),m.forEach((E,v)=>{let P=v%y,u=Math.floor(v/y);E.x=I*.75+P*20,E.y=D*.5+(u-y/2)*g,E.vx=E.vy=0}),Ve("Fleets re-formed")});let f=document.getElementById("reinforceFreqBtn"),t=[0,.5,1,2];if(f){let c=()=>{let m=_t();f.textContent=m>0?`${m}s`:"Every step"};c(),f.addEventListener("click",()=>{let m=_t(),g=(t.indexOf(m)+1)%t.length;Gn(t[g]),c();let y=_t();Ve(`Reinforcement check: ${y>0?y+"s":"every step"}`)})}w&&typeof w.addEventListener=="function"&&w.addEventListener("click",c=>{Pe.push({x:c.clientX,y:c.clientY,r:24,life:.25,team:Te(0,1)});for(let g=0;g<24;g++){let y=p(0,Y),E=p(40,220);on(c.clientX,c.clientY,Math.cos(y)*E,Math.sin(y)*E,p(.2,1),"rgba(255,255,255,$a)")}})}q.length===0&&vt();var A=null,C={triedWebGL:!1,gl2:!1,gl1:!1,importError:null,used:null};try{if(typeof window<"u"&&typeof HTMLCanvasElement<"u"&&!HTMLCanvasElement.prototype.__getContextWrapped){let n=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=function(e,s){try{let i=n.call(this,e,s);if(!i)try{let l=new Error("getContext returned null for type "+e).stack;if(C.getContextNullStacks=C.getContextNullStacks||[],C.getContextNullStacks.push({type:e,attrs:s,stack:l,time:Date.now()}),typeof window<"u")try{window.__rendererDiag=C}catch{}console.warn("DEBUG: HTMLCanvasElement.getContext returned null for",e,s,`
stack:`,l)}catch{}return i}catch(i){try{let l=new Error("getContext threw for type "+e).stack;if(C.getContextThrowStacks=C.getContextThrowStacks||[],C.getContextThrowStacks.push({type:e,attrs:s,err:String(i),stack:l,time:Date.now()}),typeof window<"u")try{window.__rendererDiag=C}catch{}console.warn("DEBUG: HTMLCanvasElement.getContext threw",i,`
stack:`,l)}catch{}throw i}};try{Object.defineProperty(HTMLCanvasElement.prototype,"__getContextWrapped",{value:!0,configurable:!1})}catch{HTMLCanvasElement.prototype.__getContextWrapped=!0}}}catch{}var j=null,we=!1;async function Wn(n={}){if(typeof window<"u"&&(window.initRenderer=Wn),typeof window<"u"&&window.__autoRendererStarted){if(we&&A)return A;if(j)return await j,A}if(we&&A)return A;if(j)return await j,A;typeof window<"u"&&(window.__autoRendererStarted=!0),j=(async()=>{let{canvas:e=w,preferWebGL:s=!0,startLoop:i=!0}=n;if(!e)throw new Error("No canvas available to initialize renderer");if(Xn(),s&&e.getContext){C.triedWebGL=!0;let l=[{},{antialias:!1},{powerPreference:"high-performance"},{antialias:!1,powerPreference:"high-performance"},{antialias:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1}],o=[],r=null;for(let t of l)try{let c=e.getContext("webgl2",t);o.push({attrs:t,ok:!!c}),c&&!r&&(r=c)}catch(c){o.push({attrs:t,ok:!1,err:String(c)})}let d=[],f=null;if(!r)for(let t of l)try{let c=e.getContext("webgl",t);d.push({attrs:t,ok:!!c}),c&&!f&&(f=c)}catch(c){d.push({attrs:t,ok:!1,err:String(c)})}if(C.attempts={webgl2:o,webgl:d},C.gl2=!!r,C.gl1=!!f,r||f)try{let{createWebGLRenderer:t}=await Promise.resolve().then(()=>(Qt(),Kt));A=t(e,{webgl2:!!r,atlasAccessor:(m,g)=>nn(m,g,typeof window<"u"&&window.devicePixelRatio||1),atlasLODs:wt});try{A.__isSpaceAutoRenderer=!0}catch{}A.init();try{w=e,typeof window<"u"&&(I=w.width=window.innerWidth,D=w.height=window.innerHeight),a=w&&typeof w.getContext=="function"&&w.getContext("2d")||ve(),Qe(),typeof Le=="function"&&Le()}catch{a=a||ve()}if(i&&A.start(()=>{requestAnimationFrame(Et)}),C.used="webgl",typeof window<"u")try{window.__rendererDiag=C}catch{}console.info("Renderer: using WebGL",{webgl2:!!r});try{qe("WebGL"+(r?"2":"1"),C.importError||"Using GPU WebGL renderer")}catch{}return A}catch(t){C.importError=String(t&&t.stack?t.stack:t),console.warn("WebGL init failed, falling back to 2D canvas renderer",t);try{qe("Canvas (WebGL failed)",C.importError)}catch{}}else{C.importError="No WebGL context (getContext returned null)",console.info("Renderer: no WebGL context available; using Canvas 2D fallback");try{qe("Canvas (no WebGL)",C.importError)}catch{}}}if(!A){if(A=(function(){return{type:"canvas",__isSpaceAutoRenderer:!0,start(o){try{le=!0,typeof o=="function"&&o()}catch{}},stop(){le=!1},isRunning(){return!!le},destroy(){}}})(),C.used="canvas",typeof window<"u")try{window.__rendererDiag=C}catch{}console.info("Renderer: using Canvas 2D fallback");try{qe("Canvas",C.importError||"Using Canvas 2D fallback")}catch{}try{w=e,typeof window<"u"&&(I=w.width=window.innerWidth,D=w.height=window.innerHeight),w&&typeof w.getContext=="function"?a=w.getContext("2d")||ve():a=ve(),Qe(),typeof Le=="function"&&Le()}catch{a=a||ve()}i&&requestAnimationFrame(Et)}return A})();try{let e=await j;return we=!0,e}finally{j&&(j=null)}}function Ci(){return A?A.type:null}function Pi(){return C}function Vn(){if(A&&typeof A.stop=="function"&&A.stop(),A&&typeof A.destroy=="function"&&A.destroy(),A=null,we=!1,j=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}function Ii(){if(Vn(),we=!1,j=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}function Bi(){if(we=!1,j=null,typeof window<"u")try{delete window.__autoRendererStarted}catch{}}typeof window<"u"&&(window.startSimulation=function(){try{le=!0;let e=document.getElementById("startPause");e&&(e.textContent="\u23F8 Pause")}catch{}},window.stopSimulation=function(){try{le=!1;let e=document.getElementById("startPause");e&&(e.textContent="\u25B6 Start")}catch{}});function ve(){let n=()=>{},e=new Proxy({},{get(s,i){return i==="createRadialGradient"?()=>({addColorStop:n}):i==="measureText"?()=>({width:0}):i==="getImageData"?()=>({data:new Uint8ClampedArray(4),width:1,height:1}):n},set(){return!0}});return e.fillStyle="#000",e.strokeStyle="#000",e.globalAlpha=1,e.lineWidth=1,e.font="12px sans-serif",e}export{_i as Particle,Bi as _internal_resetInitFlags,on as acquireParticle,Ee as backgroundGradient,Je as bullets,xt as clamp,Mi as evaluateReinforcement,Pe as flashes,Fn as getHullAtlas,nn as getHullAtlasForRadius,Dn as getHullPath,_t as getReinforcementInterval,Pi as getRendererDiagnostics,Ci as getRendererType,Li as handleReinforcement,an as healthFlashes,Ke as hullAtlases,gt as hullPaths,Wn as initRenderer,Le as initStars,mi as particlePool,Ze as particles,Qe as recomputeBackgroundGradient,gi as releaseParticle,vt as reset,Ai as resetReinforcementCooldowns,Gn as setReinforcementInterval,rn as shieldFlashes,q as ships,ge as shipsVMap,tn as stars,Vn as stopRenderer,Ii as stopRendererAndAllowReinit,oe as teamColor};
